---
title: "PheWAS Analyses Oct/Nov 2022"
author: "Sarah Paul"
output:
  pdf_document: default
  pdf: default
  word_document: default
  html_document:
    df_print: paged
---

## Libraries, functions

```{r}
library(data.table)
library(lmerTest)
library(lme4)
library(readxl)
library(dplyr)
library(ggplot2)
library(reshape2)
library(ggrepel)
library(forcats)
library(ggsci)
library(RColorBrewer)
library(optimx)
library(minqa)
library(dfoptim)
library(survey)
#remotes::install_version("lavaan.survey", version="1.1.3.1")
library(lavaan.survey)
library(Polychrome)
library(ggnewscale)
library(ggpubr)
library(gplots)
library(ggforce)
library(remotes)
library(ggh4x)
library(tidyr)
library(psych)
library(openai)
library(scales)
library(DHARMa)
library(TMB)
library(glmmTMB)
library(RNOmni)
library(DescTools)
library(tibble)
library(purrr)
library(foreach)
library(doParallel)
library(future.apply)
library(progress)
library(mice)
library(plyr)
library(caret)
library(stringr)
library(naniar) 
library(VIM)  
library(glmnet)
#Sys.setenv(OPENAI_API_KEY = "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")
#install.packages("usethis")
#require(usethis)
#edit_r_environ(scope = "project")
#require(devtools)
#install_github("MichelNivard/GPTstudio")
#Functions that help
#Nabs warnings from a loop
withWarnings <- function(expr) {
  myWarnings <- NULL
  wHandler <- function(w) {
    myWarnings <<- c(myWarnings, list(w))
    invokeRestart("muffleWarning")
  }
  val <- withCallingHandlers(expr, warning = wHandler)
  list(value = val, warnings = myWarnings)
} 
set.seed(10)

```

#### READING IN DATA

```{r}
PheWAS_baseline <- read_excel("FINAL_PHEWAS_baseline_n5556_5.11.23.xlsx")

PheWAS_baseline$site_id <- ifelse(PheWAS_baseline$site_id == 22, 21, PheWAS_baseline$site_id)
PheWAS_baseline[PheWAS_baseline == "NA"] <- NA
PheWAS_baseline[PheWAS_baseline == ""] <- NA

which(colnames(PheWAS_baseline) == "tlfb_tob")
PheWAS_baseline[,c(1:4,20,671:1291)] <- lapply(PheWAS_baseline[,c(1:4,20,671:1291)],as.factor)
PheWAS_baseline[,c(5:19,21:670)] <- lapply(PheWAS_baseline[,c(5:19,21:670)],as.numeric)

descbase <- as.data.frame(psych::describe(PheWAS_baseline[,21:670]))
skewed <- descbase[descbase$skew > 1.96 | descbase$skew < -1.96,]
skeweddf <- PheWAS_baseline[colnames(PheWAS_baseline) %in% rownames(skewed)] 
skeweddf <- cbind(PheWAS_baseline[,1:20], skeweddf)

skeweddf <- skeweddf %>%
  relocate(pds_m5_y, .after = "medhx_9b") %>%
  relocate(pds_m5_p, .after = "pds_m5_y") %>% 
  relocate(pds_m4_p, .after = "pds_m5_p") %>%
  relocate(medhx_6m_times, .after = "pds_m4_p") %>%
  relocate(medhx_6n_notes, .after = "medhx_6m_times") %>%
  relocate(medhx_6p_notes, .after = "medhx_6n_notes") #%>%
 # mutate(across(path_alc_youth1:path_alc_youth8, ~5-.x)) #%>%
  #mutate(across(where(is.numeric), ~ .x + 1))

# winsorizing
skeweddf[,21:312] <- lapply(skeweddf[,21:312], function(x) Winsorize(x, minval = mean(x, na.rm = T)-3*sd(x, na.rm = T), maxval = mean(x, na.rm = T)+3*sd(x, na.rm = T)))
descskewed <- as.data.frame(psych::describe(skeweddf[,21:312]))
skewed2 <- descskewed[descskewed$skew > 1.96 | descskewed$skew < -1.96,]
skeweddf2 <- skeweddf[colnames(skeweddf) %in% rownames(skewed2)] 
# inverse normal transformation
skeweddf2[,1:226] <- lapply(skeweddf2[,1:226], function(x) qnorm((rank(x, na.last="keep")-0.5)/sum(!is.na(x))))
skeweddf2 <- cbind(skeweddf[,1:20], skeweddf2) 

`%nin%` <- Negate(`%in%`)
PheWAS_baseline <- PheWAS_baseline[colnames(PheWAS_baseline) %nin% rownames(skewed)]

PheWAS_baseline <- PheWAS_baseline %>%
  mutate_if(is.numeric, scale)

skeweddf <- skeweddf[colnames(skeweddf) %nin% colnames(skeweddf2)] %>%
  mutate_if(is.numeric, scale)

PheWAS_baseline <- cbind(PheWAS_baseline[,1:20], skeweddf2[,21:246], skeweddf[colnames(skeweddf) %nin% colnames(skeweddf2)], PheWAS_baseline[,21:999])

## moving continuous items with issues to the end of the continuous section
PheWAS_baseline <- PheWAS_baseline %>%
  relocate(reshist_state_immigrant_factor, .after = "birth_weight_oz_comb") %>%
  relocate(pds_f4_p, .after = "reshist_state_immigrant_factor") %>%
  relocate(pds_f4_2_y, .after = "pds_f4_p") %>%
  relocate(pds_m4_y, .after = "pds_f4_2_y") %>%
  relocate(pds_m5_y, .after = "pds_m4_y") %>%
  relocate(pds_m5_p, .after = "pds_m5_y") %>% 
  relocate(pds_m4_p, .after = "pds_m5_p") %>% 
  relocate(pds_p_ss_female_category_2, .after = "pds_m4_p") %>%
  relocate(pds_p_ss_male_category_2, .after = "pds_p_ss_female_category_2") %>%
  relocate(pds_y_ss_female_category_2, .after = "pds_p_ss_male_category_2") %>%
  relocate(pds_y_ss_male_cat_2, .after = "pds_y_ss_female_category_2") %>%
  relocate(medhx_6m_times, .after = "pds_y_ss_male_cat_2") %>%
  relocate(medhx_6n_notes, .after = "medhx_6m_times") %>%
  relocate(medhx_6p_notes, .after = "medhx_6n_notes")  
which(colnames(PheWAS_baseline) == "birth_weight_oz_comb")

attach(PheWAS_baseline)

#fwrite(PheWAS_baseline, file = "PheWAS_baseline_transformed.csv")
```

#### baseline COMPULSIVE PRS

```{r}
# CONTINUOUS VARIALBES AS OUTCOME
First <- 21 
Last <- 656
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline)[i]
  Warn[i] <- LMEOut$warnings
}

#Store results in a dataframe
Results <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1 <- lmer(reshist_state_immigrant_factor ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_f4_p_mod1 <- lmer(pds_f4_p ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_f4_2_y_mod1 <- lmer(pds_f4_2_y ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m4_y_mod1 <- lmer(pds_m4_y ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m5_y_mod1 <- lmer(pds_m5_y ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m5_p_mod1 <- lmer(pds_m5_p ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m4_p_mod1 <- lmer(pds_m4_p ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_p_ss_female_category_2_mod1 <- lmer(pds_p_ss_female_category_2 ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_p_ss_male_category_2_mod1 <- lmer(pds_p_ss_male_category_2 ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_y_ss_female_category_2_mod1 <- lmer(pds_y_ss_female_category_2 ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_y_ss_male_cat_2_mod1 <- lmer(pds_y_ss_male_cat_2 ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6m_times_mod1 <- lmer(medhx_6m_times ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6n_notes_mod1 <- lmer(medhx_6n_notes ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6p_notes_mod1 <- lmer(medhx_6p_notes ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

which(colnames(PheWAS_baseline) == "medhx_6p_notes")

## merging the results from the above models 
Variable <- colnames(PheWAS_baseline[657:670])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1))[2,1], coef(summary(pds_f4_p_mod1))[2,1], coef(summary(pds_f4_2_y_mod1))[2,1], coef(summary(pds_m4_y_mod1))[2,1], coef(summary(pds_m5_y_mod1))[2,1],  coef(summary(pds_m5_p_mod1))[2,1],coef(summary(pds_m4_p_mod1))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1))[2,1], coef(summary(pds_p_ss_male_category_2_mod1))[2,1], coef(summary(pds_y_ss_female_category_2_mod1))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1))[2,1], coef(summary(medhx_6m_times_mod1))[2,1], coef(summary(medhx_6n_notes_mod1))[2,1], coef(summary(medhx_6p_notes_mod1))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1))[2,2], coef(summary(pds_f4_p_mod1))[2,2], coef(summary(pds_f4_2_y_mod1))[2,2], coef(summary(pds_m4_y_mod1))[2,2], coef(summary(pds_m5_y_mod1))[2,2], coef(summary(pds_m5_p_mod1))[2,2], coef(summary(pds_m4_p_mod1))[2,2], coef(summary(pds_p_ss_female_category_2_mod1))[2,2], coef(summary(pds_p_ss_male_category_2_mod1))[2,2], coef(summary(pds_y_ss_female_category_2_mod1))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1))[2,2], coef(summary(medhx_6m_times_mod1))[2,2], coef(summary(medhx_6n_notes_mod1))[2,2], coef(summary(medhx_6p_notes_mod1))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1))[2,5], coef(summary(pds_f4_p_mod1))[2,5], coef(summary(pds_f4_2_y_mod1))[2,5], coef(summary(pds_m4_y_mod1))[2,5], coef(summary(pds_m5_y_mod1))[2,5],coef(summary(pds_m5_p_mod1))[2,5], coef(summary(pds_m4_p_mod1))[2,5], coef(summary(pds_p_ss_female_category_2_mod1))[2,5], coef(summary(pds_p_ss_male_category_2_mod1))[2,5], coef(summary(pds_y_ss_female_category_2_mod1))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1))[2,5], coef(summary(medhx_6m_times_mod1))[2,5], coef(summary(medhx_6n_notes_mod1))[2,5], coef(summary(medhx_6p_notes_mod1))[2,5])
Resultsb <- cbind(Variable, Beta, STE, Pval)

# merging with the other results
Results_cont <- rbind(Results, Resultsb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 671
Last <- 1291
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline[,i] ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
Results <- rbind(Results_cont, Results_cat)
# 2 tiers of FDR correction
Results$FDR <- p.adjust(Results$Pval, method="fdr")
Results$Bonferroni <- p.adjust(Results$Pval, method = "bonferroni")
#Write out results
fwrite(Results, "Compulsive_results_base_8.4.23.csv")

```

#### baseline Psychotic PRS

```{r}
# CONTINUOUS VARIALBES AS OUTCOME
First <- 21 
Last <- 656
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline)[i]
  Warn[i] <- LMEOut$warnings
}

#Store results in a dataframe
Results2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results2) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod2 <- lmer(reshist_state_immigrant_factor ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_f4_p_mod2 <- lmer(pds_f4_p ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_f4_2_y_mod2 <- lmer(pds_f4_2_y ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m4_y_mod2 <- lmer(pds_m4_y ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m5_y_mod2 <- lmer(pds_m5_y ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m5_p_mod2 <- lmer(pds_m5_p ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m4_p_mod2 <- lmer(pds_m4_p ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_p_ss_female_category_2_mod2 <- lmer(pds_p_ss_female_category_2 ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_p_ss_male_category_2_mod2 <- lmer(pds_p_ss_male_category_2 ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_y_ss_female_category_2_mod2 <- lmer(pds_y_ss_female_category_2 ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_y_ss_male_cat_2_mod2 <- lmer(pds_y_ss_male_cat_2 ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6m_times_mod2 <- lmer(medhx_6m_times ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6n_notes_mod2 <- lmer(medhx_6n_notes ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6p_notes_mod2 <- lmer(medhx_6p_notes ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)
which(colnames(PheWAS_baseline) == "medhx_6p_notes")




## merging the results from the above models 
Variable <- colnames(PheWAS_baseline[657:670])

Beta <- c(coef(summary(reshist_state_immigrant_factor_mod2))[2,1], coef(summary(pds_f4_p_mod2))[2,1], coef(summary(pds_f4_2_y_mod2))[2,1], coef(summary(pds_m4_y_mod2))[2,1],coef(summary(pds_m5_y_mod2))[2,1],  coef(summary(pds_m5_p_mod2))[2,1],coef(summary(pds_m4_p_mod2))[2,1],coef(summary(pds_p_ss_female_category_2_mod2))[2,1], coef(summary(pds_p_ss_male_category_2_mod2))[2,1], coef(summary(pds_y_ss_female_category_2_mod2))[2,1], coef(summary(pds_y_ss_male_cat_2_mod2))[2,1], coef(summary(medhx_6m_times_mod2))[2,1], coef(summary(medhx_6n_notes_mod2))[2,1], coef(summary(medhx_6p_notes_mod2))[2,1])

STE <- c(coef(summary(reshist_state_immigrant_factor_mod2))[2,2], coef(summary(pds_f4_p_mod2))[2,2], coef(summary(pds_f4_2_y_mod2))[2,2], coef(summary(pds_m4_y_mod2))[2,2], coef(summary(pds_m5_y_mod2))[2,2], coef(summary(pds_m5_p_mod2))[2,2], coef(summary(pds_m4_p_mod2))[2,2], coef(summary(pds_p_ss_female_category_2_mod2))[2,2], coef(summary(pds_p_ss_male_category_2_mod2))[2,2], coef(summary(pds_y_ss_female_category_2_mod2))[2,2], coef(summary(pds_y_ss_male_cat_2_mod2))[2,2], coef(summary(medhx_6m_times_mod2))[2,2], coef(summary(medhx_6n_notes_mod2))[2,2], coef(summary(medhx_6p_notes_mod2))[2,2])

Pval <- c(coef(summary(reshist_state_immigrant_factor_mod2))[2,5], coef(summary(pds_f4_p_mod2))[2,5], coef(summary(pds_f4_2_y_mod2))[2,5], coef(summary(pds_m4_y_mod2))[2,5], coef(summary(pds_m5_y_mod2))[2,5],coef(summary(pds_m5_p_mod2))[2,5], coef(summary(pds_m4_p_mod2))[2,5], coef(summary(pds_p_ss_female_category_2_mod2))[2,5], coef(summary(pds_p_ss_male_category_2_mod2))[2,5], coef(summary(pds_y_ss_female_category_2_mod2))[2,5], coef(summary(pds_y_ss_male_cat_2_mod2))[2,5], coef(summary(medhx_6m_times_mod2))[2,5], coef(summary(medhx_6n_notes_mod2))[2,5], coef(summary(medhx_6p_notes_mod2))[2,5])

Results2b <- cbind(Variable, Beta, STE, Pval)

# merging with the other results
Results2_cont <- rbind(Results2, Results2b)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 671
Last <- 1291
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline[,i] ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results2_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results2_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
Results2 <- rbind(Results2_cont, Results2_cat)
# 2 tiers of FDR correction
Results2$FDR <- p.adjust(Results2$Pval, method="fdr")
Results2$Bonferroni <- p.adjust(Results2$Pval, method = "bonferroni")
#Write out results
fwrite(Results2, "Psychotic_results_base_8.11.23.csv")


```

#### baseline Neurodev PRS

```{r}
# CONTINUOUS VARIALBES AS OUTCOME
First <- 21 
Last <- 656
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline)[i]
  Warn[i] <- LMEOut$warnings
}

#Store results in a dataframe
Results3 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results3) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod3 <- lmer(reshist_state_immigrant_factor ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_f4_p_mod3 <- lmer(pds_f4_p ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_f4_2_y_mod3 <- lmer(pds_f4_2_y ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m4_y_mod3 <- lmer(pds_m4_y ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m5_y_mod3 <- lmer(pds_m5_y ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m5_p_mod3 <- lmer(pds_m5_p ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m4_p_mod3 <- lmer(pds_m4_p ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_p_ss_female_category_2_mod3 <- lmer(pds_p_ss_female_category_2 ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_p_ss_male_category_2_mod3 <- lmer(pds_p_ss_male_category_2 ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_y_ss_female_category_2_mod3 <- lmer(pds_y_ss_female_category_2 ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_y_ss_male_cat_2_mod3 <- lmer(pds_y_ss_male_cat_2 ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6m_times_mod3 <- lmer(medhx_6m_times ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6n_notes_mod3 <- lmer(medhx_6n_notes ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6p_notes_mod3 <- lmer(medhx_6p_notes ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)
which(colnames(PheWAS_baseline) == "medhx_6p_notes")




## merging the results from the above models 
Variable <- colnames(PheWAS_baseline[657:670])

Beta <- c(coef(summary(reshist_state_immigrant_factor_mod3))[2,1], coef(summary(pds_f4_p_mod3))[2,1], coef(summary(pds_f4_2_y_mod3))[2,1], coef(summary(pds_m4_y_mod3))[2,1], coef(summary(pds_m5_y_mod3))[2,1], coef(summary(pds_m5_p_mod3))[2,1],coef(summary(pds_m4_p_mod3))[2,1],coef(summary(pds_p_ss_female_category_2_mod3))[2,1], coef(summary(pds_p_ss_male_category_2_mod3))[2,1], coef(summary(pds_y_ss_female_category_2_mod3))[2,1], coef(summary(pds_y_ss_male_cat_2_mod3))[2,1], coef(summary(medhx_6m_times_mod3))[2,1], coef(summary(medhx_6n_notes_mod3))[2,1], coef(summary(medhx_6p_notes_mod3))[2,1])

STE <- c(coef(summary(reshist_state_immigrant_factor_mod3))[2,2], coef(summary(pds_f4_p_mod3))[2,2], coef(summary(pds_f4_2_y_mod3))[2,2], coef(summary(pds_m4_y_mod3))[2,2], coef(summary(pds_m5_y_mod3))[2,2], coef(summary(pds_m5_p_mod3))[2,2], coef(summary(pds_m4_p_mod3))[2,2], coef(summary(pds_p_ss_female_category_2_mod3))[2,2], coef(summary(pds_p_ss_male_category_2_mod3))[2,2], coef(summary(pds_y_ss_female_category_2_mod3))[2,2], coef(summary(pds_y_ss_male_cat_2_mod3))[2,2], coef(summary(medhx_6m_times_mod3))[2,2], coef(summary(medhx_6n_notes_mod3))[2,2], coef(summary(medhx_6p_notes_mod3))[2,2])

Pval <- c(coef(summary(reshist_state_immigrant_factor_mod3))[2,5], coef(summary(pds_f4_p_mod3))[2,5], coef(summary(pds_f4_2_y_mod3))[2,5], coef(summary(pds_m4_y_mod3))[2,5], coef(summary(pds_m5_y_mod3))[2,5],coef(summary(pds_m5_p_mod3))[2,5], coef(summary(pds_m4_p_mod3))[2,5], coef(summary(pds_p_ss_female_category_2_mod3))[2,5], coef(summary(pds_p_ss_male_category_2_mod3))[2,5], coef(summary(pds_y_ss_female_category_2_mod3))[2,5], coef(summary(pds_y_ss_male_cat_2_mod3))[2,5], coef(summary(medhx_6m_times_mod3))[2,5], coef(summary(medhx_6n_notes_mod3))[2,5], coef(summary(medhx_6p_notes_mod3))[2,5])

Results3b <- cbind(Variable, Beta, STE, Pval)

# merging with the other results
Results3_cont <- rbind(Results3, Results3b)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 671
Last <- 1291
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline[,i] ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results3_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results3_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
Results3 <- rbind(Results3_cont, Results3_cat)
# 2 tiers of FDR correction
Results3$FDR <- p.adjust(Results3$Pval, method="fdr")
Results3$Bonferroni <- p.adjust(Results3$Pval, method = "bonferroni")
#Write out results
fwrite(Results3, "Neurodev_results_base_8.11.23.csv")

```

#### baseline Internalizing PRS

```{r}
# CONTINUOUS VARIALBES AS OUTCOME
First <- 21 
Last <- 656
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline)[i]
  Warn[i] <- LMEOut$warnings
}

#Store results in a dataframe
Results4 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results4) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod4 <- lmer(reshist_state_immigrant_factor ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_f4_p_mod4 <- lmer(pds_f4_p ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_f4_2_y_mod4 <- lmer(pds_f4_2_y ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m4_y_mod4 <- lmer(pds_m4_y ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m5_y_mod4 <- lmer(pds_m5_y ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m5_p_mod4 <- lmer(pds_m5_p ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_m4_p_mod4 <- lmer(pds_m4_p ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_p_ss_female_category_2_mod4 <- lmer(pds_p_ss_female_category_2 ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_p_ss_male_category_2_mod4 <- lmer(pds_p_ss_male_category_2 ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_y_ss_female_category_2_mod4 <- lmer(pds_y_ss_female_category_2 ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

pds_y_ss_male_cat_2_mod4 <- lmer(pds_y_ss_male_cat_2 ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6m_times_mod4 <- lmer(medhx_6m_times ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6n_notes_mod4 <- lmer(medhx_6n_notes ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)

medhx_6p_notes_mod4 <- lmer(medhx_6p_notes ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline)
which(colnames(PheWAS_baseline) == "medhx_6p_notes")




## merging the results from the above models 
Variable <- colnames(PheWAS_baseline[657:670])

Beta <- c(coef(summary(reshist_state_immigrant_factor_mod4))[2,1], coef(summary(pds_f4_p_mod4))[2,1], coef(summary(pds_f4_2_y_mod4))[2,1], coef(summary(pds_m4_y_mod4))[2,1], coef(summary(pds_m5_y_mod4))[2,1], coef(summary(pds_m5_p_mod4))[2,1],coef(summary(pds_m4_p_mod4))[2,1],coef(summary(pds_p_ss_female_category_2_mod4))[2,1], coef(summary(pds_p_ss_male_category_2_mod4))[2,1], coef(summary(pds_y_ss_female_category_2_mod4))[2,1], coef(summary(pds_y_ss_male_cat_2_mod4))[2,1], coef(summary(medhx_6m_times_mod4))[2,1], coef(summary(medhx_6n_notes_mod4))[2,1], coef(summary(medhx_6p_notes_mod4))[2,1])

STE <- c(coef(summary(reshist_state_immigrant_factor_mod4))[2,2], coef(summary(pds_f4_p_mod4))[2,2], coef(summary(pds_f4_2_y_mod4))[2,2], coef(summary(pds_m4_y_mod4))[2,2], coef(summary(pds_m5_y_mod4))[2,2], coef(summary(pds_m5_p_mod4))[2,2], coef(summary(pds_m4_p_mod4))[2,2], coef(summary(pds_p_ss_female_category_2_mod4))[2,2], coef(summary(pds_p_ss_male_category_2_mod4))[2,2], coef(summary(pds_y_ss_female_category_2_mod4))[2,2], coef(summary(pds_y_ss_male_cat_2_mod4))[2,2], coef(summary(medhx_6m_times_mod4))[2,2], coef(summary(medhx_6n_notes_mod4))[2,2], coef(summary(medhx_6p_notes_mod4))[2,2])

Pval <- c(coef(summary(reshist_state_immigrant_factor_mod4))[2,5], coef(summary(pds_f4_p_mod4))[2,5], coef(summary(pds_f4_2_y_mod4))[2,5], coef(summary(pds_m4_y_mod4))[2,5], coef(summary(pds_m5_y_mod4))[2,5],coef(summary(pds_m5_p_mod4))[2,5], coef(summary(pds_m4_p_mod4))[2,5], coef(summary(pds_p_ss_female_category_2_mod4))[2,5], coef(summary(pds_p_ss_male_category_2_mod4))[2,5], coef(summary(pds_y_ss_female_category_2_mod4))[2,5], coef(summary(pds_y_ss_male_cat_2_mod4))[2,5], coef(summary(medhx_6m_times_mod4))[2,5], coef(summary(medhx_6n_notes_mod4))[2,5], coef(summary(medhx_6p_notes_mod4))[2,5])

Results4b <- cbind(Variable, Beta, STE, Pval)

# merging with the other results
Results4_cont <- rbind(Results4, Results4b)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 671
Last <- 1291
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline[,i] ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results4_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results4_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
Results4 <- rbind(Results4_cont, Results4_cat)
# 2 tiers of FDR correction
Results4$FDR <- p.adjust(Results4$Pval, method="fdr")
Results4$Bonferroni <- p.adjust(Results4$Pval, method = "bonferroni")
#Write out results
fwrite(Results4, "Internalizing_results_base_8.11.23.csv")

```

#### READING IN FU2 DATA

```{r}
PheWAS_FU <- read_excel("FINAL_PheWAS_FU2_n5556_07.29.23.xlsx")
PheWAS_FU$site_id <- ifelse(PheWAS_FU$site_id == 22, 21, PheWAS_FU$site_id)
PheWAS_FU[PheWAS_FU == "NA"] <- NA
PheWAS_FU[PheWAS_FU == ""] <- NA

which(colnames(PheWAS_FU) == "tlfb_list_l2___1")
PheWAS_FU[,c(1:4,20:21,1250:1718)] <- lapply(PheWAS_FU[,c(1:4,20:21,1250:1718)],as.factor)
PheWAS_FU[,c(5:19,22:1249)] <- lapply(PheWAS_FU[,c(5:19,22:1249)],as.numeric)

descFU <- as.data.frame(psych::describe(PheWAS_FU[,22:1249]))
skewedFU <- descFU[descFU$skew > 1.96 | descFU$skew < -1.96,]
#fwrite(skewedFU, "skewedFU.csv", row.names = T)
skewedFUdf <- PheWAS_FU[colnames(PheWAS_FU) %in% rownames(skewedFU)] 

# winsorizing
skewedFUdf[,1:462] <- lapply(skewedFUdf[,1:462], function(x) Winsorize(x, minval = mean(x, na.rm = T)-3*sd(x, na.rm = T), maxval = mean(x, na.rm = T)+3*sd(x, na.rm = T)))
descskewedFU <- as.data.frame(psych::describe(skewedFUdf[,1:462]))
skewedFU2 <- descskewedFU[descskewedFU$skew > 1.96 | descskewedFU$skew < -1.96,]
#fwrite(skewedFU2, "skewedFU2.csv", row.names = T)
skewedFUdf2 <- skewedFUdf[colnames(skewedFUdf) %in% rownames(skewedFU2)] 
# inverse normal transformation
skewedFUdf2[,1:333] <- lapply(skewedFUdf2[,1:333], function(x) qnorm((rank(x, na.last="keep")-0.5)/sum(!is.na(x))))

PheWAS_FU <- PheWAS_FU[colnames(PheWAS_FU) %nin% rownames(skewedFU)]

PheWAS_FU <- PheWAS_FU %>%
  mutate_if(is.numeric, scale)

skewedFUdf <- skewedFUdf[colnames(skewedFUdf) %nin% colnames(skewedFUdf2)] %>%
  mutate_if(is.numeric, scale)

PheWAS_FU <- cbind(PheWAS_FU[,1:21], skewedFUdf2, skewedFUdf, PheWAS_FU[,22:1256])

PheWAS_FU_reshist <-  PheWAS_FU %>%
  dplyr::select(subjectkey:COVID_visittype, contains("reshist"))
PheWAS_FU_sexvar <- PheWAS_FU %>%
  dplyr::select(subjectkey:COVID_visittype, contains("estradiol"), contains("pds"), contains("menstrual"), contains("gish"))
PheWAS_FU_other <- PheWAS_FU  %>%
  dplyr::select(subjectkey:COVID_visittype, contains("biospec"), contains("fitbit"), prodromal_19b_y, prodromal_21b_y, ksads_sleepprob_raw_818_pTRAN, ksads_sleepprob_raw_818_tTRAN, ple_injur_fu2_p, ple_friend_died_fu2_p)

PheWAS_FU2 <- PheWAS_FU %>%
  dplyr::select(-contains("reshist"), -contains("pds_"), -contains("menstrual"), -contains("gish"), -contains("biospec"), -contains("fitbit"), -filtered_estradiol, -prodromal_19b_y, -prodromal_21b_y, -ksads_sleepprob_raw_818_pTRAN, -ksads_sleepprob_raw_818_tTRAN, -ple_injur_fu2_p, -ple_friend_died_fu2_p)

PheWAS_FU2 <- as.data.frame(PheWAS_FU2)
#fwrite(PheWAS_FU, file = "PheWAS_FU_transformed.csv")
detach(PheWAS_baseline)
```

#### FU COMPULSIVE PRS

```{r}
which(colnames(PheWAS_FU2)=="tlfb_list_l2___1")
attach(PheWAS_FU2)
First <- 22
Last <- 1054
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
ResultsFU <- ResultsFU %>%
  filter(Variable != "kbi_p_c_school_setting_l_home",
         Variable != "kbi_p_c_school_setting_l_public",
         Variable != "kbi_p_c_school_setting_l_private")
detach(PheWAS_FU2)
attach(PheWAS_FU_reshist)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 22
Last <- 118
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1 <- glmer(as.factor(reshist_state_mj_laws_rec) ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)
mj_laws_med_mod1 <- glmer(as.factor(reshist_state_mj_laws_med) ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)
mj_laws_low_mod1 <- glmer(as.factor(reshist_state_mj_laws_low) ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)

Variable <- colnames(PheWAS_FU_reshist[119:121])
Beta <- c(coef(summary(mj_laws_rec_mod1))[2,1], coef(summary(mj_laws_med_mod1))[2,1], coef(summary(mj_laws_low_mod1))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1))[2,2], coef(summary(mj_laws_med_mod1))[2,2], coef(summary(mj_laws_low_mod1))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1))[2,4], coef(summary(mj_laws_med_mod1))[2,4], coef(summary(mj_laws_low_mod1))[2,4])
ResultsFU_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFU_reshist <- rbind(ResultsFU_reshist, ResultsFU_reshistb)


detach(PheWAS_FU_reshist)
attach(PheWAS_FU_sexvar)

PheWAS_FU_sexvar <- PheWAS_FU_sexvar %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric))

# take out sex and covid visit type
First <- 22
Last <- 82
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1 <- glmer(pds_f5_y ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
pds_f5b_p_mod1 <- glmer(pds_f5b_p ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_y_mod1 <- glmer(menstrualcycle3_y ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_p_mod1 <- glmer(menstrualcycle3_p ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)

Variable <- colnames(PheWAS_FU_sexvar[83:86])
Beta <- c(coef(summary(pds_f5_y_mod1))[2,1], coef(summary(pds_f5b_p_mod1))[2,1], coef(summary(menstrualcycle3_y_mod1))[2,1], coef(summary(menstrualcycle3_p_mod1))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1))[2,2], coef(summary(pds_f5b_p_mod1))[2,2], coef(summary(menstrualcycle3_y_mod1))[2,2], coef(summary(menstrualcycle3_p_mod1))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1))[2,4], coef(summary(pds_f5b_p_mod1))[2,4], coef(summary(menstrualcycle3_y_mod1))[2,4], coef(summary(menstrualcycle3_p_mod1))[2,4])
ResultsFU_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFU_sexvar <- rbind(ResultsFU_sexvar, ResultsFU_sexvarb)


detach(PheWAS_FU_sexvar)
attach(PheWAS_FU_other)

# take out sex and covid visit type
First <- 22
Last <- 52
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 53
Last <- 58
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU_other <- rbind(ResultsFU_other, ResultsFU_other2)
detach(PheWAS_FU_other)

which(colnames(PheWAS_FU2) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2 <- PheWAS_FU2 %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2)

# take out sex and covid visit type
First <- 1055
Last <- 1509
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU_comp <- rbind(ResultsFU, ResultsFU_reshist, ResultsFU_sexvar, ResultsFU_other, ResultsFU_cat)
#ResultsFU_comp <- ResultsFU_comp %>%
#  dplyr::filter(Variable!="ksads_bd_raw_162_pTRAN")
ResultsFU_comp$FDR <- p.adjust(ResultsFU_comp$Pval, method = "fdr")
ResultsFU_comp$Bonferroni <- p.adjust(ResultsFU_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFU_comp, "Compulsive_results_FU_8.11.23.txt", sep="\t")


detach(PheWAS_FU2)

```

#### FU Psychotic PRS

```{r}
attach(PheWAS_FU2)
First <- 22
Last <- 1054
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU2) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
ResultsFU2 <- ResultsFU2 %>%
  filter(Variable != "kbi_p_c_school_setting_l_home",
         Variable != "kbi_p_c_school_setting_l_public",
         Variable != "kbi_p_c_school_setting_l_private")
detach(PheWAS_FU2)
attach(PheWAS_FU_reshist)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 22
Last <- 118
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU2_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU2_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod2 <- glmer(as.factor(reshist_state_mj_laws_rec) ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)
mj_laws_med_mod2 <- glmer(as.factor(reshist_state_mj_laws_med) ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)
mj_laws_low_mod2 <- glmer(as.factor(reshist_state_mj_laws_low) ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)

Variable <- colnames(PheWAS_FU_reshist[119:121])
Beta <- c(coef(summary(mj_laws_rec_mod2))[2,1], coef(summary(mj_laws_med_mod2))[2,1], coef(summary(mj_laws_low_mod2))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod2))[2,2], coef(summary(mj_laws_med_mod2))[2,2], coef(summary(mj_laws_low_mod2))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod2))[2,4], coef(summary(mj_laws_med_mod2))[2,4], coef(summary(mj_laws_low_mod2))[2,4])
ResultsFU2_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFU2_reshist <- rbind(ResultsFU2_reshist, ResultsFU2_reshistb)


detach(PheWAS_FU_reshist)
attach(PheWAS_FU_sexvar)

PheWAS_FU_sexvar <- PheWAS_FU_sexvar %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric))

# take out sex and covid visit type
First <- 22
Last <- 82
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU2_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU2_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod2 <- glmer(pds_f5_y ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
pds_f5b_p_mod2 <- glmer(pds_f5b_p ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_y_mod2 <- glmer(menstrualcycle3_y ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_p_mod2 <- glmer(menstrualcycle3_p ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)

Variable <- colnames(PheWAS_FU_sexvar[83:86])
Beta <- c(coef(summary(pds_f5_y_mod2))[2,1], coef(summary(pds_f5b_p_mod2))[2,1], coef(summary(menstrualcycle3_y_mod2))[2,1], coef(summary(menstrualcycle3_p_mod2))[2,1])
STE <- c(coef(summary(pds_f5_y_mod2))[2,2], coef(summary(pds_f5b_p_mod2))[2,2], coef(summary(menstrualcycle3_y_mod2))[2,2], coef(summary(menstrualcycle3_p_mod2))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod2))[2,4], coef(summary(pds_f5b_p_mod2))[2,4], coef(summary(menstrualcycle3_y_mod2))[2,4], coef(summary(menstrualcycle3_p_mod2))[2,4])
ResultsFU2_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFU2_sexvar <- rbind(ResultsFU2_sexvar, ResultsFU2_sexvarb)


detach(PheWAS_FU_sexvar)
attach(PheWAS_FU_other)

# take out sex and covid visit type
First <- 22
Last <- 52
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU2_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU2_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 53
Last <- 58
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU2_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU2_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU2_other <- rbind(ResultsFU2_other, ResultsFU2_other2)
detach(PheWAS_FU_other)

which(colnames(PheWAS_FU2) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2 <- PheWAS_FU2 %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2)

# take out sex and covid visit type
First <- 1055
Last <- 1516
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU2_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU2_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU2_comp <- rbind(ResultsFU2, ResultsFU2_reshist, ResultsFU2_sexvar, ResultsFU2_other, ResultsFU2_cat)
#ResultsFU2_comp <- ResultsFU2_comp %>%
#  dplyr::filter(Variable!="ksads_bd_raw_162_pTRAN")
ResultsFU2_comp$FDR <- p.adjust(ResultsFU2_comp$Pval, method = "fdr")
ResultsFU2_comp$Bonferroni <- p.adjust(ResultsFU2_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFU2_comp, "Psychotic_results_FU_8.27.23.txt", sep="\t")

#Write out results

detach(PheWAS_FU2)

```

#### FU Neurodev PRS

```{r}
which(colnames(PheWAS_FU2)=="tlfb_list_l2___1")
attach(PheWAS_FU2)
First <- 22
Last <- 1054
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
ResultsFU3 <- ResultsFU3 %>%
  filter(Variable != "kbi_p_c_school_setting_l_home",
         Variable != "kbi_p_c_school_setting_l_public",
         Variable != "kbi_p_c_school_setting_l_private")
detach(PheWAS_FU2)
attach(PheWAS_FU_reshist)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 22
Last <- 118
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod3 <- glmer(as.factor(reshist_state_mj_laws_rec) ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)
mj_laws_med_mod3 <- glmer(as.factor(reshist_state_mj_laws_med) ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)
mj_laws_low_mod3 <- glmer(as.factor(reshist_state_mj_laws_low) ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)

Variable <- colnames(PheWAS_FU_reshist[119:121])
Beta <- c(coef(summary(mj_laws_rec_mod3))[2,1], coef(summary(mj_laws_med_mod3))[2,1], coef(summary(mj_laws_low_mod3))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod3))[2,2], coef(summary(mj_laws_med_mod3))[2,2], coef(summary(mj_laws_low_mod3))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod3))[2,4], coef(summary(mj_laws_med_mod3))[2,4], coef(summary(mj_laws_low_mod3))[2,4])
ResultsFU3_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFU3_reshist <- rbind(ResultsFU3_reshist, ResultsFU3_reshistb)


detach(PheWAS_FU_reshist)
attach(PheWAS_FU_sexvar)

PheWAS_FU_sexvar <- PheWAS_FU_sexvar %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric))

# take out sex and covid visit type
First <- 22
Last <- 82
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod3 <- glmer(pds_f5_y ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
pds_f5b_p_mod3 <- glmer(pds_f5b_p ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_y_mod3 <- glmer(menstrualcycle3_y ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_p_mod3 <- glmer(menstrualcycle3_p ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)

Variable <- colnames(PheWAS_FU_sexvar[83:86])
Beta <- c(coef(summary(pds_f5_y_mod3))[2,1], coef(summary(pds_f5b_p_mod3))[2,1], coef(summary(menstrualcycle3_y_mod3))[2,1], coef(summary(menstrualcycle3_p_mod3))[2,1])
STE <- c(coef(summary(pds_f5_y_mod3))[2,2], coef(summary(pds_f5b_p_mod3))[2,2], coef(summary(menstrualcycle3_y_mod3))[2,2], coef(summary(menstrualcycle3_p_mod3))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod3))[2,4], coef(summary(pds_f5b_p_mod3))[2,4], coef(summary(menstrualcycle3_y_mod3))[2,4], coef(summary(menstrualcycle3_p_mod3))[2,4])
ResultsFU3_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFU3_sexvar <- rbind(ResultsFU3_sexvar, ResultsFU3_sexvarb)


detach(PheWAS_FU_sexvar)
attach(PheWAS_FU_other)

# take out sex and covid visit type
First <- 22
Last <- 52
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 53
Last <- 58
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU3_other <- rbind(ResultsFU3_other, ResultsFU3_other2)
detach(PheWAS_FU_other)

which(colnames(PheWAS_FU2) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2 <- PheWAS_FU2 %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2)

# take out sex and covid visit type
First <- 1055
Last <- 1516
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU3_comp <- rbind(ResultsFU3, ResultsFU3_reshist, ResultsFU3_sexvar, ResultsFU3_other, ResultsFU3_cat)
ResultsFU3_comp <- ResultsFU3_comp %>%
  dplyr::filter(Variable!="ksads_bd_raw_162_pTRAN")
ResultsFU3_comp$FDR <- p.adjust(ResultsFU3_comp$Pval, method = "fdr")
ResultsFU3_comp$Bonferroni <- p.adjust(ResultsFU3_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFU3_comp, "Neurodev_results_FU_8.27.23.txt", sep="\t")
detach(PheWAS_FU2)

#ResultsFU3_comp <- fread("Neurodev_results_FU_8.27.23.txt", sep = "\t")

```

#### FU Internalizing PRS

```{r}
which(colnames(PheWAS_FU2)=="tlfb_list_l2___1")
attach(PheWAS_FU2)
First <- 22
Last <- 1054
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
ResultsFU4 <- ResultsFU4 %>%
  filter(Variable != "kbi_p_c_school_setting_l_home",
         Variable != "kbi_p_c_school_setting_l_public",
         Variable != "kbi_p_c_school_setting_l_private")
detach(PheWAS_FU2)
attach(PheWAS_FU_reshist)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 22
Last <- 118
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod4 <- glmer(as.factor(reshist_state_mj_laws_rec) ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)
mj_laws_med_mod4 <- glmer(as.factor(reshist_state_mj_laws_med) ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)
mj_laws_low_mod4 <- glmer(as.factor(reshist_state_mj_laws_low) ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist)

Variable <- colnames(PheWAS_FU_reshist[119:121])
Beta <- c(coef(summary(mj_laws_rec_mod4))[2,1], coef(summary(mj_laws_med_mod4))[2,1], coef(summary(mj_laws_low_mod4))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod4))[2,2], coef(summary(mj_laws_med_mod4))[2,2], coef(summary(mj_laws_low_mod4))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod4))[2,4], coef(summary(mj_laws_med_mod4))[2,4], coef(summary(mj_laws_low_mod4))[2,4])
ResultsFU4_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFU4_reshist <- rbind(ResultsFU4_reshist, ResultsFU4_reshistb)


detach(PheWAS_FU_reshist)
attach(PheWAS_FU_sexvar)

PheWAS_FU_sexvar <- PheWAS_FU_sexvar %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric))

# take out sex and covid visit type
First <- 22
Last <- 82
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod4 <- glmer(pds_f5_y ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
pds_f5b_p_mod4 <- glmer(pds_f5b_p ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_y_mod4 <- glmer(menstrualcycle3_y ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_p_mod4 <- glmer(menstrualcycle3_p ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)

Variable <- colnames(PheWAS_FU_sexvar[83:86])
Beta <- c(coef(summary(pds_f5_y_mod4))[2,1], coef(summary(pds_f5b_p_mod4))[2,1], coef(summary(menstrualcycle3_y_mod4))[2,1], coef(summary(menstrualcycle3_p_mod4))[2,1])
STE <- c(coef(summary(pds_f5_y_mod4))[2,2], coef(summary(pds_f5b_p_mod4))[2,2], coef(summary(menstrualcycle3_y_mod4))[2,2], coef(summary(menstrualcycle3_p_mod4))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod4))[2,4], coef(summary(pds_f5b_p_mod4))[2,4], coef(summary(menstrualcycle3_y_mod4))[2,4], coef(summary(menstrualcycle3_p_mod4))[2,4])
ResultsFU4_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFU4_sexvar <- rbind(ResultsFU4_sexvar, ResultsFU4_sexvarb)


detach(PheWAS_FU_sexvar)
attach(PheWAS_FU_other)

# take out sex and covid visit type
First <- 22
Last <- 52
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 53
Last <- 58
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU4_other <- rbind(ResultsFU4_other, ResultsFU4_other2)
detach(PheWAS_FU_other)

which(colnames(PheWAS_FU2) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2 <- PheWAS_FU2 %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2)

# take out sex and covid visit type
First <- 1055
Last <- 1516
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU4_comp <- rbind(ResultsFU4, ResultsFU4_reshist, ResultsFU4_sexvar, ResultsFU4_other, ResultsFU4_cat)
ResultsFU4_comp <- ResultsFU4_comp %>%
  dplyr::filter(Variable!="ksads_bd_raw_162_pTRAN")
ResultsFU4_comp$FDR <- p.adjust(ResultsFU4_comp$Pval, method = "fdr")
ResultsFU4_comp$Bonferroni <- p.adjust(ResultsFU4_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFU4_comp, "Internalizing_results_FU_8.27.23.txt", sep="\t")
detach(PheWAS_FU2)

```

#### IMAGING ANALYSES

```{r}
MRI <- read_excel("~/Documents/Paperpreparation/Nicole_PheWAS_GSEM/abcd30_baseline_allMRIvariables_forphewas.xlsx")
MRI<- merge(PheWAS_FU2[,1:20], MRI, by = "subjectkey")

MRIcovs <- MRI %>%
  dplyr::select(1:20, mri_info_manufacturer_COV, rsfmri_c_ngd_meanmotion_COV, dmri_dti_meanmotion_COV, dmri_dtifa_fiberat_allfibers, smri_vol_cdk_total, smri_area_cdk_total, smri_thick_cdk_mean, smri_vol_scs_subcorticalgv)

MRIglobal <- MRI %>%
  dplyr::select(1:20, mri_info_manufacturer_COV, dmri_dti_meanmotion_COV, smri_vol_scs_intracranialv, smri_vol_cdk_total, smri_area_cdk_total, smri_thick_cdk_mean, smri_vol_scs_subcorticalgv, smri_vol_scs_wholeb, smri_vol_scs_suprateialv, smri_vol_scs_cbwmatterlh, smri_vol_scs_cbwmatterrh, smri_vol_cdk_totallh, smri_vol_cdk_totalrh, smri_thick_cdk_meanlh, smri_thick_cdk_meanrh, smri_area_cdk_totallh, smri_area_cdk_totalrh, dmri_dtifa_fiberat_allfibers, dmri_dtimd_fiberat_allfibers)

MRIcortvol <- MRI %>%
  dplyr::select(1:20, mri_info_manufacturer_COV, smri_vol_cdk_total, contains("smri_vol_cdk")) %>%
  dplyr::select(-smri_vol_cdk_totallh, -smri_vol_cdk_totalrh)

MRIsubcortvol <- MRI %>%
  dplyr::select(1:20, mri_info_manufacturer_COV, smri_vol_scs_subcorticalgv, contains("smri_vol_scs")) %>%
  dplyr::select(-smri_vol_scs_intracranialv, -smri_vol_scs_wholeb, -smri_vol_scs_suprateialv, -smri_vol_scs_cbwmatterlh, -smri_vol_scs_cbwmatterrh, -contains("wmhint"))

MRIcortarea <- MRI %>%
  dplyr::select(1:20, mri_info_manufacturer_COV, smri_area_cdk_total, contains("smri_area_cdk")) %>%
  dplyr::select(-smri_area_cdk_totallh, -smri_area_cdk_totalrh)

MRIcortthick <- MRI %>%
  dplyr::select(1:20, mri_info_manufacturer_COV, smri_thick_cdk_mean, contains("smri_thick_cdk")) %>%
  dplyr::select(-smri_thick_cdk_meanlh, -smri_thick_cdk_meanrh)

MRIdtifa <- MRI %>%
  dplyr::select(1:20, mri_info_manufacturer_COV, dmri_dti_meanmotion_COV, dmri_dtifa_fiberat_allfibers, contains("dmri_dtifa")) %>%
  dplyr::select(-c(61:80))

MRIdtimd <- MRI %>%
  dplyr::select(1:20, mri_info_manufacturer_COV, dmri_dti_meanmotion_COV, dmri_dtifa_fiberat_allfibers, contains("dmri_dtimd")) %>%
  dplyr::select(-c(61:65))

MRIrsfc <- MRI %>%
  dplyr::select(1:20, mri_info_manufacturer_COV, rsfmri_c_ngd_meanmotion_COV, contains("rsfmri")) %>%
  dplyr::select(-rsfmri_c_ngd_ca_ngd_ad, -rsfmri_c_ngd_cgc_ngd_ad, -rsfmri_c_ngd_cgc_ngd_ca, -rsfmri_c_ngd_dla_ngd_ad, -rsfmri_c_ngd_dla_ngd_ca, -rsfmri_c_ngd_dla_ngd_cgc, -rsfmri_c_ngd_dt_ngd_ad, -rsfmri_c_ngd_dt_ngd_ca, -rsfmri_c_ngd_dt_ngd_cgc, -rsfmri_c_ngd_dt_ngd_dla, -rsfmri_c_ngd_fo_ngd_ad, -rsfmri_c_ngd_fo_ngd_ca, -rsfmri_c_ngd_fo_ngd_cgc, -rsfmri_c_ngd_fo_ngd_dla, -rsfmri_c_ngd_fo_ngd_dt, -rsfmri_c_ngd_n_ngd_ad, -rsfmri_c_ngd_n_ngd_ca, -rsfmri_c_ngd_n_ngd_cgc, -rsfmri_c_ngd_n_ngd_dla, -rsfmri_c_ngd_n_ngd_dt, -rsfmri_c_ngd_n_ngd_fo, -rsfmri_c_ngd_rspltp_ngd_ad, -rsfmri_c_ngd_rspltp_ngd_ca, -rsfmri_c_ngd_rspltp_ngd_cgc, -rsfmri_c_ngd_rspltp_ngd_dla, -rsfmri_c_ngd_rspltp_ngd_dt, -rsfmri_c_ngd_rspltp_ngd_fo, -rsfmri_c_ngd_rspltp_ngd_n, -rsfmri_c_ngd_sa_ngd_ad, -rsfmri_c_ngd_sa_ngd_ca, -rsfmri_c_ngd_sa_ngd_cgc, -rsfmri_c_ngd_sa_ngd_dla, -rsfmri_c_ngd_sa_ngd_dt, -rsfmri_c_ngd_sa_ngd_fo, -rsfmri_c_ngd_sa_ngd_n, -rsfmri_c_ngd_sa_ngd_rspltp, -rsfmri_c_ngd_smh_ngd_ad, -rsfmri_c_ngd_smh_ngd_ca, -rsfmri_c_ngd_smh_ngd_cgc, -rsfmri_c_ngd_smh_ngd_dla, -rsfmri_c_ngd_smh_ngd_dt, -rsfmri_c_ngd_smh_ngd_fo, -rsfmri_c_ngd_smh_ngd_n, -rsfmri_c_ngd_smh_ngd_rspltp, -rsfmri_c_ngd_smh_ngd_sa, -rsfmri_c_ngd_smm_ngd_ad, -rsfmri_c_ngd_smm_ngd_ca, -rsfmri_c_ngd_smm_ngd_cgc, -rsfmri_c_ngd_smm_ngd_dla, -rsfmri_c_ngd_smm_ngd_dt, -rsfmri_c_ngd_smm_ngd_fo, -rsfmri_c_ngd_smm_ngd_n, -rsfmri_c_ngd_smm_ngd_rspltp, -rsfmri_c_ngd_smm_ngd_sa, -rsfmri_c_ngd_smm_ngd_smh, -rsfmri_c_ngd_vs_ngd_ad, -rsfmri_c_ngd_vs_ngd_ca, -rsfmri_c_ngd_vs_ngd_cgc, -rsfmri_c_ngd_vs_ngd_dla, -rsfmri_c_ngd_vs_ngd_dt, -rsfmri_c_ngd_vs_ngd_fo, -rsfmri_c_ngd_vs_ngd_n, -rsfmri_c_ngd_vs_ngd_rspltp, -rsfmri_c_ngd_vs_ngd_sa, -rsfmri_c_ngd_vs_ngd_smh, -rsfmri_c_ngd_vs_ngd_smm, -rsfmri_c_ngd_vta_ngd_ad, -rsfmri_c_ngd_vta_ngd_ca, -rsfmri_c_ngd_vta_ngd_cgc, -rsfmri_c_ngd_vta_ngd_dla, -rsfmri_c_ngd_vta_ngd_dt, -rsfmri_c_ngd_vta_ngd_fo, -rsfmri_c_ngd_vta_ngd_n, -rsfmri_c_ngd_vta_ngd_rspltp, -rsfmri_c_ngd_vta_ngd_sa, -rsfmri_c_ngd_vta_ngd_smh, -rsfmri_c_ngd_vta_ngd_smm, -rsfmri_c_ngd_vta_ngd_vs)
```

#### Global imaging analyses

```{r}
MRIglobal[, c(1:4, 20:21)] <- lapply(MRIglobal[,c(1:4, 20:21)], as.factor)
MRIglobal[, c(5:19, 22:39)] <- lapply(MRIglobal[,c(5:19, 22:39)], as.numeric)

MRIglobal <- MRIglobal %>%
  mutate_if(is.numeric, scale)

MRIglobal[MRIglobal == "NA"] <- NA

attach(MRIglobal)

## Compulsive PRS
First <- 22
#********CHANGE********Number of the last column you want to run. 
Last <- 36
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIglobal[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIglobal)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Comp_global <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Comp_global) <- c("Variable", "Beta", "STE", "Pval")

global_FA_mod1 <- lmer(dmri_dtifa_fiberat_allfibers ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + (1|site_id) + (1|rel_family_id))
global_MD_mod1 <- lmer(dmri_dtimd_fiberat_allfibers ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + (1|site_id) + (1|rel_family_id))

Variable <- c("dmri_dtifa_fiberat_allfibers", "dmri_dtimd_fiberat_allfibers")
Beta <- c(coef(summary(global_FA_mod1))[2,1], coef(summary(global_MD_mod1))[2,1])
STE <- c(coef(summary(global_FA_mod1))[2,2], coef(summary(global_MD_mod1))[2,2])
Pval <- c(coef(summary(global_FA_mod1))[2,5], coef(summary(global_MD_mod1))[2,5])

Results_Comp_global_DTI <- cbind(Variable, Beta, STE, Pval)
Results_Comp_global <- rbind(Results_Comp_global[,1:4], Results_Comp_global_DTI)
Results_Comp_global$FDR <- p.adjust(Results_Comp_global$Pval, method = "fdr")
Results_Comp_global$Bonferroni <- p.adjust(Results_Comp_global$Pval, method = "bonferroni")
fwrite(Results_Comp_global, file = "Results_Compulsive_GlobalMRI_10.28.22.txt", sep = "\t")

## Psychotic PRS
First <- 22
#********CHANGE********Number of the last column you want to run. 
Last <- 36
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIglobal[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIglobal)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Psych_global <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Psych_global) <- c("Variable", "Beta", "STE", "Pval")

global_FA_mod2 <- lmer(dmri_dtifa_fiberat_allfibers ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + (1|site_id) + (1|rel_family_id))
global_MD_mod2 <- lmer(dmri_dtimd_fiberat_allfibers ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + (1|site_id) + (1|rel_family_id))

Variable <- c("dmri_dtifa_fiberat_allfibers", "dmri_dtimd_fiberat_allfibers")
Beta <- c(coef(summary(global_FA_mod2))[2,1], coef(summary(global_MD_mod2))[2,1])
STE <- c(coef(summary(global_FA_mod2))[2,2], coef(summary(global_MD_mod2))[2,2])
Pval <- c(coef(summary(global_FA_mod2))[2,5], coef(summary(global_MD_mod2))[2,5])

Results_Psych_global_DTI <- cbind(Variable, Beta, STE, Pval)
Results_Psych_global <- rbind(Results_Psych_global[,1:4], Results_Psych_global_DTI)
Results_Psych_global$FDR <- p.adjust(Results_Psych_global$Pval, method = "fdr")
Results_Psych_global$Bonferroni <- p.adjust(Results_Psych_global$Pval, method = "bonferroni")
fwrite(Results_Psych_global, file = "Results_Psychotic_GlobalMRI_10.28.22.txt", sep = "\t")

## Neurodev PRS
First <- 22
#********CHANGE********Number of the last column you want to run. 
Last <- 36
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIglobal[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIglobal)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neuro_global <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neuro_global) <- c("Variable", "Beta", "STE", "Pval")

global_FA_mod3 <- lmer(dmri_dtifa_fiberat_allfibers ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + (1|site_id) + (1|rel_family_id))
global_MD_mod3 <- lmer(dmri_dtimd_fiberat_allfibers ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + (1|site_id) + (1|rel_family_id))

Variable <- c("dmri_dtifa_fiberat_allfibers", "dmri_dtimd_fiberat_allfibers")
Beta <- c(coef(summary(global_FA_mod3))[2,1], coef(summary(global_MD_mod3))[2,1])
STE <- c(coef(summary(global_FA_mod3))[2,2], coef(summary(global_MD_mod3))[2,2])
Pval <- c(coef(summary(global_FA_mod3))[2,5], coef(summary(global_MD_mod3))[2,5])

Results_Neuro_global_DTI <- cbind(Variable, Beta, STE, Pval)
Results_Neuro_global <- rbind(Results_Neuro_global[,1:4], Results_Neuro_global_DTI)
Results_Neuro_global$FDR <- p.adjust(Results_Neuro_global$Pval, method = "fdr")
Results_Neuro_global$Bonferroni <- p.adjust(Results_Neuro_global$Pval, method = "bonferroni")
fwrite(Results_Neuro_global, file = "Results_Neurodev_GlobalMRI_10.28.22.txt", sep = "\t")

## Internalizing PRS
First <- 22
#********CHANGE********Number of the last column you want to run. 
Last <- 36
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIglobal[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIglobal)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Internal_global <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Internal_global) <- c("Variable", "Beta", "STE", "Pval")

global_FA_mod4 <- lmer(dmri_dtifa_fiberat_allfibers ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + (1|site_id) + (1|rel_family_id))
global_MD_mod4 <- lmer(dmri_dtimd_fiberat_allfibers ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + (1|site_id) + (1|rel_family_id))

Variable <- c("dmri_dtifa_fiberat_allfibers", "dmri_dtimd_fiberat_allfibers")
Beta <- c(coef(summary(global_FA_mod4))[2,1], coef(summary(global_MD_mod4))[2,1])
STE <- c(coef(summary(global_FA_mod4))[2,2], coef(summary(global_MD_mod4))[2,2])
Pval <- c(coef(summary(global_FA_mod4))[2,5], coef(summary(global_MD_mod4))[2,5])

Results_Internal_global_DTI <- cbind(Variable, Beta, STE, Pval)
Results_Internal_global <- rbind(Results_Internal_global[,1:4], Results_Internal_global_DTI)
Results_Internal_global$FDR <- p.adjust(Results_Internal_global$Pval, method = "fdr")
Results_Internal_global$Bonferroni <- p.adjust(Results_Internal_global$Pval, method = "bonferroni")
fwrite(Results_Internal_global, file = "Results_Internalizing_GlobalMRI_10.28.22.txt", sep = "\t")
```

#### Cortical Volume Imaging Analyses

```{r}
MRIcortvol[, c(1:4, 20:21)] <- lapply(MRIcortvol[,c(1:4, 20:21)], as.factor)
MRIcortvol[, c(5:19, 22:90)] <- lapply(MRIcortvol[,c(5:19, 22:90)], as.numeric)

MRIcortvol <- MRIcortvol %>%
  mutate_if(is.numeric, scale)

MRIcortvol[MRIcortvol == "NA"] <- NA

attach(MRIcortvol)

## Compulsive PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortvol[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_vol_cdk_total + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortvol)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Comp_CortVol <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Comp_CortVol) <- c("Variable", "Beta", "STE", "Pval")
Results_Comp_CortVol$FDR <- p.adjust(Results_Comp_CortVol$Pval, method = "fdr")
Results_Comp_CortVol$Bonferroni <- p.adjust(Results_Comp_CortVol$Pval, method = "bonferroni")
fwrite(Results_Comp_CortVol, file = "Results_Compulsive_CorticalVolMRI_10.28.22.txt", sep = "\t")


## Psychotic PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortvol[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_vol_cdk_total + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortvol)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Psych_CortVol <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Psych_CortVol) <- c("Variable", "Beta", "STE", "Pval")
Results_Psych_CortVol$FDR <- p.adjust(Results_Psych_CortVol$Pval, method = "fdr")
Results_Psych_CortVol$Bonferroni <- p.adjust(Results_Psych_CortVol$Pval, method = "bonferroni")
fwrite(Results_Psych_CortVol, file = "Results_Psychotic_CorticalVolMRI_10.28.22.txt", sep = "\t")


## Neurodev PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortvol[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_vol_cdk_total + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortvol)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neuro_CortVol <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neuro_CortVol) <- c("Variable", "Beta", "STE", "Pval")
Results_Neuro_CortVol$FDR <- p.adjust(Results_Neuro_CortVol$Pval, method = "fdr")
Results_Neuro_CortVol$Bonferroni <- p.adjust(Results_Neuro_CortVol$Pval, method = "bonferroni")
fwrite(Results_Neuro_CortVol, file = "Results_Neurodev_CorticalVolMRI_10.28.22.txt", sep = "\t")


## Internalizing PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortvol[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_vol_cdk_total + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortvol)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Internal_CortVol <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Internal_CortVol) <- c("Variable", "Beta", "STE", "Pval")
Results_Internal_CortVol$FDR <- p.adjust(Results_Internal_CortVol$Pval, method = "fdr")
Results_Internal_CortVol$Bonferroni <- p.adjust(Results_Internal_CortVol$Pval, method = "bonferroni")
fwrite(Results_Internal_CortVol, file = "Results_Internalizing_CorticalVolMRI_10.28.22.txt", sep = "\t")

detach(MRIcortvol)
```

#### Cortical Area Imaging Analyses

```{r}
MRIcortarea[, c(1:4, 20:21)] <- lapply(MRIcortarea[,c(1:4, 20:21)], as.factor)
MRIcortarea[, c(5:19, 22:90)] <- lapply(MRIcortarea[,c(5:19, 22:90)], as.numeric)

MRIcortarea <- MRIcortarea %>%
  mutate_if(is.numeric, scale)

MRIcortarea[MRIcortarea == "NA"] <- NA

attach(MRIcortarea)

## Compulsive PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortarea[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_area_cdk_total + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortarea)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Comp_Cortarea <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Comp_Cortarea) <- c("Variable", "Beta", "STE", "Pval")
Results_Comp_Cortarea$FDR <- p.adjust(Results_Comp_Cortarea$Pval, method = "fdr")
Results_Comp_Cortarea$Bonferroni <- p.adjust(Results_Comp_Cortarea$Pval, method = "bonferroni")
fwrite(Results_Comp_Cortarea, file = "Results_Compulsive_CorticalareaMRI_10.28.22.txt", sep = "\t")


## Psychotic PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortarea[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_area_cdk_total + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortarea)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Psych_Cortarea <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Psych_Cortarea) <- c("Variable", "Beta", "STE", "Pval")
Results_Psych_Cortarea$FDR <- p.adjust(Results_Psych_Cortarea$Pval, method = "fdr")
Results_Psych_Cortarea$Bonferroni <- p.adjust(Results_Psych_Cortarea$Pval, method = "bonferroni")
fwrite(Results_Psych_Cortarea, file = "Results_Psychotic_CorticalareaMRI_10.28.22.txt", sep = "\t")


## Neurodev PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortarea[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_area_cdk_total + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortarea)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neuro_Cortarea <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neuro_Cortarea) <- c("Variable", "Beta", "STE", "Pval")
Results_Neuro_Cortarea$FDR <- p.adjust(Results_Neuro_Cortarea$Pval, method = "fdr")
Results_Neuro_Cortarea$Bonferroni <- p.adjust(Results_Neuro_Cortarea$Pval, method = "bonferroni")
fwrite(Results_Neuro_Cortarea, file = "Results_Neurodev_CorticalareaMRI_10.28.22.txt", sep = "\t")


## Internalizing PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortarea[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_area_cdk_total + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortarea)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Internal_Cortarea <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Internal_Cortarea) <- c("Variable", "Beta", "STE", "Pval")
Results_Internal_Cortarea$FDR <- p.adjust(Results_Internal_Cortarea$Pval, method = "fdr")
Results_Internal_Cortarea$Bonferroni <- p.adjust(Results_Internal_Cortarea$Pval, method = "bonferroni")
fwrite(Results_Internal_Cortarea, file = "Results_Internalizing_CorticalareaMRI_10.28.22.txt", sep = "\t")

detach(MRIcortarea)
```

#### Cortical Thickness Imaging Analyses

```{r}
MRIcortthick[, c(1:4, 20:21)] <- lapply(MRIcortthick[,c(1:4, 20:21)], as.factor)
MRIcortthick[, c(5:19, 22:90)] <- lapply(MRIcortthick[,c(5:19, 22:90)], as.numeric)

MRIcortthick <- MRIcortthick %>%
  mutate_if(is.numeric, scale)

MRIcortthick[MRIcortthick == "NA"] <- NA

attach(MRIcortthick)

## Compulsive PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortthick[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_thick_cdk_mean + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortthick)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Comp_Cortthick <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Comp_Cortthick) <- c("Variable", "Beta", "STE", "Pval")
Results_Comp_Cortthick$FDR <- p.adjust(Results_Comp_Cortthick$Pval, method = "fdr")
Results_Comp_Cortthick$Bonferroni <- p.adjust(Results_Comp_Cortthick$Pval, method = "bonferroni")
fwrite(Results_Comp_Cortthick, file = "Results_Compulsive_CorticalthickMRI_10.28.22.txt", sep = "\t")


## Psychotic PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortthick[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_thick_cdk_mean + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortthick)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Psych_Cortthick <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Psych_Cortthick) <- c("Variable", "Beta", "STE", "Pval")
Results_Psych_Cortthick$FDR <- p.adjust(Results_Psych_Cortthick$Pval, method = "fdr")
Results_Psych_Cortthick$Bonferroni <- p.adjust(Results_Psych_Cortthick$Pval, method = "bonferroni")
fwrite(Results_Psych_Cortthick, file = "Results_Psychotic_CorticalthickMRI_10.28.22.txt", sep = "\t")


## Neurodev PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortthick[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_thick_cdk_mean + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortthick)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neuro_Cortthick <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neuro_Cortthick) <- c("Variable", "Beta", "STE", "Pval")
Results_Neuro_Cortthick$FDR <- p.adjust(Results_Neuro_Cortthick$Pval, method = "fdr")
Results_Neuro_Cortthick$Bonferroni <- p.adjust(Results_Neuro_Cortthick$Pval, method = "bonferroni")
fwrite(Results_Neuro_Cortthick, file = "Results_Neurodev_CorticalthickMRI_10.28.22.txt", sep = "\t")


## Internalizing PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 90
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIcortthick[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_thick_cdk_mean + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIcortthick)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Internal_Cortthick <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Internal_Cortthick) <- c("Variable", "Beta", "STE", "Pval")
Results_Internal_Cortthick$FDR <- p.adjust(Results_Internal_Cortthick$Pval, method = "fdr")
Results_Internal_Cortthick$Bonferroni <- p.adjust(Results_Internal_Cortthick$Pval, method = "bonferroni")
fwrite(Results_Internal_Cortthick, file = "Results_Internalizing_CorticalthickMRI_10.28.22.txt", sep = "\t")

detach(MRIcortthick)
```

#### Subcortical Volume Imaging Analyses

```{r}
MRIsubcortvol[, c(1:4, 20:21)] <- lapply(MRIsubcortvol[,c(1:4, 20:21)], as.factor)
MRIsubcortvol[, c(5:19, 22:57)] <- lapply(MRIsubcortvol[,c(5:19, 22:57)], as.numeric)

MRIsubcortvol <- MRIsubcortvol %>%
  mutate_if(is.numeric, scale)

MRIsubcortvol[MRIsubcortvol == "NA"] <- NA

attach(MRIsubcortvol)

## Compulsive PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 57
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIsubcortvol[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_vol_scs_subcorticalgv + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIsubcortvol)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Comp_subcortVol <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Comp_subcortVol) <- c("Variable", "Beta", "STE", "Pval")
Results_Comp_subcortVol$FDR <- p.adjust(Results_Comp_subcortVol$Pval, method = "fdr")
Results_Comp_subcortVol$Bonferroni <- p.adjust(Results_Comp_subcortVol$Pval, method = "bonferroni")
fwrite(Results_Comp_subcortVol, file = "Results_Compulsive_subcorticalVolMRI_10.28.22.txt", sep = "\t")


## Psychotic PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 57
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIsubcortvol[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_vol_scs_subcorticalgv + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIsubcortvol)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Psych_subcortVol <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Psych_subcortVol) <- c("Variable", "Beta", "STE", "Pval")
Results_Psych_subcortVol$FDR <- p.adjust(Results_Psych_subcortVol$Pval, method = "fdr")
Results_Psych_subcortVol$Bonferroni <- p.adjust(Results_Psych_subcortVol$Pval, method = "bonferroni")
fwrite(Results_Psych_subcortVol, file = "Results_Psychotic_subcorticalVolMRI_10.28.22.txt", sep = "\t")


## Neurodev PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 57
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIsubcortvol[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_vol_scs_subcorticalgv + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIsubcortvol)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neuro_subcortVol <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neuro_subcortVol) <- c("Variable", "Beta", "STE", "Pval")
Results_Neuro_subcortVol$FDR <- p.adjust(Results_Neuro_subcortVol$Pval, method = "fdr")
Results_Neuro_subcortVol$Bonferroni <- p.adjust(Results_Neuro_subcortVol$Pval, method = "bonferroni")
fwrite(Results_Neuro_subcortVol, file = "Results_Neurodev_subcorticalVolMRI_10.28.22.txt", sep = "\t")


## Internalizing PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 57
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIsubcortvol[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + smri_vol_scs_subcorticalgv + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIsubcortvol)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Internal_subcortVol <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Internal_subcortVol) <- c("Variable", "Beta", "STE", "Pval")
Results_Internal_subcortVol$FDR <- p.adjust(Results_Internal_subcortVol$Pval, method = "fdr")
Results_Internal_subcortVol$Bonferroni <- p.adjust(Results_Internal_subcortVol$Pval, method = "bonferroni")
fwrite(Results_Internal_subcortVol, file = "Results_Internalizing_subcorticalVolMRI_10.28.22.txt", sep = "\t")

detach(MRIsubcortvol)

```

#### RSFC Imaging Analyses

```{r}
MRIrsfc[, c(1:4, 20:21)] <- lapply(MRIrsfc[,c(1:4, 20:21)], as.factor)
MRIrsfc[, c(5:19, 22:113)] <- lapply(MRIrsfc[,c(5:19, 22:113)], as.numeric)

MRIrsfc <- MRIrsfc %>%
  mutate_if(is.numeric, scale)

MRIrsfc[MRIrsfc == "NA"] <- NA

attach(MRIrsfc)

## Compulsive PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 113
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIrsfc[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + rsfmri_c_ngd_meanmotion_COV + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIrsfc)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Comp_rsfc <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Comp_rsfc) <- c("Variable", "Beta", "STE", "Pval")
Results_Comp_rsfc$FDR <- p.adjust(Results_Comp_rsfc$Pval, method = "fdr")
Results_Comp_rsfc$Bonferroni <- p.adjust(Results_Comp_rsfc$Pval, method = "bonferroni")
fwrite(Results_Comp_rsfc, file = "Results_Compulsive_MRIrsfc_11.6.22.txt", sep = "\t")


## Psychotic PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 113
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIrsfc[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + rsfmri_c_ngd_meanmotion_COV + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIrsfc)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Psych_rsfc <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Psych_rsfc) <- c("Variable", "Beta", "STE", "Pval")
Results_Psych_rsfc$FDR <- p.adjust(Results_Psych_rsfc$Pval, method = "fdr")
Results_Psych_rsfc$Bonferroni <- p.adjust(Results_Psych_rsfc$Pval, method = "bonferroni")
fwrite(Results_Psych_rsfc, file = "Results_Psychotic_MRIrsfc_11.6.22.txt", sep = "\t")


## Neurodev PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 113
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIrsfc[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + rsfmri_c_ngd_meanmotion_COV + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIrsfc)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neuro_rsfc <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neuro_rsfc) <- c("Variable", "Beta", "STE", "Pval")
Results_Neuro_rsfc$FDR <- p.adjust(Results_Neuro_rsfc$Pval, method = "fdr")
Results_Neuro_rsfc$Bonferroni <- p.adjust(Results_Neuro_rsfc$Pval, method = "bonferroni")
fwrite(Results_Neuro_rsfc, file = "Results_Neurodev_MRIrsfc_11.6.22.txt", sep = "\t")


## Internalizing PRS
First <- 23
#********CHANGE********Number of the last column you want to run. 
Last <- 113
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIrsfc[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + rsfmri_c_ngd_meanmotion_COV + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIrsfc)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Internal_rsfc <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Internal_rsfc) <- c("Variable", "Beta", "STE", "Pval")
Results_Internal_rsfc$FDR <- p.adjust(Results_Internal_rsfc$Pval, method = "fdr")
Results_Internal_rsfc$Bonferroni <- p.adjust(Results_Internal_rsfc$Pval, method = "bonferroni")
fwrite(Results_Internal_rsfc, file = "Results_Internalizing_MRIrsfc_11.6.22.txt", sep = "\t")

detach(MRIrsfc)

```

#### FA Imaging Analyses

```{r}
MRIdtifa[, c(1:4, 20:21)] <- lapply(MRIdtifa[,c(1:4, 20:21)], as.factor)
MRIdtifa[, c(5:19, 22:60)] <- lapply(MRIdtifa[,c(5:19, 22:60)], as.numeric)

MRIdtifa <- MRIdtifa %>%
  mutate_if(is.numeric, scale)

MRIdtifa[MRIdtifa == "NA"] <- NA

attach(MRIdtifa)

## Compulsive PRS
First <- 24
#********CHANGE********Number of the last column you want to run. 
Last <- 60
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIdtifa[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + dmri_dtifa_fiberat_allfibers + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIdtifa)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Comp_dtifa <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Comp_dtifa) <- c("Variable", "Beta", "STE", "Pval")
Results_Comp_dtifa$FDR <- p.adjust(Results_Comp_dtifa$Pval, method = "fdr")
Results_Comp_dtifa$Bonferroni <- p.adjust(Results_Comp_dtifa$Pval, method = "bonferroni")
fwrite(Results_Comp_dtifa, file = "Results_Compulsive_MRIdtifa_10.28.22.txt", sep = "\t")


## Psychotic PRS
First <- 24
#********CHANGE********Number of the last column you want to run. 
Last <- 60
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIdtifa[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + dmri_dtifa_fiberat_allfibers + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIdtifa)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Psych_dtifa <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Psych_dtifa) <- c("Variable", "Beta", "STE", "Pval")
Results_Psych_dtifa$FDR <- p.adjust(Results_Psych_dtifa$Pval, method = "fdr")
Results_Psych_dtifa$Bonferroni <- p.adjust(Results_Psych_dtifa$Pval, method = "bonferroni")
fwrite(Results_Psych_dtifa, file = "Results_Psychotic_MRIdtifa_10.28.22.txt", sep = "\t")


## Neurodev PRS
First <- 24
#********CHANGE********Number of the last column you want to run. 
Last <- 60
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIdtifa[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + dmri_dtifa_fiberat_allfibers + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIdtifa)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neuro_dtifa <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neuro_dtifa) <- c("Variable", "Beta", "STE", "Pval")
Results_Neuro_dtifa$FDR <- p.adjust(Results_Neuro_dtifa$Pval, method = "fdr")
Results_Neuro_dtifa$Bonferroni <- p.adjust(Results_Neuro_dtifa$Pval, method = "bonferroni")
fwrite(Results_Neuro_dtifa, file = "Results_Neurodev_MRIdtifa_10.28.22.txt", sep = "\t")


## Internalizing PRS
First <- 24
#********CHANGE********Number of the last column you want to run. 
Last <- 60
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIdtifa[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + dmri_dtifa_fiberat_allfibers + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIdtifa)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Internal_dtifa <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Internal_dtifa) <- c("Variable", "Beta", "STE", "Pval")
Results_Internal_dtifa$FDR <- p.adjust(Results_Internal_dtifa$Pval, method = "fdr")
Results_Internal_dtifa$Bonferroni <- p.adjust(Results_Internal_dtifa$Pval, method = "bonferroni")
fwrite(Results_Internal_dtifa, file = "Results_Internalizing_MRIdtifa_10.28.22.txt", sep = "\t")

detach(MRIdtifa)

```

#### MD Imaging Analyses

```{r}
MRIdtimd[, c(1:4, 20:21)] <- lapply(MRIdtimd[,c(1:4, 20:21)], as.factor)
MRIdtimd[, c(5:19, 22:60)] <- lapply(MRIdtimd[,c(5:19, 22:60)], as.numeric)

MRIdtimd <- MRIdtimd %>%
  mutate_if(is.numeric, scale)

MRIdtimd[MRIdtimd == "NA"] <- NA

attach(MRIdtimd)

## Compulsive PRS
First <- 24
#********CHANGE********Number of the last column you want to run. 
Last <- 60
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIdtimd[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + dmri_dtifa_fiberat_allfibers + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIdtimd)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Comp_dtimd <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Comp_dtimd) <- c("Variable", "Beta", "STE", "Pval")
Results_Comp_dtimd$FDR <- p.adjust(Results_Comp_dtimd$Pval, method = "fdr")
Results_Comp_dtimd$Bonferroni <- p.adjust(Results_Comp_dtimd$Pval, method = "bonferroni")
fwrite(Results_Comp_dtimd, file = "Results_Compulsive_MRIdtimd_10.28.22.txt", sep = "\t")


## Psychotic PRS
First <- 24
#********CHANGE********Number of the last column you want to run. 
Last <- 60
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIdtimd[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + dmri_dtifa_fiberat_allfibers + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIdtimd)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Psych_dtimd <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Psych_dtimd) <- c("Variable", "Beta", "STE", "Pval")
Results_Psych_dtimd$FDR <- p.adjust(Results_Psych_dtimd$Pval, method = "fdr")
Results_Psych_dtimd$Bonferroni <- p.adjust(Results_Psych_dtimd$Pval, method = "bonferroni")
fwrite(Results_Psych_dtimd, file = "Results_Psychotic_MRIdtimd_10.28.22.txt", sep = "\t")


## Neurodev PRS
First <- 24
#********CHANGE********Number of the last column you want to run. 
Last <- 60
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIdtimd[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + dmri_dtifa_fiberat_allfibers + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIdtimd)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neuro_dtimd <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neuro_dtimd) <- c("Variable", "Beta", "STE", "Pval")
Results_Neuro_dtimd$FDR <- p.adjust(Results_Neuro_dtimd$Pval, method = "fdr")
Results_Neuro_dtimd$Bonferroni <- p.adjust(Results_Neuro_dtimd$Pval, method = "bonferroni")
fwrite(Results_Neuro_dtimd, file = "Results_Neurodev_MRIdtimd_10.28.22.txt", sep = "\t")


## Internalizing PRS
First <- 24
#********CHANGE********Number of the last column you want to run. 
Last <- 60
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  #******CHANGE*******add your covariates, build your LMER
  LMEOut <- withWarnings( a <- lmer(MRIdtimd[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + dmri_dtifa_fiberat_allfibers + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(MRIdtimd)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Internal_dtimd <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Internal_dtimd) <- c("Variable", "Beta", "STE", "Pval")
Results_Internal_dtimd$FDR <- p.adjust(Results_Internal_dtimd$Pval, method = "fdr")
Results_Internal_dtimd$Bonferroni <- p.adjust(Results_Internal_dtimd$Pval, method = "bonferroni")
fwrite(Results_Internal_dtimd, file = "Results_Internalizing_MRIdtimd_10.28.22.txt", sep = "\t")

detach(MRIdtimd)

```

#### baseline Plots

##### Compulsive PRS

```{r}
Results <- read.csv("Compulsive_results_base_8.4.23.csv")
Results2 <- read.csv("Psychotic_results_base_8.11.23.csv")
Results3 <- read.csv("Neurodev_results_base_8.11.23.csv")
Results4 <- read.csv("Internalizing_results_base_8.11.23.csv")

mycols <- c("darkorange1", "lightseagreen", "orchid3", "lightskyblue", "goldenrod1",  "seagreen", "pink2", "deepskyblue4")
mycols_darker <- c("darkorange1", "lightseagreen", "orchid4", "steelblue3", "goldenrod3",  "seagreen", "palevioletred", "deepskyblue4")


Results_Substance <- Results %>%
  filter(grepl('tlfb|path|isip|su_|caff|rules_|peer_dev', Variable)) %>%
  filter(!grepl('devhx|caff_24|caff_ago', Variable)) %>%
  arrange(Variable)
Results_Substance$Category <- rep("Substance", 46)

Results_CE <- Results %>%
  filter(grepl('crpbi|fes|prosocial|school|reshist|monitor|neighborhood|enviro|pmq|psb_|nsc_|srpf', Variable)) %>%
  filter(!grepl('profess|kbi', Variable)) %>%
  arrange(Variable)
Results_CE$Category <- rep("Culture/Environment", 113)

Results_MH_y <- Results %>%
  filter(grepl('ksad|cbcl|prodrom|pps_|upps|bisbas|bis_|resiliency|kbi|gen_child|pgbi|bpm|ADHD', Variable)) %>%
  filter(!grepl('monitor|parent_rules|prosocial|fes_youth|asr_|famhx|fam_hist', Variable)) %>%
  arrange(Variable)
Results_MH_y$Category <- rep("Child Mental Health", 639)

Results_MH_p <- Results %>%
  filter(grepl('asr_|famhx|fam_hist|q1|q2|q4|q5|q6|q9', Variable)) %>%
  filter(!grepl('cbcl|ksads|bpm|parent_mon|parent_rul|fes_|prosocial', Variable)) %>%
  arrange(Variable)
Results_MH_p$Category <- rep("Family Mental Health", 239)

Results_PH <- Results %>%
  filter(grepl('medhx|devhx|tbi|pds|puber|sports|sai_|filtered_|anthro|child_|antidep_|sds_|sleep|weight|SSRI|antidep|hormon_sal|medicat|physical|caff_24|caff_ago', Variable)) %>%
  filter(!grepl('demo|gen_child', Variable)) %>%
  arrange(Variable)
Results_PH$Category <- rep("Physical Health", 175)

Results_NP <- Results %>%
  filter(grepl('nihtbx|RAVLT|cash|lmt|wisc', Variable)) %>%
  arrange(Variable)
Results_NP$Category <- rep("Cognition", 14)

Results_Screen <- Results %>%
  filter(grepl('screen|stq', Variable)) %>%
  arrange(Variable)
Results_Screen$Category <- rep("Screen Time", 18)

Results_Demo <- Results %>%
  filter(grepl('demo|prtnr_wor|prnt_wor', Variable)) %>%
  arrange(Variable)
Results_Demo$Category <- rep("Demographics", 27)

# binding them in this order
Results_Compulsive <- rbind(Results_NP, Results_Screen, Results_Demo, Results_Substance, Results_CE, Results_PH, Results_MH_p, Results_MH_y)
Results_Compulsive$Variable <- factor(Results_Compulsive$Variable, levels = (Results_Compulsive$Variable))
Results_Compulsive$Category <- factor(Results_Compulsive$Category, levels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))

Results_Compulsive$neg_log_p <- -log10(as.numeric(Results_Compulsive$Pval))
Results_Compulsive$direction <- as.factor(ifelse(Results_Compulsive$Beta > 0, 1, 0))

Results_Compulsive <- Results_Compulsive %>%
  mutate(xpos = c(seq(1,14,1), seq(24, 41, 1), seq(51,77,1), seq(87,132,1), seq(142,198,.5), seq(208,295,.5), seq(305,424, .5), seq(434,753,.5)),
         xpos2 = c(seq(1,14,1), seq(26, 43, 1), seq(55,81,1), seq(91,136,1), seq(146,258,1), seq(268,442,1),
                   seq(452,690,1), seq(700,1338))) %>%
  mutate(catlab = ifelse(xpos == 2, "Cognition",
                         ifelse(xpos == 26, "Screen Time",
                                ifelse(xpos == 59, "Demographics",
                                       ifelse(xpos == 110, "Substance",
                                              ifelse(xpos == 172, "Culture/\nEnvironment",
                                                     ifelse(xpos == 260, "Physical\nHealth",
                                                            ifelse(xpos == 370, "Family\nMental Health",
                                                                   ifelse(xpos == 600, "Child\nMental Health", "")))))))),
         catlab2 = ifelse(xpos2 == 1, "Cognition",
                         ifelse(xpos2 == 37, "Screen Time",
                                ifelse(xpos2 == 70, "Demographics",
                                       ifelse(xpos2 == 115, "Substance",
                                              ifelse(xpos2 == 214, "Culture/\nEnvironment",
                                                     ifelse(xpos2 == 357, "Physical\nHealth",
                                                            ifelse(xpos2 == 563, "Family\nMental Health",
                                                                   ifelse(xpos2 == 1014, "Child\nMental Health", "")))))))))

Results_Compulsive <- Results_Compulsive %>%
  mutate(xlabs = ifelse(Category == "Cognition", "darkorange1",
                 ifelse(Category == "Screen Time", "lightseagreen",
                        ifelse(Category == "Demographics", "orchid3",
                               ifelse(Category == "Substance", "lightskyblue",
                                      ifelse(Category == "Culture/Environment", "goldenrod1", 
                                             ifelse(Category == "Physical Health", "seagreen",
                                                    ifelse(Category == "Family Mental Health", "pink2",
                                                           ifelse(Category == "Child Mental Health", "deepskyblue4", "")))))))))


Compulsive_Plot_Finala <- ggplot(Results_Compulsive, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(FDR < 0.05, as.character(Variable), "")), 
                  aes(label=label), size=3, box.padding = unit(0.4, "lines")) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Compulsive Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(.5, 755.5), expand = c(.01, .01), labels = Results_Compulsive$catlab, breaks = Results_Compulsive$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results_Compulsive$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Compulsive_Plot_Finala, file = "Compulsive_Plot_Finala2.png", height = 4, width = 5)

Compulsive_Plot_Finalb <- ggplot(Results_Compulsive, aes(x=xpos2, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(FDR < 0.05, as.character(Variable), "")), 
                  aes(label=label), size=3, box.padding = unit(0.4, "lines")) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Compulsive Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(1,1338), expand = c(.01, .01), labels = Results_Compulsive$catlab2, breaks = Results_Compulsive$xpos2) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results_Compulsive$xlabs, family = "Arial"), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold", family = "Arial"),
        plot.subtitle = element_text(size = 10, hjust = .5, family = "Arial"),
        legend.title = element_blank(),
        legend.text = element_text(size = 8, family = "Arial"),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Compulsive_Plot_Finalb, file = "Compulsive_Plot_Finalb2.png", height = 4, width = 6)
```

##### Psychotic PRS

```{r}
Results2_Substance <- Results2 %>%
  filter(grepl('tlfb|path|isip|su_|caff|rules_|peer_dev', Variable)) %>%
  filter(!grepl('devhx|caff_24|caff_ago', Variable)) %>%
  arrange(Variable)
Results2_Substance$Category <- rep("Substance", 46)

Results2_CE <- Results2 %>%
  filter(grepl('crpbi|fes|prosocial|school|reshist|monitor|neighborhood|enviro|pmq|psb_|nsc_|srpf', Variable)) %>%
  filter(!grepl('profess|kbi', Variable)) %>%
  arrange(Variable)
Results2_CE$Category <- rep("Culture/Environment", 113)

Results2_MH_y <- Results2 %>%
  filter(grepl('ksad|cbcl|prodrom|pps_|upps|bisbas|bis_|resiliency|kbi|gen_child|pgbi|bpm|ADHD', Variable)) %>%
  filter(!grepl('monitor|parent_rules|prosocial|fes_youth|asr_|famhx|fam_hist', Variable)) %>%
  arrange(Variable)
Results2_MH_y$Category <- rep("Child Mental Health", 639)

Results2_MH_p <- Results2 %>%
  filter(grepl('asr_|famhx|fam_hist|q1|q2|q4|q5|q6|q9', Variable)) %>%
  filter(!grepl('cbcl|ksads|bpm|parent_mon|parent_rul|fes_|prosocial', Variable)) %>%
  arrange(Variable)
Results2_MH_p$Category <- rep("Family Mental Health", 239)

Results2_PH <- Results2 %>%
  filter(grepl('medhx|devhx|tbi|pds|puber|sports|sai_|filtered_|anthro|child_|antidep_|sds_|sleep|weight|SSRI|antidep|hormon_sal|medicat|physical|caff_24|caff_ago', Variable)) %>%
  filter(!grepl('demo|gen_child', Variable)) %>%
  arrange(Variable)
Results2_PH$Category <- rep("Physical Health", 175)

Results2_NP <- Results2 %>%
  filter(grepl('nihtbx|RAVLT|cash|lmt|wisc', Variable)) %>%
  arrange(Variable)
Results2_NP$Category <- rep("Cognition", 14)

Results2_Screen <- Results2 %>%
  filter(grepl('screen|stq', Variable)) %>%
  arrange(Variable)
Results2_Screen$Category <- rep("Screen Time", 18)

Results2_Demo <- Results2 %>%
  filter(grepl('demo|prtnr_wor|prnt_wor', Variable)) %>%
  arrange(Variable)
Results2_Demo$Category <- rep("Demographics", 27)

# binding them in this order
Results2_Psychotic <- rbind(Results2_NP, Results2_Screen, Results2_Demo, Results2_Substance, Results2_CE, Results2_PH, Results2_MH_p, Results2_MH_y)
Results2_Psychotic$Variable <- factor(Results2_Psychotic$Variable, levels = (Results2_Psychotic$Variable))
Results2_Psychotic$Category <- factor(Results2_Psychotic$Category, levels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))

Results2_Psychotic$neg_log_p <- -log10(as.numeric(Results2_Psychotic$Pval))
Results2_Psychotic$direction <- as.factor(ifelse(Results2_Psychotic$Beta > 0, 1, 0))


Results2_Psychotic <- Results2_Psychotic %>%
  mutate(xpos = c(seq(1,14,1), seq(24, 41, 1), seq(51,77,1), seq(87,132,1), seq(142,198,.5), seq(208,295,.5), seq(305,424, .5), seq(434,753,.5)),
         xpos2 = c(seq(1,14,1), seq(26, 43, 1), seq(55,81,1), seq(91,136,1), seq(146,258,1), seq(268,442,1),
                   seq(452,690,1), seq(700,1338))) %>%
  mutate(catlab = ifelse(xpos == 2, "Cognition",
                         ifelse(xpos == 26, "Screen Time",
                                ifelse(xpos == 59, "Demographics",
                                       ifelse(xpos == 110, "Substance",
                                              ifelse(xpos == 172, "Culture/\nEnvironment",
                                                     ifelse(xpos == 260, "Physical\nHealth",
                                                            ifelse(xpos == 370, "Family\nMental Health",
                                                                   ifelse(xpos == 600, "Child\nMental Health", "")))))))),
         catlab2 = ifelse(xpos2 == 1, "Cognition",
                         ifelse(xpos2 == 37, "Screen Time",
                                ifelse(xpos2 == 70, "Demographics",
                                       ifelse(xpos2 == 115, "Substance",
                                              ifelse(xpos2 == 214, "Culture/\nEnvironment",
                                                     ifelse(xpos2 == 357, "Physical\nHealth",
                                                            ifelse(xpos2 == 563, "Family\nMental Health",
                                                                   ifelse(xpos2 == 1014, "Child\nMental Health", "")))))))))


Results2_Psychotic <- Results2_Psychotic %>%
  mutate(xlabs = ifelse(Category == "Cognition", "darkorange1",
                 ifelse(Category == "Screen Time", "lightseagreen",
                        ifelse(Category == "Demographics", "orchid3",
                               ifelse(Category == "Substance", "lightskyblue",
                                      ifelse(Category == "Culture/Environment", "goldenrod1", 
                                             ifelse(Category == "Physical Health", "seagreen",
                                                    ifelse(Category == "Family Mental Health", "pink2",
                                                           ifelse(Category == "Child Mental Health", "deepskyblue4", "")))))))))


Psychotic_Plot_Finala <- ggplot(Results2_Psychotic, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(FDR < 0.05, as.character(Variable), "")), 
                  aes(label=label), size=3, box.padding = unit(0.4, "lines")) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Psychotic Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(.5, 755.5), expand = c(.01, .01), labels = Results2_Psychotic$catlab, breaks = Results2_Psychotic$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results2_Psychotic$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Psychotic_Plot_Finala, file = "Psychotic_Plot_Finala2.png", height = 4, width = 5)

Psychotic_Plot_Finalb <- ggplot(Results2_Psychotic, aes(x=xpos2, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(FDR < 0.05, as.character(Variable), "")), 
                  aes(label=label), size=3, box.padding = unit(0.4, "lines")) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Psychotic Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(1, 1338), expand = c(.01, .01), labels = Results2_Psychotic$catlab2, breaks = Results2_Psychotic$xpos2) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results2_Psychotic$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Psychotic_Plot_Finalb, file = "Psychotic_Plot_Finalb2.png", height = 4, width = 6)
```

##### Neurodev PRS

```{r}
Results3 <- read.csv("Neurodev_results_base_8.11.23_R2.csv")

Results3_Substance <- Results3 %>%
  filter(grepl('tlfb|path|isip|su_|caff|rules_|peer_dev', Variable)) %>%
  filter(!grepl('devhx|caff_24|caff_ago', Variable)) %>%
  arrange(Variable)
Results3_Substance$Category <- rep("Substance", 46)

Results3_CE <- Results3 %>%
  filter(grepl('crpbi|fes|prosocial|school|reshist|monitor|neighborhood|enviro|pmq|psb_|nsc_|srpf', Variable)) %>%
  filter(!grepl('profess|kbi', Variable)) %>%
  arrange(Variable)
Results3_CE$Category <- rep("Culture/Environment", 113)

Results3_MH_y <- Results3 %>%
  filter(grepl('ksad|cbcl|prodrom|pps_|upps|bisbas|bis_|resiliency|kbi|gen_child|pgbi|bpm|ADHD', Variable)) %>%
  filter(!grepl('monitor|parent_rules|prosocial|fes_youth|asr_|famhx|fam_hist', Variable)) %>%
  arrange(Variable)
Results3_MH_y$Category <- rep("Child Mental Health", 639)

Results3_MH_p <- Results3 %>%
  filter(grepl('asr_|famhx|fam_hist|q1|q2|q4|q5|q6|q9', Variable)) %>%
  filter(!grepl('cbcl|ksads|bpm|parent_mon|parent_rul|fes_|prosocial', Variable)) %>%
  arrange(Variable)
Results3_MH_p$Category <- rep("Family Mental Health", 239)

Results3_PH <- Results3 %>%
  filter(grepl('medhx|devhx|tbi|pds|puber|sports|sai_|filtered_|anthro|child_|antidep_|sds_|sleep|weight|SSRI|antidep|hormon_sal|medicat|physical|caff_24|caff_ago', Variable)) %>%
  filter(!grepl('demo|gen_child', Variable)) %>%
  arrange(Variable)
Results3_PH$Category <- rep("Physical Health", 175)

Results3_NP <- Results3 %>%
  filter(grepl('nihtbx|RAVLT|cash|lmt|wisc', Variable)) %>%
  arrange(Variable)
Results3_NP$Category <- rep("Cognition", 14)

Results3_Screen <- Results3 %>%
  filter(grepl('screen|stq', Variable)) %>%
  arrange(Variable)
Results3_Screen$Category <- rep("Screen Time", 18)

Results3_Demo <- Results3 %>%
  filter(grepl('demo|prtnr_wor|prnt_wor', Variable)) %>%
  arrange(Variable)
Results3_Demo$Category <- rep("Demographics", 27)




# binding them in this order
Results3_Neurodev <- rbind(Results3_NP, Results3_Screen, Results3_Demo, Results3_Substance, Results3_CE, Results3_PH, Results3_MH_p, Results3_MH_y)
Results3_Neurodev$Variable <- factor(Results3_Neurodev$Variable, levels = (Results3_Neurodev$Variable))
Results3_Neurodev$Category <- factor(Results3_Neurodev$Category, levels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))

Results3_Neurodev_Rename <- Results3_Neurodev
Results3_Neurodev_Rename$Variable <- as.character(Results3_Neurodev_Rename$Variable)
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_scr_dsm5_adhd_r", "Variable"] <- "CBCL-ADHD"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_scr_syn_attention_r", "Variable"] <- "CBCL-Attention"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_q78_p", "Variable"] <- "CBCL-78-Inattentive"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_scr_syn_totprob_r", "Variable"] <- "CBCL-Total-Problems"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "ksads_14_425_p", "Variable"] <- "KSADS-P-ADHD-425"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_scr_syn_rulebreak_r", "Variable"] <- "CBCL-Rulebreak"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_scr_syn_external_r", "Variable"] <- "CBCL-External"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "ksads_14_411_p", "Variable"] <- "KSADS-P-ADHD-411"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "ksads_14_413_p", "Variable"] <- "KSADS-P-ADHD-413"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_q41_p", "Variable"] <- "CBCL-41-Impulsive"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "ksads_14_412_p", "Variable"] <- "KSADS-P-ADHD-412"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "ksads_14_415_p", "Variable"] <- "KSADS-P-ADHD-415"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_scr_dsm5_conduct_r", "Variable"] <- "CBCL-Conduct"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "stq_y_ss_weekend", "Variable"] <- "Wknd-Screentime"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "stq_y_ss_weekday", "Variable"] <- "Wkdy-Screentime"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_scr_syn_aggressive_r", "Variable"] <- "CBCL-Aggressive"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_q08_p", "Variable"] <- "CBCL-8-Concentrate"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "ksads_14_416_p", "Variable"] <- "KSADS-P-ADHD-416"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "ksads_14_417_p", "Variable"] <- "KSADS-P-ADHD-417"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_q28_p", "Variable"] <- "CBCL-28-Breaks-Rules"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "ksads_14_79_p", "Variable"] <- "KSADS-P-ADHD-79"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "ksads_14_78_p", "Variable"] <- "KSADS-P-ADHD-78"
Results3_Neurodev_Rename[Results3_Neurodev_Rename$Variable == "cbcl_scr_dsm5_opposit_r", "Variable"] <- "CBCL-Oppositional"

Results3_Neurodev_Rename$Variable <- factor(Results3_Neurodev_Rename$Variable, levels = Results3_Neurodev_Rename$Variable)

Results3_Neurodev_Rename$neg_log_p <- -log10(as.numeric(Results3_Neurodev_Rename$Pval))
Results3_Neurodev_Rename$direction <- as.factor(ifelse(Results3_Neurodev_Rename$Beta > 0, 1, 0))

Results3_Neurodev_Rename <- Results3_Neurodev_Rename %>%
  mutate(xpos = c(seq(1,14,1), seq(24, 41, 1), seq(51,77,1), seq(87,132,1), seq(142,198,.5), seq(208,295,.5), seq(305,424, .5), seq(434,753,.5)),
         xpos2 = c(seq(1,14,1), seq(26, 43, 1), seq(55,81,1), seq(91,136,1), seq(146,258,1), seq(268,442,1),
                   seq(452,690,1), seq(700,1338))) %>%
  mutate(catlab = ifelse(xpos == 2, "Cognition",
                         ifelse(xpos == 26, "Screen Time",
                                ifelse(xpos == 59, "Demographics",
                                       ifelse(xpos == 110, "Substance",
                                              ifelse(xpos == 172, "Culture/\nEnvironment",
                                                     ifelse(xpos == 260, "Physical\nHealth",
                                                            ifelse(xpos == 370, "Family\nMental Health",
                                                                   ifelse(xpos == 600, "Child\nMental Health", "")))))))),
         catlab2 = ifelse(xpos2 == 1, "Cognition",
                         ifelse(xpos2 == 37, "Screen Time",
                                ifelse(xpos2 == 70, "Demographics",
                                       ifelse(xpos2 == 115, "Substance",
                                              ifelse(xpos2 == 214, "Culture/\nEnvironment",
                                                     ifelse(xpos2 == 357, "Physical\nHealth",
                                                            ifelse(xpos2 == 563, "Family\nMental Health",
                                                                   ifelse(xpos2 == 1014, "Child\nMental Health", "")))))))))


Results3_Neurodev_Rename <- Results3_Neurodev_Rename %>%
  mutate(xlabs = ifelse(Category == "Cognition", "darkorange1",
                 ifelse(Category == "Screen Time", "lightseagreen",
                        ifelse(Category == "Demographics", "orchid3",
                               ifelse(Category == "Substance", "lightskyblue",
                                      ifelse(Category == "Culture/Environment", "goldenrod1", 
                                             ifelse(Category == "Physical Health", "seagreen",
                                                    ifelse(Category == "Family Mental Health", "pink2",
                                                           ifelse(Category == "Child Mental Health", "deepskyblue4", "")))))))))

options(ggrepel.max.overlaps = Inf)

Neurodev_Plot_Finala <- ggplot(Results3_Neurodev_Rename, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-14, as.character(Variable), "")), 
                  aes(label=label, color = Category), size=1.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Neurodevelopmental Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(.5, 755.3), expand = c(.01, .01), labels = Results3_Neurodev_Rename$catlab, breaks = Results3_Neurodev_Rename$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results3_Neurodev_Rename$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Neurodev_Plot_Finala, file = "Neurodev_Plot_Finala2.png", height = 4, width = 5)

Neurodev_Plot_Finalb <- ggplot(Results3_Neurodev_Rename, aes(x=xpos2, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 1.5e-12, as.character(Variable), "")), 
                  aes(label=label, color = Category), size=1.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Neurodevelopmental Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(1, 1338), expand = c(.01, .01), labels = Results3_Neurodev_Rename$catlab2, breaks = Results3_Neurodev_Rename$xpos2) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results3_Neurodev_Rename$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Neurodev_Plot_Finalb, file = "Neurodev_Plot_Finalb2.png", height = 4, width = 6)

Neurodev_Plot_Finalc <- ggplot(Results3_Neurodev_Rename, aes(x=xpos2, y=neg_log_p,  text=paste("R2 Threshold: ", R2_Threshold))) +  
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 1e-12, as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Neurodevelopmental Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(1, 1338), expand = c(.01, .01), labels = Results3_Neurodev_Rename$catlab2, breaks = Results3_Neurodev_Rename$xpos2) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 7.1, colour = Results3_Neurodev_Rename$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Neurodev_Plot_Finalc, file = "Neurodev_Plot_Finalc2.png", height = 4, width = 6)


Neurodev_Plot_Finalposter <- ggplot(Results3_Neurodev_Rename, aes(x=xpos2, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 1e-12, as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Neurodevelopmental Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(1, 1338), expand = c(.01, .01)) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Neurodev_Plot_Finalposter, file = "Neurodev_Plot_Finalposter.png", height = 4, width = 6)
```

##### Internalizing PRS

```{r}
Results4_Substance <- Results4 %>%
  filter(grepl('tlfb|path|isip|su_|caff|rules_|peer_dev', Variable)) %>%
  filter(!grepl('devhx|caff_24|caff_ago', Variable)) %>%
  arrange(Variable)
Results4_Substance$Category <- rep("Substance", 46)

Results4_CE <- Results4 %>%
  filter(grepl('crpbi|fes|prosocial|school|reshist|monitor|neighborhood|enviro|pmq|psb_|nsc_|srpf', Variable)) %>%
  filter(!grepl('profess|kbi', Variable)) %>%
  arrange(Variable)
Results4_CE$Category <- rep("Culture/Environment", 113)

Results4_MH_y <- Results4 %>%
  filter(grepl('ksad|cbcl|prodrom|pps_|upps|bisbas|bis_|resiliency|kbi|gen_child|pgbi|bpm|ADHD', Variable)) %>%
  filter(!grepl('monitor|parent_rules|prosocial|fes_youth|asr_|famhx|fam_hist', Variable)) %>%
  arrange(Variable)
Results4_MH_y$Category <- rep("Child Mental Health", 639)

Results4_MH_p <- Results4 %>%
  filter(grepl('asr_|famhx|fam_hist|q1|q2|q4|q5|q6|q9', Variable)) %>%
  filter(!grepl('cbcl|ksads|bpm|parent_mon|parent_rul|fes_|prosocial', Variable)) %>%
  arrange(Variable)
Results4_MH_p$Category <- rep("Family Mental Health", 239)

Results4_PH <- Results4 %>%
  filter(grepl('medhx|devhx|tbi|pds|puber|sports|sai_|filtered_|anthro|child_|antidep_|sds_|sleep|weight|SSRI|antidep|hormon_sal|medicat|physical|caff_24|caff_ago', Variable)) %>%
  filter(!grepl('demo|gen_child', Variable)) %>%
  arrange(Variable)
Results4_PH$Category <- rep("Physical Health", 175)

Results4_NP <- Results4 %>%
  filter(grepl('nihtbx|RAVLT|cash|lmt|wisc', Variable)) %>%
  arrange(Variable)
Results4_NP$Category <- rep("Cognition", 14)

Results4_Screen <- Results4 %>%
  filter(grepl('screen|stq', Variable)) %>%
  arrange(Variable)
Results4_Screen$Category <- rep("Screen Time", 18)

Results4_Demo <- Results4 %>%
  filter(grepl('demo|prtnr_wor|prnt_wor', Variable)) %>%
  arrange(Variable)
Results4_Demo$Category <- rep("Demographics", 27)

# binding them in this order
Results4_Internal <- rbind(Results4_NP, Results4_Screen, Results4_Demo, Results4_Substance, Results4_CE, Results4_PH, Results4_MH_p, Results4_MH_y)
Results4_Internal$Variable <- factor(Results4_Internal$Variable, levels = (Results4_Internal$Variable))
Results4_Internal$Category <- factor(Results4_Internal$Category, levels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))

Results4_Internal_Rename <- Results4_Internal
Results4_Internal_Rename$Variable <- as.character(Results4_Internal_Rename$Variable)
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_syn_totprob_r", "Variable"] <- "CBCL-Total-Problems"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "famhx_ss_moth_prob_dprs_p", "Variable"] <- "FamHx-Mom-Prob-Dprs"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_dsm5_depress_r", "Variable"] <- "CBCL-Dprs"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_q03_p", "Variable"] <- "CBCL-3-Argue"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_syn_somatic_r", "Variable"] <- "CBCL-Somatic"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "sds_p_ss_dims", "Variable"] <- "SDS-Sleep-Disord-DIMS"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "famhx_ss_momdad_dg_p", "Variable"] <- "FamHx-Parent-Prob-Drugs"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "pps_y_ss_severity_score", "Variable"] <- "PPS-SS-Severity"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_syn_internal_r", "Variable"] <- "CBCL-Internal"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_syn_external_r", "Variable"] <- "CBCL-External"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "pps_y_ss_bother_sum", "Variable"] <- "PPS-SS-Bother-Sum"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_dsm5_opposit_r", "Variable"] <- "CBCL-Oppositional"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_07_stress_r", "Variable"] <- "CBCL-Stress-Scale"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "sds_p_ss_total", "Variable"] <- "SDS-Sleep-Disord-Total"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_dsm5_somaticpr_r", "Variable"] <- "CBCL-Somatic(DSM)"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "famhx_ss_fath_prob_dprs_p", "Variable"] <- "FamHx-Dad-Prob-Dprs"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "su_caff_max_calc", "Variable"] <- "Caffeine-Max"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_syn_rulebreak_r", "Variable"] <- "CBCL-Rulebreak"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_syn_aggressive_r", "Variable"] <- "CBCL-Aggressive"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "pps_y_ss_number", "Variable"] <- "PPS-SS-Number"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_dsm5_conduct_r", "Variable"] <- "CBCL-Conduct"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "ksads_23_957_p", "Variable"] <- "KSADS-P-Suicidal-957"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "ksads_23_146_p", "Variable"] <- "KSADS-P-Suicidal-146"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "famhx_ss_momdad_nrv_p", "Variable"] <- "FamHx-Parent-Prob-Anxiety"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "cbcl_scr_dsm5_anxdisord_r", "Variable"] <- "CBCL-Anxiety-Disord"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "prodromal_20_y", "Variable"] <- "PPS-See-Things"
Results4_Internal_Rename[Results4_Internal_Rename$Variable == "su_caff_ss_sum_calc", "Variable"] <- "Caffeine-Sum"

Results4_Internal_Rename$Variable <- factor(Results4_Internal_Rename$Variable, levels = Results4_Internal_Rename$Variable)

Results4_Internal_Rename$neg_log_p <- -log10(as.numeric(Results4_Internal_Rename$Pval))
Results4_Internal_Rename$direction <- as.factor(ifelse(Results4_Internal_Rename$Beta > 0, 1, 0))

Results4_Internal_Rename <- Results4_Internal_Rename %>%
  mutate(xpos = c(seq(1,14,1), seq(24, 41, 1), seq(51,77,1), seq(87,132,1), seq(142,198,.5), seq(208,295,.5), seq(305,424, .5), seq(434,753,.5)),
         xpos2 = c(seq(1,14,1), seq(26, 43, 1), seq(55,81,1), seq(91,136,1), seq(146,258,1), seq(268,442,1),
                   seq(452,690,1), seq(700,1338))) %>%
  mutate(catlab = ifelse(xpos == 2, "Cognition",
                         ifelse(xpos == 26, "Screen Time",
                                ifelse(xpos == 59, "Demographics",
                                       ifelse(xpos == 110, "Substance",
                                              ifelse(xpos == 172, "Culture/\nEnvironment",
                                                     ifelse(xpos == 260, "Physical\nHealth",
                                                            ifelse(xpos == 370, "Family\nMental Health",
                                                                   ifelse(xpos == 600, "Child\nMental Health", "")))))))),
         catlab2 = ifelse(xpos2 == 1, "Cognition",
                         ifelse(xpos2 == 37, "Screen Time",
                                ifelse(xpos2 == 70, "Demographics",
                                       ifelse(xpos2 == 115, "Substance",
                                              ifelse(xpos2 == 214, "Culture/\nEnvironment",
                                                     ifelse(xpos2 == 357, "Physical\nHealth",
                                                            ifelse(xpos2 == 563, "Family\nMental Health",
                                                                   ifelse(xpos2 == 1014, "Child\nMental Health", "")))))))))

Results4_Internal_Rename <- Results4_Internal_Rename %>%
  mutate(xlabs = ifelse(Category == "Cognition", "darkorange1",
                 ifelse(Category == "Screen Time", "lightseagreen",
                        ifelse(Category == "Demographics", "orchid3",
                               ifelse(Category == "Substance", "lightskyblue",
                                      ifelse(Category == "Culture/Environment", "goldenrod1", 
                                             ifelse(Category == "Physical Health", "seagreen",
                                                    ifelse(Category == "Family Mental Health", "pink2",
                                                           ifelse(Category == "Child Mental Health", "deepskyblue4", "")))))))))
options(ggrepel.max.overlaps = Inf)

Internal_Plot_Finala <- ggplot(Results4_Internal_Rename, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-8, as.character(Variable), "")), 
                  aes(label=label, color = Category), size=1.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Internalizing Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(.5, 755.5), expand = c(.01, .01), labels = Results4_Internal_Rename$catlab, breaks = Results4_Internal_Rename$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results4_Internal_Rename$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Internal_Plot_Finala, file = "Internal_Plot_Finala2.png", height = 4, width = 5)

Internal_Plot_Finalb <- ggplot(Results4_Internal_Rename, aes(x=xpos2, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-08 & Variable != "PPS-See-Things" & Variable != "KSADS-P-Suicidal-957", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=1.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "PPS-See-Things", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=1.5, nudge_y = .4, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "KSADS-P-Suicidal-957", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=1.5, nudge_x = -50, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Internalizing Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(1, 1338), expand = c(.01, .01), labels = Results4_Internal_Rename$catlab2, breaks = Results4_Internal_Rename$xpos2) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results4_Internal_Rename$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Internal_Plot_Finalb, file = "Internal_Plot_Finalb.png", height = 4, width = 6)

Internal_Plot_Finalc <- ggplot(Results4_Internal_Rename, aes(x=xpos2, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 4e-08 & Variable != "PPS-See-Things" & Variable != "PPS-SS-Number" & Variable != "KSADS-P-Suicidal-957" & Variable != "FamHx-Parent-Prob-Anxiety", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "PPS-See-Things", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2, nudge_y = .4, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "KSADS-P-Suicidal-957", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2, nudge_y = .58, nudge_x = -15, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "FamHx-Parent-Prob-Anxiety", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2, nudge_x = -50, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "PPS-SS-Number", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2, nudge_y = .6, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Internalizing Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(1, 1338), expand = c(.01, .01), labels = Results4_Internal_Rename$catlab2, breaks = Results4_Internal_Rename$xpos2) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 7.1, colour = Results4_Internal_Rename$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Internal_Plot_Finalc, file = "Internal_Plot_Finalc2.png", height = 4, width = 6)

Internal_Plot_Finalposter <- ggplot(Results4_Internal_Rename, aes(x=xpos2, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 4e-08 & Variable != "PPS-See-Things" & Variable != "PPS-SS-Number" & Variable != "KSADS-P-Suicidal-957" & Variable != "FamHx-Parent-Prob-Anxiety", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "PPS-See-Things", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2, nudge_y = .4, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "KSADS-P-Suicidal-957", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2, nudge_y = .58, nudge_x = -15, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "FamHx-Parent-Prob-Anxiety", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2, nudge_x = -50, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "PPS-SS-Number", as.character(Variable), "")), 
                  aes(label=label, color = Category), size=2, nudge_y = .6, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1271), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Internalizing Factor PRS PheWAS", subtitle = "Baseline Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  scale_x_continuous(limits = c(1, 1338), expand = c(.01, .01)) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Internal_Plot_Finalposter, file = "Internal_Plot_Finalposter.png", height = 4, width = 6)
```

#### Follow-Up Plots

##### Compulsive PRS

```{r}
ResultsFU_comp <- fread("Compulsive_results_FU_8.11.23.txt", header = T, data.table = F)
ResultsFU2_comp <- fread("Psychotic_results_FU_8.27.23.txt", header = T, data.table = F)
ResultsFU3_comp <- fread("Neurodev_results_FU_8.27.23.txt", header = T, data.table = F)
ResultsFU4_comp <- fread("Internalizing_results_FU_8.27.23.txt", header = T, data.table = F)

Results_FU_Substance <- ResultsFU_comp %>%
  filter(grepl('tlfb|path|isip|su_|caff|rules_|peer_dev|ascq|ptu_|meeq|phs_|aeq_', Variable)) %>%
  filter(!grepl('caff_ago|caff_24', Variable))
Results_FU_Substance$Category <- rep("Substance", 119)

Results_FU_CE <- ResultsFU_comp %>%
  filter(grepl('crpbi|fes|prosocial|school|reshist|monitor|neighborhood|enviro|pmq|ple_|cybb|pnh_|nsc_|psb_|sag_|comc|srpf_|dim_mat|dim_y|pbp_|peq', Variable)) %>%
  filter(!grepl('profess|kbi|eatq|screen|mctq', Variable))
Results_FU_CE$Category <- rep("Culture/Environment", 441)

Results_FU_MH_y <- ResultsFU_comp %>%
  filter(grepl('ksad|cbcl|prodrom|pps_|upps|bisbas|bis_|resiliency|kbi|gen_child|pgbi|bpmt|bpm|sup_|eatq_|ssrs_|poa_|ksad', Variable)) %>%
  filter(!grepl('monitor|parent_rules|prosocial|fes_youth|asr_|famhx|fam_hist|abcl|screen|dim_matrix|dim_yes', Variable))
Results_FU_MH_y$Category <- rep("Child Mental Health", 636)

Results_FU_MH_p <- ResultsFU_comp %>%
  filter(grepl('asr_|famhx|fam_hist|q1|q2|q4|q5|q6|q9|abcl', Variable)) %>%
  filter(!grepl('cbcl|ksads|bpmt|parent|fes_|prosocial|screen|dim_matrix|dim_yes', Variable))
Results_FU_MH_p$Category <- rep("Family Mental Health", 158)

Results_FU_PH <- ResultsFU_comp %>%
  filter(grepl('medhx|devhx|tbi|pds|puber|sports|sai_|filtered_|anthro|child_|antidep_|sds_|sleep|weight|SSRI|antidepressant|bkfs|mctq|gish|physical_activity|pain_last|brought|blood_pressure|pain_|menstrual|biospec|fitbit|caff_ago|caff_24', Variable)) %>%
  filter(!grepl('demo|gen_child|screen|ksad', Variable))
Results_FU_PH$Category <- rep("Physical Health", 202)

Results_FU_NP <- ResultsFU_comp %>%
  filter(grepl('nihtbx|RAVLT|lmt', Variable))
Results_FU_NP$Category <- rep("Cognition", 8)

Results_FU_Screen <- ResultsFU_comp %>%
  filter(grepl('screen|stq', Variable))
Results_FU_Screen$Category <- rep("Screen Time", 107)

Results_FU_Demo <- ResultsFU_comp %>%
  filter(grepl('demo', Variable))
Results_FU_Demo$Category <- rep("Demographics", 26)

Results_FU_Compulsive <- rbind(Results_FU_NP, Results_FU_Screen, Results_FU_Demo, Results_FU_Substance, Results_FU_CE, Results_FU_PH, Results_FU_MH_p, Results_FU_MH_y)

Results_FU_Compulsive$Variable <- factor(Results_FU_Compulsive$Variable, levels = Results_FU_Compulsive$Variable)
Results_FU_Compulsive$Category <- factor(Results_FU_Compulsive$Category, levels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))
Results_FU_Compulsive$Pval <- as.numeric(Results_FU_Compulsive$Pval)
Results_FU_Compulsive$neg_log_p <- -log10(Results_FU_Compulsive$Pval)
Results_FU_Compulsive$direction <- as.factor(ifelse(Results_FU_Compulsive$Beta > 0, 1, 0))

Results_FU_Compulsive <- Results_FU_Compulsive %>%
  mutate(xpos = c(seq(1,8,1), seq(20, 126, 1), seq(136,161,1), seq(171,289,1), seq(299,739,1), seq(749,950,1), seq(960,1117, 1), seq(1127,1762, 1))) %>%
  mutate(catlab = ifelse(xpos == 2, "Cognition",
                         ifelse(xpos == 80, "Screen Time",
                                ifelse(xpos == 150, "Demographics",
                                       ifelse(xpos ==235, "Substance",
                                              ifelse(xpos == 535, "Culture/\nEnvironment",
                                                     ifelse(xpos == 865, "Physical\nHealth",
                                                            ifelse(xpos == 1045, "Family\nMental Health",
                                                                   ifelse(xpos == 1450, "Child\nMental Health", "")))))))))

Results_FU_Compulsive <- Results_FU_Compulsive %>%
  mutate(xlabs = ifelse(Category == "Cognition", "darkorange1",
                 ifelse(Category == "Screen Time", "lightseagreen",
                        ifelse(Category == "Demographics", "orchid3",
                               ifelse(Category == "Substance", "lightskyblue",
                                      ifelse(Category == "Culture/Environment", "goldenrod1", 
                                             ifelse(Category == "Physical Health", "seagreen",
                                                    ifelse(Category == "Family Mental Health", "pink2",
                                                           ifelse(Category == "Child Mental Health", "deepskyblue4", "")))))))))


Compulsive_FU_Plot_Finala <- ggplot(Results_FU_Compulsive, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Bonferroni < 0.05, as.character(Variable), "")), 
                  aes(label=label), size=3, box.padding = unit(0.4, "lines")) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1697), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Compulsive Factor PRS PheWAS", subtitle = "Two-Year Follow-Up Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 24)) +
  scale_x_continuous(limits = c(.5, 1763), expand = c(.01, .01), labels = Results_FU_Compulsive$catlab, breaks = Results_FU_Compulsive$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results_FU_Compulsive$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Compulsive_FU_Plot_Finala, file = "Compulsive_FU_Plot_Finala2.png", height = 4, width = 6)

```

##### Psychotic PRS

```{r}
Results2_FU_Substance <- ResultsFU2_comp %>%
  filter(grepl('tlfb|path|isip|su_|caff|rules_|peer_dev|ascq|ptu_|meeq|phs_|aeq_', Variable)) %>%
  filter(!grepl('caff_ago|caff_24', Variable))
Results2_FU_Substance$Category <- rep("Substance", 119)

Results2_FU_CE <- ResultsFU2_comp %>%
  filter(grepl('crpbi|fes|prosocial|school|reshist|monitor|neighborhood|enviro|pmq|ple_|cybb|pnh_|nsc_|psb_|sag_|comc|srpf_|dim_mat|dim_y|pbp_|peq', Variable)) %>%
  filter(!grepl('profess|kbi|eatq|screen|mctq', Variable))
Results2_FU_CE$Category <- rep("Culture/Environment", 441)

Results2_FU_MH_y <- ResultsFU2_comp %>%
  filter(grepl('ksad|cbcl|prodrom|pps_|upps|bisbas|bis_|resiliency|kbi|gen_child|pgbi|bpmt|bpm|sup_|eatq_|ssrs_|poa_|ksad', Variable)) %>%
  filter(!grepl('monitor|parent_rules|prosocial|fes_youth|asr_|famhx|fam_hist|abcl|screen|dim_matrix|dim_yes', Variable))
Results2_FU_MH_y$Category <- rep("Child Mental Health", 636)

Results2_FU_MH_p <- ResultsFU2_comp %>%
  filter(grepl('asr_|famhx|fam_hist|q1|q2|q4|q5|q6|q9|abcl', Variable)) %>%
  filter(!grepl('cbcl|ksads|bpmt|parent|fes_|prosocial|screen|dim_matrix|dim_yes', Variable))
Results2_FU_MH_p$Category <- rep("Family Mental Health", 158)

Results2_FU_PH <- ResultsFU2_comp %>%
  filter(grepl('medhx|devhx|tbi|pds|puber|sports|sai_|filtered_|anthro|child_|antidep_|sds_|sleep|weight|SSRI|antidepressant|bkfs|mctq|gish|physical_activity|pain_last|brought|blood_pressure|pain_|menstrual|biospec|fitbit|caff_ago|caff_24', Variable)) %>%
  filter(!grepl('demo|gen_child|screen|ksad', Variable))
Results2_FU_PH$Category <- rep("Physical Health", 202)

Results2_FU_NP <- ResultsFU2_comp %>%
  filter(grepl('nihtbx|RAVLT|lmt', Variable))
Results2_FU_NP$Category <- rep("Cognition", 8)

Results2_FU_Screen <- ResultsFU2_comp %>%
  filter(grepl('screen|stq', Variable))
Results2_FU_Screen$Category <- rep("Screen Time", 107)

Results2_FU_Demo <- ResultsFU2_comp %>%
  filter(grepl('demo', Variable))
Results2_FU_Demo$Category <- rep("Demographics", 26)

Results2_FU_Psychotic <- rbind(Results2_FU_NP, Results2_FU_Screen, Results2_FU_Demo, Results2_FU_Substance, Results2_FU_CE, Results2_FU_PH, Results2_FU_MH_p, Results2_FU_MH_y)

Results2_FU_Psychotic$Variable <- factor(Results2_FU_Psychotic$Variable, levels = Results2_FU_Psychotic$Variable)
Results2_FU_Psychotic$Category <- factor(Results2_FU_Psychotic$Category, levels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))
Results2_FU_Psychotic$Pval <- as.numeric(Results2_FU_Psychotic$Pval)
Results2_FU_Psychotic$neg_log_p <- -log10(Results2_FU_Psychotic$Pval)
Results2_FU_Psychotic$direction <- as.factor(ifelse(Results2_FU_Psychotic$Beta > 0, 1, 0))

Results2_FU_Psychotic <- Results2_FU_Psychotic %>%
  mutate(xpos = c(seq(1,8,1), seq(20, 126, 1), seq(136,161,1), seq(171,289,1), seq(299,739,1), seq(749,950,1), seq(960,1117, 1), seq(1127,1762, 1))) %>%
  mutate(catlab = ifelse(xpos == 2, "Cognition",
                         ifelse(xpos == 80, "Screen Time",
                                ifelse(xpos == 150, "Demographics",
                                       ifelse(xpos ==235, "Substance",
                                              ifelse(xpos == 535, "Culture/\nEnvironment",
                                                     ifelse(xpos == 865, "Physical\nHealth",
                                                            ifelse(xpos == 1045, "Family\nMental Health",
                                                                   ifelse(xpos == 1450, "Child\nMental Health", "")))))))))

Results2_FU_Psychotic <- Results2_FU_Psychotic %>%
  mutate(xlabs = ifelse(Category == "Cognition", "darkorange1",
                 ifelse(Category == "Screen Time", "lightseagreen",
                        ifelse(Category == "Demographics", "orchid3",
                               ifelse(Category == "Substance", "lightskyblue",
                                      ifelse(Category == "Culture/Environment", "goldenrod1", 
                                             ifelse(Category == "Physical Health", "seagreen",
                                                    ifelse(Category == "Family Mental Health", "pink2",
                                                           ifelse(Category == "Child Mental Health", "deepskyblue4", "")))))))))

Results2_FU_Psychotic$Variable <- as.character(Results2_FU_Psychotic$Variable)
Results2_FU_Psychotic[Results2_FU_Psychotic$Variable == "srpf_y_ss_iiss", "Variable"] <- "SRPF-School-Involvement-Subscale"
Results2_FU_Psychotic[Results2_FU_Psychotic$Variable == "su_caff_intake_9_calc_l", "Variable"] <- "Caff-Intake-9-Energy-Drink"

Results2_FU_Psychotic$Variable <- factor(Results2_FU_Psychotic$Variable, levels = Results2_FU_Psychotic$Variable)

Psychotic_FU_Plot_Finala <- ggplot(Results2_FU_Psychotic, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "SRPF-School-Involvement-Subscale", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=1.5, nudge_x = 45, nudge_y = .65, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32') + #, segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "Caff-Intake-9-Energy-Drink", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=1.5, nudge_y = .55, nudge_x = -45, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32') +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1697), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Psychotic Factor PRS PheWAS", subtitle = "Two-Year Follow-Up Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 24)) +
  scale_x_continuous(limits = c(.5, 1763), expand = c(.01, .01), labels = Results2_FU_Psychotic$catlab, breaks = Results2_FU_Psychotic$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results2_FU_Psychotic$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Psychotic_FU_Plot_Finala, file = "Psychotic_FU_Plot_Finala.png", height = 4, width = 6)

Psychotic_FU_Plot_Finalb <- ggplot(Results2_FU_Psychotic, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "SRPF-School-Involvement-Subscale", as.character(Variable), "")), 
                  aes(label=label), colour = "goldenrod2", size=2, nudge_x = 45, nudge_y = .8, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32') + #, segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "Caff-Intake-9-Energy-Drink", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2, nudge_y = .55, nudge_x = -45, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32') +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1697), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Psychotic Factor PRS PheWAS", subtitle = "Two-Year Follow-Up Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 24)) +
  scale_x_continuous(limits = c(.5, 1763), expand = c(.01, .01), labels = Results2_FU_Psychotic$catlab, breaks = Results2_FU_Psychotic$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 7.1, colour = Results2_FU_Psychotic$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Psychotic_FU_Plot_Finalb, file = "Psychotic_FU_Plot_Finalb.png", height = 4, width = 6)
```

##### Neurodevelopmental PRS

```{r}
Results3_FU_Substance <- ResultsFU3_comp %>%
  filter(grepl('tlfb|path|isip|su_|caff|rules_|peer_dev|ascq|ptu_|meeq|phs_|aeq_', Variable)) %>%
  filter(!grepl('caff_ago|caff_24', Variable))
Results3_FU_Substance$Category <- rep("Substance", 119)

Results3_FU_CE <- ResultsFU3_comp %>%
  filter(grepl('crpbi|fes|prosocial|school|reshist|monitor|neighborhood|enviro|pmq|ple_|cybb|pnh_|nsc_|psb_|sag_|comc|srpf_|dim_mat|dim_y|pbp_|peq', Variable)) %>%
  filter(!grepl('profess|kbi|eatq|screen|mctq', Variable))
Results3_FU_CE$Category <- rep("Culture/Environment", 441)

Results3_FU_MH_y <- ResultsFU3_comp %>%
  filter(grepl('ksad|cbcl|prodrom|pps_|upps|bisbas|bis_|resiliency|kbi|gen_child|pgbi|bpmt|bpm|sup_|eatq_|ssrs_|poa_|ksad', Variable)) %>%
  filter(!grepl('monitor|parent_rules|prosocial|fes_youth|asr_|famhx|fam_hist|abcl|screen|dim_matrix|dim_yes', Variable))
Results3_FU_MH_y$Category <- rep("Child Mental Health", 636)

Results3_FU_MH_p <- ResultsFU3_comp %>%
  filter(grepl('asr_|famhx|fam_hist|q1|q2|q4|q5|q6|q9|abcl', Variable)) %>%
  filter(!grepl('cbcl|ksads|bpmt|parent|fes_|prosocial|screen|dim_matrix|dim_yes', Variable))
Results3_FU_MH_p$Category <- rep("Family Mental Health", 158)

Results3_FU_PH <- ResultsFU3_comp %>%
  filter(grepl('medhx|devhx|tbi|pds|puber|sports|sai_|filtered_|anthro|child_|antidep_|sds_|sleep|weight|SSRI|antidepressant|bkfs|mctq|gish|physical_activity|pain_last|brought|blood_pressure|pain_|menstrual|biospec|fitbit|caff_ago|caff_24', Variable)) %>%
  filter(!grepl('demo|gen_child|screen|ksad', Variable))
Results3_FU_PH$Category <- rep("Physical Health", 202)

Results3_FU_NP <- ResultsFU3_comp %>%
  filter(grepl('nihtbx|RAVLT|lmt', Variable))
Results3_FU_NP$Category <- rep("Cognition", 8)

Results3_FU_Screen <- ResultsFU3_comp %>%
  filter(grepl('screen|stq', Variable))
Results3_FU_Screen$Category <- rep("Screen Time", 107)

Results3_FU_Demo <- ResultsFU3_comp %>%
  filter(grepl('demo', Variable))
Results3_FU_Demo$Category <- rep("Demographics", 26)

Results3_FU_Neurodev <- rbind(Results3_FU_NP, Results3_FU_Screen, Results3_FU_Demo, Results3_FU_Substance, Results3_FU_CE, Results3_FU_PH, Results3_FU_MH_p, Results3_FU_MH_y)

Results3_FU_Neurodev$Variable <- factor(Results3_FU_Neurodev$Variable, levels = Results3_FU_Neurodev$Variable)
Results3_FU_Neurodev$Category <- factor(Results3_FU_Neurodev$Category, levels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))
Results3_FU_Neurodev$Pval <- as.numeric(Results3_FU_Neurodev$Pval)
Results3_FU_Neurodev$neg_log_p <- -log10(Results3_FU_Neurodev$Pval)
Results3_FU_Neurodev$direction <- as.factor(ifelse(Results3_FU_Neurodev$Beta > 0, 1, 0))

Results3_FU_Neurodev <- Results3_FU_Neurodev %>%
  mutate(xpos = c(seq(1,8,1), seq(20, 126, 1), seq(136,161,1), seq(171,289,1), seq(299,739,1), seq(749,950,1), seq(960,1117, 1), seq(1127,1762, 1))) %>%
  mutate(catlab = ifelse(xpos == 2, "Cognition",
                         ifelse(xpos == 80, "Screen Time",
                                ifelse(xpos == 150, "Demographics",
                                       ifelse(xpos ==235, "Substance",
                                              ifelse(xpos == 535, "Culture/\nEnvironment",
                                                     ifelse(xpos == 865, "Physical\nHealth",
                                                            ifelse(xpos == 1045, "Family\nMental Health",
                                                                   ifelse(xpos == 1450, "Child\nMental Health", "")))))))))
Results3_FU_Neurodev <- Results3_FU_Neurodev %>%
  mutate(xlabs = ifelse(Category == "Cognition", "darkorange1",
                 ifelse(Category == "Screen Time", "lightseagreen",
                        ifelse(Category == "Demographics", "orchid3",
                               ifelse(Category == "Substance", "lightskyblue",
                                      ifelse(Category == "Culture/Environment", "goldenrod1", 
                                             ifelse(Category == "Physical Health", "seagreen",
                                                    ifelse(Category == "Family Mental Health", "pink2",
                                                           ifelse(Category == "Child Mental Health", "deepskyblue4", "")))))))))

Results3_FU_Neurodev$Variable <- as.character(Results3_FU_Neurodev$Variable)
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_p_ss_effort_cont_sup_scale", "Variable"] <- "EATQ-SS-Effort-Ctrl"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_p_ss_attention", "Variable"] <- "EATQ-SS-Attention"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_p_ss_activation", "Variable"] <- "EATQ-SS-Activation"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_p_ss_inhibitory", "Variable"] <- "EATQ-SS-Inhibitory"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "sag_grade_type", "Variable"] <- "SAG-p-School-Grades"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_finish_p", "Variable"] <- "EATQ-Finish-Time"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "bpm_y_scr_attention_r", "Variable"] <- "BPM-y-Attention"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "cbcl_q08_p", "Variable"] <- "CBCL-8-Concentrate"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "cbcl_q61_p", "Variable"] <- "CBCL-61-SchWork"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "bpm_y_scr_totalprob_r", "Variable"] <- "BPM-y-Total-Problems"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_close_attention", "Variable"] <- "EATQ-Close-Attention"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_p_ss_aggression", "Variable"] <- "EATQ-SS-Aggression"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "bpm_4_y", "Variable"] <- "BPM-4y-Concentrate"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "cbcl_scr_dsm5_adhd_r", "Variable"] <- "CBCL-ADHD"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "cbcl_scr_syn_attention_r", "Variable"] <- "CBCL-Attention"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "upps19_y", "Variable"] <- "UPPS-19-Done-Time"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "bpm_y_scr_external_r", "Variable"] <- "BPM-y-External"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "screentime_wknd_typical_composit", "Variable"] <- "Wknd-Screentime"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "screentime_wkdy_typical_composit", "Variable"] <- "Wkdy-Screentime"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_puts_off_p", "Variable"] <- "EATQ-Puts-Off"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_concentrate_p", "Variable"] <- "EATQ-Concentrate"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_sidetracked_p", "Variable"] <- "EATQ-Sidetracked"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_p_ss_neg_affect_sup_scale", "Variable"] <- "EATQ-SS-Negative-Affect"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "upps_y_ss_lack_of_perseverance", "Variable"] <- "UPPS-SS-Lack-Persev"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "kbi_p_how_well_c_school_l", "Variable"] <- "KBI-p-How-Well-in-School"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_peripheral_p", "Variable"] <- "EATQ-Periph-Attention"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "eatq_close_attention_p", "Variable"] <- "EATQ-Close-Attention"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "srpf_y_ss_iiss", "Variable"] <- "SRPF-School-Involvement-Subscale"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "screentime_pmum_short_7_p", "Variable"] <- "Screentime_7p-Only-Media-Motivates"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "screentime_pmum_short_7_p", "Variable"] <- "Screentime_7p-Only-Media-Motivates"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "kbi_p_grades_in_school_l", "Variable"] <- "KBI-p-School-Grades"
Results3_FU_Neurodev[Results3_FU_Neurodev$Variable == "cbcl_scr_dsm5_conduct_r", "Variable"] <- "CBCL-Conduct"

Results3_FU_Neurodev$Variable <- factor(Results3_FU_Neurodev$Variable, levels = Results3_FU_Neurodev$Variable)
options(ggrepel.max.overlaps = Inf)

Neurodev_FU_Plot_Finala <- ggplot(Results3_FU_Neurodev, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-13 & Category!="Culture/Environment", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=1.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-13 & Category=="Culture/Environment", as.character(Variable), "")), 
                  aes(label=label), color = "goldenrod2", size=1.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1697), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Neurodevelopmental Factor PRS PheWAS", subtitle = "Two-Year Follow-Up Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 24)) +
  scale_x_continuous(limits = c(.5, 1763), expand = c(.01, .01), labels = Results3_FU_Neurodev$catlab, breaks = Results3_FU_Neurodev$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results3_FU_Neurodev$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Neurodev_FU_Plot_Finala, file = "Neurodev_FU_Plot_Finala2.png", height = 4, width = 6)

Neurodev_FU_Plot_Finalb <- ggplot(Results3_FU_Neurodev, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-13 & Category!="Culture/Environment" & Variable != "BPM-y-External" & Variable != "EATQ-Concentrate" & Variable != "KBI-p-School-Grades", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "BPM-y-External", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  nudge_x = -10, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "EATQ-Concentrate", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  nudge_x = 100, nudge_y = -.1, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "KBI-p-School-Grades", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  nudge_x = -20, nudge_y = -.5, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-13 & Category=="Culture/Environment", as.character(Variable), "")), 
                  aes(label=label), color = "goldenrod2", size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1697), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Neurodevelopmental Factor PRS PheWAS", subtitle = "Two-Year Follow-Up Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 24)) +
  scale_x_continuous(limits = c(.5, 1763), expand = c(.01, .01), labels = Results3_FU_Neurodev$catlab, breaks = Results3_FU_Neurodev$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 7.1, colour = Results3_FU_Neurodev$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Neurodev_FU_Plot_Finalb, file = "Neurodev_FU_Plot_Finalb2.png", height = 4, width = 6)

Neurodev_FU_Plot_Finalposter <- ggplot(Results3_FU_Neurodev, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-13 & Category!="Culture/Environment" & Variable != "BPM-y-External" & Variable != "EATQ-Concentrate" & Variable != "KBI-p-School-Grades", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "BPM-y-External", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  nudge_y = -.5, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "EATQ-Concentrate", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  nudge_x = 100, nudge_y = -.1, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "KBI-p-School-Grades", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  nudge_x = -20, nudge_y = -1, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-13 & Category=="Culture/Environment", as.character(Variable), "")), 
                  aes(label=label), color = "goldenrod2", size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1697), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Neurodevelopmental Factor PRS PheWAS", subtitle = "Two-Year Follow-Up Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 24)) +
  scale_x_continuous(limits = c(.5, 1763), expand = c(.01, .01)) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Neurodev_FU_Plot_Finalposter, file = "Neurodev_FU_Plot_Finalposter.png", height = 4, width = 6)
```

##### Internalizing PRS

```{r}
Results4_FU_Substance <- ResultsFU4_comp %>%
  filter(grepl('tlfb|path|isip|su_|caff|rules_|peer_dev|ascq|ptu_|meeq|phs_|aeq_', Variable)) %>%
  filter(!grepl('caff_ago|caff_24', Variable))
Results4_FU_Substance$Category <- rep("Substance", 119)

Results4_FU_CE <- ResultsFU4_comp %>%
  filter(grepl('crpbi|fes|prosocial|school|reshist|monitor|neighborhood|enviro|pmq|ple_|cybb|pnh_|nsc_|psb_|sag_|comc|srpf_|dim_mat|dim_y|pbp_|peq', Variable)) %>%
  filter(!grepl('profess|kbi|eatq|screen|mctq', Variable))
Results4_FU_CE$Category <- rep("Culture/Environment", 441)

Results4_FU_MH_y <- ResultsFU4_comp %>%
  filter(grepl('ksad|cbcl|prodrom|pps_|upps|bisbas|bis_|resiliency|kbi|gen_child|pgbi|bpmt|bpm|sup_|eatq_|ssrs_|poa_|ksad', Variable)) %>%
  filter(!grepl('monitor|parent_rules|prosocial|fes_youth|asr_|famhx|fam_hist|abcl|screen|dim_matrix|dim_yes', Variable))
Results4_FU_MH_y$Category <- rep("Child Mental Health", 636)

Results4_FU_MH_p <- ResultsFU4_comp %>%
  filter(grepl('asr_|famhx|fam_hist|q1|q2|q4|q5|q6|q9|abcl', Variable)) %>%
  filter(!grepl('cbcl|ksads|bpmt|parent|fes_|prosocial|screen|dim_matrix|dim_yes', Variable))
Results4_FU_MH_p$Category <- rep("Family Mental Health", 158)

Results4_FU_PH <- ResultsFU4_comp %>%
  filter(grepl('medhx|devhx|tbi|pds|puber|sports|sai_|filtered_|anthro|child_|antidep_|sds_|sleep|weight|SSRI|antidepressant|bkfs|mctq|gish|physical_activity|pain_last|brought|blood_pressure|pain_|menstrual|biospec|fitbit|caff_ago|caff_24', Variable)) %>%
  filter(!grepl('demo|gen_child|screen|ksad', Variable))
Results4_FU_PH$Category <- rep("Physical Health", 202)

Results4_FU_NP <- ResultsFU4_comp %>%
  filter(grepl('nihtbx|RAVLT|lmt', Variable))
Results4_FU_NP$Category <- rep("Cognition", 8)

Results4_FU_Screen <- ResultsFU4_comp %>%
  filter(grepl('screen|stq', Variable))
Results4_FU_Screen$Category <- rep("Screen Time", 107)

Results4_FU_Demo <- ResultsFU4_comp %>%
  filter(grepl('demo', Variable))
Results4_FU_Demo$Category <- rep("Demographics", 26)

Results4_FU_Internal <- rbind(Results4_FU_NP, Results4_FU_Screen, Results4_FU_Demo, Results4_FU_Substance, Results4_FU_CE, Results4_FU_PH, Results4_FU_MH_p, Results4_FU_MH_y)

Results4_FU_Internal$Variable <- factor(Results4_FU_Internal$Variable, levels = Results4_FU_Internal$Variable)
Results4_FU_Internal$Category <- factor(Results4_FU_Internal$Category, levels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))
Results4_FU_Internal$Pval <- as.numeric(Results4_FU_Internal$Pval)
Results4_FU_Internal$neg_log_p <- -log10(Results4_FU_Internal$Pval)
Results4_FU_Internal$direction <- as.factor(ifelse(Results4_FU_Internal$Beta > 0, 1, 0))

Results4_FU_Internal <- Results4_FU_Internal %>%
  mutate(xpos = c(seq(1,8,1), seq(20, 126, 1), seq(136,161,1), seq(171,289,1), seq(299,739,1), seq(749,950,1), seq(960,1117, 1), seq(1127,1762, 1))) %>%
  mutate(catlab = ifelse(xpos == 2, "Cognition",
                         ifelse(xpos == 80, "Screen Time",
                                ifelse(xpos == 150, "Demographics",
                                       ifelse(xpos ==235, "Substance",
                                              ifelse(xpos == 535, "Culture/\nEnvironment",
                                                     ifelse(xpos == 865, "Physical\nHealth",
                                                            ifelse(xpos == 1045, "Family\nMental Health",
                                                                   ifelse(xpos == 1450, "Child\nMental Health", "")))))))))

Results4_FU_Internal <- Results4_FU_Internal %>%
  mutate(xlabs = ifelse(Category == "Cognition", "darkorange1",
                 ifelse(Category == "Screen Time", "lightseagreen",
                        ifelse(Category == "Demographics", "orchid3",
                               ifelse(Category == "Substance", "lightskyblue",
                                      ifelse(Category == "Culture/Environment", "goldenrod1", 
                                             ifelse(Category == "Physical Health", "seagreen",
                                                    ifelse(Category == "Family Mental Health", "pink2",
                                                           ifelse(Category == "Child Mental Health", "deepskyblue4", "")))))))))

Results4_FU_Internal$Variable <- as.character(Results4_FU_Internal$Variable)
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_syn_totprob_r", "Variable"] <- "CBCL-Total-Problems"
Results4_FU_Internal[Results4_FU_Internal$Variable == "bpm_y_scr_totalprob_r", "Variable"] <- "BPM-y-Total-Problems"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_syn_external_r", "Variable"] <- "CBCL-External"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_syn_internal_r", "Variable"] <- "CBCL-Internal"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_syn_aggressive_r", "Variable"] <- "CBCL-Aggressive"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_syn_thought_r", "Variable"] <- "CBCL-Thought-Problems"
Results4_FU_Internal[Results4_FU_Internal$Variable == "ple_y_ss_total_bad", "Variable"] <- "PLE-y-SS-Total-Bad"
Results4_FU_Internal[Results4_FU_Internal$Variable == "ple_y_ss_affected_bad_sum", "Variable"] <- "PLE-y-SS-Affected-Bad"
Results4_FU_Internal[Results4_FU_Internal$Variable == "eatq_p_ss_effort_cont_sup_scale", "Variable"] <- "EATQ-SS-Effort-Ctrl"
Results4_FU_Internal[Results4_FU_Internal$Variable == "eatq_p_ss_neg_affect_sup_scale", "Variable"] <- "EATQ-SS-Neg-Affect"
Results4_FU_Internal[Results4_FU_Internal$Variable == "eatq_p_ss_attention", "Variable"] <- "EATQ-SS-Attention"
Results4_FU_Internal[Results4_FU_Internal$Variable == "pps_y_ss_severity_score", "Variable"] <- "PPS-SS-Severity"
Results4_FU_Internal[Results4_FU_Internal$Variable == "prodromal_8_y", "Variable"] <- "PPS-8-Not-Trust"
Results4_FU_Internal[Results4_FU_Internal$Variable == "prodromal_2b_y", "Variable"] <- "PPS-2b-Strange-Sounds"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_07_stress_r", "Variable"] <- "CBCL-Stress-Scale"
Results4_FU_Internal[Results4_FU_Internal$Variable == "abcl_q110_p", "Variable"] <- "ABCL-110-Good-Decisions"
Results4_FU_Internal[Results4_FU_Internal$Variable == "eatq_p_ss_inhibitory", "Variable"] <- "EATQ-SS-Inhibitory"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_dsm5_depress_r", "Variable"] <- "CBCL-Dprs"
Results4_FU_Internal[Results4_FU_Internal$Variable == "ple_y_ss_total_number", "Variable"] <- "PLE-y-SS-Total-Number"
Results4_FU_Internal[Results4_FU_Internal$Variable == "sds_p_ss_total", "Variable"] <- "SDS-Sleep-Disord-Total"
Results4_FU_Internal[Results4_FU_Internal$Variable == "demo_comb_income_v2_l", "Variable"] <- "Comb Income"
Results4_FU_Internal[Results4_FU_Internal$Variable == "pps_y_ss_number", "Variable"] <- "PPS-SS-Number"
Results4_FU_Internal[Results4_FU_Internal$Variable == "pps_y_ss_bother_sum", "Variable"] <- "PPS-SS-Bother-Sum"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_dsm5_opposit_r", "Variable"] <- "CBCL-Oppositional"
Results4_FU_Internal[Results4_FU_Internal$Variable == "sds_p_ss_dims", "Variable"] <- "SDS-Sleep-Disord-DIMS"
Results4_FU_Internal[Results4_FU_Internal$Variable == "ple_y_ss_affect_sum", "Variable"] <- "PLE-y-SS-Affected-Sum"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_q03_p", "Variable"] <- "CBCL-3-Argue"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_07_ocd_r", "Variable"] <- "CBCL-OCD-Scale"
Results4_FU_Internal[Results4_FU_Internal$Variable == "eatq_phenx_stick_to_plan_p", "Variable"] <- "EATQ-Stick-Plan"
Results4_FU_Internal[Results4_FU_Internal$Variable == "eatq_p_ss_depressive_mood", "Variable"] <- "EATQ-SS-Dprs-Mood"
Results4_FU_Internal[Results4_FU_Internal$Variable == "ple_argue_fu2_y", "Variable"] <- "PLE-y-Argue-Affected"
Results4_FU_Internal[Results4_FU_Internal$Variable == "prodromal_8b_y", "Variable"] <- "PPS-8b-Not-Trust"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_dsm5_anxdisord_r", "Variable"] <- "CBCL-Anx-Disord"
Results4_FU_Internal[Results4_FU_Internal$Variable == "eatq_p_ss_activation", "Variable"] <- "EATQ-SS-Activation"
Results4_FU_Internal[Results4_FU_Internal$Variable == "eatq_p_ss_fear", "Variable"] <- "EATQ-SS-Fear"
Results4_FU_Internal[Results4_FU_Internal$Variable == "eatq_p_ss_frustration", "Variable"] <- "EATQ-SS-Frustration"
Results4_FU_Internal[Results4_FU_Internal$Variable == "bpm_4_y", "Variable"] <- "BPM-4y-Concentrate"
Results4_FU_Internal[Results4_FU_Internal$Variable == "bpm_y_scr_internal_r", "Variable"] <- "BPM-y-Internal"
Results4_FU_Internal[Results4_FU_Internal$Variable == "bpm_y_scr_attention_r", "Variable"] <- "BPM-y-Attention"
Results4_FU_Internal[Results4_FU_Internal$Variable == "kbi_p_c_mh_sa_l", "Variable"] <- "KBI-p-MH-Services"
Results4_FU_Internal[Results4_FU_Internal$Variable == "kbipcserviceschecklistl10", "Variable"] <- "KBI-p-No-MH-Services"
Results4_FU_Internal[Results4_FU_Internal$Variable == "screentime_pmum_short_4_p", "Variable"] <- "Screentime-4p-Only-Media-Helps"
Results4_FU_Internal[Results4_FU_Internal$Variable == "srpf_y_ss_iiss", "Variable"] <- "SRPF-School-Involvement-Subscale"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_q04_p", "Variable"] <- "CBCL-4-Fails-to-Finish"
Results4_FU_Internal[Results4_FU_Internal$Variable == "bpm_19_y", "Variable"] <- "BPM-19y-Worry"
Results4_FU_Internal[Results4_FU_Internal$Variable == "cbcl_scr_syn_rulebreak_r", "Variable"] <- "CBCL-Rulebreak"
Results4_FU_Internal[Results4_FU_Internal$Variable == "sag_grade_type", "Variable"] <- "SAG-p-School-Grades"
Results4_FU_Internal[Results4_FU_Internal$Variable == "pgbi_p_ss_score", "Variable"] <- "PGBI-Sum-Score"


Results4_FU_Internal$Variable <- factor(Results4_FU_Internal$Variable, levels = Results4_FU_Internal$Variable)
options(ggrepel.max.overlaps = Inf)

Internal_FU_Plot_Finala <- ggplot(Results4_FU_Internal, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-10 & Category!="Culture/Environment" & Variable != "KBI-p-MH-Services", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=1.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-10 & Category=="Culture/Environment", as.character(Variable), "")), 
                  aes(label=label), color = "goldenrod2", size=1.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "KBI-p-MH-Services", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=1.5,  nudge_y = -.05, nudge_x = -60, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1694), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Internalizing Factor PRS PheWAS", subtitle = "Two-Year Follow-Up Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 24)) +
  scale_x_continuous(limits = c(.5, 1760), expand = c(.01, .01), labels = Results4_FU_Internal$catlab, breaks = Results4_FU_Internal$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 6, colour = Results4_FU_Internal$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Internal_FU_Plot_Finala, file = "Internal_FU_Plot_Finala.png", height = 4, width = 6)

Internal_FU_Plot_Finalb <- ggplot(Results4_FU_Internal, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-10 & Category!="Culture/Environment" & Variable != "KBI-p-MH-Services" & Variable != "BPM-4y-Concentrate", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-10 & Category=="Culture/Environment" & Variable != "PLE-y-SS-Affected-Sum", as.character(Variable), "")), 
                  aes(label=label), color = "goldenrod2", size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "PLE-y-SS-Affected-Sum", as.character(Variable), "")), 
                  aes(label=label), color = "goldenrod2", size=2, nudge_x = 25, nudge_y = .1, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "KBI-p-MH-Services", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  nudge_y = -1.4, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.1) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "BPM-4y-Concentrate", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  nudge_x = -250, nudge_y = -.75, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1697), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Internalizing Factor PRS PheWAS", subtitle = "Two-Year Follow-Up Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 24)) +
  scale_x_continuous(limits = c(.5, 1763), expand = c(.01, .01), labels = Results4_FU_Internal$catlab, breaks = Results4_FU_Internal$xpos) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, margin = margin(t = 0), hjust = 1, size = 7.1, colour = Results4_FU_Internal$xlabs), 
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Internal_FU_Plot_Finalb, file = "Internal_FU_Plot_Finalb2.png", height = 4, width = 6)

Internal_FU_Plot_Finalposter <- ggplot(Results4_FU_Internal, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(Category), shape = direction), size = 2) + 
  scale_color_manual(values = mycols, labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Category", size="Effect Size", x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-10 & Category!="Culture/Environment" & Variable != "KBI-p-MH-Services" & Variable != "BPM-4y-Concentrate", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Pval < 5e-10 & Category=="Culture/Environment" & Variable != "PLE-y-SS-Affected-Sum", as.character(Variable), "")), 
                  aes(label=label), color = "goldenrod2", size=2,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "PLE-y-SS-Affected-Sum", as.character(Variable), "")), 
                  aes(label=label), color = "goldenrod2", size=2, nudge_x = 25, nudge_y = .1, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "KBI-p-MH-Services", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  nudge_y = -1.4, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.1) + 
  geom_text_repel(data=. %>% mutate(label = ifelse(Variable == "BPM-4y-Concentrate", as.character(Variable), "")), 
                  aes(label=label, colour = Category), size=2,  nudge_x = -250, nudge_y = -.75, box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2) + 
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/1697), color = "coral3", linetype = 'dashed', size = .5) +
  guides(shape = "none", color = "none") +
  ggtitle(label = "Internalizing Factor PRS PheWAS", subtitle = "Two-Year Follow-Up Phenotypes") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 24)) +
  scale_x_continuous(limits = c(.5, 1763), expand = c(.01, .01)) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks=element_blank(),
        plot.title = element_text(size = 11, hjust = .5, face = "bold"),
        plot.subtitle = element_text(size = 10, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.1, 'cm'),
        legend.box.margin = margin(0,0,0,-10)) 
ggsave(Internal_FU_Plot_Finalposter, file = "Internal_FU_Plot_Finalposter.png", height = 4, width = 6)
```

#### Imaging Plots

```{r}
Global <- rbind(Results_Comp_global, Results_Psych_global, Results_Neuro_global, Results_Internal_global)
Global$PRS <- c(rep("Compulsive", 17), rep("Psychotic", 17), rep("Neurodevelopmental", 17), rep("Internalizing", 17))
Global$PRS <- factor(Global$PRS, levels = c("Compulsive", "Psychotic", "Neurodevelopmental", "Internalizing"))
Global$neg_log_p <- -log10(as.numeric(Global$Pval))
Global$direction <- ifelse(Global$Beta > 0, 1, 0)
Global <- Global %>%
  mutate(Variable2 = ifelse(Variable == "smri_vol_scs_suprateialv", "Supratent. Vol",
                            ifelse(Variable == "smri_vol_cdk_total", "Total Cortical Vol",
                                   ifelse(Variable == "smri_vol_cdk_totallh", "LH Cortical Vol",
                                          ifelse(Variable == "smri_vol_cdk_totalrh", "RH Cortical Vol",
                                                 ifelse(Variable == "smri_vol_scs_wholeb", "Whole Brain Vol",
                                                        ifelse(Variable == "smri_thick_cdk_meanrh", "RH Mean Thick", Variable)))))))

CortVol <- rbind(Results_Comp_CortVol, Results_Psych_CortVol, Results_Neuro_CortVol, Results_Internal_CortVol)
CortVol$PRS <- c(rep("Compulsive", 68), rep("Psychotic", 68), rep("Neurodevelopmental", 68), rep("Internalizing", 68))
CortVol$PRS <- factor(CortVol$PRS, levels = c("Compulsive", "Psychotic", "Neurodevelopmental", "Internalizing"))
CortVol$neg_log_p <- -log10(as.numeric(CortVol$Pval))
CortVol$direction <- ifelse(CortVol$Beta > 0, 1, 0)
CortVol <- CortVol %>%
  mutate(Variable2 = ifelse(Variable == "smri_vol_cdk_precnlh", "LH Precentral", Variable))

CortArea <- rbind(Results_Comp_Cortarea, Results_Psych_Cortarea, Results_Neuro_Cortarea, Results_Internal_Cortarea)
CortArea$PRS <- c(rep("Compulsive", 68), rep("Psychotic", 68), rep("Neurodevelopmental", 68), rep("Internalizing", 68))
CortArea$PRS <- factor(CortArea$PRS, levels = c("Compulsive", "Psychotic", "Neurodevelopmental", "Internalizing"))
CortArea$neg_log_p <- -log10(as.numeric(CortArea$Pval))
CortArea$direction <- ifelse(CortArea$Beta > 0, 1, 0)
CortArea <- CortArea %>%
  mutate(Variable2 = ifelse(Variable == "smri_area_cdk_precnlh", "LH Precentral", 
                            ifelse(Variable == "smri_area_cdk_trvtmrh", "RH Transverse Temporal", Variable)))

CortThick <- rbind(Results_Comp_Cortthick, Results_Psych_Cortthick, Results_Neuro_Cortthick, Results_Internal_Cortthick)
CortThick$PRS <- c(rep("Compulsive", 68), rep("Psychotic", 68), rep("Neurodevelopmental", 68), rep("Internalizing", 68))
CortThick$PRS <- factor(CortThick$PRS, levels = c("Compulsive", "Psychotic", "Neurodevelopmental", "Internalizing"))
CortThick$neg_log_p <- -log10(as.numeric(CortThick$Pval))
CortThick$direction <- ifelse(CortThick$Beta > 0, 1, 0)
CortThick <- CortThick %>%
  mutate(Variable2 = ifelse(Variable == "smri_thick_cdk_parsobisrh", "RH Pars Orbitalis", Variable))

Subcort <- rbind(Results_Comp_subcortVol, Results_Psych_subcortVol, Results_Neuro_subcortVol, Results_Internal_subcortVol)
Subcort$PRS <- c(rep("Compulsive", 35), rep("Psychotic", 35), rep("Neurodevelopmental", 35), rep("Internalizing", 35))
Subcort$PRS <- factor(Subcort$PRS, levels = c("Compulsive", "Psychotic", "Neurodevelopmental", "Internalizing"))
Subcort$neg_log_p <- -log10(as.numeric(Subcort$Pval))
Subcort$direction <- ifelse(Subcort$Beta > 0, 1, 0)
Subcort <- Subcort %>%
  mutate(Variable2 = ifelse(Variable == "smri_vol_scs_4thventricle", "4th Ventricle", 
                            ifelse(Variable == "smri_vol_scs_vedcrh", "RH Ventral DC", Variable)))

RSFC <- rbind(Results_Comp_rsfc, Results_Psych_rsfc, Results_Neuro_rsfc, Results_Internal_rsfc)
RSFC$PRS <- c(rep("Compulsive", 91), rep("Psychotic", 91), rep("Neurodevelopmental", 91), rep("Internalizing", 91))
RSFC$PRS <- factor(RSFC$PRS, levels = c("Compulsive", "Psychotic", "Neurodevelopmental", "Internalizing"))
RSFC$neg_log_p <- -log10(as.numeric(RSFC$Pval))
RSFC$direction <- ifelse(RSFC$Beta > 0, 1, 0)

DTIFA <- rbind(Results_Comp_dtifa, Results_Psych_dtifa, Results_Neuro_dtifa, Results_Internal_dtifa)
DTIFA$PRS <- c(rep("Compulsive", 37), rep("Psychotic", 37), rep("Neurodevelopmental", 37), rep("Internalizing", 37))
DTIFA$PRS <- factor(DTIFA$PRS, levels = c("Compulsive", "Psychotic", "Neurodevelopmental", "Internalizing"))
DTIFA$neg_log_p <- -log10(as.numeric(DTIFA$Pval))
DTIFA$direction <- ifelse(DTIFA$Beta > 0, 1, 0)
DTIFA <- DTIFA %>%
  mutate(Variable2 = ifelse(Variable == "dmri_dtifa_fiberat_cc", "Corpus Callosum", Variable))

DTIMD <- rbind(Results_Comp_dtimd, Results_Psych_dtimd, Results_Neuro_dtimd, Results_Internal_dtimd)
DTIMD$PRS <- c(rep("Compulsive", 37), rep("Psychotic", 37), rep("Neurodevelopmental", 37), rep("Internalizing", 37))
DTIMD$PRS <- factor(DTIMD$PRS, levels = c("Compulsive", "Psychotic", "Neurodevelopmental", "Internalizing"))
DTIMD$neg_log_p <- -log10(as.numeric(DTIMD$Pval))
DTIMD$direction <- ifelse(DTIMD$Beta > 0, 1, 0)



## Global plot
Global$xpos <- c(rep(seq(1,17,1),4))
Global$braintype <- factor(ifelse(grepl("smri", Global$Variable), "sMRI", 
                                  ifelse(grepl("dtifa", Global$Variable), "dMRI FA", "dMRI MD")),
                           levels = c("sMRI", "dMRI FA", "dMRI MD"))
Global_Final <- ggplot(Global, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(braintype), shape = as.factor(direction)), size = 2.3) + 
  scale_color_manual(values = c("steelblue", "darkorange2", "goldenrod3"), labels = c("sMRI", "dMRI FA", "dMRI MD")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Neuroimaging \nMetric", x="", y="-log(p-value)") +
  new_scale_color() +
  geom_text_repel(data=. %>% mutate(label = ifelse(Bonferroni < .05, as.character(Variable2), "")), 
                  aes(label=label, color = braintype), size=2.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2)  +
  scale_color_manual(values = c("steelblue4", "darkorange4", "goldenrod4")) +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/17), color = "coral3", linetype = 'dashed', size = .5) +
  theme_classic() +
  guides(shape = "none", colour = "none") +
  ggtitle(label = "Associations Between PRS and Global Brain Metrics") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 4.2)) +
  ylab("-log(p-value)") +
  theme(axis.text.x = element_blank(), 
        axis.ticks=element_blank(),
        axis.title.y = element_text(size = 10, face = "bold"),
        axis.text.y = element_text(size = 8),
        plot.title = element_text(size = 12, hjust = .5, face = "bold"),
        strip.text = element_text(hjust=.5,vjust = 1,size = 8, margin = margin(b = 2, t = 2)),
        strip.background = element_rect(fill = "white", color = "black"),
        legend.title = element_text(size = 9, face = "bold", hjust = .5),
        legend.text = element_text(size = 9),
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.001, "cm"),
        legend.box.margin = margin(0,0,0,-5)) +
  facet_wrap(~PRS) 
  
ggsave(Global_Final, file = "Global_Final_plot1.png", width = 6, height = 5)

## Cortical Volume plot
CortVol$xpos <- c(rep(seq(1,68,1),4))
CortVol$hemisphere <- factor(ifelse(grepl("lh", CortVol$Variable), "Left Hemisphere", "Right Hemisphere"),
                           levels = c("Left Hemisphere", "Right Hemisphere"))
CortVol_Final <- ggplot(CortVol, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(hemisphere), shape = as.factor(direction)), size = 2.3) + 
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3"), labels = c("Left", "Right")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Hemisphere", x="", y="-log(p-value)") +
  new_scale_color() +
  geom_text_repel(data=. %>% mutate(label = ifelse(Bonferroni < .05, as.character(Variable2), "")), 
                  aes(label=label, color = hemisphere), size=2.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2)  +
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3")) +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/68), color = "coral3", linetype = 'dashed', size = .5) +
  theme_classic() +
  guides(shape = "none", colour = "none") +
  ggtitle(label = "Associations Between PRS and Cortical Volume Brain Metrics") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 4.2)) +
  ylab("-log(p-value)") +
  theme(axis.text.x = element_blank(), 
        axis.ticks=element_blank(),
        axis.title.y = element_text(size = 10, face = "bold"),
        axis.text.y = element_text(size = 8),
        plot.title = element_text(size = 12, hjust = .5, face = "bold"),
        strip.text = element_text(hjust=.5,vjust = 1,size = 8, margin = margin(b = 2, t = 2)),
        strip.background = element_rect(fill = "white", color = "black"),
        legend.title = element_text(size = 9, face = "bold", hjust = .5),
        legend.text = element_text(size = 9),
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.001, "cm"),
        legend.box.margin = margin(0,0,0,-5)) +
  facet_wrap(~PRS) 
  
ggsave(CortVol_Final, file = "CortVol_Final_plot1.png", width = 6, height = 5)

## Cortical Area plot
CortArea$xpos <- c(rep(seq(1,68,1),4))
CortArea$hemisphere <- factor(ifelse(grepl("lh", CortArea$Variable), "Left Hemisphere", "Right Hemisphere"),
                           levels = c("Left Hemisphere", "Right Hemisphere"))
CortArea_Final <- ggplot(CortArea, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(hemisphere), shape = as.factor(direction)), size = 2.3) + 
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3"), labels = c("Left", "Right")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Hemisphere", x="", y="-log(p-value)") +
  new_scale_color() +
  geom_text_repel(data=. %>% mutate(label = ifelse(Bonferroni < .05, as.character(Variable2), "")), 
                  aes(label=label, color = hemisphere), size=2.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2)  +
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3")) +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/68), color = "coral3", linetype = 'dashed', size = .5) +
  theme_classic() +
  guides(shape = "none", colour = "none") +
  ggtitle(label = "Associations Between PRS and Cortical Area Brain Metrics") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 4.2)) +
  ylab("-log(p-value)") +
  theme(axis.text.x = element_blank(), 
        axis.ticks=element_blank(),
        axis.title.y = element_text(size = 10, face = "bold"),
        axis.text.y = element_text(size = 8),
        plot.title = element_text(size = 12, hjust = .5, face = "bold"),
        strip.text = element_text(hjust=.5,vjust = 1,size = 8, margin = margin(b = 2, t = 2)),
        strip.background = element_rect(fill = "white", color = "black"),
        legend.title = element_text(size = 9, face = "bold", hjust = .5),
        legend.text = element_text(size = 9),
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.001, "cm"),
        legend.box.margin = margin(0,0,0,-5)) +
  facet_wrap(~PRS) 
  
ggsave(CortArea_Final, file = "CortArea_Final_plot1.png", width = 6, height = 5)

## Cortical Thick plot
CortThick$xpos <- c(rep(seq(1,68,1),4))
CortThick$hemisphere <- factor(ifelse(grepl("lh", CortThick$Variable), "Left Hemisphere", "Right Hemisphere"),
                           levels = c("Left Hemisphere", "Right Hemisphere"))
CortThick_Final <- ggplot(CortThick, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=as.factor(hemisphere), shape = as.factor(direction)), size = 2.3) + 
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3"), labels = c("Left", "Right")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Hemisphere", x="", y="-log(p-value)") +
  new_scale_color() +
  geom_text_repel(data=. %>% mutate(label = ifelse(Bonferroni < .05, as.character(Variable2), "")), 
                  aes(label=label, color = hemisphere), size=2.5,  box.padding = 0.1, point.padding = .1, size=2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2)  +
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3")) +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/68), color = "coral3", linetype = 'dashed', size = .5) +
  theme_classic() +
  guides(shape = "none", colour = "none") +
  ggtitle(label = "Associations Between PRS and Cortical Thickness Brain Metrics") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 4.2)) +
  ylab("-log(p-value)") +
  theme(axis.text.x = element_blank(), 
        axis.ticks=element_blank(),
        axis.title.y = element_text(size = 10, face = "bold"),
        axis.text.y = element_text(size = 8),
        plot.title = element_text(size = 12, hjust = .5, face = "bold"),
        strip.text = element_text(hjust=.5,vjust = 1,size = 8, margin = margin(b = 2, t = 2)),
        strip.background = element_rect(fill = "white", color = "black"),
        legend.title = element_text(size = 9, face = "bold", hjust = .5),
        legend.text = element_text(size = 9),
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.001, "cm"),
        legend.box.margin = margin(0,0,0,-5)) +
  facet_wrap(~PRS) 
  
ggsave(CortThick_Final, file = "CortThick_Final_plot1.png", width = 6, height = 5)


## Subcortical Volume plot
Subcort$xpos <- c(rep(seq(1,35,1),4))
Subcort$hemisphere <- factor(ifelse(grepl("lh", Subcort$Variable), "Left Hemisphere", 
                                    ifelse(grepl("rh", Subcort$Variable), "Right Hemisphere", "Non-Lateral")),
                           levels = c("Left Hemisphere", "Right Hemisphere", "Non-Lateral"))
Subcort <- Subcort %>%
  arrange(PRS, hemisphere)
Subcort_Final <- ggplot(Subcort %>% arrange(hemisphere), aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=hemisphere, shape = as.factor(direction)), size = 2.3) + 
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3", "deepskyblue1"), labels = c("Left", "Right", "Non-Lateral")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Hemisphere", x="", y="-log(p-value)") +
  new_scale_color() +
  geom_text_repel(data=. %>% mutate(label = ifelse(Bonferroni < .05, as.character(Variable2), "")), 
                  aes(label=label, color = hemisphere), size=2.5,  box.padding = 0.1, point.padding = .1, size=2, nudge_y = .2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2)  +
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3", "deepskyblue3")) +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/35), color = "coral3", linetype = 'dashed', size = .5) +
  theme_classic() +
  guides(shape = "none", colour = "none") +
  ggtitle(label = "Associations Between PRS and \nSubcortical Volume Brain Metrics") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 4.2)) +
  ylab("-log(p-value)") +
  theme(axis.text.x = element_blank(), 
        axis.ticks=element_blank(),
        axis.title.y = element_text(size = 10, face = "bold"),
        axis.text.y = element_text(size = 8),
        plot.title = element_text(size = 12, hjust = .5, face = "bold"),
        strip.text = element_text(hjust=.5,vjust = 1,size = 8, margin = margin(b = 2, t = 2)),
        strip.background = element_rect(fill = "white", color = "black"),
        legend.title = element_text(size = 9, face = "bold", hjust = .5),
        legend.text = element_text(size = 9),
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.001, "cm"),
        legend.box.margin = margin(0,0,0,-5)) +
  facet_wrap(~PRS) 
  
ggsave(Subcort_Final, file = "Subcort_Final_plot1.png", width = 6, height = 5)


## RSFC plot
RSFC$xpos <- c(rep(seq(1,91,1),4))
RSFC$network1 <- factor(rep(c(rep("auditory", 13), rep("cingulo-parietal", 12), rep("cingulo-opercular", 11), rep("dorsal attention", 10), rep("default", 9), rep("fronto-parietal", 8), rep("none", 7), rep("retrosplenial temporal", 6), rep("salience", 5), rep("sensorimotor hand", 4), rep("sensorimotor mouth", 3), rep("visual", 2), "ventral attention"), 4), levels = c("auditory", "cingulo-parietal", "cingulo-opercular", "dorsal attention", "default", "frontal parietal", "none", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention"))
RSFC$network2 <- factor(rep(c("auditory", "cingulo-parietal", "cingulo-opercular", "dorsal attention", "default", "frontal parietal", "none", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention", "cingulo-parietal", "cingulo-opercular", "dorsal attention", "default", "frontal parietal", "none", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention","cingulo-opercular", "dorsal attention", "default", "frontal parietal", "none", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention", "dorsal attention", "default", "frontal parietal", "none", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention", "default", "frontal parietal", "none", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention", "frontal parietal", "none", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention", "none", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention", "sensorimotor mouth", "visual", "ventral attention", "visual", "ventral attention", "ventral attention"), 4), levels = c("auditory", "cingulo-parietal", "cingulo-opercular", "dorsal attention", "default", "frontal parietal", "none", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention"))

color_col = c("orchid3", "dodgerblue4", "mediumpurple4", "seagreen4", "palevioletred4", "goldenrod1", "lemonchiffon3", "slateblue2", "darkslategrey", "turquoise2", "darkorange2", "maroon3", "deepskyblue2", "black")
RSFC_Final <- ggplot(RSFC[1:91,], aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=network2, shape = as.factor(direction)), size = 5) + 
  geom_point(aes(shape = as.factor(direction), color = network1),  size = 3) + 
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  scale_color_manual(values = color_col, labels = c("auditory", "cingulo-parietal", "cingulo-opercular", "dorsal attention", "default", "frontal parietal", "none", "retrosplenial temporal", "salience", "sensorimotor hand", "sensorimotor mouth", "visual", "ventral attention")) +
  labs(color="Network", x="", y="-log(p-value)") +
  new_scale_color() +
  geom_text_repel(data=. %>% mutate(label = ifelse(Bonferroni < .05, as.character(Variable), "")), 
                  aes(label=label, color = network1), size=2.5,  box.padding = 0.1, point.padding = .1, size=2, nudge_y = .2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2)  +
  #scale_color_manual(values = c("deepskyblue4", "deepskyblue3", "deepskyblue3")) +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/35), color = "coral3", linetype = 'dashed', size = .5) +
  theme_classic() +
  guides(shape = "none", colour = "none") +
  ggtitle(label = "Associations Between PRS and Functional Connectivity Metrics") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 4.2)) +
  ylab("-log(p-value)") +
  theme(axis.text.x = element_blank(), 
        axis.ticks=element_blank(),
        axis.title.y = element_text(size = 10, face = "bold"),
        axis.text.y = element_text(size = 8),
        plot.title = element_text(size = 12, hjust = .5, face = "bold"),
        strip.text = element_text(hjust=.5,vjust = 1,size = 8, margin = margin(b = 2, t = 2)),
        strip.background = element_rect(fill = "white", color = "black"),
        legend.title = element_text(size = 9, face = "bold", hjust = .5),
        legend.text = element_text(size = 9),
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.001, "cm"),
        legend.box.margin = margin(0,0,0,-5)) +
  facet_wrap(~PRS) 
  
ggsave(RSFC_Final, file = "RSFC_Final_plot1.png", width = 6, height = 5)

RSFC$Variable[RSFC$Variable=="rsfmri_c_ngd_fo_ngd_fo"] <- "Frontoparietal Network"
RSFC_Final2 <- ggplot(RSFC, aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(shape = as.factor(direction)), color = "orchid4", size = 2.3) + 
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(x="", y="-log(p-value)") +
  geom_text_repel(data=. %>% mutate(label = ifelse(Bonferroni < .05, as.character(Variable), "")), 
                  aes(label=label), color = "orchid4", size=2.5,  box.padding = 0.1, point.padding = .1, size=2, nudge_y = .2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2)  +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/91), color = "coral3", linetype = 'dashed', size = .5) +
  theme_classic() +
  guides(shape = "none", colour = "none") +
  ggtitle(label = "Associations Between PRS and Functional Connectivity Metrics") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 4.2)) +
  ylab("-log(p-value)") +
  theme(axis.text.x = element_blank(), 
        axis.ticks=element_blank(),
        axis.title.y = element_text(size = 10, face = "bold"),
        axis.text.y = element_text(size = 8),
        plot.title = element_text(size = 12, hjust = .5, face = "bold"),
        strip.text = element_text(hjust=.5,vjust = 1,size = 8, margin = margin(b = 2, t = 2)),
        strip.background = element_rect(fill = "white", color = "black"),
        legend.title = element_text(size = 9, face = "bold", hjust = .5),
        legend.text = element_text(size = 9),
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.001, "cm"),
        legend.box.margin = margin(0,0,0,-5)) +
  facet_wrap(~PRS) 
  
ggsave(RSFC_Final2, file = "RSFC_Final_plot2.png", width = 6, height = 5)

## FA PLOT
DTIFA$xpos <- c(rep(seq(1,37,1),4))
DTIFA$hemisphere <- factor(ifelse(grepl("lh", DTIFA$Variable), "Left Hemisphere", 
                                    ifelse(grepl("rh", DTIFA$Variable), "Right Hemisphere", "Non-Lateral")),
                           levels = c("Left Hemisphere", "Right Hemisphere", "Non-Lateral"))
DTIFA <- DTIFA %>%
  arrange(PRS, hemisphere)
DTIFA_Final <- ggplot(DTIFA %>% arrange(hemisphere), aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=hemisphere, shape = as.factor(direction)), size = 2.3) + 
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3", "deepskyblue1"), labels = c("Left", "Right", "Non-Lateral")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Hemisphere", x="", y="-log(p-value)") +
  new_scale_color() +
  geom_text_repel(data=. %>% mutate(label = ifelse(Bonferroni < .05, as.character(Variable2), "")), 
                  aes(label=label, color = hemisphere), size=2.5,  box.padding = 0.1, point.padding = .1, size=2, nudge_y = .2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2)  +
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3", "deepskyblue3")) +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/37), color = "coral3", linetype = 'dashed', size = .5) +
  theme_classic() +
  guides(shape = "none", colour = "none") +
  ggtitle(label = "Associations Between PRS and \nFractional Anisotropy Metrics") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 4.2)) +
  ylab("-log(p-value)") +
  theme(axis.text.x = element_blank(), 
        axis.ticks=element_blank(),
        axis.title.y = element_text(size = 10, face = "bold"),
        axis.text.y = element_text(size = 8),
        plot.title = element_text(size = 12, hjust = .5, face = "bold"),
        strip.text = element_text(hjust=.5,vjust = 1,size = 8, margin = margin(b = 2, t = 2)),
        strip.background = element_rect(fill = "white", color = "black"),
        legend.title = element_text(size = 9, face = "bold", hjust = .5),
        legend.text = element_text(size = 9),
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.001, "cm"),
        legend.box.margin = margin(0,0,0,-5)) +
  facet_wrap(~PRS) 
  
ggsave(DTIFA_Final, file = "DTIFA_Final_plot1.png", width = 6, height = 5)

## MD PLOT
DTIMD$xpos <- c(rep(seq(1,37,1),4))
DTIMD$hemisphere <- factor(ifelse(grepl("lh", DTIMD$Variable), "Left Hemisphere", 
                                    ifelse(grepl("rh", DTIMD$Variable), "Right Hemisphere", "Non-Lateral")),
                           levels = c("Left Hemisphere", "Right Hemisphere", "Non-Lateral"))
DTIMD <- DTIMD %>%
  arrange(PRS, hemisphere)
DTIMD_Final <- ggplot(DTIMD %>% arrange(hemisphere), aes(x=xpos, y=neg_log_p)) + 
  geom_point(aes(col=hemisphere, shape = as.factor(direction)), size = 2.3) + 
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3", "deepskyblue1"), labels = c("Left", "Right", "Non-Lateral")) +
  scale_shape_manual(values = c("\u25BC", "\u25B2")) +
  labs(color="Hemisphere", x="", y="-log(p-value)") +
  new_scale_color() +
  geom_text_repel(data=. %>% mutate(label = ifelse(Bonferroni < .05, as.character(Variable2), "")), 
                  aes(label=label, color = hemisphere), size=2.5,  box.padding = 0.1, point.padding = .1, size=2, nudge_y = .2, segment.color = 'gray32', segment.size = 0.3, arrow = arrow(length = unit(0.007, 'npc')), min.segment.length = 0.2)  +
  scale_color_manual(values = c("deepskyblue4", "deepskyblue3", "deepskyblue3")) +
  geom_hline(yintercept=0, color="black", size=.8, alpha=0.5) +
  geom_hline(yintercept = -log10(.05/37), color = "coral3", linetype = 'dashed', size = .5) +
  theme_classic() +
  guides(shape = "none", colour = "none") +
  ggtitle(label = "Associations Between PRS and \nMean Diffusivity Metrics") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 4.2)) +
  ylab("-log(p-value)") +
  theme(axis.text.x = element_blank(), 
        axis.ticks=element_blank(),
        axis.title.y = element_text(size = 10, face = "bold"),
        axis.text.y = element_text(size = 8),
        plot.title = element_text(size = 12, hjust = .5, face = "bold"),
        strip.text = element_text(hjust=.5,vjust = 1,size = 8, margin = margin(b = 2, t = 2)),
        strip.background = element_rect(fill = "white", color = "black"),
        legend.title = element_text(size = 9, face = "bold", hjust = .5),
        legend.text = element_text(size = 9),
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.001, "cm"),
        legend.box.margin = margin(0,0,0,-5)) +
  facet_wrap(~PRS) 
  
ggsave(DTIMD_Final, file = "DTIMD_Final_plot1.png", width = 6, height = 5)

```

#### BRAIN TO FU PHENOTYPE ANALYSES

```{r}
#PheWAS_FU <- read_excel("FINAL_PheWAS_FU2_n5556_07.29.23.xlsx")

#PheWAS_FU$site_id <- ifelse(PheWAS_FU$site_id == 22, 21, PheWAS_FU$site_id)
#PheWAS_FU[PheWAS_FU == "NA"] <- NA
#PheWAS_FU[PheWAS_FU == ""] <- NA

sig_brain <- MRI%>%
  dplyr::select(subjectkey, mri_info_manufacturer_COV, rsfmri_c_ngd_meanmotion_COV, dmri_dti_meanmotion_COV, smri_thick_cdk_mean, smri_area_cdk_total, smri_vol_scs_subcorticalgv, dmri_dtifa_fiberat_allfibers, 
                smri_thick_cdk_meanrh, smri_vol_cdk_total, smri_vol_cdk_totallh, smri_vol_cdk_totalrh, smri_vol_scs_suprateialv, smri_vol_scs_wholeb, smri_vol_cdk_precnlh, smri_area_cdk_precnlh, smri_area_cdk_trvtmrh, smri_thick_cdk_parsobisrh, smri_vol_scs_4thventricle, smri_vol_scs_vedcrh, rsfmri_c_ngd_fo_ngd_fo, dmri_dtifa_fiberat_cc) 

sig_brain[,1:2] <- lapply(sig_brain[,1:2], as.factor)
sig_brain[,3:22] <- lapply(sig_brain[,3:22], as.numeric)

sig_brain <- sig_brain %>%
  mutate_if(is.numeric, scale)

Psychotic_FU_sig <- ResultsFU2_comp[ResultsFU2_comp$Bonferroni < 0.05, ]
Neurodev_FU_sig <- ResultsFU3_comp[ResultsFU3_comp$Bonferroni < 0.05, ]

Psychotic_FU_sig_df <- PheWAS_FU[colnames(PheWAS_FU) %in% Psychotic_FU_sig$Variable]
Neurodev_FU_sig_df <- PheWAS_FU[colnames(PheWAS_FU) %in% Neurodev_FU_sig$Variable]

Psychotic_brain_sig <- cbind(PheWAS_FU[, 1:21], sig_brain[,-1], Psychotic_FU_sig_df)
Neurodev_brain_sig <- cbind(PheWAS_FU[, 1:21], sig_brain[,-1], Neurodev_FU_sig_df)

Psychotic_brain_sig[, c(1:4,20:22)] <- lapply(Psychotic_brain_sig[,c(1:4,20:22)],as.factor)
Psychotic_brain_sig[, c(5:19,23:44)] <- lapply(Psychotic_brain_sig[,c(5:19,23:44)],as.numeric)

#Psychotic_brain_sig <- Psychotic_brain_sig %>%
 # dplyr::select(-su_caff_intake_9_calc_l) %>%
#  mutate_if(is.numeric, scale) %>%
#  left_join(., Psychotic_brain_sig[, c("subjectkey","su_caff_intake_9_calc_l")], by = "subjectkey")

Psychotic_brain_sig <- as.data.frame(Psychotic_brain_sig)

psychotic_pars_mod <- lmer(srpf_y_ss_iiss ~ smri_thick_cdk_parsobisrh + sex + interview_age + mri_info_manufacturer_COV + smri_thick_cdk_mean + COVID_visittype + (1|site_id) + (1|rel_family_id), data = Psychotic_brain_sig)
summary(psychotic_pars_mod)

psychotic_ventraldc_mod <- lmer(srpf_y_ss_iiss ~ smri_vol_scs_vedcrh + sex + interview_age + mri_info_manufacturer_COV + smri_vol_scs_subcorticalgv + COVID_visittype + (1|site_id) + (1|rel_family_id), data = Psychotic_brain_sig)
summary(psychotic_ventraldc_mod)

psychotic_fiberat_cc_mod <- lmer(srpf_y_ss_iiss ~ dmri_dtifa_fiberat_cc + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + dmri_dtifa_fiberat_allfibers + COVID_visittype + (1|site_id) + (1|rel_family_id), data = Psychotic_brain_sig)
summary(psychotic_fiberat_cc_mod)

psychotic_pars_mod2 <- lmer(su_caff_intake_9_calc_l ~ smri_thick_cdk_parsobisrh + sex + interview_age + mri_info_manufacturer_COV + smri_thick_cdk_mean + COVID_visittype + (1|site_id) + (1|rel_family_id), data = Psychotic_brain_sig)
summary(psychotic_pars_mod2) 
#est = -0.02464, p = 0.00111

psychotic_ventraldc_mod2 <- lmer(su_caff_intake_9_calc_l ~ smri_vol_scs_vedcrh + sex + interview_age + mri_info_manufacturer_COV + smri_vol_scs_subcorticalgv + COVID_visittype + (1|site_id) + (1|rel_family_id), data = Psychotic_brain_sig)
summary(psychotic_ventraldc_mod2)

psychotic_fiberat_cc_mod2 <- lmer(su_caff_intake_9_calc_l ~ dmri_dtifa_fiberat_cc + sex + interview_age + mri_info_manufacturer_COV + dmri_dti_meanmotion_COV + dmri_dtifa_fiberat_allfibers + COVID_visittype + (1|site_id) + (1|rel_family_id), data = Psychotic_brain_sig)
summary(psychotic_fiberat_cc_mod2)

# FDR1
p.adjust(c(.544, 0.00111), method = "fdr")
# FDR2
p.adjust(c(.544, .691, .863, 0.00111, .12, .145), method = "fdr")
# Bonferroni
p.adjust(c(.544, .691, .863, 0.00111, .12, .145), method = "bonferroni")

Neurodev_brain_sig[, c(1:4,20:22, 240:256)] <- lapply(Neurodev_brain_sig[,c(1:4,20:22, 240:256)],as.factor)
Neurodev_brain_sig[, c(5:19,23:239)] <- lapply(Neurodev_brain_sig[,c(5:19,23:239)],as.numeric)

#Neurodev_brain_sig <- Neurodev_brain_sig %>%
#  mutate_if(is.numeric, scale)

Neurodev_brain_sig <- as.data.frame(Neurodev_brain_sig)

Neurodev_brain_sig_sexvar <- Neurodev_brain_sig %>%
  dplyr::select(subjectkey:dmri_dtifa_fiberat_cc, contains("pds"), contains("menstrual"), contains("gish"))

#Neurodev_brain_sig_other <- Neurodev_brain_sig  %>%
#  select(subjectkey:dmri_dtifa_fiberat_cc, contains("biospec"), contains("fitbit"))

Neurodev_brain_sig2 <- Neurodev_brain_sig %>%
  dplyr::select(-contains("pds"), -contains("menstrual"), -contains("gish"))


#### CDK TOT VOL ####
attach(Neurodev_brain_sig2)

First <- 43
Last <- 235
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(Neurodev_brain_sig2[,i] ~ smri_vol_cdk_total + sex + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(Neurodev_brain_sig2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_vol_tot_cont <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_vol_tot_cont) <- c("Variable", "Beta", "STE", "Pval")

set.seed(10)
First <- 236 
Last <- 252 
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  LMEOut <- withWarnings( a <- glmer(Neurodev_brain_sig2[,i] ~ smri_vol_cdk_total + sex + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|site_id) + (1|rel_family_id), nAGQ = 0, family = "binomial"))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(Neurodev_brain_sig2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_vol_tot_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_vol_tot_cat) <- c("Variable", "Beta", "STE", "Pval")

detach(Neurodev_brain_sig2)
attach(Neurodev_brain_sig_sexvar)

First <- 43
Last <- 46
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  LMEOut <- withWarnings( a <- lmer(Neurodev_brain_sig_sexvar[,i] ~ smri_vol_cdk_total + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(Neurodev_brain_sig_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_vol_tot_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_vol_tot_sexvar) <- c("Variable", "Beta", "STE", "Pval")
detach(Neurodev_brain_sig_sexvar)

Results_Neur_vol_tot <- rbind(Results_Neur_vol_tot_cont, Results_Neur_vol_tot_cat, Results_Neur_vol_tot_sexvar)
Results_Neur_vol_tot$FDR <- p.adjust(Results_Neur_vol_tot$Pval, method = "fdr")
Results_Neur_vol_tot$Bonferroni <- p.adjust(Results_Neur_vol_tot$Pval, method = "fdr")



#### CDK RH THICK ####
attach(Neurodev_brain_sig2)

First <- 43
Last <- 235
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(Neurodev_brain_sig2[,i] ~ smri_thick_cdk_meanrh + sex + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(Neurodev_brain_sig2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_thick_rh_cont <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_thick_rh_cont) <- c("Variable", "Beta", "STE", "Pval")

set.seed(10)
First <- 236 
Last <- 252
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  LMEOut <- withWarnings( a <- glmer(Neurodev_brain_sig2[,i] ~ smri_thick_cdk_meanrh + sex + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|site_id) + (1|rel_family_id), nAGQ = 0, family = "binomial"))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(Neurodev_brain_sig2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_thick_rh_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_thick_rh_cat) <- c("Variable", "Beta", "STE", "Pval")

detach(Neurodev_brain_sig2)
attach(Neurodev_brain_sig_sexvar)

First <- 43
Last <- 46
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  LMEOut <- withWarnings( a <- lmer(Neurodev_brain_sig_sexvar[,i] ~ smri_thick_cdk_meanrh + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(Neurodev_brain_sig_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_thick_rh_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_thick_rh_sexvar) <- c("Variable", "Beta", "STE", "Pval")
detach(Neurodev_brain_sig_sexvar)

Results_Neur_thick_rh <- rbind(Results_Neur_thick_rh_cont, Results_Neur_thick_rh_cat, Results_Neur_thick_rh_sexvar)
Results_Neur_thick_rh$FDR <- p.adjust(Results_Neur_thick_rh$Pval, method = "fdr")
Results_Neur_thick_rh$Bonferroni <- p.adjust(Results_Neur_thick_rh$Pval, method = "fdr")



#### Supratentorial volume ####
attach(Neurodev_brain_sig2)

First <- 43
Last <- 235
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(Neurodev_brain_sig2[,i] ~ smri_vol_scs_suprateialv + sex + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(Neurodev_brain_sig2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_suprateialv_cont <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_suprateialv_cont) <- c("Variable", "Beta", "STE", "Pval")

set.seed(10)
First <- 236 
Last <- 252 
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  LMEOut <- withWarnings( a <- glmer(Neurodev_brain_sig2[,i] ~ smri_vol_scs_suprateialv + sex + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|site_id) + (1|rel_family_id), nAGQ = 0, family = "binomial"))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(Neurodev_brain_sig2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_suprateialv_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_suprateialv_cat) <- c("Variable", "Beta", "STE", "Pval")

detach(Neurodev_brain_sig2)
attach(Neurodev_brain_sig_sexvar)

First <- 43
Last <- 46
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  LMEOut <- withWarnings( a <- lmer(Neurodev_brain_sig_sexvar[,i] ~ smri_vol_scs_suprateialv + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(Neurodev_brain_sig_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_suprateialv_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_suprateialv_sexvar) <- c("Variable", "Beta", "STE", "Pval")
detach(Neurodev_brain_sig_sexvar)

Results_Neur_suprateialv <- rbind(Results_Neur_suprateialv_cont, Results_Neur_suprateialv_cat, Results_Neur_suprateialv_sexvar)
Results_Neur_suprateialv$FDR <- p.adjust(Results_Neur_suprateialv$Pval, method = "fdr")
Results_Neur_suprateialv$Bonferroni <- p.adjust(Results_Neur_suprateialv$Pval, method = "fdr")



#### Whole brain volume ####
attach(Neurodev_brain_sig2)

First <- 43
Last <- 235
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(Neurodev_brain_sig2[,i] ~ smri_vol_scs_wholeb + sex + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(Neurodev_brain_sig2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_wholeb_cont <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_wholeb_cont) <- c("Variable", "Beta", "STE", "Pval")

set.seed(10)
First <- 236 
Last <- 252 
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  LMEOut <- withWarnings( a <- glmer(Neurodev_brain_sig2[,i] ~ smri_vol_scs_wholeb + sex + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|site_id) + (1|rel_family_id), nAGQ = 0, family = "binomial"))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(Neurodev_brain_sig2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_wholeb_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_wholeb_cat) <- c("Variable", "Beta", "STE", "Pval")

detach(Neurodev_brain_sig2)
attach(Neurodev_brain_sig_sexvar)

First <- 43
Last <- 46
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  LMEOut <- withWarnings( a <- lmer(Neurodev_brain_sig_sexvar[,i] ~ smri_vol_scs_wholeb + interview_age + mri_info_manufacturer_COV + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(Neurodev_brain_sig_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_wholeb_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_wholeb_sexvar) <- c("Variable", "Beta", "STE", "Pval")
detach(Neurodev_brain_sig_sexvar)

Results_Neur_wholeb <- rbind(Results_Neur_wholeb_cont, Results_Neur_wholeb_cat, Results_Neur_wholeb_sexvar)
Results_Neur_wholeb$FDR <- p.adjust(Results_Neur_wholeb$Pval, method = "fdr")
Results_Neur_wholeb$Bonferroni <- p.adjust(Results_Neur_wholeb$Pval, method = "fdr")


#### 4th ventricle volume ####
attach(Neurodev_brain_sig2)

First <- 43
Last <- 235
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(Neurodev_brain_sig2[,i] ~ smri_vol_scs_4thventricle + sex + interview_age + mri_info_manufacturer_COV + COVID_visittype + smri_vol_scs_subcorticalgv + (1|site_id) + (1|rel_family_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(Neurodev_brain_sig2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_4thventricle_cont <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_4thventricle_cont) <- c("Variable", "Beta", "STE", "Pval")

set.seed(10)
First <- 236 
Last <- 252 
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  LMEOut <- withWarnings( a <- glmer(Neurodev_brain_sig2[,i] ~ smri_vol_scs_4thventricle + sex + interview_age + mri_info_manufacturer_COV + COVID_visittype + smri_vol_scs_subcorticalgv + (1|site_id) + (1|rel_family_id), nAGQ = 0, family = "binomial"))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(Neurodev_brain_sig2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_4thventricle_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_4thventricle_cat) <- c("Variable", "Beta", "STE", "Pval")

detach(Neurodev_brain_sig2)
attach(Neurodev_brain_sig_sexvar)

First <- 43
Last <- 46
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  LMEOut <- withWarnings( a <- lmer(Neurodev_brain_sig_sexvar[,i] ~ smri_vol_scs_4thventricle + interview_age + mri_info_manufacturer_COV + COVID_visittype + smri_vol_scs_subcorticalgv + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(Neurodev_brain_sig_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_Neur_4thventricle_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_Neur_4thventricle_sexvar) <- c("Variable", "Beta", "STE", "Pval")
detach(Neurodev_brain_sig_sexvar)

Results_Neur_4thventricle <- rbind(Results_Neur_4thventricle_cont, Results_Neur_4thventricle_cat, Results_Neur_4thventricle_sexvar)
Results_Neur_4thventricle$FDR <- p.adjust(Results_Neur_4thventricle$Pval, method = "fdr")
Results_Neur_4thventricle$Bonferroni <- p.adjust(Results_Neur_4thventricle$Pval, method = "fdr")


Results_brain_pheno <- rbind(Results_Neur_vol_tot, Results_Neur_thick_rh, Results_Neur_suprateialv, Results_Neur_wholeb, Results_Neur_4thventricle)
brain_region <- as.data.frame(c(rep("vol_tot", 214), rep("thk_rh", 214), rep("suprateialv", 214), rep("wholeb", 214), rep("4th_ven", 214)))
colnames(brain_region) <- "brain_region"
Results_brain_pheno <- as.data.frame(cbind(brain_region, Results_brain_pheno))
Results_brain_pheno$FDR2 <- p.adjust(Results_brain_pheno$Pval, method = "fdr")
Results_brain_pheno$Bonferroni <- p.adjust(Results_brain_pheno$Pval, method = "bonferroni")
fwrite(Results_brain_pheno, "PheWAS_BraintoPheno_Results_bonf2_8.13.23.txt", sep = "\t")

#Results_brain_pheno <- fread("PheWAS_BraintoPheno_Results_bonf2_8.13.23.txt", sep = "\t")
```

#### Mediation

```{r}
library(mediation)


FU_covar <- PheWAS_FU[,c(1:21)]
colnames(FU_covar)[19] <- "FU_age"
FU_covar[,"sex"] <- NULL
baseline_covar <- PheWAS_baseline[, c("interview_age", "sex")]
colnames(baseline_covar)[1] <- "FU2_age"
sig_outcomes <- Results_brain_pheno[Results_brain_pheno$Bonferroni < .05,]
sig_outcomes_df <- PheWAS_FU[colnames(PheWAS_FU) %in% sig_outcomes$Variable] 

sig_brain_psych <- MRI %>%
  dplyr::select(mri_info_manufacturer_COV, smri_thick_cdk_mean, smri_thick_cdk_parsobisrh) %>%
  mutate_at(c("smri_thick_cdk_mean", "smri_thick_cdk_parsobisrh"), as.numeric) %>%
  mutate_if(is.numeric, scale)

meddata_psych <- cbind.data.frame(FU_covar, baseline_covar, sig_brain_psych, as.data.frame(PheWAS_FU[,c( "su_caff_intake_9_calc_l")]))
colnames(meddata_psych)[26] <- "su_caff_intake_9_calc_l"

sig_brain <- MRI %>%
  dplyr::select(mri_info_manufacturer_COV, smri_vol_scs_subcorticalgv, smri_vol_cdk_total, smri_vol_cdk_totallh, smri_vol_scs_suprateialv, smri_vol_scs_wholeb, smri_vol_scs_4thventricle) %>%
  mutate_at(c("smri_vol_scs_subcorticalgv", "smri_vol_cdk_total", "smri_vol_cdk_totallh", "smri_vol_scs_suprateialv", "smri_vol_scs_wholeb", "smri_vol_scs_4thventricle"), as.numeric) %>%
  mutate_if(is.numeric, scale)

meddata <- cbind(FU_covar, baseline_covar, sig_brain, sig_outcomes_df)


sig_cortvol <- Results_brain_pheno[Results_brain_pheno$brain_region=="vol_tot" & Results_brain_pheno$Bonferroni <.05]
sig_cortvol <- sig_cortvol$Variable
meddata_cortvol <- cbind.data.frame(meddata[,1:23], meddata[, "smri_vol_cdk_total"], meddata[colnames(meddata) %in% sig_cortvol])
colnames(meddata_cortvol)[24] <- "smri_vol_cdk_total"

fwrite(meddata_cortvol, file = "meddata_cortvol.csv")
  
sig_supra <- Results_brain_pheno[Results_brain_pheno$brain_region=="suprateialv" & Results_brain_pheno$Bonferroni <.05]
sig_supra <- sig_supra$Variable
meddata_supra <- cbind.data.frame(meddata[,1:23], meddata[, "smri_vol_scs_suprateialv"], meddata[colnames(meddata) %in% sig_supra])
colnames(meddata_supra)[24] <- "smri_vol_scs_suprateialv"

fwrite(meddata_supra, file = "meddata_supra.csv")

sig_wholeb <- Results_brain_pheno[Results_brain_pheno$brain_region=="wholeb" & Results_brain_pheno$Bonferroni <.05]
sig_wholeb <- sig_wholeb$Variable
meddata_wholeb <- cbind.data.frame(meddata[,1:23], meddata[, "smri_vol_scs_wholeb"], meddata[colnames(meddata) %in% sig_wholeb])
colnames(meddata_wholeb)[24] <- "smri_vol_scs_wholeb"

fwrite(meddata_wholeb, file = "meddata_wholeb.csv")


meddata_cortvol3 <- meddata_cortvol %>%
  filter(!is.na(demo_med_insur_d_p)&!is.na(mri_info_manufacturer_COV)&!is.na(COVID_visittype)&!is.na(site_id)&!is.na(sex)&!is.na(smri_vol_cdk_total)) %>%
  mutate(demo_med_insur_d_p = as.numeric(as.character(demo_med_insur_d_p)))
model1 <- lmer(smri_vol_cdk_total ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + FU2_age + sex + mri_info_manufacturer_COV + site_id + (1|rel_family_id), data = meddata_cortvol3)
  model2 <- lmer(demo_med_insur_d_p ~ Neurodev_PRScs + smri_vol_cdk_total + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + FU_age + sex + mri_info_manufacturer_COV + COVID_visittype + site_id + (1|rel_family_id), data = meddata_cortvol3)
  fit <- mediation::mediate(model1, model2, treat = "Neurodev_PRScs", mediator = "smri_vol_cdk_total", sims = 10000)
fitsum_cortvol_insur <- summary(fit)

meddata_cortvol3 <- meddata_cortvol %>%
  filter(!is.na(kbi_p_conflict_causes_l___6)&!is.na(mri_info_manufacturer_COV)&!is.na(COVID_visittype)&!is.na(site_id)&!is.na(sex)&!is.na(smri_vol_cdk_total)) %>%
  mutate(kbi_p_conflict_causes_l___6 = as.numeric(as.character(kbi_p_conflict_causes_l___6)))
model1 <- lmer(smri_vol_cdk_total ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + FU2_age + sex + mri_info_manufacturer_COV + site_id + (1|rel_family_id), data = meddata_cortvol3)
  model2 <- lmer(kbi_p_conflict_causes_l___6 ~ Neurodev_PRScs + smri_vol_cdk_total + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + FU_age + sex + mri_info_manufacturer_COV + COVID_visittype + site_id + (1|rel_family_id), data = meddata_cortvol3)
  fit <- mediation::mediate(model1, model2, treat = "Neurodev_PRScs", mediator = "kbi_p_conflict_causes_l___6", sims = 10000)
fitsum_cortvol_kbi <- summary(fit)
  
cortvol_results <- fread("medresults_cortvol_10000.csv")
colnames(cortvol_results) <- c("Outcome", "ACME", "ACME_L", "ACME_U", "ACME_P", "ADE", "Total", "PropMed", "PropMed_P")
cortvol_cat_results <- data.frame(Outcome = c("demo_med_insur_d_p", "kbi_p_conflict_causes_l___6"),
                                     ACME = c(0.000799, 0),
                                     ACME_L = c(0.000296, 0),
                                     ACME_U = c(0.0014378265, 0),
                                     ACME_P = c(6e-04, 1),
                                     ADE = c(0.015390, 0.01293),
                                     Total = c(0.016189, 0.01293),
                                     PropMed = c(0.048297, 0),
                                     PropMed_P = c(6e-04, 1))

cortvol_results_full <- rbind(cortvol_results, cortvol_cat_results)
cortvol_results_full$sig <- ifelse(cortvol_results_full$ACME_P < .001, 1, 0)
fwrite(cortvol_results_full, file = "cortvol_results_full.csv")

meddata_supra3 <- meddata_supra %>%
  filter(!is.na(demo_med_insur_d_p)&!is.na(mri_info_manufacturer_COV)&!is.na(COVID_visittype)&!is.na(site_id)&!is.na(sex)&!is.na(smri_vol_scs_suprateialv)) %>%
  mutate(demo_med_insur_d_p = as.numeric(as.character(demo_med_insur_d_p)))
model1 <- lmer(smri_vol_scs_suprateialv ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + FU2_age + sex + mri_info_manufacturer_COV + site_id + (1|rel_family_id), data = meddata_supra3)
  model2 <- lmer(demo_med_insur_d_p ~ Neurodev_PRScs + smri_vol_scs_suprateialv + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + FU_age + sex + mri_info_manufacturer_COV + COVID_visittype + site_id + (1|rel_family_id), data = meddata_supra3)
  fit <- mediation::mediate(model1, model2, treat = "Neurodev_PRScs", mediator = "smri_vol_scs_suprateialv", sims = 10000)
fitsum_supra_insur <- summary(fit)



supra_results <- fread("medresults_supra_10000.csv")
colnames(supra_results) <- c("Outcome", "ACME", "ACME_L", "ACME_U", "ACME_P", "ADE", "Total", "PropMed", "PropMed_P")
supra_cat_results <- data.frame(Outcome = c("demo_med_insur_d_p"),
                                     ACME = c(0.000688),
                                     ACME_L = c(0.000221),
                                     ACME_U = c(0.0012833266),
                                     ACME_P = c(0.0018),
                                     ADE = c(0.015439),
                                     Total = c(0.016127),
                                     PropMed = c(0.041716),
                                     PropMed_P = c(0.0018))
supra_results_full <- rbind(supra_results, supra_cat_results)
supra_results_full$sig <- ifelse(supra_results_full$ACME_P < 0.001162791, 1, 0)
fwrite(supra_results_full, file = "supra_results_full.csv")

meddata_wholeb3 <- meddata_wholeb %>%
  filter(!is.na(demo_med_insur_d_p)&!is.na(mri_info_manufacturer_COV)&!is.na(COVID_visittype)&!is.na(site_id)&!is.na(sex)&!is.na(smri_vol_scs_wholeb)) %>%
  mutate(demo_med_insur_d_p = as.numeric(as.character(demo_med_insur_d_p)))
model1 <- lmer(smri_vol_scs_wholeb ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + FU2_age + sex + mri_info_manufacturer_COV + site_id + (1|rel_family_id), data = meddata_wholeb3)
  model2 <- lmer(demo_med_insur_d_p ~ Neurodev_PRScs + smri_vol_scs_wholeb + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + FU_age + sex + mri_info_manufacturer_COV + COVID_visittype + site_id + (1|rel_family_id), data = meddata_wholeb3)
  fit <- mediation::mediate(model1, model2, treat = "Neurodev_PRScs", mediator = "smri_vol_scs_wholeb", sims = 10000)
fitsum_wholeb_insur <- summary(fit)

wholeb_results <- fread("medresults_wholeb_10000.csv")
colnames(wholeb_results) <- c("Outcome", "ACME", "ACME_L", "ACME_U", "ACME_P", "ADE", "Total", "PropMed", "PropMed_P")
wholeb_cat_results <- data.frame(Outcome = c("demo_med_insur_d_p"),
                                     ACME = c(0.000707),
                                     ACME_L = c(0.000218),
                                     ACME_U = c(0.0013299584),
                                     ACME_P = c(0.0024),
                                     ADE = c(0.015513),
                                     Total = c(0.016220),
                                     PropMed = c(0.042454),
                                     PropMed_P = c(0.0024))
wholeb_results_full <- rbind(wholeb_results, wholeb_cat_results)
wholeb_results_full$sig <- ifelse(wholeb_results_full$ACME_P < 0.001, 1, 0)
fwrite(wholeb_results_full, file = "wholeb_results_full.csv")

meddata_psych2 <- meddata_psych %>%
  filter(!is.na(su_caff_intake_9_calc_l)&!is.na(mri_info_manufacturer_COV)&!is.na(COVID_visittype)&!is.na(site_id)&!is.na(sex)&!is.na(smri_thick_cdk_parsobisrh))
model1 <- lmer(smri_thick_cdk_parsobisrh ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + FU2_age + sex + mri_info_manufacturer_COV + site_id + (1|rel_family_id), data = meddata_psych2)
  model2 <- lmer(su_caff_intake_9_calc_l ~ Psychotic_PRScs + smri_thick_cdk_parsobisrh + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + FU_age + sex + mri_info_manufacturer_COV + COVID_visittype + site_id + (1|rel_family_id), data = meddata_psych2)
  fit <- mediation::mediate(model1, model2, treat = "Psychotic_PRScs", mediator = "smri_thick_cdk_parsobisrh", sims = 10000)
psych_med_fit <- summary(fit)

```

#### More Plots

```{r}
## broader categories

Categories <- c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health","Family Mental Health", "Child Mental Health")
Total_Count_base <- c(208, 179, 124, 946, 365, 1202, 697, 2473)
Retained_Count_base <- c(14, 18, 27, 46, 111, 175, 239, 637)
Total_Count_FU <- c(172, 239, 149, 769, 1293, 1734, 283, 5517)
Retained_Count_FU <- c(8, 104, 26, 119, 439, 202, 158, 634)
barplotdf <- data.frame(Categories, Total_Count_base, Retained_Count_base, Total_Count_FU, Retained_Count_FU)

barplotdf$Categories <- as.factor(barplotdf$Categories)

barplotdf <- reshape2::melt(barplotdf, id.vars = 'Categories') 

barplotdf$wave <- factor(c(rep("Baseline", 16), rep("2-Year-Follow-Up", 16)), levels = c("Baseline", "2-Year-Follow-Up"))
barplotdf$variable <- c(rep("Total", 8),rep("Retained", 8), rep("Total", 8),rep("Retained", 8))
barplotdf$Categories <- factor(barplotdf$Categories, levels = barplotdf$Categories[1:8])
names(barplotdf)[1] <- "Category"
names(barplotdf)[2] <- "Total/Retained"
barplotdf$`Total/Retained` <- factor(barplotdf$`Total/Retained`, levels = c("Total", "Retained"))
barplotdf$xpos <- c(seq(1,15,2), seq(2,16,2),seq(1,15,2), seq(2,16,2))


barplot3 <- barplotdf %>%
ggplot(aes(x = xpos, y = as.numeric(value))) +
  geom_col(aes(x = xpos, fill = Category, alpha = factor(`Total/Retained`)), position = position_dodge(preserve = "single")) +#, show.legend = F) +
  scale_fill_manual(values = mycols) +
  scale_alpha_manual(values = c(1, .5), guide = "none") +
  theme_classic() +
  xlab("Category") +
  ylab("Count") +
  ggtitle("# Phenotypes/Domain: Total & Retained") +
  scale_y_continuous(limits = c(0, 5610), breaks = seq(0, 5610, 250), expand = c(0.01,0.01)) +
  scale_x_continuous(limits = c(0.5,16.5), expand = c(0.01,0.01), breaks = seq(1,16,2), labels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health","Family Mental Health", "Child Mental Health")) +
  theme(text = element_text(size = 12),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 6),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8, face = "bold"),
        plot.title = element_blank(),
        strip.text = element_text(hjust=.5,vjust = 1,size = 9, margin = margin(b = 1.7, t = 2)),
        strip.background = element_rect(fill = "white", color = "#2C3A48"),
        legend.title = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 7),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.0001, "cm"),
        legend.box.margin = margin(0,0,0,0)) +
  geom_text(aes(label = value, x = xpos), hjust = 0.5, vjust = -.5, size = 2, nudge_y = -8) +
  facet_wrap(~wave)

ggsave(barplot3, file = "barplot4.png", width = 5, height = 4)

```

#### Summary Plot

```{r}
sigsneurbase <- Results3_Neurodev[Results3_Neurodev$Bonferroni < .05,]
table(sigsneurbase$Category)
sigsintbase <- Results4_Internal[Results4_Internal$Bonferroni < .05,]
table(sigsintbase$Category)
sigsneurFU <- Results3_FU_Neurodev[Results3_FU_Neurodev$Bonferroni < .05,]
table(sigsneurFU$Category)
sigsintFU <- Results4_FU_Internal[Results4_FU_Internal$Bonferroni < .05,]
table(sigsintFU$Category)

Categories <- c(rep(c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"), 8))
PRS <- rep(c(rep("Compulsive", 8), rep("Psychotic", 8), rep("Neurodevelopmental", 8), rep("Internalizing", 8)), 2)
Wave <- c(rep("Baseline", 32), rep("2-Year Follow-Up", 32))

NumSigs <- c(rep(0,16), 
             3, 10, 3, 6, 3, 9, 11, 145,
             1, 4, 1, 5, 0, 12, 27, 74,
             rep(0,8),
             0, 0, 0, 1, 1, 0, 0, 0, 
             1, 18, 2, 8, 39, 11, 0, 135,
             0, 10, 2, 5, 29, 10, 19, 108)

Totals <- c(rep(c(14, 18, 27, 46, 111, 175, 239, 637),4), rep(c(8, 104, 26, 119, 439, 202, 158, 634), 4))
results_barplotdf <- data.frame(Categories, PRS, Wave, NumSigs, Totals)

results_barplotdf$Categories <- factor(results_barplotdf$Categories, levels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))
results_barplotdf$PRS <- factor(results_barplotdf$PRS, levels = c("Compulsive", "Psychotic", "Neurodevelopmental", "Internalizing"))
results_barplotdf$Wave <- factor(results_barplotdf$Wave, levels = c("Baseline", "2-Year Follow-Up"))

totalsdf <- data.frame(Wave = c(rep("Baseline", 8), rep("2-Year-Follow-Up", 8)),
                      Totals = c(14, 18, 27, 46, 111, 175, 239, 637, 8, 104, 26, 119, 439, 202, 158, 634),
                      x = rep(c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")),2)

results_barplot <-  results_barplotdf %>%
ggplot(aes(x = NumSigs, y = Categories, fill = PRS, label = Totals)) +
  geom_col() +
  scale_fill_manual(values = c("darkorange", "turquoise4", "mediumorchid4", "goldenrod")) +
  theme_bw() +
  ylab("Category") +
  xlab("Number of Significantly Associated Phenotypes") +
  labs(fill = "Polygenic Risk Score") +
  scale_x_continuous(limits = c(0, 250), breaks = seq(0, 250, 25), expand = c(0.01,0.01)) +
  theme(text = element_text(size = 12),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 12,  hjust = 0.5, face = "bold"),
        strip.text = element_text(hjust=.5,vjust = 1,size = 10, margin = margin(b = 2, t = 2)),
        strip.background = element_rect(fill = "white", colour = "black"),
        legend.title = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.0001, "cm"), 
        legend.position = "top",
        legend.box.margin = margin(0,0,-7,0)) +
  facet_wrap(~Wave, strip.position = "top", ncol = 2)  +
  geom_text(x = rep(261,64), y = Categories, size = 2.2) +
  coord_cartesian(xlim = c(0, 250), # This focuses the x-axis on the range of interest
                      clip = 'off') +
  theme(plot.margin = unit(c(1,1,1,1), "lines"), panel.spacing=unit(1.2,"lines"))

ggsave(results_barplot, file = "results_barplot2.png", width = 7, height = 3)



sigsneurbase <- Results3_Neurodev[Results3_Neurodev$Bonferroni < .05,]
table(sigsneurbase$Category)
sigsintbase <- Results4_Internal[Results4_Internal$Bonferroni < .05,]
table(sigsintbase$Category)
sigsneurFU <- Results3_FU_Neurodev[Results3_FU_Neurodev$Bonferroni < .05,]
table(sigsneurFU$Category)
sigsintFU <- Results4_FU_Internal[Results4_FU_Internal$Bonferroni < .05,]
table(sigsintFU$Category)

Categories <- c(rep(c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"), 8))
PRS <- rep(c(rep("Compulsive", 8), rep("Psychotic", 8), rep("Neurodevelopmental", 8), rep("Internalizing", 8)), 2)
Wave <- c(rep("Baseline", 32), rep("2-Year Follow-Up", 32))

NumSigs <- c(rep(0,16), 
             3, 10, 3, 6, 3, 9, 11, 145,
             1, 4, 1, 5, 0, 12, 27, 74,
             rep(0,8),
             0, 0, 0, 1, 1, 0, 0, 0, 
             1, 18, 2, 8, 39, 11, 0, 135,
             0, 10, 2, 5, 29, 10, 19, 108)

Totals <- c(rep(c(14, 18, 27, 46, 111, 175, 239, 637),4), rep(c(8, 104, 26, 119, 439, 202, 158, 634), 4))
results_barplotdf <- data.frame(Categories, PRS, Wave, NumSigs, Totals)

results_barplotdf$Categories <- factor(results_barplotdf$Categories, levels = c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))
results_barplotdf$PRS <- factor(results_barplotdf$PRS, levels = c("Compulsive", "Psychotic", "Neurodevelopmental", "Internalizing"))
results_barplotdf$Wave <- factor(results_barplotdf$Wave, levels = c("Baseline", "2-Year Follow-Up"))

totalsdf <- data.frame(Wave = c(rep("Baseline", 8), rep("2-Year-Follow-Up", 8)),
                      Totals = c(14, 18, 27, 46, 111, 175, 239, 637, 8, 104, 26, 119, 439, 202, 158, 634),
                      x = rep(c("Cognition", "Screen Time", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health")),2)
results_barplotdf_base <- results_barplotdf %>%
  filter(Wave == "Baseline")
results_barplot_base <-  results_barplotdf_base %>%
ggplot(aes(x = NumSigs, y = Categories, fill = PRS, label = Totals)) +
  geom_col() +
  scale_fill_manual(values = c("darkorange", "turquoise4", "mediumorchid4", "goldenrod")) +
  theme_bw() +
  ylab("Category") +
  xlab("Number of Significantly Associated Phenotypes") +
  labs(fill = "Polygenic Risk Score") +
  scale_x_continuous(limits = c(0, 250), breaks = seq(0, 250, 50), expand = c(0.01,0.01)) +
  theme(text = element_text(size = 12),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 12,  hjust = 0.5, face = "bold"),
        legend.title = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.0001, "cm"), 
        legend.position = "top",
        legend.box.margin = margin(0,0,-7,0)) +
  geom_text(x = rep(258,32), y = results_barplotdf_base$Categories, size = 2.2) +
  coord_cartesian(xlim = c(0, 250), # This focuses the x-axis on the range of interest
                      clip = 'off') +
  theme(plot.margin = unit(c(1,1,1,1), "lines"), panel.spacing=unit(1.2,"lines"))

# Convert to a ggplot and print
leg <- get_legend(results_barplot_base)
leg<-as_ggplot(leg)
leg<-leg+theme(plot.margin = margin(-50,0,-50,0))
#leg4
ggsave(leg, file = "results_barplot_legend.png", width = 6, height = 0.3)

results_barplot_base <- results_barplot_base + theme(legend.position = "none")

ggsave(results_barplot_base, file = "results_barplot_base.png", width = 6, height = 3)


results_barplotdf_FU <- results_barplotdf %>%
  filter(Wave == "2-Year Follow-Up")
results_barplot_FU <-  results_barplotdf_FU %>%
ggplot(aes(x = NumSigs, y = Categories, fill = PRS, label = Totals)) +
  geom_col() +
  scale_fill_manual(values = c("darkorange", "turquoise4", "mediumorchid4", "goldenrod")) +
  theme_bw() +
  ylab("Category") +
  xlab("Number of Significantly Associated Phenotypes") +
  labs(fill = "Polygenic Risk Score") +
  scale_x_continuous(limits = c(0, 250), breaks = seq(0, 250, 50), expand = c(0.01,0.01)) +
  theme(text = element_text(size = 12),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 12,  hjust = 0.5, face = "bold"),
        legend.title = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 8),
        legend.key.size = unit(.4, 'cm'),
        legend.spacing.y = unit(.0001, "cm"), 
        legend.position = "top",
        legend.box.margin = margin(0,0,-7,0)) +
  geom_text(x = rep(258,32), y = results_barplotdf_base$Categories, size = 2.2) +
  coord_cartesian(xlim = c(0, 250), # This focuses the x-axis on the range of interest
                      clip = 'off') +
  theme(plot.margin = unit(c(1,1,1,1), "lines"), panel.spacing=unit(1.2,"lines"))


results_barplot_FU <- results_barplot_FU + theme(legend.position = "none")

ggsave(results_barplot_FU, file = "results_barplot_FU.png", width = 6, height = 3)
```

#### Supplemental Heatmap Results

```{r}
Compbase <- read.csv("Compulsive_results_base_8.4.23.csv", header = T)
Compbase$PRS <- rep("Compulsive", 1271)
Psychbase <- read.csv("Psychotic_results_base_8.11.23.csv", header = T)
Psychbase$PRS <- rep("Psychotic", 1271)
Neurbase <- read.csv("Neurodev_results_base_8.11.23.csv", header = T)
Neurbase$PRS <- rep("Neurodevel", 1271)
Intbase <- read.csv("Internalizing_results_base_8.11.23.csv", header = T)
Intbase$PRS <- rep("Internal", 1271)

sigs_neur <- Neurbase[Neurbase$Bonferroni < .05,]
sigs_int <- Intbase[Intbase$Bonferroni < .05,]
sigsbase <- merge(sigs_neur, sigs_int, by = "Variable", all = T)

sigsbase <- rbind(Compbase[Compbase$Variable %in% sigsbase$Variable,],
                  Psychbase[Psychbase$Variable %in% sigsbase$Variable,],
                  Neurbase[Neurbase$Variable %in% sigsbase$Variable,],
                  Intbase[Intbase$Variable %in% sigsbase$Variable,])

sigsbase <- sigsbase %>%
  mutate(Category = ifelse(grepl('tlfb|path|isip|su_|caff|rules_|peer_dev', Variable) & 
                             !grepl('devhx', Variable), "Substance",
                           ifelse(grepl('crpbi|fes|prosocial|school|reshist|monitor|neighborhood|enviro|pmq|psb_|nsc_|srpf', Variable) & !grepl('profess|kbi', Variable), "Culture/Environment",
                                  ifelse(grepl('ksad|cbcl|prodrom|pps_|upps|bisbas|bis_|resiliency|kbi|gen_child|pgbi|bpm|ADHD', Variable) & !grepl('monitor|parent_rules|prosocial|fes_youth|asr_|famhx|fam_hist', Variable), "Child Mental Health",
                                                     ifelse(grepl('asr_|famhx|fam_hist|q1|q2|q4|q5|q6|q9', Variable) & !grepl('cbcl|ksads|bpm|parent_mon|parent_rul|fes_|prosocial', Variable), "Family Mental Health",
                                                            ifelse(grepl('medhx|devhx|tbi|pds|puber|sports|sai_|filtered_|anthro|child_|antidep_|sds_|sleep|weight|SSRI|antidep|hormon_sal|medicat', Variable) & !grepl('demo|gen_child', Variable), "Physical Health",
                                                                   ifelse(grepl('nihtbx|RAVLT|cash|lmt|wisc', Variable), "Cognition",
                                                                           ifelse(grepl('screen|stq', Variable), "Screentime",
                                                                                  ifelse(grepl('demo|prnt_wor|prtnr_wor', Variable), "Demographics", 999))))))))) %>%
  
  mutate(Category = factor(Category, levels = c("Cognition", "Screentime", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))) %>%
  mutate(PRS = factor(PRS, levels = c("Compulsive", "Psychotic", "Neurodevel", "Internal")))

sigsbase <- sigsbase[order(sigsbase$Category),]

fwrite(sigsbase, file = "sigsbase_9.28.23.txt", sep = "\t")
sigsbase <- fread("sigsbase_9.28.23_rename.txt", header = T, data.table = F)

factvar <- sapply(PheWAS_baseline, is.factor)
factbase <- PheWAS_baseline[, factvar]
factbase <- colnames(factbase)

sigsbase <- sigsbase %>%
  mutate(Category3 = factor(Category3, levels = c("Family History of Psychopathology", "Caregiver Behavior (ASR)", "Child Behavior (BPMT)", "Child Behavior (CBCL)", "Impulsive Personality Traits", "School Issues & Performance", "Substance Use & Attitudes", "Cognition", "Environment/Demographics", "KSADS DSM-5 Symptoms", "Mania & Psychosis Symptoms", "Other Child Mental Health", "Birth/Pregnancy", "Sleep", "Other Physical Health", "Screentime"))) %>%
  arrange(Category3, Variable_Rename) %>%
  mutate(PRS = factor(PRS, levels = c("Compulsive", "Psychotic", "Neurodevel", "Internal"))) %>%
  mutate(OR = ifelse(Variable %in% factbase, exp(Beta), NA)) %>%
  mutate(factor = ifelse(!is.na(OR), 1, 0))


sigsbasea <- sigsbase[1:500,]
sigsbaseb <- sigsbase[501:992,]

myPalette <- colorRampPalette(rev(brewer.pal(11, "RdYlBu")), space="rgb")
myPalette2 <- colorRampPalette(rev(brewer.pal(11, "PiYG")), space="rgb")

hmbase1 <- ggplot(sigsbasea, aes(x = PRS, y = Rename2, fill = OR)) +
  geom_tile(color = "white") +
  scale_fill_gradientn(colours = myPalette2(100), limits = c(.4, 1.6))+ 
  guides(fill = "none") + 
  new_scale_fill() +
  geom_tile(data = subset(sigsbasea, factor == 0), color = "white", aes(fill = Beta)) +
  scale_fill_gradientn(colours = myPalette(100), limits = c(-.5, .5))+ 
  scale_y_discrete(position = "left") +
  scale_x_discrete(expand = c(0,0)) +
  theme_minimal() +
  geom_text(aes(label = ifelse(Bonferroni < .05, "*", "")), size = 1.5, nudge_y = -.125) +
  theme(axis.text.x = element_text(size = 6, hjust = .5),
        axis.title.x = element_text(size = 8),
        axis.text.y = element_text(size = 4.8, hjust = 1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank()) +
  ggforce::facet_col(facets = vars(Category3), 
                     scales = "free_y", 
                     space = "free") +
  theme(strip.text = element_text(hjust=.5,vjust = 1,size = 5, margin = margin(b = .1, t = .2), face = "bold"),
        strip.background = element_rect(fill = "white", color = "white"),
        panel.spacing=unit(0,'npc'),
        plot.margin = unit(c(1.18,.1,0,.1), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.direction = "horizontal", 
        legend.position = c(.5,1.04),
        legend.key.width = unit(1, 'cm'),
        legend.key.height = unit(.2, 'cm'),
        legend.margin=margin(0, 2, 0, 0),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 5)) +
  guides(fill = guide_colorbar(label.position = "top", 
            title.position = "right", title.vjust = 0.13)) 

hmbase2 <- ggplot(sigsbaseb, aes(x = PRS, y = Rename2, fill = Beta)) +
  geom_tile(color = "white") +
  scale_fill_gradientn(colours = myPalette(100),limits = c(-.5, .5))+
  guides(fill = "none") +
  new_scale_fill() +
  geom_tile(data = subset(sigsbaseb, factor == 1), color = "white", aes(fill = OR)) +
  scale_fill_gradientn(colours = myPalette2(100), limits = c(.4, 1.6))+ 
  scale_y_discrete(position = "right") +
  scale_x_discrete(expand = c(0,0)) +
  theme_minimal() +
  geom_text(aes(label = ifelse(Bonferroni < .05, "*", "")), size = 1.5, nudge_y = -.125) +
  theme(axis.text.x = element_text(size = 6, hjust = .5,),
        axis.title.x = element_text(size = 8),
        axis.text.y = element_text(size = 4.8, hjust = 0),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank()) +
  ggforce::facet_col(facets = vars(Category3), 
                     scales = "free_y", 
                     space = "free") +
  theme(strip.text = element_text(hjust=.5,vjust = 1,size = 5, margin = margin(b = .1, t = .2), face = "bold"),
        strip.background = element_rect(fill = "white", color = "white"),
        panel.spacing=unit(0,'npc'),
        plot.margin = unit(c(1.18,.1,0,.1), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.direction = "horizontal", 
        legend.position = c(.5,1.04),
        legend.key.width = unit(1, 'cm'),
        legend.key.height = unit(.2, 'cm'),
        legend.margin=margin(0, 0, 0, 2),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 5)) +
  guides(fill = guide_colorbar(label.position = "top", 
            title.position = "right", title.vjust = 0.13))
hm_base <- ggarrange(hmbase1, hmbase2, ncol = 2)
ggsave(hm_base, file = "Baseline_heatmap_RESUB.png", width = 7, height = 8)




CompFU <- fread("Compulsive_results_FU_8.25.23.txt", header = T, data.table = F)
CompFU$PRS <- rep("Compulsive", 1697)
PsychFU <- fread("Psychotic_results_FU_8.27.23.txt", header = T, data.table = F)
PsychFU$PRS <- rep("Psychotic", 1697)
NeurFU <- fread("Neurodev_results_FU_8.27.23.txt", header = T, data.table = F)
NeurFU$PRS <- rep("Neurodevel", 1697)
IntFU <- fread("Internalizing_results_FU_8.27.23.txt", header = T, data.table = F)
IntFU$PRS <- rep("Internal", 1697)

sigsFU_neur <- NeurFU[NeurFU$Bonferroni < .05,]
sigsFU_int <- IntFU[IntFU$Bonferroni < .05,]
sigsFU <- merge(sigsFU_neur, sigsFU_int, by = "Variable", all = T)

sigsFU <- rbind(CompFU[CompFU$Variable %in% sigsFU$Variable,],
                  PsychFU[PsychFU$Variable %in% sigsFU$Variable,],
                  NeurFU[NeurFU$Variable %in% sigsFU$Variable,],
                  IntFU[IntFU$Variable %in% sigsFU$Variable,])

sigsFU <- sigsFU %>%
  mutate(Category = ifelse(grepl('tlfb|path|isip|su_|caff|rules_|peer_dev|ascq|ptu_|meeq|phs_|aeq_', Variable) & !grepl('caff_ago|caff_24', Variable), "Substance",
                           ifelse(grepl('crpbi|fes|prosocial|school|reshist|monitor|neighborhood|enviro|pmq|ple_|cybb|pnh_|nsc_|psb_|sag_|comc|srpf_|dim_mat|dim_y|pbp_|peq', Variable) & !grepl('profess|kbi|eatq|screen|mctq', Variable), "Culture/Environment",
                                  ifelse(grepl('ksad|cbcl|prodrom|pps_|upps|bisbas|bis_|resiliency|kbi|gen_child|pgbi|bpmt|bpm|sup_|eatq_|ssrs_|poa_|ksad', Variable) & !grepl('monitor|parent_rules|prosocial|fes_youth|asr_|famhx|fam_hist|abcl|screen|dim_matrix|dim_yes', Variable), "Child Mental Health",
                                         ifelse(grepl('asr_|famhx|fam_hist|q1|q2|q4|q5|q6|q9|abcl', Variable) & !grepl('cbcl|ksads|bpmt|parent|fes_|prosocial|screen|dim_matrix|dim_yes', Variable), "Family Mental Health",
                                                ifelse(grepl('medhx|devhx|tbi|pds|puber|sports|sai_|filtered_|anthro|child_|antidep_|sds_|sleep|weight|SSRI|antidepressant|bkfs|mctq|gish|physical_activity|pain_last|brought|blood_pressure|pain_|menstrual|biospec|fitbit|caff_ago|caff_24', Variable) & !grepl('demo|gen_child|screen|ksad', Variable), "Physical Health",
                                                                    ifelse(grepl('nihtbx|RAVLT|lmt', Variable), "Cognition",
                                                                          ifelse(grepl('screen|stq', Variable), "Screentime", "Demographics")))))))) %>%
  mutate(Category = factor(Category, levels = c("Cognition", "Screentime", "Demographics", "Substance", "Culture/Environment", "Physical Health", "Family Mental Health", "Child Mental Health"))) %>%
  mutate(PRS = factor(PRS, levels = c("Compulsive", "Psychotic", "Neurodevel", "Internal")))

sigsFU <- sigsFU[order(sigsFU$Category),]

fwrite(sigsFU, file = "sigsFU_9.29.23.txt", sep = "\t")
sigsFU <- fread("sigsFU_9.29.23_rename.txt", header = T, data.table = F)

factvar <- sapply(PheWAS_FU, is.factor)
factFU <- PheWAS_FU[, factvar]
factFU <- colnames(factFU)

sigsFU <- sigsFU %>%
  mutate(Category3 = factor(Category3, levels = c("Child Behavior (BPMT)", "Child Behavior (BPM)", "Child Behavior (CBCL)", "Child Behavior (EATQ)", "Impulsive Personality Traits", "Substance Use & Attitudes", "Cognition", "Diet", "Caregiver Behavior (ASR)", "School Issues & Performance",  "Environment/Demographics", "Life Events, Victimization", "Mania & Psychosis Symptoms", "Other Child Mental Health", "Puberty, Sexual & Gender Identity", "Sleep",  "Screentime"))) %>%
  arrange(Category3, Variable_Rename) %>%
  mutate(PRS = factor(PRS, levels = c("Compulsive", "Psychotic", "Neurodevel", "Internal"))) %>%
  mutate(OR = ifelse(Variable %in% factFU, exp(Beta), NA)) %>%
  mutate(factor = ifelse(!is.na(OR), 1, 0))


sigsFUa <- sigsFU[1:584,]
sigsFUb <- sigsFU[585:1180,]

myPalette <- colorRampPalette(rev(brewer.pal(11, "RdYlBu")), space="rgb")
myPalette2 <- colorRampPalette(rev(brewer.pal(11, "PiYG")), space="rgb")

hmFU1 <- ggplot(sigsFUa, aes(x = PRS, y = Variable_Rename, fill = OR)) +
  geom_tile(color = "white") +
  scale_fill_gradientn(colours = myPalette2(100), limits = c(.4, 1.6))+ 
  guides(fill = "none") + 
  new_scale_fill() +
  geom_tile(data = subset(sigsFUa, factor == 0), color = "white", aes(fill = Beta)) +
  scale_fill_gradientn(colours = myPalette(100), limits = c(-.5, .5))+ 
  scale_y_discrete(position = "left") +
  scale_x_discrete(expand = c(0,0)) +
  theme_minimal() +
  geom_text(aes(label = ifelse(Bonferroni < .05, "*", "")), size = 1.5, nudge_y = -.125) +
  theme(axis.text.x = element_text(size = 6, hjust = .5),
        axis.title.x = element_text(size = 8),
        axis.text.y = element_text(size = 4.8, hjust = 1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank()) +
  ggforce::facet_col(facets = vars(Category3), 
                     scales = "free_y", 
                     space = "free") +
  theme(strip.text = element_text(hjust=.5,vjust = 1,size = 5, margin = margin(b = .1, t = .2), face = "bold"),
        strip.background = element_rect(fill = "white", color = "white"),
        panel.spacing=unit(0,'npc'),
        plot.margin = unit(c(1.18,.1,0,.1), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.direction = "horizontal", 
        legend.position = c(.5,1.04),
        legend.key.width = unit(1, 'cm'),
        legend.key.height = unit(.2, 'cm'),
        legend.margin=margin(0, 2, 0, 0),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 5)) +
  guides(fill = guide_colorbar(label.position = "top", 
            title.position = "right", title.vjust = 0.13)) 

hmFU2 <- ggplot(sigsFUb, aes(x = PRS, y = Variable_Rename, fill = Beta)) +
  geom_tile(color = "white") +
  scale_fill_gradientn(colours = myPalette(100),limits = c(-.5, .5))+
  guides(fill = "none") +
  new_scale_fill() +
  geom_tile(data = subset(sigsFUb, factor == 1), color = "white", aes(fill = OR)) +
  scale_fill_gradientn(colours = myPalette2(100), limits = c(.4, 1.6))+ 
  scale_y_discrete(position = "right") +
  scale_x_discrete(expand = c(0,0)) +
  theme_minimal() +
  geom_text(aes(label = ifelse(Bonferroni < .05, "*", "")), size = 1.5, nudge_y = -.125) +
  theme(axis.text.x = element_text(size = 6, hjust = .5,),
        axis.title.x = element_text(size = 8),
        axis.text.y = element_text(size = 4.8, hjust = 0),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank()) +
  ggforce::facet_col(facets = vars(Category3), 
                     scales = "free_y", 
                     space = "free") +
  theme(strip.text = element_text(hjust=.5,vjust = 1,size = 5, margin = margin(b = .1, t = .2), face = "bold"),
        strip.background = element_rect(fill = "white", color = "white"),
        panel.spacing=unit(0,'npc'),
        plot.margin = unit(c(1.18,.1,0,.1), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.direction = "horizontal", 
        legend.position = c(.5,1.04),
        legend.key.width = unit(1, 'cm'),
        legend.key.height = unit(.2, 'cm'),
        legend.margin=margin(0, 0, 0, 2),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 5)) +
  guides(fill = guide_colorbar(label.position = "top", 
            title.position = "right", title.vjust = 0.13))
hm_FU <- ggarrange(hmFU1, hmFU2, ncol = 2)
ggsave(hm_FU, file = "FU_heatmap_RESUB.png", width = 7, height = 8.5)


```

#### Supplemental controlling for CBCL Total baseline

```{r}
PheWAS_baseline_cbcltot <- PheWAS_baseline %>%
    relocate(cbcl_scr_syn_totprob_r, .after = "sex")
attach(PheWAS_baseline_cbcltot)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 656
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_cbcltot[,i] ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_cbcltot)[i]
  Warn[i] <- LMEOut$warnings
}

#Store results in a dataframe
Results_cbcl <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_cbcl) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_cbcl_mod1 <- lmer(reshist_state_immigrant_factor ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_f4_p_cbcl_mod1 <- lmer(pds_f4_p ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_f4_2_y_cbcl_mod1 <- lmer(pds_f4_2_y ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m4_y_cbcl_mod1 <- lmer(pds_m4_y ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m5_y_cbcl_mod1 <- lmer(pds_m5_y ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m5_p_cbcl_mod1 <- lmer(pds_m5_p ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m4_p_cbcl_mod1 <- lmer(pds_m4_p ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_p_ss_female_category_2_cbcl_mod1 <- lmer(pds_p_ss_female_category_2 ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_p_ss_male_category_2_cbcl_mod1 <- lmer(pds_p_ss_male_category_2 ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_y_ss_female_category_2_cbcl_mod1 <- lmer(pds_y_ss_female_category_2 ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_y_ss_male_cat_2_cbcl_mod1 <- lmer(pds_y_ss_male_cat_2 ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

medhx_6m_times_cbcl_mod1 <- lmer(medhx_6m_times ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

medhx_6n_notes_cbcl_mod1 <- lmer(medhx_6n_notes ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

medhx_6p_notes_cbcl_mod1 <- lmer(medhx_6p_notes ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

which(colnames(PheWAS_baseline_cbcltot) == "medhx_6p_notes")

## merging the results from the above models 
Variable <- colnames(PheWAS_baseline_cbcltot[657:670])
Beta <- c(coef(summary(reshist_state_immigrant_factor_cbcl_mod1))[2,1], coef(summary(pds_f4_p_cbcl_mod1))[2,1], coef(summary(pds_m5_y_cbcl_mod1))[2,1], coef(summary(pds_f4_2_y_cbcl_mod1))[2,1], coef(summary(pds_m4_y_cbcl_mod1))[2,1], coef(summary(pds_m5_p_cbcl_mod1))[2,1],coef(summary(pds_m4_p_cbcl_mod1))[2,1],
          coef(summary(pds_p_ss_female_category_2_cbcl_mod1))[2,1], coef(summary(pds_p_ss_male_category_2_cbcl_mod1))[2,1], coef(summary(pds_y_ss_female_category_2_cbcl_mod1))[2,1], coef(summary(pds_y_ss_male_cat_2_cbcl_mod1))[2,1], coef(summary(medhx_6m_times_cbcl_mod1))[2,1], coef(summary(medhx_6n_notes_cbcl_mod1))[2,1], coef(summary(medhx_6p_notes_cbcl_mod1))[2,1])
coef(summary(reshist_state_immigrant_factor_cbcl_mod1))[2,2]
coef(summary(reshist_state_immigrant_factor_cbcl_mod1))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_cbcl_mod1))[2,2], coef(summary(pds_f4_p_cbcl_mod1))[2,2], coef(summary(pds_f4_2_y_cbcl_mod1))[2,2], coef(summary(pds_m4_y_cbcl_mod1))[2,2], coef(summary(pds_m5_y_cbcl_mod1))[2,2], coef(summary(pds_m5_p_cbcl_mod1))[2,2], coef(summary(pds_m4_p_cbcl_mod1))[2,2], coef(summary(pds_p_ss_female_category_2_cbcl_mod1))[2,2], coef(summary(pds_p_ss_male_category_2_cbcl_mod1))[2,2], coef(summary(pds_y_ss_female_category_2_cbcl_mod1))[2,2], coef(summary(pds_y_ss_male_cat_2_cbcl_mod1))[2,2], coef(summary(medhx_6m_times_cbcl_mod1))[2,2], coef(summary(medhx_6n_notes_cbcl_mod1))[2,2], coef(summary(medhx_6p_notes_cbcl_mod1))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_cbcl_mod1))[2,5], coef(summary(pds_f4_p_cbcl_mod1))[2,5], coef(summary(pds_f4_2_y_cbcl_mod1))[2,5], coef(summary(pds_m4_y_cbcl_mod1))[2,5], coef(summary(pds_m5_y_cbcl_mod1))[2,5],coef(summary(pds_m5_p_cbcl_mod1))[2,5], coef(summary(pds_m4_p_cbcl_mod1))[2,5], coef(summary(pds_p_ss_female_category_2_cbcl_mod1))[2,5], coef(summary(pds_p_ss_male_category_2_cbcl_mod1))[2,5], coef(summary(pds_y_ss_female_category_2_cbcl_mod1))[2,5], coef(summary(pds_y_ss_male_cat_2_cbcl_mod1))[2,5], coef(summary(medhx_6m_times_cbcl_mod1))[2,5], coef(summary(medhx_6n_notes_cbcl_mod1))[2,5], coef(summary(medhx_6p_notes_cbcl_mod1))[2,5])
Results_cbcl_b <- cbind(Variable, Beta, STE, Pval)

# merging with the other results
Results_cbcl_cont <- rbind(Results_cbcl, Results_cbcl_b)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 671
Last <- 1291
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_cbcltot[,i] ~ Compulsive_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_cbcltot)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_cbcl_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(Results_cbcl_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
Results_cbcl <- rbind(Results_cbcl_cont, Results_cbcl_cat)
# 2 tiers of FDR correction
Results_cbcl$FDR <- p.adjust(Results_cbcl$Pval, method="fdr")
Results$Results_cbcl <- p.adjust(Results_cbcl$Pval, method = "bonferroni")
#Write out results
fwrite(Results_cbcl, "Compulsive_results_base_cbcltot_8.17.23.csv")



# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 656
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results3 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_cbcltot[,i] ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_cbcltot)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results3 in a dataframe
Results3_cbcl <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results3
colnames(Results3_cbcl) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_cbcl_mod3 <- lmer(reshist_state_immigrant_factor ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_f4_p_cbcl_mod3 <- lmer(pds_f4_p ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_f4_2_y_cbcl_mod3 <- lmer(pds_f4_2_y ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m4_y_cbcl_mod3 <- lmer(pds_m4_y ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m5_y_cbcl_mod3 <- lmer(pds_m5_y ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m5_p_cbcl_mod3 <- lmer(pds_m5_p ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m4_p_cbcl_mod3 <- lmer(pds_m4_p ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_p_ss_female_category_2_cbcl_mod3 <- lmer(pds_p_ss_female_category_2 ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_p_ss_male_category_2_cbcl_mod3 <- lmer(pds_p_ss_male_category_2 ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_y_ss_female_category_2_cbcl_mod3 <- lmer(pds_y_ss_female_category_2 ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_y_ss_male_cat_2_cbcl_mod3 <- lmer(pds_y_ss_male_cat_2 ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

medhx_6m_times_cbcl_mod3 <- lmer(medhx_6m_times ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

medhx_6n_notes_cbcl_mod3 <- lmer(medhx_6n_notes ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

medhx_6p_notes_cbcl_mod3 <- lmer(medhx_6p_notes ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

which(colnames(PheWAS_baseline_cbcltot) == "medhx_6p_notes")

## merging the Results3 from the above models 
Variable <- colnames(PheWAS_baseline_cbcltot[657:670])
Beta <- c(coef(summary(reshist_state_immigrant_factor_cbcl_mod3))[2,1], coef(summary(pds_f4_p_cbcl_mod3))[2,1], coef(summary(pds_m5_y_cbcl_mod3))[2,1], coef(summary(pds_f4_2_y_cbcl_mod3))[2,1], coef(summary(pds_m4_y_cbcl_mod3))[2,1], coef(summary(pds_m5_p_cbcl_mod3))[2,1],coef(summary(pds_m4_p_cbcl_mod3))[2,1],
          coef(summary(pds_p_ss_female_category_2_cbcl_mod3))[2,1], coef(summary(pds_p_ss_male_category_2_cbcl_mod3))[2,1], coef(summary(pds_y_ss_female_category_2_cbcl_mod3))[2,1], coef(summary(pds_y_ss_male_cat_2_cbcl_mod3))[2,1], coef(summary(medhx_6m_times_cbcl_mod3))[2,1], coef(summary(medhx_6n_notes_cbcl_mod3))[2,1], coef(summary(medhx_6p_notes_cbcl_mod3))[2,1])
coef(summary(reshist_state_immigrant_factor_cbcl_mod3))[2,2]
coef(summary(reshist_state_immigrant_factor_cbcl_mod3))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_cbcl_mod3))[2,2], coef(summary(pds_f4_p_cbcl_mod3))[2,2], coef(summary(pds_f4_2_y_cbcl_mod3))[2,2], coef(summary(pds_m4_y_cbcl_mod3))[2,2], coef(summary(pds_m5_y_cbcl_mod3))[2,2], coef(summary(pds_m5_p_cbcl_mod3))[2,2], coef(summary(pds_m4_p_cbcl_mod3))[2,2], coef(summary(pds_p_ss_female_category_2_cbcl_mod3))[2,2], coef(summary(pds_p_ss_male_category_2_cbcl_mod3))[2,2], coef(summary(pds_y_ss_female_category_2_cbcl_mod3))[2,2], coef(summary(pds_y_ss_male_cat_2_cbcl_mod3))[2,2], coef(summary(medhx_6m_times_cbcl_mod3))[2,2], coef(summary(medhx_6n_notes_cbcl_mod3))[2,2], coef(summary(medhx_6p_notes_cbcl_mod3))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_cbcl_mod3))[2,5], coef(summary(pds_f4_p_cbcl_mod3))[2,5], coef(summary(pds_f4_2_y_cbcl_mod3))[2,5], coef(summary(pds_m4_y_cbcl_mod3))[2,5], coef(summary(pds_m5_y_cbcl_mod3))[2,5],coef(summary(pds_m5_p_cbcl_mod3))[2,5], coef(summary(pds_m4_p_cbcl_mod3))[2,5], coef(summary(pds_p_ss_female_category_2_cbcl_mod3))[2,5], coef(summary(pds_p_ss_male_category_2_cbcl_mod3))[2,5], coef(summary(pds_y_ss_female_category_2_cbcl_mod3))[2,5], coef(summary(pds_y_ss_male_cat_2_cbcl_mod3))[2,5], coef(summary(medhx_6m_times_cbcl_mod3))[2,5], coef(summary(medhx_6n_notes_cbcl_mod3))[2,5], coef(summary(medhx_6p_notes_cbcl_mod3))[2,5])
Results3_cbcl_b <- cbind(Variable, Beta, STE, Pval)

# merging with the other Results3
Results3_cbcl_cont <- rbind(Results3_cbcl, Results3_cbcl_b)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 671
Last <- 1291
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results3 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_cbcltot[,i] ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_cbcltot)[i]
  Warn[i] <- LMEOut$warnings
}
#Store Results3 in a dataframe
Results3_cbcl_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results3
colnames(Results3_cbcl_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
Results3_cbcl <- rbind(Results3_cbcl_cont, Results3_cbcl_cat)
# 2 tiers of FDR correction
Results3_cbcl$FDR <- p.adjust(Results3_cbcl$Pval, method="fdr")
Results3_cbcl$Bonferroni <- p.adjust(Results3_cbcl$Pval, method = "bonferroni")
#Write out Results3
fwrite(Results3_cbcl, "Neurodev_Results_base_cbcltot_8.17.23.csv")





# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 656
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results4 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_cbcltot[,i] ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_cbcltot)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results4 in a dataframe
Results4_cbcl <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results4
colnames(Results4_cbcl) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_cbcl_mod4 <- lmer(reshist_state_immigrant_factor ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_f4_p_cbcl_mod4 <- lmer(pds_f4_p ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_f4_2_y_cbcl_mod4 <- lmer(pds_f4_2_y ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m4_y_cbcl_mod4 <- lmer(pds_m4_y ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m5_y_cbcl_mod4 <- lmer(pds_m5_y ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m5_p_cbcl_mod4 <- lmer(pds_m5_p ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_m4_p_cbcl_mod4 <- lmer(pds_m4_p ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_p_ss_female_category_2_cbcl_mod4 <- lmer(pds_p_ss_female_category_2 ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_p_ss_male_category_2_cbcl_mod4 <- lmer(pds_p_ss_male_category_2 ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_y_ss_female_category_2_cbcl_mod4 <- lmer(pds_y_ss_female_category_2 ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

pds_y_ss_male_cat_2_cbcl_mod4 <- lmer(pds_y_ss_male_cat_2 ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

medhx_6m_times_cbcl_mod4 <- lmer(medhx_6m_times ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

medhx_6n_notes_cbcl_mod4 <- lmer(medhx_6n_notes ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

medhx_6p_notes_cbcl_mod4 <- lmer(medhx_6p_notes ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_cbcltot)

which(colnames(PheWAS_baseline_cbcltot) == "medhx_6p_notes")

## merging the Results4 from the above models 
Variable <- colnames(PheWAS_baseline_cbcltot[657:670])
Beta <- c(coef(summary(reshist_state_immigrant_factor_cbcl_mod4))[2,1], coef(summary(pds_f4_p_cbcl_mod4))[2,1], coef(summary(pds_m5_y_cbcl_mod4))[2,1], coef(summary(pds_f4_2_y_cbcl_mod4))[2,1], coef(summary(pds_m4_y_cbcl_mod4))[2,1], coef(summary(pds_m5_p_cbcl_mod4))[2,1],coef(summary(pds_m4_p_cbcl_mod4))[2,1],
          coef(summary(pds_p_ss_female_category_2_cbcl_mod4))[2,1], coef(summary(pds_p_ss_male_category_2_cbcl_mod4))[2,1], coef(summary(pds_y_ss_female_category_2_cbcl_mod4))[2,1], coef(summary(pds_y_ss_male_cat_2_cbcl_mod4))[2,1], coef(summary(medhx_6m_times_cbcl_mod4))[2,1], coef(summary(medhx_6n_notes_cbcl_mod4))[2,1], coef(summary(medhx_6p_notes_cbcl_mod4))[2,1])
coef(summary(reshist_state_immigrant_factor_cbcl_mod4))[2,2]
coef(summary(reshist_state_immigrant_factor_cbcl_mod4))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_cbcl_mod4))[2,2], coef(summary(pds_f4_p_cbcl_mod4))[2,2], coef(summary(pds_f4_2_y_cbcl_mod4))[2,2], coef(summary(pds_m4_y_cbcl_mod4))[2,2], coef(summary(pds_m5_y_cbcl_mod4))[2,2], coef(summary(pds_m5_p_cbcl_mod4))[2,2], coef(summary(pds_m4_p_cbcl_mod4))[2,2], coef(summary(pds_p_ss_female_category_2_cbcl_mod4))[2,2], coef(summary(pds_p_ss_male_category_2_cbcl_mod4))[2,2], coef(summary(pds_y_ss_female_category_2_cbcl_mod4))[2,2], coef(summary(pds_y_ss_male_cat_2_cbcl_mod4))[2,2], coef(summary(medhx_6m_times_cbcl_mod4))[2,2], coef(summary(medhx_6n_notes_cbcl_mod4))[2,2], coef(summary(medhx_6p_notes_cbcl_mod4))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_cbcl_mod4))[2,5], coef(summary(pds_f4_p_cbcl_mod4))[2,5], coef(summary(pds_f4_2_y_cbcl_mod4))[2,5], coef(summary(pds_m4_y_cbcl_mod4))[2,5], coef(summary(pds_m5_y_cbcl_mod4))[2,5],coef(summary(pds_m5_p_cbcl_mod4))[2,5], coef(summary(pds_m4_p_cbcl_mod4))[2,5], coef(summary(pds_p_ss_female_category_2_cbcl_mod4))[2,5], coef(summary(pds_p_ss_male_category_2_cbcl_mod4))[2,5], coef(summary(pds_y_ss_female_category_2_cbcl_mod4))[2,5], coef(summary(pds_y_ss_male_cat_2_cbcl_mod4))[2,5], coef(summary(medhx_6m_times_cbcl_mod4))[2,5], coef(summary(medhx_6n_notes_cbcl_mod4))[2,5], coef(summary(medhx_6p_notes_cbcl_mod4))[2,5])
Results4_cbcl_b <- cbind(Variable, Beta, STE, Pval)

# merging with the other Results4
Results4_cbcl_cont <- rbind(Results4_cbcl, Results4_cbcl_b)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 671
Last <- 1291
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results4 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_cbcltot[,i] ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_cbcltot)[i]
  Warn[i] <- LMEOut$warnings
}
#Store Results4 in a dataframe
Results4_cbcl_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results4
colnames(Results4_cbcl_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
Results4_cbcl <- rbind(Results4_cbcl_cont, Results4_cbcl_cat)
# 2 tiers of FDR correction
Results4_cbcl$FDR <- p.adjust(Results4_cbcl$Pval, method="fdr")
Results4_cbcl$Bonferroni <- p.adjust(Results4_cbcl$Pval, method = "bonferroni")
#Write out Results4
fwrite(Results4_cbcl, "Internalizing_Results_base_cbcltot_8.17.23.csv")
```

#### Supplemental controlling for cbcl \#### FU2

```{r}
PheWAS_FU_cbcltot <- PheWAS_FU %>%
  relocate(cbcl_scr_syn_totprob_r, .after = "COVID_visittype")
PheWAS_FU_cbcltot_reshist <-  PheWAS_FU_cbcltot %>%
  dplyr::select(subjectkey:cbcl_scr_syn_totprob_r, contains("reshist"))
PheWAS_FU_cbcltot_sexvar <- PheWAS_FU_cbcltot %>%
  dplyr::select(subjectkey:cbcl_scr_syn_totprob_r, contains("estradiol"), contains("pds"), contains("menstrual"), contains("gish"))
PheWAS_FU_cbcltot_other <- PheWAS_FU_cbcltot  %>%
  dplyr::select(subjectkey:cbcl_scr_syn_totprob_r, contains("biospec"), contains("fitbit"), , ksads_bd_raw_122_p:ksads_adhd_raw_975_p, prodromal_19b_y, prodromal_21b_y, ksads_sleepprob_raw_818_pTRAN, ksads_sleepprob_raw_818_tTRAN, ple_injur_fu2_p, ple_friend_died_fu2_p, ksads_bd_raw_122_p:ksads_adhd_raw_975_p)

PheWAS_FU_cbcltot2 <- PheWAS_FU_cbcltot %>%
  dplyr::select(-contains("reshist"), -contains("pds_"), -contains("menstrual"), -contains("gish"), -contains("biospec"), -contains("fitbit"), -filtered_estradiol, -prodromal_19b_y, -prodromal_21b_y, -ksads_sleepprob_raw_818_pTRAN, -ksads_sleepprob_raw_818_tTRAN, -ple_injur_fu2_p, -ple_friend_died_fu2_p, -screentime_wkdy_school_, -c(ksads_bd_raw_122_p:ksads_adhd_raw_975_p))
#screentime_wkdy_school_ not possible with cbcl??

attach(PheWAS_FU_cbcltot2)
First <- 23
Last <- 1040
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_cbcltot2[,i] ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_cbcltot2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_cbcl <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_cbcl) <- c("Variable", "Beta", "STE", "Pval")

detach(PheWAS_FU_cbcltot2)
attach(PheWAS_FU_cbcltot_reshist)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 23
Last <- 119
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_cbcltot_reshist[,i] ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_cbcltot_reshist)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_cbcl_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_cbcl_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_cbcl_mod3 <- glmer(as.factor(reshist_state_mj_laws_rec) ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_cbcltot_reshist)
mj_laws_med_cbcl_mod3 <- glmer(as.factor(reshist_state_mj_laws_med) ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_cbcltot_reshist)
mj_laws_low_cbcl_mod3 <- glmer(as.factor(reshist_state_mj_laws_low) ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_cbcltot_reshist)

Variable <- colnames(PheWAS_FU_cbcltot_reshist[120:122])
Beta <- c(coef(summary(mj_laws_rec_cbcl_mod3))[2,1], coef(summary(mj_laws_med_cbcl_mod3))[2,1], coef(summary(mj_laws_low_cbcl_mod3))[2,1])
STE <- c(coef(summary(mj_laws_rec_cbcl_mod3))[2,2], coef(summary(mj_laws_med_cbcl_mod3))[2,2], coef(summary(mj_laws_low_cbcl_mod3))[2,2])
Pval <- c(coef(summary(mj_laws_rec_cbcl_mod3))[2,4], coef(summary(mj_laws_med_cbcl_mod3))[2,4], coef(summary(mj_laws_low_cbcl_mod3))[2,4])
ResultsFU3_cbcl_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFU3_cbcl_reshist <- rbind(ResultsFU3_cbcl_reshist, ResultsFU3_cbcl_reshistb)


detach(PheWAS_FU_cbcltot_reshist)

PheWAS_FU_cbcltot_sexvar <- PheWAS_FU_cbcltot_sexvar %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(cbcl_scr_syn_totprob_r, .after = "COVID_visittype") %>%
  relocate(C1:interview_age, .after = "site_id")

attach(PheWAS_FU_cbcltot_sexvar)
# take out sex and covid visit type
First <- 23
Last <- 83
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_cbcltot_sexvar[,i] ~ Neurodev_PRScs +cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_cbcltot_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_cbcl_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_cbcl_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_cbcl_mod3 <- glmer(pds_f5_y ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
pds_f5b_p_cbcl_mod3 <- glmer(pds_f5b_p ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_y_cbcl_mod3 <- glmer(menstrualcycle3_y ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_p_cbcl_mod3 <- glmer(menstrualcycle3_p ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)

Variable <- colnames(PheWAS_FU_cbcltot_sexvar[84:87])
Beta <- c(coef(summary(pds_f5_y_cbcl_mod3))[2,1], coef(summary(pds_f5b_p_cbcl_mod3))[2,1], coef(summary(menstrualcycle3_y_cbcl_mod3))[2,1], coef(summary(menstrualcycle3_p_cbcl_mod3))[2,1])
STE <- c(coef(summary(pds_f5_y_cbcl_mod3))[2,2], coef(summary(pds_f5b_p_cbcl_mod3))[2,2], coef(summary(menstrualcycle3_y_cbcl_mod3))[2,2], coef(summary(menstrualcycle3_p_cbcl_mod3))[2,2])
Pval <- c(coef(summary(pds_f5_y_cbcl_mod3))[2,4], coef(summary(pds_f5b_p_cbcl_mod3))[2,4], coef(summary(menstrualcycle3_y_cbcl_mod3))[2,4], coef(summary(menstrualcycle3_p_cbcl_mod3))[2,4])
ResultsFU3_cbcl_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFU3_cbcl_sexvar <- rbind(ResultsFU3_cbcl_sexvar, ResultsFU3_cbcl_sexvarb)


detach(PheWAS_FU_cbcltot_sexvar)
attach(PheWAS_FU_cbcltot_other)

# take out sex and covid visit type
First <- 23
Last <- 54
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_cbcltot_other[,i] ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_cbcltot_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_cbcl_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_cbcl_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 55
Last <- 72
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_cbcltot_other[,i] ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_cbcltot_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_cbcl_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_cbcl_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU3_cbcl_other <- rbind(ResultsFU3_cbcl_other, ResultsFU3_cbcl_other2)
detach(PheWAS_FU_cbcltot_other)

which(colnames(PheWAS_FU_cbcltot2) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU_cbcltot2) == "kbi_p_c_school_setting_l_home")
PheWAS_FU_cbcltot2 <- PheWAS_FU_cbcltot2 %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU_cbcltot2)

# take out sex and covid visit type
First <- 1041
Last <- 1502
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU_cbcltot2[,i] ~ Neurodev_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU_cbcltot2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU3_cbcl_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU3_cbcl_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU3_cbcl_comp <- rbind(ResultsFU3_cbcl, ResultsFU3_cbcl_reshist, ResultsFU3_cbcl_sexvar, ResultsFU3_cbcl_other, ResultsFU3_cbcl_cat)
ResultsFU3_cbcl_comp <- ResultsFU3_cbcl_comp %>%
  dplyr::filter(Variable!="ksads_bd_raw_162_pTRAN")
ResultsFU3_cbcl_comp$FDR <- p.adjust(ResultsFU3_cbcl_comp$Pval, method = "fdr")
ResultsFU3_cbcl_comp$Bonferroni <- p.adjust(ResultsFU3_cbcl_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFU3_cbcl_comp, "Neurodev_results_FU_cbcl_8.27.23.txt", sep="\t")
detach(PheWAS_FU_cbcltot2)




attach(PheWAS_FU_cbcltot2)
First <- 23
Last <- 1040
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_cbcltot2[,i] ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_cbcltot2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_cbcl <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_cbcl) <- c("Variable", "Beta", "STE", "Pval")
ResultsFU4_cbcl <- ResultsFU4_cbcl %>%
  filter(Variable != "kbi_p_c_school_setting_l_home",
         Variable != "kbi_p_c_school_setting_l_public",
         Variable != "kbi_p_c_school_setting_l_private")
detach(PheWAS_FU_cbcltot2)
attach(PheWAS_FU_cbcltot_reshist)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 23
Last <- 119
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_cbcltot_reshist[,i] ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_cbcltot_reshist)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_cbcl_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_cbcl_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_cbcl_mod4 <- glmer(as.factor(reshist_state_mj_laws_rec) ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_cbcltot_reshist)
mj_laws_med_cbcl_mod4 <- glmer(as.factor(reshist_state_mj_laws_med) ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_cbcltot_reshist)
mj_laws_low_cbcl_mod4 <- glmer(as.factor(reshist_state_mj_laws_low) ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_cbcltot_reshist)

Variable <- colnames(PheWAS_FU_cbcltot_reshist[120:122])
Beta <- c(coef(summary(mj_laws_rec_cbcl_mod4))[2,1], coef(summary(mj_laws_med_cbcl_mod4))[2,1], coef(summary(mj_laws_low_cbcl_mod4))[2,1])
STE <- c(coef(summary(mj_laws_rec_cbcl_mod4))[2,2], coef(summary(mj_laws_med_cbcl_mod4))[2,2], coef(summary(mj_laws_low_cbcl_mod4))[2,2])
Pval <- c(coef(summary(mj_laws_rec_cbcl_mod4))[2,4], coef(summary(mj_laws_med_cbcl_mod4))[2,4], coef(summary(mj_laws_low_cbcl_mod4))[2,4])
ResultsFU4_cbcl_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFU4_cbcl_reshist <- rbind(ResultsFU4_cbcl_reshist, ResultsFU4_cbcl_reshistb)


detach(PheWAS_FU_cbcltot_reshist)

PheWAS_FU_cbcltot_sexvar <- PheWAS_FU_cbcltot_sexvar %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(cbcl_scr_syn_totprob_r, .after = "COVID_visittype") %>%
  relocate(C1:interview_age, .after = "site_id")

attach(PheWAS_FU_cbcltot_sexvar)
# take out sex and covid visit type
First <- 23
Last <- 83
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_cbcltot_sexvar[,i] ~ Internalizing_PRScs +cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_cbcltot_sexvar)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_cbcl_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_cbcl_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_cbcl_mod4 <- glmer(pds_f5_y ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
pds_f5b_p_cbcl_mod4 <- glmer(pds_f5b_p ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_y_cbcl_mod4 <- glmer(menstrualcycle3_y ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)
menstrualcycle3_p_cbcl_mod4 <- glmer(menstrualcycle3_p ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar)

Variable <- colnames(PheWAS_FU_cbcltot_sexvar[84:87])
Beta <- c(coef(summary(pds_f5_y_cbcl_mod4))[2,1], coef(summary(pds_f5b_p_cbcl_mod4))[2,1], coef(summary(menstrualcycle3_y_cbcl_mod4))[2,1], coef(summary(menstrualcycle3_p_cbcl_mod4))[2,1])
STE <- c(coef(summary(pds_f5_y_cbcl_mod4))[2,2], coef(summary(pds_f5b_p_cbcl_mod4))[2,2], coef(summary(menstrualcycle3_y_cbcl_mod4))[2,2], coef(summary(menstrualcycle3_p_cbcl_mod4))[2,2])
Pval <- c(coef(summary(pds_f5_y_cbcl_mod4))[2,4], coef(summary(pds_f5b_p_cbcl_mod4))[2,4], coef(summary(menstrualcycle3_y_cbcl_mod4))[2,4], coef(summary(menstrualcycle3_p_cbcl_mod4))[2,4])
ResultsFU4_cbcl_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFU4_cbcl_sexvar <- rbind(ResultsFU4_cbcl_sexvar, ResultsFU4_cbcl_sexvarb)


detach(PheWAS_FU_cbcltot_sexvar)
attach(PheWAS_FU_cbcltot_other)

# take out sex and covid visit type
First <- 23
Last <- 54
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_cbcltot_other[,i] ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_cbcltot_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_cbcl_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_cbcl_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 55
Last <- 72
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_cbcltot_other[,i] ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_cbcltot_other)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_cbcl_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_cbcl_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU4_cbcl_other <- rbind(ResultsFU4_cbcl_other, ResultsFU4_cbcl_other2)
detach(PheWAS_FU_cbcltot_other)

which(colnames(PheWAS_FU_cbcltot2) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU_cbcltot2) == "kbi_p_c_school_setting_l_home")
PheWAS_FU_cbcltot2 <- PheWAS_FU_cbcltot2 %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU_cbcltot2)

# take out sex and covid visit type
First <- 1041
Last <- 1502
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU_cbcltot2[,i] ~ Internalizing_PRScs + cbcl_scr_syn_totprob_r + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU_cbcltot2)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFU4_cbcl_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFU4_cbcl_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFU4_cbcl_comp <- rbind(ResultsFU4_cbcl, ResultsFU4_cbcl_reshist, ResultsFU4_cbcl_sexvar, ResultsFU4_cbcl_other, ResultsFU4_cbcl_cat)
ResultsFU4_cbcl_comp <- ResultsFU4_cbcl_comp %>%
  dplyr::filter(Variable!="ksads_bd_raw_162_pTRAN")
ResultsFU4_cbcl_comp$FDR <- p.adjust(ResultsFU4_cbcl_comp$Pval, method = "fdr")
ResultsFU4_cbcl_comp$Bonferroni <- p.adjust(ResultsFU4_cbcl_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFU4_cbcl_comp, "Internalizing_results_FU_cbcl_8.27.23.txt", sep="\t")
detach(PheWAS_FU_cbcltot2)
```

#### Confidence Intervals

```{r}
samevars <- read_excel("samevars.xlsx")
same_base <- PheWAS_baseline[colnames(PheWAS_baseline) %in% samevars$Variable_base]
same_base <- cbind(PheWAS_baseline[, 1:20], same_base)

#### Compulsive Baseline
attach(same_base)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 21 
Last <- 584
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_base[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_base)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store results in a dataframe
Results_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel Results
colnames(Results_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

pds_f4_p_mod1 <- lmer(pds_f4_p ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_f4_2_y_mod1 <- lmer(pds_f4_2_y ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m4_y_mod1 <- lmer(pds_m4_y ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m5_y_mod1 <- lmer(pds_m5_y ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m5_p_mod1 <- lmer(pds_m5_p ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m4_p_mod1 <- lmer(pds_m4_p ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_p_ss_female_category_2_mod1 <- lmer(pds_p_ss_female_category_2 ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_p_ss_male_category_2_mod1 <- lmer(pds_p_ss_male_category_2 ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_y_ss_female_category_2_mod1 <- lmer(pds_y_ss_female_category_2 ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_y_ss_male_cat_2_mod1 <- lmer(pds_y_ss_male_cat_2 ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)



## merging the results from the above models 
Variable <- colnames(same_base[585:594])

Beta <- c(coef(summary(pds_f4_p_mod1))[2,1], coef(summary(pds_m5_y_mod1))[2,1], coef(summary(pds_f4_2_y_mod1))[2,1], coef(summary(pds_m4_y_mod1))[2,1], coef(summary(pds_m5_p_mod1))[2,1],coef(summary(pds_m4_p_mod1))[2,1],coef(summary(pds_p_ss_female_category_2_mod1))[2,1], coef(summary(pds_p_ss_male_category_2_mod1))[2,1], coef(summary(pds_y_ss_female_category_2_mod1))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1))[2,1])

STE <- c(coef(summary(pds_f4_p_mod1))[2,2], coef(summary(pds_f4_2_y_mod1))[2,2], coef(summary(pds_m4_y_mod1))[2,2], coef(summary(pds_m5_y_mod1))[2,2], coef(summary(pds_m5_p_mod1))[2,2], coef(summary(pds_m4_p_mod1))[2,2], coef(summary(pds_p_ss_female_category_2_mod1))[2,2], coef(summary(pds_p_ss_male_category_2_mod1))[2,2], coef(summary(pds_y_ss_female_category_2_mod1))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1))[2,2])

Pval <- c(coef(summary(pds_f4_p_mod1))[2,5], coef(summary(pds_f4_2_y_mod1))[2,5], coef(summary(pds_m4_y_mod1))[2,5], coef(summary(pds_m5_y_mod1))[2,5],coef(summary(pds_m5_p_mod1))[2,5], coef(summary(pds_m4_p_mod1))[2,5], coef(summary(pds_p_ss_female_category_2_mod1))[2,5], coef(summary(pds_p_ss_male_category_2_mod1))[2,5], coef(summary(pds_y_ss_female_category_2_mod1))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1))[2,5])
set.seed(1234)
CIl <- c(confint.merMod(pds_f4_p_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_f4_2_y_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m4_y_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m5_y_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1],confint.merMod(pds_m5_p_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m4_p_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_p_ss_female_category_2_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_p_ss_male_category_2_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_y_ss_female_category_2_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_y_ss_male_cat_2_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1])
set.seed(1234)
CIu <- c(confint.merMod(pds_f4_p_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_f4_2_y_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m4_y_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m5_y_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2],confint.merMod(pds_m5_p_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m4_p_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_p_ss_female_category_2_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_p_ss_male_category_2_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_y_ss_female_category_2_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_y_ss_male_cat_2_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2])

Resultsb_CI <- cbind(Variable, Beta, STE, Pval, CIl, CIu)

# merging with the other results
Results_cont_CI <- rbind(Results_CI[,-7], as.data.frame(Resultsb_CI))

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 595
Last <- 824
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(same_base[,i] ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(same_base)[i]
  Warn[i] <- LMEOut$warnings
  CIl[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}
#Store results in a dataframe
Results_cat_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel Results
colnames(Results_cat_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

# merge
Results_CI <- rbind(Results_cont_CI, Results_cat_CI)

Results_CI <- Results_CI %>%
  mutate(Pval = as.numeric(Pval)) %>%
  mutate(p_CI_same = ifelse((Pval < .05 & (CIl <= 0 & CIu >= 0)) | (Pval > .05 & ((CIl <= 0 & CIu <= 0) | (CIl >= 0 & CIu >= 0))), 0, 1))

#Write out results
fwrite(Results_CI, "Compulsive_Results_CI_resub.csv")





#### Psychotic Baseline
attach(same_base)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 21 
Last <- 584
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_base[,i] ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_base)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store results in a dataframe
Results2_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel Results
colnames(Results2_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

pds_f4_p_mod2 <- lmer(pds_f4_p ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_f4_2_y_mod2 <- lmer(pds_f4_2_y ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m4_y_mod2 <- lmer(pds_m4_y ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m5_y_mod2 <- lmer(pds_m5_y ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m5_p_mod2 <- lmer(pds_m5_p ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m4_p_mod2 <- lmer(pds_m4_p ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_p_ss_female_category_2_mod2 <- lmer(pds_p_ss_female_category_2 ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_p_ss_male_category_2_mod2 <- lmer(pds_p_ss_male_category_2 ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_y_ss_female_category_2_mod2 <- lmer(pds_y_ss_female_category_2 ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_y_ss_male_cat_2_mod2 <- lmer(pds_y_ss_male_cat_2 ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)



## merging the results from the above models 
Variable <- colnames(same_base[585:594])

Beta <- c(coef(summary(pds_f4_p_mod2))[2,1], coef(summary(pds_m5_y_mod2))[2,1], coef(summary(pds_f4_2_y_mod2))[2,1], coef(summary(pds_m4_y_mod2))[2,1], coef(summary(pds_m5_p_mod2))[2,1],coef(summary(pds_m4_p_mod2))[2,1],coef(summary(pds_p_ss_female_category_2_mod2))[2,1], coef(summary(pds_p_ss_male_category_2_mod2))[2,1], coef(summary(pds_y_ss_female_category_2_mod2))[2,1], coef(summary(pds_y_ss_male_cat_2_mod2))[2,1])

STE <- c(coef(summary(pds_f4_p_mod2))[2,2], coef(summary(pds_f4_2_y_mod2))[2,2], coef(summary(pds_m4_y_mod2))[2,2], coef(summary(pds_m5_y_mod2))[2,2], coef(summary(pds_m5_p_mod2))[2,2], coef(summary(pds_m4_p_mod2))[2,2], coef(summary(pds_p_ss_female_category_2_mod2))[2,2], coef(summary(pds_p_ss_male_category_2_mod2))[2,2], coef(summary(pds_y_ss_female_category_2_mod2))[2,2], coef(summary(pds_y_ss_male_cat_2_mod2))[2,2])

Pval <- c(coef(summary(pds_f4_p_mod2))[2,5], coef(summary(pds_f4_2_y_mod2))[2,5], coef(summary(pds_m4_y_mod2))[2,5], coef(summary(pds_m5_y_mod2))[2,5],coef(summary(pds_m5_p_mod2))[2,5], coef(summary(pds_m4_p_mod2))[2,5], coef(summary(pds_p_ss_female_category_2_mod2))[2,5], coef(summary(pds_p_ss_male_category_2_mod2))[2,5], coef(summary(pds_y_ss_female_category_2_mod2))[2,5], coef(summary(pds_y_ss_male_cat_2_mod2))[2,5])
set.seed(1234)
CIl <- c(confint.merMod(pds_f4_p_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_f4_2_y_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m4_y_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m5_y_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1],confint.merMod(pds_m5_p_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m4_p_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_p_ss_female_category_2_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_p_ss_male_category_2_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_y_ss_female_category_2_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_y_ss_male_cat_2_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1])
set.seed(1234)
CIu <- c(confint.merMod(pds_f4_p_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_f4_2_y_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m4_y_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m5_y_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2],confint.merMod(pds_m5_p_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m4_p_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_p_ss_female_category_2_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_p_ss_male_category_2_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_y_ss_female_category_2_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_y_ss_male_cat_2_mod2, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2])

Resultsb_CI <- cbind(Variable, Beta, STE, Pval, CIl, CIu)

# merging with the other results
Results2_cont_CI <- rbind(Results2_CI[,-7], as.data.frame(Resultsb_CI))

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 595
Last <- 824
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(same_base[,i] ~ Psychotic_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(same_base)[i]
  Warn[i] <- LMEOut$warnings
  CIl[i] <- confint(a, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Psychotic_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}
#Store results in a dataframe
Results2_cat_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel Results
colnames(Results2_cat_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

# merge
Results2_CI <- rbind(Results2_cont_CI, Results2_cat_CI)

Results2_CI <- Results2_CI %>%
  mutate(Pval = as.numeric(Pval)) %>%
  mutate(p_CI_same = ifelse((Pval < .05 & (CIl <= 0 & CIu >= 0)) | (Pval > .05 & ((CIl <= 0 & CIu <= 0) | (CIl >= 0 & CIu >= 0))), 0, 1))

#Write out results
fwrite(Results2_CI, "Psychotic_Results2_CI_resub.csv")


## NEURODEV baseline
attach(same_base)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 21 
Last <- 584
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_base[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_base)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store results in a dataframe
Results3_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel Results
colnames(Results3_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

pds_f4_p_mod3 <- lmer(pds_f4_p ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_f4_2_y_mod3 <- lmer(pds_f4_2_y ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m4_y_mod3 <- lmer(pds_m4_y ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m5_y_mod3 <- lmer(pds_m5_y ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m5_p_mod3 <- lmer(pds_m5_p ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m4_p_mod3 <- lmer(pds_m4_p ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_p_ss_female_category_2_mod3 <- lmer(pds_p_ss_female_category_2 ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_p_ss_male_category_2_mod3 <- lmer(pds_p_ss_male_category_2 ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_y_ss_female_category_2_mod3 <- lmer(pds_y_ss_female_category_2 ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_y_ss_male_cat_2_mod3 <- lmer(pds_y_ss_male_cat_2 ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)



## merging the results from the above models 
Variable <- colnames(same_base[585:594])

Beta <- c(coef(summary(pds_f4_p_mod3))[2,1], coef(summary(pds_m5_y_mod3))[2,1], coef(summary(pds_f4_2_y_mod3))[2,1], coef(summary(pds_m4_y_mod3))[2,1], coef(summary(pds_m5_p_mod3))[2,1],coef(summary(pds_m4_p_mod3))[2,1],coef(summary(pds_p_ss_female_category_2_mod3))[2,1], coef(summary(pds_p_ss_male_category_2_mod3))[2,1], coef(summary(pds_y_ss_female_category_2_mod3))[2,1], coef(summary(pds_y_ss_male_cat_2_mod3))[2,1])

STE <- c(coef(summary(pds_f4_p_mod3))[2,2], coef(summary(pds_f4_2_y_mod3))[2,2], coef(summary(pds_m4_y_mod3))[2,2], coef(summary(pds_m5_y_mod3))[2,2], coef(summary(pds_m5_p_mod3))[2,2], coef(summary(pds_m4_p_mod3))[2,2], coef(summary(pds_p_ss_female_category_2_mod3))[2,2], coef(summary(pds_p_ss_male_category_2_mod3))[2,2], coef(summary(pds_y_ss_female_category_2_mod3))[2,2], coef(summary(pds_y_ss_male_cat_2_mod3))[2,2])

Pval <- c(coef(summary(pds_f4_p_mod3))[2,5], coef(summary(pds_f4_2_y_mod3))[2,5], coef(summary(pds_m4_y_mod3))[2,5], coef(summary(pds_m5_y_mod3))[2,5],coef(summary(pds_m5_p_mod3))[2,5], coef(summary(pds_m4_p_mod3))[2,5], coef(summary(pds_p_ss_female_category_2_mod3))[2,5], coef(summary(pds_p_ss_male_category_2_mod3))[2,5], coef(summary(pds_y_ss_female_category_2_mod3))[2,5], coef(summary(pds_y_ss_male_cat_2_mod3))[2,5])
set.seed(1234)
CIl <- c(confint.merMod(pds_f4_p_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_f4_2_y_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m4_y_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m5_y_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1],confint.merMod(pds_m5_p_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m4_p_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_p_ss_female_category_2_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_p_ss_male_category_2_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_y_ss_female_category_2_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_y_ss_male_cat_2_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1])
set.seed(1234)
CIu <- c(confint.merMod(pds_f4_p_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_f4_2_y_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m4_y_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m5_y_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2],confint.merMod(pds_m5_p_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m4_p_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_p_ss_female_category_2_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_p_ss_male_category_2_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_y_ss_female_category_2_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_y_ss_male_cat_2_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2])

Results3b_CI <- cbind(Variable, Beta, STE, Pval, CIl, CIu)

# merging with the other results
Results3_cont_CI <- rbind(Results3_CI[,-7], as.data.frame(Results3b_CI))

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 595
Last <- 824
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(same_base[,i] ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(same_base)[i]
  Warn[i] <- LMEOut$warnings
  CIl[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}
#Store results in a dataframe
Results3_cat_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel Results
colnames(Results3_cat_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

# merge
Results3_CI <- rbind(Results3_cont_CI, Results3_cat_CI)

Results3_CI <- Results3_CI %>%
  mutate(Pval = as.numeric(Pval)) %>%
  mutate(p_CI_same = ifelse((Pval < .05 & (CIl <= 0 & CIu >= 0)) | (Pval > .05 & ((CIl <= 0 & CIu <= 0) | (CIl >= 0 & CIu >= 0))), 0, 1))

#Write out results
fwrite(Results3_CI, "Neurodev_Results3_CI_resub.csv")


# INTERNALIZING baseline
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 21 
Last <- 584
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_base[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_base)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store results in a dataframe
Results4_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel Results
colnames(Results4_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

pds_f4_p_mod4 <- lmer(pds_f4_p ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_f4_2_y_mod4 <- lmer(pds_f4_2_y ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m4_y_mod4 <- lmer(pds_m4_y ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m5_y_mod4 <- lmer(pds_m5_y ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m5_p_mod4 <- lmer(pds_m5_p ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_m4_p_mod4 <- lmer(pds_m4_p ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_p_ss_female_category_2_mod4 <- lmer(pds_p_ss_female_category_2 ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_p_ss_male_category_2_mod4 <- lmer(pds_p_ss_male_category_2 ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_y_ss_female_category_2_mod4 <- lmer(pds_y_ss_female_category_2 ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)

pds_y_ss_male_cat_2_mod4 <- lmer(pds_y_ss_male_cat_2 ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = same_base)



## merging the results from the above models 
Variable <- colnames(same_base[585:594])

Beta <- c(coef(summary(pds_f4_p_mod4))[2,1], coef(summary(pds_m5_y_mod4))[2,1], coef(summary(pds_f4_2_y_mod4))[2,1], coef(summary(pds_m4_y_mod4))[2,1], coef(summary(pds_m5_p_mod4))[2,1],coef(summary(pds_m4_p_mod4))[2,1],coef(summary(pds_p_ss_female_category_2_mod4))[2,1], coef(summary(pds_p_ss_male_category_2_mod4))[2,1], coef(summary(pds_y_ss_female_category_2_mod4))[2,1], coef(summary(pds_y_ss_male_cat_2_mod4))[2,1])

STE <- c(coef(summary(pds_f4_p_mod4))[2,2], coef(summary(pds_f4_2_y_mod4))[2,2], coef(summary(pds_m4_y_mod4))[2,2], coef(summary(pds_m5_y_mod4))[2,2], coef(summary(pds_m5_p_mod4))[2,2], coef(summary(pds_m4_p_mod4))[2,2], coef(summary(pds_p_ss_female_category_2_mod4))[2,2], coef(summary(pds_p_ss_male_category_2_mod4))[2,2], coef(summary(pds_y_ss_female_category_2_mod4))[2,2], coef(summary(pds_y_ss_male_cat_2_mod4))[2,2])

Pval <- c(coef(summary(pds_f4_p_mod4))[2,5], coef(summary(pds_f4_2_y_mod4))[2,5], coef(summary(pds_m4_y_mod4))[2,5], coef(summary(pds_m5_y_mod4))[2,5],coef(summary(pds_m5_p_mod4))[2,5], coef(summary(pds_m4_p_mod4))[2,5], coef(summary(pds_p_ss_female_category_2_mod4))[2,5], coef(summary(pds_p_ss_male_category_2_mod4))[2,5], coef(summary(pds_y_ss_female_category_2_mod4))[2,5], coef(summary(pds_y_ss_male_cat_2_mod4))[2,5])

set.seed(1234)
CIl <- c(confint.merMod(pds_f4_p_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_f4_2_y_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m4_y_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m5_y_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1],confint.merMod(pds_m5_p_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_m4_p_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_p_ss_female_category_2_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_p_ss_male_category_2_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_y_ss_female_category_2_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(pds_y_ss_male_cat_2_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1])

set.seed(1234)
CIu <- c(confint.merMod(pds_f4_p_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_f4_2_y_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m4_y_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m5_y_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2],confint.merMod(pds_m5_p_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_m4_p_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_p_ss_female_category_2_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_p_ss_male_category_2_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_y_ss_female_category_2_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(pds_y_ss_male_cat_2_mod4, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2])

Results4b_CI <- cbind(Variable, Beta, STE, Pval, CIl, CIu)
# merging with the other results
Results4_cont_CI <- rbind(Results4_CI, Results4b_CI)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 595
Last <- 824
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CI <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(same_base[,i] ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(same_base)[i]
  Warn[i] <- LMEOut$warnings
  CIl[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}
#Store results in a dataframe
Results4_cat_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel Results
colnames(Results4_cat_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

# merge
Results4_CI <- rbind(Results4_cont_CI, Results4_cat_CI)

Results4_CI <- Results4_CI %>%
  mutate(Pval = as.numeric(Pval)) %>%
  mutate(p_CI_same = ifelse((Pval < .05 & (CIl <= 0 & CIu >= 0)) | (Pval > .05 & ((CIl <= 0 & CIu <= 0) | (CIl >= 0 & CIu >= 0))), 0, 1))

#Write out results
fwrite(Results4_CI, "Internalizing_Results4_CI_resub.csv")

```

#### Confidence Intervals FU

```{r}
same_FU <- PheWAS_FU[colnames(PheWAS_FU) %in% samevars$Variable_FU]
same_FU <- cbind(PheWAS_FU[, 1:21], same_FU)


same_FU_reshist <-  same_FU %>%
  dplyr::select(subjectkey:COVID_visittype, contains("reshist"))
same_FU_sexvar <- same_FU %>%
  dplyr::select(subjectkey:COVID_visittype, filtered_estradiol, contains("pds"), contains("menstrual"), contains("gish"))
same_FU_other <- same_FU %>%
  dplyr::select(subjectkey:COVID_visittype, prodromal_19b_y, prodromal_21b_y)
same_FU2 <- same_FU %>%
  dplyr::select(-contains("reshist"), -contains("pds_"), -contains("menstrual"),  -filtered_estradiol, -prodromal_19b_y, -prodromal_21b_y)

same_FU2 <- as.data.frame(same_FU2)

attach(same_FU2)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 541
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_FU2[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_FU2)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store ResultsFU in a dataframe
ResultsFU_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")
detach(same_FU2)

prodromal_19b_y_FU_CI_mod1 <- lmer(prodromal_19b_y ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), data = same_FU_other, control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)))
prodromal_21b_y_FU_CI_mod1 <- lmer(prodromal_21b_y ~ Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), data = same_FU_other, control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)))

Variable <- colnames(same_FU_other[22:23])
Beta <- c(coef(summary(prodromal_19b_y_FU_CI_mod1))[2,1], coef(summary(prodromal_21b_y_FU_CI_mod1))[2,1])
STE <- c(coef(summary(prodromal_19b_y_FU_CI_mod1))[2,2], coef(summary(prodromal_21b_y_FU_CI_mod1))[2,2])
Pval <- c(coef(summary(prodromal_19b_y_FU_CI_mod1))[2,5], coef(summary(prodromal_21b_y_FU_CI_mod1))[2,5])
set.seed(1234)
CIl <- c(confint.merMod(prodromal_19b_y_FU_CI_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(prodromal_21b_y_FU_CI_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1])
set.seed(1234)
CIu <- c(confint.merMod(prodromal_19b_y_FU_CI_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(prodromal_21b_y_FU_CI_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2])

ResultsFU_CI_prodrom <- cbind(Variable, Beta, STE, Pval, CIl, CIu)
# merging with the other ResultsFU_CI
ResultsFU_CI <- rbind(ResultsFU_CI, ResultsFU_CI_prodrom)

attach(same_FU_sexvar)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 38
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_FU_sexvar[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_FU_sexvar)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store ResultsFU in a dataframe
ResultsFU_CI_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU_CI_sexvar) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

# merging with the other ResultsFU
ResultsFU_cont_CI <- rbind(ResultsFU_CI, ResultsFU_CI_sexvar)
detach(same_FU_sexvar)

attach(same_FU_reshist)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 58
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_FU_reshist[,i] ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_FU_reshist)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store ResultsFU in a dataframe
ResultsFU_CI_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU_CI_reshist) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

mj_laws_rec_mod1 <- glmer(as.factor(reshist_state_mj_laws_rec) ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = same_FU_reshist)
mj_laws_med_mod1 <- glmer(as.factor(reshist_state_mj_laws_med) ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = same_FU_reshist)
mj_laws_low_mod1 <- glmer(as.factor(reshist_state_mj_laws_low) ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = same_FU_reshist)

Variable <- colnames(same_FU_reshist[59:61])

Beta = c(coef(summary(mj_laws_rec_mod1))[2,1], coef(summary(mj_laws_med_mod1))[2,1], coef(summary(mj_laws_low_mod1))[2,1])
STE = c(coef(summary(mj_laws_rec_mod1))[2,2], coef(summary(mj_laws_med_mod1))[2,2], coef(summary(mj_laws_low_mod1))[2,2])
Pval = c(coef(summary(mj_laws_rec_mod1))[2,4], coef(summary(mj_laws_med_mod1))[2,4], coef(summary(mj_laws_low_mod1))[2,4])
set.seed(1234)
CIl <- c(confint.merMod(mj_laws_rec_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(mj_laws_med_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(mj_laws_low_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1])
set.seed(1234)
CIu <- c(confint.merMod(mj_laws_rec_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(mj_laws_med_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(mj_laws_low_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2])

ResultsFUb_CI <- cbind(Variable, Beta, STE, Pval, CIl, CIu)

# merging with the other ResultsFU
ResultsFU_cont_mj_CI <- rbind(ResultsFU_cont_CI, ResultsFU_CI_reshist)
ResultsFU_cont_mj_CI <- rbind(ResultsFU_cont_mj_CI, ResultsFUb_CI)

detach(same_FU_reshist)

attach(same_FU2)
## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 542
Last <- 764
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(same_FU2[,i] ~ Compulsive_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(same_FU2)[i]
  Warn[i] <- LMEOut$warnings
  CIl[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}
#Store ResultsFU in a dataframe
ResultsFU_cat_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU_cat_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")


# merge
ResultsFU_CI2 <- rbind(ResultsFU_cont_mj_CI, ResultsFU_cat_CI)

kbi_home_mod1 <- glmer(kbi_p_c_school_setting_l_home ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0, data = same_FU2)
kbi_public_mod1 <- glmer(kbi_p_c_school_setting_l_public ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0, data = same_FU2)
kbi_private_mod1 <- glmer(kbi_p_c_school_setting_l_private ~ Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0, data = same_FU2)

Variable <- c("kbi_p_c_school_setting_l_home", "kbi_p_c_school_setting_l_public", "kbi_p_c_school_setting_l_private")

Beta = c(coef(summary(kbi_home_mod1))[2,1], coef(summary(kbi_public_mod1))[2,1], coef(summary(kbi_private_mod1))[2,1])
STE = c(coef(summary(kbi_home_mod1))[2,2], coef(summary(kbi_public_mod1))[2,2], coef(summary(kbi_private_mod1))[2,2])
Pval = c(coef(summary(kbi_home_mod1))[2,4], coef(summary(kbi_public_mod1))[2,4], coef(summary(kbi_private_mod1))[2,4])
set.seed(1234)
CIl <- c(confint.merMod(kbi_home_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(kbi_public_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(kbi_private_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1])
set.seed(1234)
CIu <- c(confint.merMod(kbi_home_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(kbi_public_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(kbi_private_mod1, "Compulsive_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2])

ResultsFU_CI_kbi <- as.data.frame(cbind(Variable, Beta, STE, Pval, CIl, CIu))
ResultsFU_CI <- rbind(ResultsFU_CI2, ResultsFU_CI_kbi)
ResultsFU_CI <- ResultsFU_CI %>%
  mutate(Pval = as.numeric(Pval)) %>%
  mutate(p_CI_same = ifelse((Pval < .05 & (CIl <= 0 & CIu >= 0)) | (Pval > .05 & ((CIl <= 0 & CIu <= 0) | (CIl >= 0 & CIu >= 0))), 0, 1))

#Write out ResultsFU
fwrite(ResultsFU_CI, "Compulsive_ResultsFU_CI.csv")



attach(same_FU2)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 541
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_FU2[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_FU2)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store ResultsFU in a dataframe
ResultsFU3_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU3_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")
detach(same_FU2)

attach(same_FU_sexvar)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 38
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_FU_sexvar[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + COVID_visittype + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_FU_sexvar)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store ResultsFU in a dataframe
ResultsFU3_CI_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU3_CI_sexvar) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

# merging with the other ResultsFU
ResultsFU3_cont_CI <- rbind(ResultsFU3_CI, ResultsFU3_CI_sexvar)
detach(same_FU_sexvar)

attach(same_FU_reshist)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 58
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_FU_reshist[,i] ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_FU_reshist)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store ResultsFU in a dataframe
ResultsFU3_CI_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU3_CI_reshist) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

mj_laws_rec_mod3 <- glmer(as.factor(reshist_state_mj_laws_rec) ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = same_FU_reshist)
mj_laws_med_mod3 <- glmer(as.factor(reshist_state_mj_laws_med) ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = same_FU_reshist)
mj_laws_low_mod3 <- glmer(as.factor(reshist_state_mj_laws_low) ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = same_FU_reshist)

Variable <- colnames(same_FU_reshist[59:61])

Beta = c(coef(summary(mj_laws_rec_mod3))[2,1], coef(summary(mj_laws_med_mod3))[2,1], coef(summary(mj_laws_low_mod3))[2,1])
STE = c(coef(summary(mj_laws_rec_mod3))[2,2], coef(summary(mj_laws_med_mod3))[2,2], coef(summary(mj_laws_low_mod3))[2,2])
Pval = c(coef(summary(mj_laws_rec_mod3))[2,4], coef(summary(mj_laws_med_mod3))[2,4], coef(summary(mj_laws_low_mod3))[2,4])
set.seed(1234)
CIl <- c(confint.merMod(mj_laws_rec_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(mj_laws_med_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(mj_laws_low_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1])
set.seed(1234)
CIu <- c(confint.merMod(mj_laws_rec_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(mj_laws_med_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(mj_laws_low_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2])

ResultsFU3b_CI <- cbind(Variable, Beta, STE, Pval, CIl, CIu)

# merging with the other ResultsFU
ResultsFU3_cont_mj_CI <- rbind(ResultsFU3_cont_CI, ResultsFU3_CI_reshist)
ResultsFU3_cont_mj_CI <- rbind(ResultsFU3_cont_mj_CI, ResultsFU3b_CI)

detach(same_FU_reshist)

attach(same_FU2)
## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 542
Last <- 764
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(same_FU2[,i] ~ Neurodev_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(same_FU2)[i]
  Warn[i] <- LMEOut$warnings
  CIl[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}
#Store ResultsFU in a dataframe
ResultsFU3_cat_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU3_cat_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")


ResultsFU3_CI2 <- rbind(ResultsFU3_cont_mj_CI, ResultsFU3_cat_CI)

kbi_home_mod3 <- glmer(kbi_p_c_school_setting_l_home ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0, data = same_FU2)
kbi_public_mod3 <- glmer(kbi_p_c_school_setting_l_public ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0, data = same_FU2)
kbi_private_mod3 <- glmer(kbi_p_c_school_setting_l_private ~ Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0, data = same_FU2)

Variable <- c("kbi_p_c_school_setting_l_home", "kbi_p_c_school_setting_l_public", "kbi_p_c_school_setting_l_private")

Beta = c(coef(summary(kbi_home_mod3))[2,1], coef(summary(kbi_public_mod3))[2,1], coef(summary(kbi_private_mod3))[2,1])
STE = c(coef(summary(kbi_home_mod3))[2,2], coef(summary(kbi_public_mod3))[2,2], coef(summary(kbi_private_mod3))[2,2])
Pval = c(coef(summary(kbi_home_mod3))[2,4], coef(summary(kbi_public_mod3))[2,4], coef(summary(kbi_private_mod3))[2,4])
set.seed(1234)
CIl <- c(confint.merMod(kbi_home_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(kbi_public_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(kbi_private_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1])
set.seed(1234)
CIu <- c(confint.merMod(kbi_home_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(kbi_public_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(kbi_private_mod3, "Neurodev_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2])

ResultsFU3_CI_kbi <- as.data.frame(cbind(Variable, Beta, STE, Pval, CIl, CIu))
ResultsFU3_CI <- rbind(ResultsFU3_CI2, ResultsFU3_CI_kbi)
ResultsFU3_CI <- ResultsFU3_CI %>%
  mutate(Pval = as.numeric(Pval)) %>%
  mutate(p_CI_same = ifelse((Pval < .05 & (CIl <= 0 & CIu >= 0)) | (Pval > .05 & ((CIl <= 0 & CIu <= 0) | (CIl >= 0 & CIu >= 0))), 0, 1))

#Write out ResultsFU
fwrite(ResultsFU3_CI, "Neurodev_ResultsFU3_CI.csv")



attach(same_FU2)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 541
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_FU2[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_FU2)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store ResultsFU in a dataframe
ResultsFU4_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU4_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")
detach(same_FU2)

attach(same_FU_sexvar)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 38
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_FU_sexvar[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + COVID_visittype + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_FU_sexvar)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store ResultsFU in a dataframe
ResultsFU4_CI_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU4_CI_sexvar) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

# merging with the other ResultsFU
ResultsFU4_cont_CI <- rbind(ResultsFU4_CI, ResultsFU4_CI_sexvar)
detach(same_FU_sexvar)

attach(same_FU_reshist)
set.seed(1234)
# CONTINUOUS VARIALBES AS OUTCOME
First <- 22 
Last <- 58
#creates objects for the loop
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(same_FU_reshist[,i] ~ Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(same_FU_reshist)[i]
  Warn[i] <- LMEOut$warnings
  set.seed(1234)
  CIl[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}

#Store ResultsFU in a dataframe
ResultsFU4_CI_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU4_CI_reshist) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

mj_laws_rec_mod3 <- glmer(as.factor(reshist_state_mj_laws_rec) ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = same_FU_reshist)
mj_laws_med_mod3 <- glmer(as.factor(reshist_state_mj_laws_med) ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = same_FU_reshist)
mj_laws_low_mod3 <- glmer(as.factor(reshist_state_mj_laws_low) ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = same_FU_reshist)

Variable <- colnames(same_FU_reshist[59:61])

Beta = c(coef(summary(mj_laws_rec_mod3))[2,1], coef(summary(mj_laws_med_mod3))[2,1], coef(summary(mj_laws_low_mod3))[2,1])
STE = c(coef(summary(mj_laws_rec_mod3))[2,2], coef(summary(mj_laws_med_mod3))[2,2], coef(summary(mj_laws_low_mod3))[2,2])
Pval = c(coef(summary(mj_laws_rec_mod3))[2,4], coef(summary(mj_laws_med_mod3))[2,4], coef(summary(mj_laws_low_mod3))[2,4])
set.seed(1234)
CIl <- c(confint.merMod(mj_laws_rec_mod3, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(mj_laws_med_mod3, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1], confint.merMod(mj_laws_low_mod3, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1])
set.seed(1234)
CIu <- c(confint.merMod(mj_laws_rec_mod3, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(mj_laws_med_mod3, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2], confint.merMod(mj_laws_low_mod3, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2])

ResultsFU4b_CI <- cbind(Variable, Beta, STE, Pval, CIl, CIu)

# merging with the other ResultsFU
ResultsFU4_cont_mj_CI <- rbind(ResultsFU4_cont_CI, ResultsFU4_CI_reshist)
ResultsFU4_cont_mj_CI <- rbind(ResultsFU4_cont_mj_CI, ResultsFU4b_CI)

detach(same_FU_reshist)

attach(same_FU2)
## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 542
Last <- 764
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsFU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
CIl <- NULL
CIu <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(same_FU2[,i] ~ Internalizing_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(same_FU2)[i]
  Warn[i] <- LMEOut$warnings
  CIl[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[1]
  set.seed(1234)
  CIu[i] <- confint(a, "Internalizing_PRScs", method = "boot", nsim = 200, parallel = "multicore", ncpus = 8)[2]
}
#Store ResultsFU in a dataframe
ResultsFU4_cat_CI <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)], CIl[First:length(CIl)], CIu[First:length(CIu)])
#Relabel ResultsFU
colnames(ResultsFU4_cat_CI) <- c("Variable", "Beta", "STE", "Pval", "CIl", "CIu")

# merge
ResultsFU4_CI2 <- rbind(ResultsFU4_cont_mj_CI, ResultsFU4_cat_CI)


ResultsFU4_CI2 <- ResultsFU4_CI2 %>%
  mutate(Pval = as.numeric(Pval)) %>%
  mutate(p_CI_same = ifelse((Pval < .05 & (CIl <= 0 & CIu >= 0)) | (Pval > .05 & ((CIl <= 0 & CIu <= 0) | (CIl >= 0 & CIu >= 0))), 0, 1))

#Write out ResultsFU
fwrite(ResultsFU4_CI2, "Internalizing_ResultsFU4_CI.csv")
```

#### Individual PRS Baseline

```{r}
indivPRS <- fread("Individual_PRS.txt")
indivPRS <- indivPRS %>%
  mutate_if(is.numeric, scale)
PheWAS_baseline_indiv <- merge(indivPRS, PheWAS_baseline, by = "subjectkey")
PheWAS_baseline_indiv <- PheWAS_baseline_indiv %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id")
PheWAS_baseline_indiv <- as.data.frame(PheWAS_baseline_indiv)
attach(PheWAS_baseline_indiv)

## ADHD PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsADHD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsADHD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsADHD) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1ADHD <- lmer(reshist_state_immigrant_factor ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1ADHD <- lmer(pds_f4_p ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1ADHD <- lmer(pds_f4_2_y ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1ADHD <- lmer(pds_m4_y ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1ADHD <- lmer(pds_m5_y ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1ADHD <- lmer(pds_m5_p ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1ADHD <- lmer(pds_m4_p ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1ADHD <- lmer(pds_p_ss_female_category_2 ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1ADHD <- lmer(pds_p_ss_male_category_2 ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1ADHD <- lmer(pds_y_ss_female_category_2 ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1ADHD <- lmer(pds_y_ss_male_cat_2 ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1ADHD <- lmer(medhx_6m_times ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1ADHD <- lmer(medhx_6n_notes ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1ADHD <- lmer(medhx_6p_notes ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsADHD from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1ADHD))[2,1], coef(summary(pds_f4_p_mod1ADHD))[2,1], coef(summary(pds_m5_y_mod1ADHD))[2,1], coef(summary(pds_f4_2_y_mod1ADHD))[2,1], coef(summary(pds_m4_y_mod1ADHD))[2,1], coef(summary(pds_m5_p_mod1ADHD))[2,1],coef(summary(pds_m4_p_mod1ADHD))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1ADHD))[2,1], coef(summary(pds_p_ss_male_category_2_mod1ADHD))[2,1], coef(summary(pds_y_ss_female_category_2_mod1ADHD))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1ADHD))[2,1], coef(summary(medhx_6m_times_mod1ADHD))[2,1], coef(summary(medhx_6n_notes_mod1ADHD))[2,1], coef(summary(medhx_6p_notes_mod1ADHD))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1ADHD))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1ADHD))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1ADHD))[2,2], coef(summary(pds_f4_p_mod1ADHD))[2,2], coef(summary(pds_f4_2_y_mod1ADHD))[2,2], coef(summary(pds_m4_y_mod1ADHD))[2,2], coef(summary(pds_m5_y_mod1ADHD))[2,2], coef(summary(pds_m5_p_mod1ADHD))[2,2], coef(summary(pds_m4_p_mod1ADHD))[2,2], coef(summary(pds_p_ss_female_category_2_mod1ADHD))[2,2], coef(summary(pds_p_ss_male_category_2_mod1ADHD))[2,2], coef(summary(pds_y_ss_female_category_2_mod1ADHD))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1ADHD))[2,2], coef(summary(medhx_6m_times_mod1ADHD))[2,2], coef(summary(medhx_6n_notes_mod1ADHD))[2,2], coef(summary(medhx_6p_notes_mod1ADHD))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1ADHD))[2,5], coef(summary(pds_f4_p_mod1ADHD))[2,5], coef(summary(pds_f4_2_y_mod1ADHD))[2,5], coef(summary(pds_m4_y_mod1ADHD))[2,5], coef(summary(pds_m5_y_mod1ADHD))[2,5],coef(summary(pds_m5_p_mod1ADHD))[2,5], coef(summary(pds_m4_p_mod1ADHD))[2,5], coef(summary(pds_p_ss_female_category_2_mod1ADHD))[2,5], coef(summary(pds_p_ss_male_category_2_mod1ADHD))[2,5], coef(summary(pds_y_ss_female_category_2_mod1ADHD))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1ADHD))[2,5], coef(summary(medhx_6m_times_mod1ADHD))[2,5], coef(summary(medhx_6n_notes_mod1ADHD))[2,5], coef(summary(medhx_6p_notes_mod1ADHD))[2,5])
ResultsADHDb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsADHD
ResultsADHD_cont <- rbind(ResultsADHD, ResultsADHDb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsADHD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsADHD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsADHD_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsADHD <- rbind(ResultsADHD_cont, ResultsADHD_cat)
# 2 tiers of FDR correction
ResultsADHD$FDR <- p.adjust(ResultsADHD$Pval, method="fdr")
ResultsADHD$Bonferroni <- p.adjust(ResultsADHD$Pval, method = "bonferroni")
#Write out ResultsADHD
fwrite(ResultsADHD, "ADHD_ResultsADHD_base_8.23.23.csv")



## PAU PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsPAU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsPAU <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsPAU) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1PAU <- lmer(reshist_state_immigrant_factor ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1PAU <- lmer(pds_f4_p ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1PAU <- lmer(pds_f4_2_y ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1PAU <- lmer(pds_m4_y ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1PAU <- lmer(pds_m5_y ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1PAU <- lmer(pds_m5_p ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1PAU <- lmer(pds_m4_p ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1PAU <- lmer(pds_p_ss_female_category_2 ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1PAU <- lmer(pds_p_ss_male_category_2 ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1PAU <- lmer(pds_y_ss_female_category_2 ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1PAU <- lmer(pds_y_ss_male_cat_2 ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1PAU <- lmer(medhx_6m_times ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1PAU <- lmer(medhx_6n_notes ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1PAU <- lmer(medhx_6p_notes ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsPAU from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1PAU))[2,1], coef(summary(pds_f4_p_mod1PAU))[2,1], coef(summary(pds_m5_y_mod1PAU))[2,1], coef(summary(pds_f4_2_y_mod1PAU))[2,1], coef(summary(pds_m4_y_mod1PAU))[2,1], coef(summary(pds_m5_p_mod1PAU))[2,1],coef(summary(pds_m4_p_mod1PAU))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1PAU))[2,1], coef(summary(pds_p_ss_male_category_2_mod1PAU))[2,1], coef(summary(pds_y_ss_female_category_2_mod1PAU))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1PAU))[2,1], coef(summary(medhx_6m_times_mod1PAU))[2,1], coef(summary(medhx_6n_notes_mod1PAU))[2,1], coef(summary(medhx_6p_notes_mod1PAU))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1PAU))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1PAU))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1PAU))[2,2], coef(summary(pds_f4_p_mod1PAU))[2,2], coef(summary(pds_f4_2_y_mod1PAU))[2,2], coef(summary(pds_m4_y_mod1PAU))[2,2], coef(summary(pds_m5_y_mod1PAU))[2,2], coef(summary(pds_m5_p_mod1PAU))[2,2], coef(summary(pds_m4_p_mod1PAU))[2,2], coef(summary(pds_p_ss_female_category_2_mod1PAU))[2,2], coef(summary(pds_p_ss_male_category_2_mod1PAU))[2,2], coef(summary(pds_y_ss_female_category_2_mod1PAU))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1PAU))[2,2], coef(summary(medhx_6m_times_mod1PAU))[2,2], coef(summary(medhx_6n_notes_mod1PAU))[2,2], coef(summary(medhx_6p_notes_mod1PAU))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1PAU))[2,5], coef(summary(pds_f4_p_mod1PAU))[2,5], coef(summary(pds_f4_2_y_mod1PAU))[2,5], coef(summary(pds_m4_y_mod1PAU))[2,5], coef(summary(pds_m5_y_mod1PAU))[2,5],coef(summary(pds_m5_p_mod1PAU))[2,5], coef(summary(pds_m4_p_mod1PAU))[2,5], coef(summary(pds_p_ss_female_category_2_mod1PAU))[2,5], coef(summary(pds_p_ss_male_category_2_mod1PAU))[2,5], coef(summary(pds_y_ss_female_category_2_mod1PAU))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1PAU))[2,5], coef(summary(medhx_6m_times_mod1PAU))[2,5], coef(summary(medhx_6n_notes_mod1PAU))[2,5], coef(summary(medhx_6p_notes_mod1PAU))[2,5])
ResultsPAUb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsPAU
ResultsPAU_cont <- rbind(ResultsPAU, ResultsPAUb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsPAU <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsPAU_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsPAU_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsPAU <- rbind(ResultsPAU_cont, ResultsPAU_cat)
# 2 tiers of FDR correction
ResultsPAU$FDR <- p.adjust(ResultsPAU$Pval, method="fdr")
ResultsPAU$Bonferroni <- p.adjust(ResultsPAU$Pval, method = "bonferroni")
#Write out ResultsPAU
fwrite(ResultsPAU, "PAU_ResultsPAU_base_8.23.23.csv")


## BIP PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsBIP <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsBIP <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsBIP) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1BIP <- lmer(reshist_state_immigrant_factor ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1BIP <- lmer(pds_f4_p ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1BIP <- lmer(pds_f4_2_y ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1BIP <- lmer(pds_m4_y ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1BIP <- lmer(pds_m5_y ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1BIP <- lmer(pds_m5_p ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1BIP <- lmer(pds_m4_p ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1BIP <- lmer(pds_p_ss_female_category_2 ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1BIP <- lmer(pds_p_ss_male_category_2 ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1BIP <- lmer(pds_y_ss_female_category_2 ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1BIP <- lmer(pds_y_ss_male_cat_2 ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1BIP <- lmer(medhx_6m_times ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1BIP <- lmer(medhx_6n_notes ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1BIP <- lmer(medhx_6p_notes ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsBIP from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1BIP))[2,1], coef(summary(pds_f4_p_mod1BIP))[2,1], coef(summary(pds_m5_y_mod1BIP))[2,1], coef(summary(pds_f4_2_y_mod1BIP))[2,1], coef(summary(pds_m4_y_mod1BIP))[2,1], coef(summary(pds_m5_p_mod1BIP))[2,1],coef(summary(pds_m4_p_mod1BIP))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1BIP))[2,1], coef(summary(pds_p_ss_male_category_2_mod1BIP))[2,1], coef(summary(pds_y_ss_female_category_2_mod1BIP))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1BIP))[2,1], coef(summary(medhx_6m_times_mod1BIP))[2,1], coef(summary(medhx_6n_notes_mod1BIP))[2,1], coef(summary(medhx_6p_notes_mod1BIP))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1BIP))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1BIP))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1BIP))[2,2], coef(summary(pds_f4_p_mod1BIP))[2,2], coef(summary(pds_f4_2_y_mod1BIP))[2,2], coef(summary(pds_m4_y_mod1BIP))[2,2], coef(summary(pds_m5_y_mod1BIP))[2,2], coef(summary(pds_m5_p_mod1BIP))[2,2], coef(summary(pds_m4_p_mod1BIP))[2,2], coef(summary(pds_p_ss_female_category_2_mod1BIP))[2,2], coef(summary(pds_p_ss_male_category_2_mod1BIP))[2,2], coef(summary(pds_y_ss_female_category_2_mod1BIP))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1BIP))[2,2], coef(summary(medhx_6m_times_mod1BIP))[2,2], coef(summary(medhx_6n_notes_mod1BIP))[2,2], coef(summary(medhx_6p_notes_mod1BIP))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1BIP))[2,5], coef(summary(pds_f4_p_mod1BIP))[2,5], coef(summary(pds_f4_2_y_mod1BIP))[2,5], coef(summary(pds_m4_y_mod1BIP))[2,5], coef(summary(pds_m5_y_mod1BIP))[2,5],coef(summary(pds_m5_p_mod1BIP))[2,5], coef(summary(pds_m4_p_mod1BIP))[2,5], coef(summary(pds_p_ss_female_category_2_mod1BIP))[2,5], coef(summary(pds_p_ss_male_category_2_mod1BIP))[2,5], coef(summary(pds_y_ss_female_category_2_mod1BIP))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1BIP))[2,5], coef(summary(medhx_6m_times_mod1BIP))[2,5], coef(summary(medhx_6n_notes_mod1BIP))[2,5], coef(summary(medhx_6p_notes_mod1BIP))[2,5])
ResultsBIPb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsBIP
ResultsBIP_cont <- rbind(ResultsBIP, ResultsBIPb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsBIP <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsBIP_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsBIP_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsBIP <- rbind(ResultsBIP_cont, ResultsBIP_cat)
# 2 tiers of FDR correction
ResultsBIP$FDR <- p.adjust(ResultsBIP$Pval, method="fdr")
ResultsBIP$Bonferroni <- p.adjust(ResultsBIP$Pval, method = "bonferroni")
#Write out ResultsBIP
fwrite(ResultsBIP, "BIP_ResultsBIP_base_8.23.23.csv")



## ASD PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsASD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsASD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsASD) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1ASD <- lmer(reshist_state_immigrant_factor ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1ASD <- lmer(pds_f4_p ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1ASD <- lmer(pds_f4_2_y ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1ASD <- lmer(pds_m4_y ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1ASD <- lmer(pds_m5_y ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1ASD <- lmer(pds_m5_p ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1ASD <- lmer(pds_m4_p ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1ASD <- lmer(pds_p_ss_female_category_2 ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1ASD <- lmer(pds_p_ss_male_category_2 ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1ASD <- lmer(pds_y_ss_female_category_2 ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1ASD <- lmer(pds_y_ss_male_cat_2 ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1ASD <- lmer(medhx_6m_times ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1ASD <- lmer(medhx_6n_notes ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1ASD <- lmer(medhx_6p_notes ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsASD from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1ASD))[2,1], coef(summary(pds_f4_p_mod1ASD))[2,1], coef(summary(pds_m5_y_mod1ASD))[2,1], coef(summary(pds_f4_2_y_mod1ASD))[2,1], coef(summary(pds_m4_y_mod1ASD))[2,1], coef(summary(pds_m5_p_mod1ASD))[2,1],coef(summary(pds_m4_p_mod1ASD))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1ASD))[2,1], coef(summary(pds_p_ss_male_category_2_mod1ASD))[2,1], coef(summary(pds_y_ss_female_category_2_mod1ASD))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1ASD))[2,1], coef(summary(medhx_6m_times_mod1ASD))[2,1], coef(summary(medhx_6n_notes_mod1ASD))[2,1], coef(summary(medhx_6p_notes_mod1ASD))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1ASD))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1ASD))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1ASD))[2,2], coef(summary(pds_f4_p_mod1ASD))[2,2], coef(summary(pds_f4_2_y_mod1ASD))[2,2], coef(summary(pds_m4_y_mod1ASD))[2,2], coef(summary(pds_m5_y_mod1ASD))[2,2], coef(summary(pds_m5_p_mod1ASD))[2,2], coef(summary(pds_m4_p_mod1ASD))[2,2], coef(summary(pds_p_ss_female_category_2_mod1ASD))[2,2], coef(summary(pds_p_ss_male_category_2_mod1ASD))[2,2], coef(summary(pds_y_ss_female_category_2_mod1ASD))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1ASD))[2,2], coef(summary(medhx_6m_times_mod1ASD))[2,2], coef(summary(medhx_6n_notes_mod1ASD))[2,2], coef(summary(medhx_6p_notes_mod1ASD))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1ASD))[2,5], coef(summary(pds_f4_p_mod1ASD))[2,5], coef(summary(pds_f4_2_y_mod1ASD))[2,5], coef(summary(pds_m4_y_mod1ASD))[2,5], coef(summary(pds_m5_y_mod1ASD))[2,5],coef(summary(pds_m5_p_mod1ASD))[2,5], coef(summary(pds_m4_p_mod1ASD))[2,5], coef(summary(pds_p_ss_female_category_2_mod1ASD))[2,5], coef(summary(pds_p_ss_male_category_2_mod1ASD))[2,5], coef(summary(pds_y_ss_female_category_2_mod1ASD))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1ASD))[2,5], coef(summary(medhx_6m_times_mod1ASD))[2,5], coef(summary(medhx_6n_notes_mod1ASD))[2,5], coef(summary(medhx_6p_notes_mod1ASD))[2,5])
ResultsASDb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsASD
ResultsASD_cont <- rbind(ResultsASD, ResultsASDb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsASD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsASD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsASD_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsASD <- rbind(ResultsASD_cont, ResultsASD_cat)
# 2 tiers of FDR correction
ResultsASD$FDR <- p.adjust(ResultsASD$Pval, method="fdr")
ResultsASD$Bonferroni <- p.adjust(ResultsASD$Pval, method = "bonferroni")
#Write out ResultsASD
fwrite(ResultsASD, "ASD_ResultsASD_base_8.23.23.csv")




## AN PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsAN <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsAN <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsAN) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1AN <- lmer(reshist_state_immigrant_factor ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1AN <- lmer(pds_f4_p ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1AN <- lmer(pds_f4_2_y ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1AN <- lmer(pds_m4_y ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1AN <- lmer(pds_m5_y ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1AN <- lmer(pds_m5_p ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1AN <- lmer(pds_m4_p ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1AN <- lmer(pds_p_ss_female_category_2 ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1AN <- lmer(pds_p_ss_male_category_2 ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1AN <- lmer(pds_y_ss_female_category_2 ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1AN <- lmer(pds_y_ss_male_cat_2 ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1AN <- lmer(medhx_6m_times ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1AN <- lmer(medhx_6n_notes ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1AN <- lmer(medhx_6p_notes ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsAN from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1AN))[2,1], coef(summary(pds_f4_p_mod1AN))[2,1], coef(summary(pds_m5_y_mod1AN))[2,1], coef(summary(pds_f4_2_y_mod1AN))[2,1], coef(summary(pds_m4_y_mod1AN))[2,1], coef(summary(pds_m5_p_mod1AN))[2,1],coef(summary(pds_m4_p_mod1AN))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1AN))[2,1], coef(summary(pds_p_ss_male_category_2_mod1AN))[2,1], coef(summary(pds_y_ss_female_category_2_mod1AN))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1AN))[2,1], coef(summary(medhx_6m_times_mod1AN))[2,1], coef(summary(medhx_6n_notes_mod1AN))[2,1], coef(summary(medhx_6p_notes_mod1AN))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1AN))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1AN))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1AN))[2,2], coef(summary(pds_f4_p_mod1AN))[2,2], coef(summary(pds_f4_2_y_mod1AN))[2,2], coef(summary(pds_m4_y_mod1AN))[2,2], coef(summary(pds_m5_y_mod1AN))[2,2], coef(summary(pds_m5_p_mod1AN))[2,2], coef(summary(pds_m4_p_mod1AN))[2,2], coef(summary(pds_p_ss_female_category_2_mod1AN))[2,2], coef(summary(pds_p_ss_male_category_2_mod1AN))[2,2], coef(summary(pds_y_ss_female_category_2_mod1AN))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1AN))[2,2], coef(summary(medhx_6m_times_mod1AN))[2,2], coef(summary(medhx_6n_notes_mod1AN))[2,2], coef(summary(medhx_6p_notes_mod1AN))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1AN))[2,5], coef(summary(pds_f4_p_mod1AN))[2,5], coef(summary(pds_f4_2_y_mod1AN))[2,5], coef(summary(pds_m4_y_mod1AN))[2,5], coef(summary(pds_m5_y_mod1AN))[2,5],coef(summary(pds_m5_p_mod1AN))[2,5], coef(summary(pds_m4_p_mod1AN))[2,5], coef(summary(pds_p_ss_female_category_2_mod1AN))[2,5], coef(summary(pds_p_ss_male_category_2_mod1AN))[2,5], coef(summary(pds_y_ss_female_category_2_mod1AN))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1AN))[2,5], coef(summary(medhx_6m_times_mod1AN))[2,5], coef(summary(medhx_6n_notes_mod1AN))[2,5], coef(summary(medhx_6p_notes_mod1AN))[2,5])
ResultsANb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsAN
ResultsAN_cont <- rbind(ResultsAN, ResultsANb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsAN <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsAN_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsAN_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsAN <- rbind(ResultsAN_cont, ResultsAN_cat)
# 2 tiers of FDR correction
ResultsAN$FDR <- p.adjust(ResultsAN$Pval, method="fdr")
ResultsAN$Bonferroni <- p.adjust(ResultsAN$Pval, method = "bonferroni")
#Write out ResultsAN
fwrite(ResultsAN, "AN_ResultsAN_base_8.23.23.csv")



## TS PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsTS <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsTS <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsTS) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1TS <- lmer(reshist_state_immigrant_factor ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1TS <- lmer(pds_f4_p ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1TS <- lmer(pds_f4_2_y ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1TS <- lmer(pds_m4_y ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1TS <- lmer(pds_m5_y ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1TS <- lmer(pds_m5_p ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1TS <- lmer(pds_m4_p ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1TS <- lmer(pds_p_ss_female_category_2 ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1TS <- lmer(pds_p_ss_male_category_2 ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1TS <- lmer(pds_y_ss_female_category_2 ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1TS <- lmer(pds_y_ss_male_cat_2 ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1TS <- lmer(medhx_6m_times ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1TS <- lmer(medhx_6n_notes ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1TS <- lmer(medhx_6p_notes ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsTS from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1TS))[2,1], coef(summary(pds_f4_p_mod1TS))[2,1], coef(summary(pds_m5_y_mod1TS))[2,1], coef(summary(pds_f4_2_y_mod1TS))[2,1], coef(summary(pds_m4_y_mod1TS))[2,1], coef(summary(pds_m5_p_mod1TS))[2,1],coef(summary(pds_m4_p_mod1TS))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1TS))[2,1], coef(summary(pds_p_ss_male_category_2_mod1TS))[2,1], coef(summary(pds_y_ss_female_category_2_mod1TS))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1TS))[2,1], coef(summary(medhx_6m_times_mod1TS))[2,1], coef(summary(medhx_6n_notes_mod1TS))[2,1], coef(summary(medhx_6p_notes_mod1TS))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1TS))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1TS))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1TS))[2,2], coef(summary(pds_f4_p_mod1TS))[2,2], coef(summary(pds_f4_2_y_mod1TS))[2,2], coef(summary(pds_m4_y_mod1TS))[2,2], coef(summary(pds_m5_y_mod1TS))[2,2], coef(summary(pds_m5_p_mod1TS))[2,2], coef(summary(pds_m4_p_mod1TS))[2,2], coef(summary(pds_p_ss_female_category_2_mod1TS))[2,2], coef(summary(pds_p_ss_male_category_2_mod1TS))[2,2], coef(summary(pds_y_ss_female_category_2_mod1TS))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1TS))[2,2], coef(summary(medhx_6m_times_mod1TS))[2,2], coef(summary(medhx_6n_notes_mod1TS))[2,2], coef(summary(medhx_6p_notes_mod1TS))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1TS))[2,5], coef(summary(pds_f4_p_mod1TS))[2,5], coef(summary(pds_f4_2_y_mod1TS))[2,5], coef(summary(pds_m4_y_mod1TS))[2,5], coef(summary(pds_m5_y_mod1TS))[2,5],coef(summary(pds_m5_p_mod1TS))[2,5], coef(summary(pds_m4_p_mod1TS))[2,5], coef(summary(pds_p_ss_female_category_2_mod1TS))[2,5], coef(summary(pds_p_ss_male_category_2_mod1TS))[2,5], coef(summary(pds_y_ss_female_category_2_mod1TS))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1TS))[2,5], coef(summary(medhx_6m_times_mod1TS))[2,5], coef(summary(medhx_6n_notes_mod1TS))[2,5], coef(summary(medhx_6p_notes_mod1TS))[2,5])
ResultsTSb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsTS
ResultsTS_cont <- rbind(ResultsTS, ResultsTSb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsTS <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsTS_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsTS_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsTS <- rbind(ResultsTS_cont, ResultsTS_cat)
# 2 tiers of FDR correction
ResultsTS$FDR <- p.adjust(ResultsTS$Pval, method="fdr")
ResultsTS$Bonferroni <- p.adjust(ResultsTS$Pval, method = "bonferroni")
#Write out ResultsTS
fwrite(ResultsTS, "TS_ResultsTS_base_8.23.23.csv")





## OCD PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsOCD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsOCD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsOCD) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1OCD <- lmer(reshist_state_immigrant_factor ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1OCD <- lmer(pds_f4_p ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1OCD <- lmer(pds_f4_2_y ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1OCD <- lmer(pds_m4_y ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1OCD <- lmer(pds_m5_y ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1OCD <- lmer(pds_m5_p ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1OCD <- lmer(pds_m4_p ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1OCD <- lmer(pds_p_ss_female_category_2 ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1OCD <- lmer(pds_p_ss_male_category_2 ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1OCD <- lmer(pds_y_ss_female_category_2 ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1OCD <- lmer(pds_y_ss_male_cat_2 ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1OCD <- lmer(medhx_6m_times ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1OCD <- lmer(medhx_6n_notes ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1OCD <- lmer(medhx_6p_notes ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsOCD from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1OCD))[2,1], coef(summary(pds_f4_p_mod1OCD))[2,1], coef(summary(pds_m5_y_mod1OCD))[2,1], coef(summary(pds_f4_2_y_mod1OCD))[2,1], coef(summary(pds_m4_y_mod1OCD))[2,1], coef(summary(pds_m5_p_mod1OCD))[2,1],coef(summary(pds_m4_p_mod1OCD))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1OCD))[2,1], coef(summary(pds_p_ss_male_category_2_mod1OCD))[2,1], coef(summary(pds_y_ss_female_category_2_mod1OCD))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1OCD))[2,1], coef(summary(medhx_6m_times_mod1OCD))[2,1], coef(summary(medhx_6n_notes_mod1OCD))[2,1], coef(summary(medhx_6p_notes_mod1OCD))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1OCD))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1OCD))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1OCD))[2,2], coef(summary(pds_f4_p_mod1OCD))[2,2], coef(summary(pds_f4_2_y_mod1OCD))[2,2], coef(summary(pds_m4_y_mod1OCD))[2,2], coef(summary(pds_m5_y_mod1OCD))[2,2], coef(summary(pds_m5_p_mod1OCD))[2,2], coef(summary(pds_m4_p_mod1OCD))[2,2], coef(summary(pds_p_ss_female_category_2_mod1OCD))[2,2], coef(summary(pds_p_ss_male_category_2_mod1OCD))[2,2], coef(summary(pds_y_ss_female_category_2_mod1OCD))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1OCD))[2,2], coef(summary(medhx_6m_times_mod1OCD))[2,2], coef(summary(medhx_6n_notes_mod1OCD))[2,2], coef(summary(medhx_6p_notes_mod1OCD))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1OCD))[2,5], coef(summary(pds_f4_p_mod1OCD))[2,5], coef(summary(pds_f4_2_y_mod1OCD))[2,5], coef(summary(pds_m4_y_mod1OCD))[2,5], coef(summary(pds_m5_y_mod1OCD))[2,5],coef(summary(pds_m5_p_mod1OCD))[2,5], coef(summary(pds_m4_p_mod1OCD))[2,5], coef(summary(pds_p_ss_female_category_2_mod1OCD))[2,5], coef(summary(pds_p_ss_male_category_2_mod1OCD))[2,5], coef(summary(pds_y_ss_female_category_2_mod1OCD))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1OCD))[2,5], coef(summary(medhx_6m_times_mod1OCD))[2,5], coef(summary(medhx_6n_notes_mod1OCD))[2,5], coef(summary(medhx_6p_notes_mod1OCD))[2,5])
ResultsOCDb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsOCD
ResultsOCD_cont <- rbind(ResultsOCD, ResultsOCDb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsOCD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsOCD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsOCD_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsOCD <- rbind(ResultsOCD_cont, ResultsOCD_cat)
# 2 tiers of FDR correction
ResultsOCD$FDR <- p.adjust(ResultsOCD$Pval, method="fdr")
ResultsOCD$Bonferroni <- p.adjust(ResultsOCD$Pval, method = "bonferroni")
#Write out ResultsOCD
fwrite(ResultsOCD, "OCD_ResultsOCD_base_8.23.23.csv")




## PTSD PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsPTSD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsPTSD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsPTSD) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1PTSD <- lmer(reshist_state_immigrant_factor ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1PTSD <- lmer(pds_f4_p ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1PTSD <- lmer(pds_f4_2_y ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1PTSD <- lmer(pds_m4_y ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1PTSD <- lmer(pds_m5_y ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1PTSD <- lmer(pds_m5_p ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1PTSD <- lmer(pds_m4_p ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1PTSD <- lmer(pds_p_ss_female_category_2 ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1PTSD <- lmer(pds_p_ss_male_category_2 ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1PTSD <- lmer(pds_y_ss_female_category_2 ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1PTSD <- lmer(pds_y_ss_male_cat_2 ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1PTSD <- lmer(medhx_6m_times ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1PTSD <- lmer(medhx_6n_notes ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1PTSD <- lmer(medhx_6p_notes ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsPTSD from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1PTSD))[2,1], coef(summary(pds_f4_p_mod1PTSD))[2,1], coef(summary(pds_m5_y_mod1PTSD))[2,1], coef(summary(pds_f4_2_y_mod1PTSD))[2,1], coef(summary(pds_m4_y_mod1PTSD))[2,1], coef(summary(pds_m5_p_mod1PTSD))[2,1],coef(summary(pds_m4_p_mod1PTSD))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1PTSD))[2,1], coef(summary(pds_p_ss_male_category_2_mod1PTSD))[2,1], coef(summary(pds_y_ss_female_category_2_mod1PTSD))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1PTSD))[2,1], coef(summary(medhx_6m_times_mod1PTSD))[2,1], coef(summary(medhx_6n_notes_mod1PTSD))[2,1], coef(summary(medhx_6p_notes_mod1PTSD))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1PTSD))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1PTSD))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1PTSD))[2,2], coef(summary(pds_f4_p_mod1PTSD))[2,2], coef(summary(pds_f4_2_y_mod1PTSD))[2,2], coef(summary(pds_m4_y_mod1PTSD))[2,2], coef(summary(pds_m5_y_mod1PTSD))[2,2], coef(summary(pds_m5_p_mod1PTSD))[2,2], coef(summary(pds_m4_p_mod1PTSD))[2,2], coef(summary(pds_p_ss_female_category_2_mod1PTSD))[2,2], coef(summary(pds_p_ss_male_category_2_mod1PTSD))[2,2], coef(summary(pds_y_ss_female_category_2_mod1PTSD))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1PTSD))[2,2], coef(summary(medhx_6m_times_mod1PTSD))[2,2], coef(summary(medhx_6n_notes_mod1PTSD))[2,2], coef(summary(medhx_6p_notes_mod1PTSD))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1PTSD))[2,5], coef(summary(pds_f4_p_mod1PTSD))[2,5], coef(summary(pds_f4_2_y_mod1PTSD))[2,5], coef(summary(pds_m4_y_mod1PTSD))[2,5], coef(summary(pds_m5_y_mod1PTSD))[2,5],coef(summary(pds_m5_p_mod1PTSD))[2,5], coef(summary(pds_m4_p_mod1PTSD))[2,5], coef(summary(pds_p_ss_female_category_2_mod1PTSD))[2,5], coef(summary(pds_p_ss_male_category_2_mod1PTSD))[2,5], coef(summary(pds_y_ss_female_category_2_mod1PTSD))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1PTSD))[2,5], coef(summary(medhx_6m_times_mod1PTSD))[2,5], coef(summary(medhx_6n_notes_mod1PTSD))[2,5], coef(summary(medhx_6p_notes_mod1PTSD))[2,5])
ResultsPTSDb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsPTSD
ResultsPTSD_cont <- rbind(ResultsPTSD, ResultsPTSDb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsPTSD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsPTSD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsPTSD_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsPTSD <- rbind(ResultsPTSD_cont, ResultsPTSD_cat)
# 2 tiers of FDR correction
ResultsPTSD$FDR <- p.adjust(ResultsPTSD$Pval, method="fdr")
ResultsPTSD$Bonferroni <- p.adjust(ResultsPTSD$Pval, method = "bonferroni")
#Write out ResultsPTSD
fwrite(ResultsPTSD, "PTSD_ResultsPTSD_base_8.23.23.csv")



## MDD PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsMDD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsMDD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsMDD) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1MDD <- lmer(reshist_state_immigrant_factor ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1MDD <- lmer(pds_f4_p ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1MDD <- lmer(pds_f4_2_y ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1MDD <- lmer(pds_m4_y ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1MDD <- lmer(pds_m5_y ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1MDD <- lmer(pds_m5_p ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1MDD <- lmer(pds_m4_p ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1MDD <- lmer(pds_p_ss_female_category_2 ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1MDD <- lmer(pds_p_ss_male_category_2 ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1MDD <- lmer(pds_y_ss_female_category_2 ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1MDD <- lmer(pds_y_ss_male_cat_2 ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1MDD <- lmer(medhx_6m_times ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1MDD <- lmer(medhx_6n_notes ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1MDD <- lmer(medhx_6p_notes ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsMDD from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1MDD))[2,1], coef(summary(pds_f4_p_mod1MDD))[2,1], coef(summary(pds_m5_y_mod1MDD))[2,1], coef(summary(pds_f4_2_y_mod1MDD))[2,1], coef(summary(pds_m4_y_mod1MDD))[2,1], coef(summary(pds_m5_p_mod1MDD))[2,1],coef(summary(pds_m4_p_mod1MDD))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1MDD))[2,1], coef(summary(pds_p_ss_male_category_2_mod1MDD))[2,1], coef(summary(pds_y_ss_female_category_2_mod1MDD))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1MDD))[2,1], coef(summary(medhx_6m_times_mod1MDD))[2,1], coef(summary(medhx_6n_notes_mod1MDD))[2,1], coef(summary(medhx_6p_notes_mod1MDD))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1MDD))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1MDD))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1MDD))[2,2], coef(summary(pds_f4_p_mod1MDD))[2,2], coef(summary(pds_f4_2_y_mod1MDD))[2,2], coef(summary(pds_m4_y_mod1MDD))[2,2], coef(summary(pds_m5_y_mod1MDD))[2,2], coef(summary(pds_m5_p_mod1MDD))[2,2], coef(summary(pds_m4_p_mod1MDD))[2,2], coef(summary(pds_p_ss_female_category_2_mod1MDD))[2,2], coef(summary(pds_p_ss_male_category_2_mod1MDD))[2,2], coef(summary(pds_y_ss_female_category_2_mod1MDD))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1MDD))[2,2], coef(summary(medhx_6m_times_mod1MDD))[2,2], coef(summary(medhx_6n_notes_mod1MDD))[2,2], coef(summary(medhx_6p_notes_mod1MDD))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1MDD))[2,5], coef(summary(pds_f4_p_mod1MDD))[2,5], coef(summary(pds_f4_2_y_mod1MDD))[2,5], coef(summary(pds_m4_y_mod1MDD))[2,5], coef(summary(pds_m5_y_mod1MDD))[2,5],coef(summary(pds_m5_p_mod1MDD))[2,5], coef(summary(pds_m4_p_mod1MDD))[2,5], coef(summary(pds_p_ss_female_category_2_mod1MDD))[2,5], coef(summary(pds_p_ss_male_category_2_mod1MDD))[2,5], coef(summary(pds_y_ss_female_category_2_mod1MDD))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1MDD))[2,5], coef(summary(medhx_6m_times_mod1MDD))[2,5], coef(summary(medhx_6n_notes_mod1MDD))[2,5], coef(summary(medhx_6p_notes_mod1MDD))[2,5])
ResultsMDDb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsMDD
ResultsMDD_cont <- rbind(ResultsMDD, ResultsMDDb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsMDD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsMDD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsMDD_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsMDD <- rbind(ResultsMDD_cont, ResultsMDD_cat)
# 2 tiers of FDR correction
ResultsMDD$FDR <- p.adjust(ResultsMDD$Pval, method="fdr")
ResultsMDD$Bonferroni <- p.adjust(ResultsMDD$Pval, method = "bonferroni")
#Write out ResultsMDD
fwrite(ResultsMDD, "MDD_ResultsMDD_base_8.23.23.csv")




## SCZ PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsSCZ <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsSCZ <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsSCZ) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1SCZ <- lmer(reshist_state_immigrant_factor ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1SCZ <- lmer(pds_f4_p ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1SCZ <- lmer(pds_f4_2_y ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1SCZ <- lmer(pds_m4_y ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1SCZ <- lmer(pds_m5_y ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1SCZ <- lmer(pds_m5_p ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1SCZ <- lmer(pds_m4_p ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1SCZ <- lmer(pds_p_ss_female_category_2 ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1SCZ <- lmer(pds_p_ss_male_category_2 ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1SCZ <- lmer(pds_y_ss_female_category_2 ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1SCZ <- lmer(pds_y_ss_male_cat_2 ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1SCZ <- lmer(medhx_6m_times ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1SCZ <- lmer(medhx_6n_notes ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1SCZ <- lmer(medhx_6p_notes ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsSCZ from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1SCZ))[2,1], coef(summary(pds_f4_p_mod1SCZ))[2,1], coef(summary(pds_m5_y_mod1SCZ))[2,1], coef(summary(pds_f4_2_y_mod1SCZ))[2,1], coef(summary(pds_m4_y_mod1SCZ))[2,1], coef(summary(pds_m5_p_mod1SCZ))[2,1],coef(summary(pds_m4_p_mod1SCZ))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1SCZ))[2,1], coef(summary(pds_p_ss_male_category_2_mod1SCZ))[2,1], coef(summary(pds_y_ss_female_category_2_mod1SCZ))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1SCZ))[2,1], coef(summary(medhx_6m_times_mod1SCZ))[2,1], coef(summary(medhx_6n_notes_mod1SCZ))[2,1], coef(summary(medhx_6p_notes_mod1SCZ))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1SCZ))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1SCZ))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1SCZ))[2,2], coef(summary(pds_f4_p_mod1SCZ))[2,2], coef(summary(pds_f4_2_y_mod1SCZ))[2,2], coef(summary(pds_m4_y_mod1SCZ))[2,2], coef(summary(pds_m5_y_mod1SCZ))[2,2], coef(summary(pds_m5_p_mod1SCZ))[2,2], coef(summary(pds_m4_p_mod1SCZ))[2,2], coef(summary(pds_p_ss_female_category_2_mod1SCZ))[2,2], coef(summary(pds_p_ss_male_category_2_mod1SCZ))[2,2], coef(summary(pds_y_ss_female_category_2_mod1SCZ))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1SCZ))[2,2], coef(summary(medhx_6m_times_mod1SCZ))[2,2], coef(summary(medhx_6n_notes_mod1SCZ))[2,2], coef(summary(medhx_6p_notes_mod1SCZ))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1SCZ))[2,5], coef(summary(pds_f4_p_mod1SCZ))[2,5], coef(summary(pds_f4_2_y_mod1SCZ))[2,5], coef(summary(pds_m4_y_mod1SCZ))[2,5], coef(summary(pds_m5_y_mod1SCZ))[2,5],coef(summary(pds_m5_p_mod1SCZ))[2,5], coef(summary(pds_m4_p_mod1SCZ))[2,5], coef(summary(pds_p_ss_female_category_2_mod1SCZ))[2,5], coef(summary(pds_p_ss_male_category_2_mod1SCZ))[2,5], coef(summary(pds_y_ss_female_category_2_mod1SCZ))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1SCZ))[2,5], coef(summary(medhx_6m_times_mod1SCZ))[2,5], coef(summary(medhx_6n_notes_mod1SCZ))[2,5], coef(summary(medhx_6p_notes_mod1SCZ))[2,5])
ResultsSCZb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsSCZ
ResultsSCZ_cont <- rbind(ResultsSCZ, ResultsSCZb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsSCZ <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsSCZ_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsSCZ_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsSCZ <- rbind(ResultsSCZ_cont, ResultsSCZ_cat)
# 2 tiers of FDR correction
ResultsSCZ$FDR <- p.adjust(ResultsSCZ$Pval, method="fdr")
ResultsSCZ$Bonferroni <- p.adjust(ResultsSCZ$Pval, method = "bonferroni")
#Write out ResultsSCZ
fwrite(ResultsSCZ, "SCZ_ResultsSCZ_base_8.23.23.csv")





## GAD PRS Baseline ##
# CONTINUOUS VARIALBES AS OUTCOME
First <- 32
Last <- 667
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsGAD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_baseline_indiv[,i] ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}

ResultsGAD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsGAD) <- c("Variable", "Beta", "STE", "Pval")

# reshist, pds, medhx variables - running these separately from the for loop, as they required me to take out some covariates - e.g., the puberty questions were for particular sexes, so taking out sex as a covariate

reshist_state_immigrant_factor_mod1GAD <- lmer(reshist_state_immigrant_factor ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_p_mod1GAD <- lmer(pds_f4_p ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_f4_2_y_mod1GAD <- lmer(pds_f4_2_y ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_y_mod1GAD <- lmer(pds_m4_y ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_y_mod1GAD <- lmer(pds_m5_y ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m5_p_mod1GAD <- lmer(pds_m5_p ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_m4_p_mod1GAD <- lmer(pds_m4_p ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_female_category_2_mod1GAD <- lmer(pds_p_ss_female_category_2 ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_p_ss_male_category_2_mod1GAD <- lmer(pds_p_ss_male_category_2 ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_female_category_2_mod1GAD <- lmer(pds_y_ss_female_category_2 ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

pds_y_ss_male_cat_2_mod1GAD <- lmer(pds_y_ss_male_cat_2 ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|site_id) + (1|rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6m_times_mod1GAD <- lmer(medhx_6m_times ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6n_notes_mod1GAD <- lmer(medhx_6n_notes ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

medhx_6p_notes_mod1GAD <- lmer(medhx_6p_notes ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|site_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = PheWAS_baseline_indiv)

which(colnames(PheWAS_baseline_indiv) == "medhx_6p_notes")

## merging the ResultsGAD from the above models 
Variable <- colnames(PheWAS_baseline_indiv[668:681])
Beta <- c(coef(summary(reshist_state_immigrant_factor_mod1GAD))[2,1], coef(summary(pds_f4_p_mod1GAD))[2,1], coef(summary(pds_m5_y_mod1GAD))[2,1], coef(summary(pds_f4_2_y_mod1GAD))[2,1], coef(summary(pds_m4_y_mod1GAD))[2,1], coef(summary(pds_m5_p_mod1GAD))[2,1],coef(summary(pds_m4_p_mod1GAD))[2,1],
          coef(summary(pds_p_ss_female_category_2_mod1GAD))[2,1], coef(summary(pds_p_ss_male_category_2_mod1GAD))[2,1], coef(summary(pds_y_ss_female_category_2_mod1GAD))[2,1], coef(summary(pds_y_ss_male_cat_2_mod1GAD))[2,1], coef(summary(medhx_6m_times_mod1GAD))[2,1], coef(summary(medhx_6n_notes_mod1GAD))[2,1], coef(summary(medhx_6p_notes_mod1GAD))[2,1])
coef(summary(reshist_state_immigrant_factor_mod1GAD))[2,2]
coef(summary(reshist_state_immigrant_factor_mod1GAD))[2,5]
STE <- c(coef(summary(reshist_state_immigrant_factor_mod1GAD))[2,2], coef(summary(pds_f4_p_mod1GAD))[2,2], coef(summary(pds_f4_2_y_mod1GAD))[2,2], coef(summary(pds_m4_y_mod1GAD))[2,2], coef(summary(pds_m5_y_mod1GAD))[2,2], coef(summary(pds_m5_p_mod1GAD))[2,2], coef(summary(pds_m4_p_mod1GAD))[2,2], coef(summary(pds_p_ss_female_category_2_mod1GAD))[2,2], coef(summary(pds_p_ss_male_category_2_mod1GAD))[2,2], coef(summary(pds_y_ss_female_category_2_mod1GAD))[2,2], coef(summary(pds_y_ss_male_cat_2_mod1GAD))[2,2], coef(summary(medhx_6m_times_mod1GAD))[2,2], coef(summary(medhx_6n_notes_mod1GAD))[2,2], coef(summary(medhx_6p_notes_mod1GAD))[2,2])
Pval <- c(coef(summary(reshist_state_immigrant_factor_mod1GAD))[2,5], coef(summary(pds_f4_p_mod1GAD))[2,5], coef(summary(pds_f4_2_y_mod1GAD))[2,5], coef(summary(pds_m4_y_mod1GAD))[2,5], coef(summary(pds_m5_y_mod1GAD))[2,5],coef(summary(pds_m5_p_mod1GAD))[2,5], coef(summary(pds_m4_p_mod1GAD))[2,5], coef(summary(pds_p_ss_female_category_2_mod1GAD))[2,5], coef(summary(pds_p_ss_male_category_2_mod1GAD))[2,5], coef(summary(pds_y_ss_female_category_2_mod1GAD))[2,5], coef(summary(pds_y_ss_male_cat_2_mod1GAD))[2,5], coef(summary(medhx_6m_times_mod1GAD))[2,5], coef(summary(medhx_6n_notes_mod1GAD))[2,5], coef(summary(medhx_6p_notes_mod1GAD))[2,5])
ResultsGADb <- cbind(Variable, Beta, STE, Pval)

# merging with the other ResultsGAD
ResultsGAD_cont <- rbind(ResultsGAD, ResultsGADb)

## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 682
Last <- 1302
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
ResultsGAD <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_baseline_indiv[,i] ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_baseline_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
ResultsGAD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
colnames(ResultsGAD_cat) <- c("Variable", "Beta", "STE", "Pval")

# merge
ResultsGAD <- rbind(ResultsGAD_cont, ResultsGAD_cat)
# 2 tiers of FDR correction
ResultsGAD$FDR <- p.adjust(ResultsGAD$Pval, method="fdr")
ResultsGAD$Bonferroni <- p.adjust(ResultsGAD$Pval, method = "bonferroni")
#Write out ResultsGAD
fwrite(ResultsGAD, "GAD_ResultsGAD_base_8.23.23.csv")


ResultsNeur <- fread("Neurodev_results_base_8.11.23.csv")
ResultsADHD <- fread("ADHD_ResultsADHD_base_8.23.23.csv")
ResultsASD <- fread("ASD_ResultsASD_base_8.23.23.csv")
ResultsInt <- fread("Internalizing_results_base_8.11.23.csv")
ResultsMDD <- fread("MDD_ResultsMDD_base_8.23.23.csv")
ResultsPTSD <- fread("PTSD_ResultsPTSD_base_8.23.23.csv")
ResultsGAD <- fread("GAD_ResultsGAD_base_8.23.23.csv")

ResultsNeurFU <- fread("Neurodev_results_FU_8.27.23.txt")
ResultsIntFU <- fread("Internalizing_results_FU_8.27.23.txt")
ResultsPsychFU <- fread("Psychotic_results_FU_8.27.23.txt")
ResultsADHDFU <- fread("ADHD_results_FU_8.27.23.txt")
ResultsASDFU <- fread("ASD_results_FU_8.27.23.txt")
ResultsMDDFU <- fread("MDD_results_FU_8.27.23.txt")
ResultsPTSDFU <- fread("PTSD_results_FU_8.27.23.txt")
ResultsGADFU <- fread("GAD_results_FU_8.27.23.txt")
ResultsPAUFU <- fread("PAU_results_FU_8.27.23.txt")
ResultsSCZFU <- fread("SCZ_results_FU_8.27.23.txt")

NeurFDR <- ResultsNeur %>%
  filter(FDR < .05)
NeurBonf <- ResultsNeur %>%
  filter(Bonferroni < .05)
IntFDR <- ResultsInt %>%
  filter(FDR < .05)
IntBonf <- ResultsInt %>%
  filter(Bonferroni < .05)
ADHDBonf <- ResultsADHD %>%
  filter(Bonferroni < .05)
ASDBonf <- ResultsASD %>%
  filter(Bonferroni < .05)
MDDBonf <- ResultsMDD %>%
  filter(Bonferroni < .05)
PTSDBonf <- ResultsPTSD %>%
  filter(Bonferroni < .05)
GADBonf <- ResultsGAD %>%
  filter(Bonferroni < .05)

NeurFUFDR <- ResultsNeurFU %>%
  filter(FDR < .05)
NeurFUBonf <- ResultsNeurFU %>%
  filter(Bonferroni < .05)
IntFUFDR <- ResultsIntFU %>%
  filter(FDR < .05)
IntFUBonf <- ResultsIntFU %>%
  filter(Bonferroni < .05)
PsychFUFDR <- ResultsPsychFU %>%
  filter(FDR < .05)
PsychFUBonf <- ResultsPsychFU %>%
  filter(Bonferroni < .05)
ADHDFUBonf <- ResultsADHDFU %>%
  filter(Bonferroni < .05)
ADHDFUFDR <- ResultsADHDFU %>%
  filter(FDR < .05)

ASDFUBonf <- ResultsASDFU %>%
  filter(Bonferroni < .05)
MDDFUBonf <- ResultsMDDFU %>%
  filter(Bonferroni < .05)
PTSDFUBonf <- ResultsPTSDFU %>%
  filter(Bonferroni < .05)
GADFUBonf <- ResultsGADFU %>%
  filter(Bonferroni < .05)
SCZFUBonf <- ResultsSCZFU %>%
  filter(Bonferroni < .05)
PAUFUBonf <- ResultsPAUFU %>%
  filter(Bonferroni < .05)
length(which(SCZFUBonf$Variable %in% PsychFUFDR$Variable))
which(SCZFUBonf$Variable %nin% PsychFUFDR$Variable)

length(which(NeurFUBonf$Variable %in% ADHDFUFDR$Variable))

```

#### Individual PRS FU2

```{r}
PheWAS_FU2_indiv <- merge(indivPRS, PheWAS_FU2, by = "subjectkey")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id")
PheWAS_FU_reshist_indiv <- merge(indivPRS, PheWAS_FU_reshist, by = "subjectkey")
PheWAS_FU_reshist_indiv <- PheWAS_FU_reshist_indiv %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id")
PheWAS_FU_sexvar_indiv <- merge(indivPRS, PheWAS_FU_sexvar, by = "subjectkey")
PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id")
PheWAS_FU_other_indiv <- merge(indivPRS, PheWAS_FU_other, by = "subjectkey")
PheWAS_FU_other_indiv <- PheWAS_FU_other_indiv %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id")
PheWAS_FU2_indiv <- as.data.frame(PheWAS_FU2_indiv)
PheWAS_FU_reshist_indiv <- as.data.frame(PheWAS_FU_reshist_indiv)
PheWAS_FU_sexvar_indiv <- as.data.frame(PheWAS_FU_sexvar_indiv)
PheWAS_FU_other_indiv <- as.data.frame(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv)=="tlfb_list_l2___1")
#### ADHD FU2 ####
attach(PheWAS_FU2_indiv)
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUADHD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUADHD) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUADHD_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUADHD_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1ADHD <- glmer(as.factor(reshist_state_mj_laws_rec) ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1ADHD <- glmer(as.factor(reshist_state_mj_laws_med) ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1ADHD <- glmer(as.factor(reshist_state_mj_laws_low) ~ ADHD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1ADHD))[2,1], coef(summary(mj_laws_med_mod1ADHD))[2,1], coef(summary(mj_laws_low_mod1ADHD))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1ADHD))[2,2], coef(summary(mj_laws_med_mod1ADHD))[2,2], coef(summary(mj_laws_low_mod1ADHD))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1ADHD))[2,4], coef(summary(mj_laws_med_mod1ADHD))[2,4], coef(summary(mj_laws_low_mod1ADHD))[2,4])
ResultsFUADHD_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUADHD_reshist <- rbind(ResultsFUADHD_reshist, ResultsFUADHD_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUADHD_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUADHD_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1ADHD <- glmer(pds_f5_y ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1ADHD <- glmer(pds_f5b_p ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1ADHD <- glmer(menstrualcycle3_y ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1ADHD <- glmer(menstrualcycle3_p ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1ADHD))[2,1], coef(summary(pds_f5b_p_mod1ADHD))[2,1], coef(summary(menstrualcycle3_y_mod1ADHD))[2,1], coef(summary(menstrualcycle3_p_mod1ADHD))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1ADHD))[2,2], coef(summary(pds_f5b_p_mod1ADHD))[2,2], coef(summary(menstrualcycle3_y_mod1ADHD))[2,2], coef(summary(menstrualcycle3_p_mod1ADHD))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1ADHD))[2,4], coef(summary(pds_f5b_p_mod1ADHD))[2,4], coef(summary(menstrualcycle3_y_mod1ADHD))[2,4], coef(summary(menstrualcycle3_p_mod1ADHD))[2,4])
ResultsFUADHD_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUADHD_sexvar <- rbind(ResultsFUADHD_sexvar, ResultsFUADHD_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUADHD_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUADHD_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUADHD_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUADHD_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUADHD_other <- rbind(ResultsFUADHD_other, ResultsFUADHD_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ ADHD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUADHD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUADHD_cat) <- c("Variable", "Beta", "STE", "Pval")
ResultsFUADHD_comp <- rbind(ResultsFUADHD, ResultsFUADHD_reshist, ResultsFUADHD_sexvar, ResultsFUADHD_other, ResultsFUADHD_cat)
ResultsFUADHD_comp$FDR <- p.adjust(ResultsFUADHD_comp$Pval, method = "fdr")
ResultsFUADHD_comp$Bonferroni <- p.adjust(ResultsFUADHD_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUADHD_comp, "ADHD_results_FU_8.27.23.txt", sep="\t")



#### PAU FU2 ####
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPAU <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPAU) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPAU_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPAU_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1PAU <- glmer(as.factor(reshist_state_mj_laws_rec) ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1PAU <- glmer(as.factor(reshist_state_mj_laws_med) ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1PAU <- glmer(as.factor(reshist_state_mj_laws_low) ~ PAU_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1PAU))[2,1], coef(summary(mj_laws_med_mod1PAU))[2,1], coef(summary(mj_laws_low_mod1PAU))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1PAU))[2,2], coef(summary(mj_laws_med_mod1PAU))[2,2], coef(summary(mj_laws_low_mod1PAU))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1PAU))[2,4], coef(summary(mj_laws_med_mod1PAU))[2,4], coef(summary(mj_laws_low_mod1PAU))[2,4])
ResultsFUPAU_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUPAU_reshist <- rbind(ResultsFUPAU_reshist, ResultsFUPAU_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPAU_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPAU_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1PAU <- glmer(pds_f5_y ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1PAU <- glmer(pds_f5b_p ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1PAU <- glmer(menstrualcycle3_y ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1PAU <- glmer(menstrualcycle3_p ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1PAU))[2,1], coef(summary(pds_f5b_p_mod1PAU))[2,1], coef(summary(menstrualcycle3_y_mod1PAU))[2,1], coef(summary(menstrualcycle3_p_mod1PAU))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1PAU))[2,2], coef(summary(pds_f5b_p_mod1PAU))[2,2], coef(summary(menstrualcycle3_y_mod1PAU))[2,2], coef(summary(menstrualcycle3_p_mod1PAU))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1PAU))[2,4], coef(summary(pds_f5b_p_mod1PAU))[2,4], coef(summary(menstrualcycle3_y_mod1PAU))[2,4], coef(summary(menstrualcycle3_p_mod1PAU))[2,4])
ResultsFUPAU_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUPAU_sexvar <- rbind(ResultsFUPAU_sexvar, ResultsFUPAU_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPAU_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPAU_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPAU_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPAU_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUPAU_other <- rbind(ResultsFUPAU_other, ResultsFUPAU_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ PAU_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPAU_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPAU_cat) <- c("Variable", "Beta", "STE", "Pval")
ResultsFUPAU_comp <- rbind(ResultsFUPAU, ResultsFUPAU_reshist, ResultsFUPAU_sexvar, ResultsFUPAU_other, ResultsFUPAU_cat)
#ResultsFUPAU_comp <- ResultsFUPAU_comp %>%
#  dplyr::filter(Variable!="ksads_bd_raw_162_pTRAN")
ResultsFUPAU_comp$FDR <- p.adjust(ResultsFUPAU_comp$Pval, method = "fdr")
ResultsFUPAU_comp$Bonferroni <- p.adjust(ResultsFUPAU_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUPAU_comp, "PAU_results_FU_8.27.23.txt", sep="\t")





#### BIP FU2 ####
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUBIP <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUBIP) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUBIP_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUBIP_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1BIP <- glmer(as.factor(reshist_state_mj_laws_rec) ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1BIP <- glmer(as.factor(reshist_state_mj_laws_med) ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1BIP <- glmer(as.factor(reshist_state_mj_laws_low) ~ BIP_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1BIP))[2,1], coef(summary(mj_laws_med_mod1BIP))[2,1], coef(summary(mj_laws_low_mod1BIP))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1BIP))[2,2], coef(summary(mj_laws_med_mod1BIP))[2,2], coef(summary(mj_laws_low_mod1BIP))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1BIP))[2,4], coef(summary(mj_laws_med_mod1BIP))[2,4], coef(summary(mj_laws_low_mod1BIP))[2,4])
ResultsFUBIP_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUBIP_reshist <- rbind(ResultsFUBIP_reshist, ResultsFUBIP_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUBIP_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUBIP_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1BIP <- glmer(pds_f5_y ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1BIP <- glmer(pds_f5b_p ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1BIP <- glmer(menstrualcycle3_y ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1BIP <- glmer(menstrualcycle3_p ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1BIP))[2,1], coef(summary(pds_f5b_p_mod1BIP))[2,1], coef(summary(menstrualcycle3_y_mod1BIP))[2,1], coef(summary(menstrualcycle3_p_mod1BIP))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1BIP))[2,2], coef(summary(pds_f5b_p_mod1BIP))[2,2], coef(summary(menstrualcycle3_y_mod1BIP))[2,2], coef(summary(menstrualcycle3_p_mod1BIP))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1BIP))[2,4], coef(summary(pds_f5b_p_mod1BIP))[2,4], coef(summary(menstrualcycle3_y_mod1BIP))[2,4], coef(summary(menstrualcycle3_p_mod1BIP))[2,4])
ResultsFUBIP_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUBIP_sexvar <- rbind(ResultsFUBIP_sexvar, ResultsFUBIP_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUBIP_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUBIP_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUBIP_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUBIP_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUBIP_other <- rbind(ResultsFUBIP_other, ResultsFUBIP_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ BIP_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUBIP_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUBIP_cat) <- c("Variable", "Beta", "STE", "Pval")
ResultsFUBIP_comp <- rbind(ResultsFUBIP, ResultsFUBIP_reshist, ResultsFUBIP_sexvar, ResultsFUBIP_other, ResultsFUBIP_cat)
ResultsFUBIP_comp$FDR <- p.adjust(ResultsFUBIP_comp$Pval, method = "fdr")
ResultsFUBIP_comp$Bonferroni <- p.adjust(ResultsFUBIP_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUBIP_comp, "BIP_results_FU_8.27.23.txt", sep="\t")





#### ASD FU2 ####
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUASD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUASD) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
ResultsFUASD <- ResultsFUASD %>%
  filter(Variable != "kbi_p_c_school_setting_l_home",
         Variable != "kbi_p_c_school_setting_l_public",
         Variable != "kbi_p_c_school_setting_l_private")
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUASD_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUASD_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1ASD <- glmer(as.factor(reshist_state_mj_laws_rec) ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1ASD <- glmer(as.factor(reshist_state_mj_laws_med) ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1ASD <- glmer(as.factor(reshist_state_mj_laws_low) ~ ASD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1ASD))[2,1], coef(summary(mj_laws_med_mod1ASD))[2,1], coef(summary(mj_laws_low_mod1ASD))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1ASD))[2,2], coef(summary(mj_laws_med_mod1ASD))[2,2], coef(summary(mj_laws_low_mod1ASD))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1ASD))[2,4], coef(summary(mj_laws_med_mod1ASD))[2,4], coef(summary(mj_laws_low_mod1ASD))[2,4])
ResultsFUASD_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUASD_reshist <- rbind(ResultsFUASD_reshist, ResultsFUASD_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUASD_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUASD_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1ASD <- glmer(pds_f5_y ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1ASD <- glmer(pds_f5b_p ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1ASD <- glmer(menstrualcycle3_y ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1ASD <- glmer(menstrualcycle3_p ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1ASD))[2,1], coef(summary(pds_f5b_p_mod1ASD))[2,1], coef(summary(menstrualcycle3_y_mod1ASD))[2,1], coef(summary(menstrualcycle3_p_mod1ASD))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1ASD))[2,2], coef(summary(pds_f5b_p_mod1ASD))[2,2], coef(summary(menstrualcycle3_y_mod1ASD))[2,2], coef(summary(menstrualcycle3_p_mod1ASD))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1ASD))[2,4], coef(summary(pds_f5b_p_mod1ASD))[2,4], coef(summary(menstrualcycle3_y_mod1ASD))[2,4], coef(summary(menstrualcycle3_p_mod1ASD))[2,4])
ResultsFUASD_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUASD_sexvar <- rbind(ResultsFUASD_sexvar, ResultsFUASD_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUASD_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUASD_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUASD_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUASD_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUASD_other <- rbind(ResultsFUASD_other, ResultsFUASD_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ ASD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUASD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUASD_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUASD_comp <- rbind(ResultsFUASD, ResultsFUASD_reshist, ResultsFUASD_sexvar, ResultsFUASD_other, ResultsFUASD_cat)
ResultsFUASD_comp$FDR <- p.adjust(ResultsFUASD_comp$Pval, method = "fdr")
ResultsFUASD_comp$Bonferroni <- p.adjust(ResultsFUASD_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUASD_comp, "ASD_results_FU_8.27.23.txt", sep="\t")


#### AN FU2 ####
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUAN <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUAN) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
ResultsFUAN <- ResultsFUAN %>%
  filter(Variable != "kbi_p_c_school_setting_l_home",
         Variable != "kbi_p_c_school_setting_l_public",
         Variable != "kbi_p_c_school_setting_l_private")
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUAN_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUAN_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1AN <- glmer(as.factor(reshist_state_mj_laws_rec) ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1AN <- glmer(as.factor(reshist_state_mj_laws_med) ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1AN <- glmer(as.factor(reshist_state_mj_laws_low) ~ AN_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1AN))[2,1], coef(summary(mj_laws_med_mod1AN))[2,1], coef(summary(mj_laws_low_mod1AN))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1AN))[2,2], coef(summary(mj_laws_med_mod1AN))[2,2], coef(summary(mj_laws_low_mod1AN))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1AN))[2,4], coef(summary(mj_laws_med_mod1AN))[2,4], coef(summary(mj_laws_low_mod1AN))[2,4])
ResultsFUAN_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUAN_reshist <- rbind(ResultsFUAN_reshist, ResultsFUAN_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUAN_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUAN_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1AN <- glmer(pds_f5_y ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1AN <- glmer(pds_f5b_p ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1AN <- glmer(menstrualcycle3_y ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1AN <- glmer(menstrualcycle3_p ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1AN))[2,1], coef(summary(pds_f5b_p_mod1AN))[2,1], coef(summary(menstrualcycle3_y_mod1AN))[2,1], coef(summary(menstrualcycle3_p_mod1AN))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1AN))[2,2], coef(summary(pds_f5b_p_mod1AN))[2,2], coef(summary(menstrualcycle3_y_mod1AN))[2,2], coef(summary(menstrualcycle3_p_mod1AN))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1AN))[2,4], coef(summary(pds_f5b_p_mod1AN))[2,4], coef(summary(menstrualcycle3_y_mod1AN))[2,4], coef(summary(menstrualcycle3_p_mod1AN))[2,4])
ResultsFUAN_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUAN_sexvar <- rbind(ResultsFUAN_sexvar, ResultsFUAN_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUAN_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUAN_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUAN_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUAN_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUAN_other <- rbind(ResultsFUAN_other, ResultsFUAN_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ AN_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUAN_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUAN_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUAN_comp <- rbind(ResultsFUAN, ResultsFUAN_reshist, ResultsFUAN_sexvar, ResultsFUAN_other, ResultsFUAN_cat)
ResultsFUAN_comp$FDR <- p.adjust(ResultsFUAN_comp$Pval, method = "fdr")
ResultsFUAN_comp$Bonferroni <- p.adjust(ResultsFUAN_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUAN_comp, "AN_results_FU_8.27.23.txt", sep="\t")





#### TS FU2 ####
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUTS <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUTS) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUTS_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUTS_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1TS <- glmer(as.factor(reshist_state_mj_laws_rec) ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1TS <- glmer(as.factor(reshist_state_mj_laws_med) ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1TS <- glmer(as.factor(reshist_state_mj_laws_low) ~ TS_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1TS))[2,1], coef(summary(mj_laws_med_mod1TS))[2,1], coef(summary(mj_laws_low_mod1TS))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1TS))[2,2], coef(summary(mj_laws_med_mod1TS))[2,2], coef(summary(mj_laws_low_mod1TS))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1TS))[2,4], coef(summary(mj_laws_med_mod1TS))[2,4], coef(summary(mj_laws_low_mod1TS))[2,4])
ResultsFUTS_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUTS_reshist <- rbind(ResultsFUTS_reshist, ResultsFUTS_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUTS_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUTS_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1TS <- glmer(pds_f5_y ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1TS <- glmer(pds_f5b_p ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1TS <- glmer(menstrualcycle3_y ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1TS <- glmer(menstrualcycle3_p ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1TS))[2,1], coef(summary(pds_f5b_p_mod1TS))[2,1], coef(summary(menstrualcycle3_y_mod1TS))[2,1], coef(summary(menstrualcycle3_p_mod1TS))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1TS))[2,2], coef(summary(pds_f5b_p_mod1TS))[2,2], coef(summary(menstrualcycle3_y_mod1TS))[2,2], coef(summary(menstrualcycle3_p_mod1TS))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1TS))[2,4], coef(summary(pds_f5b_p_mod1TS))[2,4], coef(summary(menstrualcycle3_y_mod1TS))[2,4], coef(summary(menstrualcycle3_p_mod1TS))[2,4])
ResultsFUTS_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUTS_sexvar <- rbind(ResultsFUTS_sexvar, ResultsFUTS_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUTS_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUTS_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUTS_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUTS_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUTS_other <- rbind(ResultsFUTS_other, ResultsFUTS_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ TS_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUTS_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUTS_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUTS_comp <- rbind(ResultsFUTS, ResultsFUTS_reshist, ResultsFUTS_sexvar, ResultsFUTS_other, ResultsFUTS_cat)
ResultsFUTS_comp$FDR <- p.adjust(ResultsFUTS_comp$Pval, method = "fdr")
ResultsFUTS_comp$Bonferroni <- p.adjust(ResultsFUTS_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUTS_comp, "TS_results_FU_8.27.23.txt", sep="\t")




#### OCD FU2 ####
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUOCD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUOCD) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUOCD_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUOCD_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1OCD <- glmer(as.factor(reshist_state_mj_laws_rec) ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1OCD <- glmer(as.factor(reshist_state_mj_laws_med) ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1OCD <- glmer(as.factor(reshist_state_mj_laws_low) ~ OCD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1OCD))[2,1], coef(summary(mj_laws_med_mod1OCD))[2,1], coef(summary(mj_laws_low_mod1OCD))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1OCD))[2,2], coef(summary(mj_laws_med_mod1OCD))[2,2], coef(summary(mj_laws_low_mod1OCD))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1OCD))[2,4], coef(summary(mj_laws_med_mod1OCD))[2,4], coef(summary(mj_laws_low_mod1OCD))[2,4])
ResultsFUOCD_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUOCD_reshist <- rbind(ResultsFUOCD_reshist, ResultsFUOCD_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUOCD_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUOCD_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1OCD <- glmer(pds_f5_y ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1OCD <- glmer(pds_f5b_p ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1OCD <- glmer(menstrualcycle3_y ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1OCD <- glmer(menstrualcycle3_p ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1OCD))[2,1], coef(summary(pds_f5b_p_mod1OCD))[2,1], coef(summary(menstrualcycle3_y_mod1OCD))[2,1], coef(summary(menstrualcycle3_p_mod1OCD))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1OCD))[2,2], coef(summary(pds_f5b_p_mod1OCD))[2,2], coef(summary(menstrualcycle3_y_mod1OCD))[2,2], coef(summary(menstrualcycle3_p_mod1OCD))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1OCD))[2,4], coef(summary(pds_f5b_p_mod1OCD))[2,4], coef(summary(menstrualcycle3_y_mod1OCD))[2,4], coef(summary(menstrualcycle3_p_mod1OCD))[2,4])
ResultsFUOCD_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUOCD_sexvar <- rbind(ResultsFUOCD_sexvar, ResultsFUOCD_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUOCD_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUOCD_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUOCD_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUOCD_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUOCD_other <- rbind(ResultsFUOCD_other, ResultsFUOCD_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ OCD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUOCD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUOCD_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUOCD_comp <- rbind(ResultsFUOCD, ResultsFUOCD_reshist, ResultsFUOCD_sexvar, ResultsFUOCD_other, ResultsFUOCD_cat)
ResultsFUOCD_comp$FDR <- p.adjust(ResultsFUOCD_comp$Pval, method = "fdr")
ResultsFUOCD_comp$Bonferroni <- p.adjust(ResultsFUOCD_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUOCD_comp, "OCD_results_FU_8.27.23.txt", sep="\t")



#### PTSD FU2 ####
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPTSD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPTSD) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPTSD_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPTSD_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1PTSD <- glmer(as.factor(reshist_state_mj_laws_rec) ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1PTSD <- glmer(as.factor(reshist_state_mj_laws_med) ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1PTSD <- glmer(as.factor(reshist_state_mj_laws_low) ~ PTSD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1PTSD))[2,1], coef(summary(mj_laws_med_mod1PTSD))[2,1], coef(summary(mj_laws_low_mod1PTSD))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1PTSD))[2,2], coef(summary(mj_laws_med_mod1PTSD))[2,2], coef(summary(mj_laws_low_mod1PTSD))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1PTSD))[2,4], coef(summary(mj_laws_med_mod1PTSD))[2,4], coef(summary(mj_laws_low_mod1PTSD))[2,4])
ResultsFUPTSD_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUPTSD_reshist <- rbind(ResultsFUPTSD_reshist, ResultsFUPTSD_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPTSD_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPTSD_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1PTSD <- glmer(pds_f5_y ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1PTSD <- glmer(pds_f5b_p ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1PTSD <- glmer(menstrualcycle3_y ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1PTSD <- glmer(menstrualcycle3_p ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1PTSD))[2,1], coef(summary(pds_f5b_p_mod1PTSD))[2,1], coef(summary(menstrualcycle3_y_mod1PTSD))[2,1], coef(summary(menstrualcycle3_p_mod1PTSD))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1PTSD))[2,2], coef(summary(pds_f5b_p_mod1PTSD))[2,2], coef(summary(menstrualcycle3_y_mod1PTSD))[2,2], coef(summary(menstrualcycle3_p_mod1PTSD))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1PTSD))[2,4], coef(summary(pds_f5b_p_mod1PTSD))[2,4], coef(summary(menstrualcycle3_y_mod1PTSD))[2,4], coef(summary(menstrualcycle3_p_mod1PTSD))[2,4])
ResultsFUPTSD_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUPTSD_sexvar <- rbind(ResultsFUPTSD_sexvar, ResultsFUPTSD_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPTSD_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPTSD_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPTSD_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPTSD_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUPTSD_other <- rbind(ResultsFUPTSD_other, ResultsFUPTSD_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ PTSD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUPTSD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUPTSD_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUPTSD_comp <- rbind(ResultsFUPTSD, ResultsFUPTSD_reshist, ResultsFUPTSD_sexvar, ResultsFUPTSD_other, ResultsFUPTSD_cat)
ResultsFUPTSD_comp$FDR <- p.adjust(ResultsFUPTSD_comp$Pval, method = "fdr")
ResultsFUPTSD_comp$Bonferroni <- p.adjust(ResultsFUPTSD_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUPTSD_comp, "PTSD_results_FU_8.27.23.txt", sep="\t")




#### SCZ FU2 ####
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUSCZ <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUSCZ) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUSCZ_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUSCZ_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1SCZ <- glmer(as.factor(reshist_state_mj_laws_rec) ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1SCZ <- glmer(as.factor(reshist_state_mj_laws_med) ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1SCZ <- glmer(as.factor(reshist_state_mj_laws_low) ~ SCZ_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1SCZ))[2,1], coef(summary(mj_laws_med_mod1SCZ))[2,1], coef(summary(mj_laws_low_mod1SCZ))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1SCZ))[2,2], coef(summary(mj_laws_med_mod1SCZ))[2,2], coef(summary(mj_laws_low_mod1SCZ))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1SCZ))[2,4], coef(summary(mj_laws_med_mod1SCZ))[2,4], coef(summary(mj_laws_low_mod1SCZ))[2,4])
ResultsFUSCZ_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUSCZ_reshist <- rbind(ResultsFUSCZ_reshist, ResultsFUSCZ_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUSCZ_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUSCZ_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1SCZ <- glmer(pds_f5_y ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1SCZ <- glmer(pds_f5b_p ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1SCZ <- glmer(menstrualcycle3_y ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1SCZ <- glmer(menstrualcycle3_p ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1SCZ))[2,1], coef(summary(pds_f5b_p_mod1SCZ))[2,1], coef(summary(menstrualcycle3_y_mod1SCZ))[2,1], coef(summary(menstrualcycle3_p_mod1SCZ))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1SCZ))[2,2], coef(summary(pds_f5b_p_mod1SCZ))[2,2], coef(summary(menstrualcycle3_y_mod1SCZ))[2,2], coef(summary(menstrualcycle3_p_mod1SCZ))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1SCZ))[2,4], coef(summary(pds_f5b_p_mod1SCZ))[2,4], coef(summary(menstrualcycle3_y_mod1SCZ))[2,4], coef(summary(menstrualcycle3_p_mod1SCZ))[2,4])
ResultsFUSCZ_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUSCZ_sexvar <- rbind(ResultsFUSCZ_sexvar, ResultsFUSCZ_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUSCZ_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUSCZ_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUSCZ_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUSCZ_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUSCZ_other <- rbind(ResultsFUSCZ_other, ResultsFUSCZ_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ SCZ_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUSCZ_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUSCZ_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUSCZ_comp <- rbind(ResultsFUSCZ, ResultsFUSCZ_reshist, ResultsFUSCZ_sexvar, ResultsFUSCZ_other, ResultsFUSCZ_cat)
ResultsFUSCZ_comp$FDR <- p.adjust(ResultsFUSCZ_comp$Pval, method = "fdr")
ResultsFUSCZ_comp$Bonferroni <- p.adjust(ResultsFUSCZ_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUSCZ_comp, "SCZ_results_FU_8.27.23.txt", sep="\t")




#### GAD FU2 ####
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUGAD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUGAD) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUGAD_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUGAD_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1GAD <- glmer(as.factor(reshist_state_mj_laws_rec) ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1GAD <- glmer(as.factor(reshist_state_mj_laws_med) ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1GAD <- glmer(as.factor(reshist_state_mj_laws_low) ~ GAD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1GAD))[2,1], coef(summary(mj_laws_med_mod1GAD))[2,1], coef(summary(mj_laws_low_mod1GAD))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1GAD))[2,2], coef(summary(mj_laws_med_mod1GAD))[2,2], coef(summary(mj_laws_low_mod1GAD))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1GAD))[2,4], coef(summary(mj_laws_med_mod1GAD))[2,4], coef(summary(mj_laws_low_mod1GAD))[2,4])
ResultsFUGAD_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUGAD_reshist <- rbind(ResultsFUGAD_reshist, ResultsFUGAD_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUGAD_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUGAD_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1GAD <- glmer(pds_f5_y ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1GAD <- glmer(pds_f5b_p ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1GAD <- glmer(menstrualcycle3_y ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1GAD <- glmer(menstrualcycle3_p ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1GAD))[2,1], coef(summary(pds_f5b_p_mod1GAD))[2,1], coef(summary(menstrualcycle3_y_mod1GAD))[2,1], coef(summary(menstrualcycle3_p_mod1GAD))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1GAD))[2,2], coef(summary(pds_f5b_p_mod1GAD))[2,2], coef(summary(menstrualcycle3_y_mod1GAD))[2,2], coef(summary(menstrualcycle3_p_mod1GAD))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1GAD))[2,4], coef(summary(pds_f5b_p_mod1GAD))[2,4], coef(summary(menstrualcycle3_y_mod1GAD))[2,4], coef(summary(menstrualcycle3_p_mod1GAD))[2,4])
ResultsFUGAD_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUGAD_sexvar <- rbind(ResultsFUGAD_sexvar, ResultsFUGAD_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUGAD_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUGAD_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUGAD_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUGAD_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUGAD_other <- rbind(ResultsFUGAD_other, ResultsFUGAD_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ GAD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUGAD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUGAD_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUGAD_comp <- rbind(ResultsFUGAD, ResultsFUGAD_reshist, ResultsFUGAD_sexvar, ResultsFUGAD_other, ResultsFUGAD_cat)
ResultsFUGAD_comp$FDR <- p.adjust(ResultsFUGAD_comp$Pval, method = "fdr")
ResultsFUGAD_comp$Bonferroni <- p.adjust(ResultsFUGAD_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUGAD_comp, "GAD_results_FU_8.27.23.txt", sep="\t")





#### MDD FU2 ####
First <- 33
Last <- 1065
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU2_indiv[,i] ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUMDD <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUMDD) <- c("Variable", "Beta", "STE", "Pval")
intersect(search(), objects())
detach(PheWAS_FU2_indiv)
attach(PheWAS_FU_reshist_indiv)

# take out rel_family_id and covid visit type (shouldn't matter anyway)
First <- 33
Last <- 129
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_reshist_indiv[,i] ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_reshist_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUMDD_reshist <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUMDD_reshist) <- c("Variable", "Beta", "STE", "Pval")


## family or site ID???
mj_laws_rec_mod1MDD <- glmer(as.factor(reshist_state_mj_laws_rec) ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_med_mod1MDD <- glmer(as.factor(reshist_state_mj_laws_med) ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)
mj_laws_low_mod1MDD <- glmer(as.factor(reshist_state_mj_laws_low) ~ MDD_PRScs +  C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + sex + (1|rel_family_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_reshist_indiv)

Variable <- colnames(PheWAS_FU_reshist_indiv[130:132])
Beta <- c(coef(summary(mj_laws_rec_mod1MDD))[2,1], coef(summary(mj_laws_med_mod1MDD))[2,1], coef(summary(mj_laws_low_mod1MDD))[2,1])
STE <- c(coef(summary(mj_laws_rec_mod1MDD))[2,2], coef(summary(mj_laws_med_mod1MDD))[2,2], coef(summary(mj_laws_low_mod1MDD))[2,2])
Pval <- c(coef(summary(mj_laws_rec_mod1MDD))[2,4], coef(summary(mj_laws_med_mod1MDD))[2,4], coef(summary(mj_laws_low_mod1MDD))[2,4])
ResultsFUMDD_reshistb <- cbind(Variable, Beta, STE, Pval)

ResultsFUMDD_reshist <- rbind(ResultsFUMDD_reshist, ResultsFUMDD_reshistb)


detach(PheWAS_FU_reshist_indiv)

PheWAS_FU_sexvar_indiv <- PheWAS_FU_sexvar_indiv %>%
  relocate(where(is.factor), .after = where(is.numeric)) %>%
  relocate(subjectkey:COVID_visittype, .before = where(is.numeric)) %>%
  relocate(FID, .after = "subjectkey") %>%
  relocate(rel_family_id, .after = "FID") %>%
  relocate(site_id, .after = "rel_family_id") %>%
  relocate(sex, .after = "Internalizing_PRScs") %>%
  relocate(interview_age, .after = "sex") %>%
  relocate(COVID_visittype, .after = "interview_age")

attach(PheWAS_FU_sexvar_indiv)
# take out sex and covid visit type
First <- 33
Last <- 93
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_sexvar_indiv[,i] ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_sexvar_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUMDD_sexvar <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUMDD_sexvar) <- c("Variable", "Beta", "STE", "Pval")

pds_f5_y_mod1MDD <- glmer(pds_f5_y ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
pds_f5b_p_mod1MDD <- glmer(pds_f5b_p ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_y_mod1MDD <- glmer(menstrualcycle3_y ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)
menstrualcycle3_p_mod1MDD <- glmer(menstrualcycle3_p ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age + (1|rel_family_id) + (1|site_id), nAGQ = 0, family = "binomial", data = PheWAS_FU_sexvar_indiv)

Variable <- colnames(PheWAS_FU_sexvar_indiv[94:97])
Beta <- c(coef(summary(pds_f5_y_mod1MDD))[2,1], coef(summary(pds_f5b_p_mod1MDD))[2,1], coef(summary(menstrualcycle3_y_mod1MDD))[2,1], coef(summary(menstrualcycle3_p_mod1MDD))[2,1])
STE <- c(coef(summary(pds_f5_y_mod1MDD))[2,2], coef(summary(pds_f5b_p_mod1MDD))[2,2], coef(summary(menstrualcycle3_y_mod1MDD))[2,2], coef(summary(menstrualcycle3_p_mod1MDD))[2,2])
Pval <- c(coef(summary(pds_f5_y_mod1MDD))[2,4], coef(summary(pds_f5b_p_mod1MDD))[2,4], coef(summary(menstrualcycle3_y_mod1MDD))[2,4], coef(summary(menstrualcycle3_p_mod1MDD))[2,4])
ResultsFUMDD_sexvarb <- cbind(Variable, Beta, STE, Pval)

ResultsFUMDD_sexvar <- rbind(ResultsFUMDD_sexvar, ResultsFUMDD_sexvarb)


detach(PheWAS_FU_sexvar_indiv)
attach(PheWAS_FU_other_indiv)

# take out sex and covid visit type
First <- 33
Last <- 63
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUMDD_other <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUMDD_other) <- c("Variable", "Beta", "STE", "Pval")

# take out sex and covid visit type and family id
First <- 64
Last <- 69
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- lmer(PheWAS_FU_other_indiv[,i] ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id)))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,5]
  Area[i] <- colnames(PheWAS_FU_other_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUMDD_other2 <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUMDD_other2) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUMDD_other <- rbind(ResultsFUMDD_other, ResultsFUMDD_other2)
detach(PheWAS_FU_other_indiv)

which(colnames(PheWAS_FU2_indiv) == "tlfb_list_l2___1")
which(colnames(PheWAS_FU2_indiv) == "kbi_p_c_school_setting_l_home")
PheWAS_FU2_indiv <- PheWAS_FU2_indiv %>%
  relocate(contains("_sq2_"), .after = "kbi_p_c_school_setting_l_private")
attach(PheWAS_FU2_indiv)

# take out sex and covid visit type
First <- 1066
Last <- 1527
Beta <- NULL
STE <- NULL
Area <- NULL
Pval <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(PheWAS_FU2_indiv[,i] ~ MDD_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age +  (1|rel_family_id) + (1|site_id), family = "binomial", nAGQ = 0))
  Beta[i] <- summary(a)$`coefficients`[2]
  STE[i] <- summary(a)$`coefficients`[2,2]
  Pval[i] <-  summary(a)$`coefficients`[2,4]
  Area[i] <- colnames(PheWAS_FU2_indiv)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
ResultsFUMDD_cat <- cbind.data.frame(Area[First:length(Area)], Beta[First:length(Beta)], STE[First:length(STE)], Pval[First:length(Pval)])
#Relabel Results
colnames(ResultsFUMDD_cat) <- c("Variable", "Beta", "STE", "Pval")

ResultsFUMDD_comp <- rbind(ResultsFUMDD, ResultsFUMDD_reshist, ResultsFUMDD_sexvar, ResultsFUMDD_other, ResultsFUMDD_cat)
ResultsFUMDD_comp$FDR <- p.adjust(ResultsFUMDD_comp$Pval, method = "fdr")
ResultsFUMDD_comp$Bonferroni <- p.adjust(ResultsFUMDD_comp$Pval, method = "bonferroni")
#Write out results
fwrite(ResultsFUMDD_comp, "MDD_results_FU_8.27.23.txt", sep="\t")
```

#### Longitudinal

```{r}
## Creating longitudinal dataset 
PheWAS_baseline3 <- read_excel("FINAL_PHEWAS_baseline_n5556_5.11.23.xlsx")
samevars <- read_excel("samevars.xlsx")
baseline_unstd <- PheWAS_baseline3 %>%
  dplyr::select(subjectkey:sex)

longit_base <- PheWAS_baseline[,colnames(PheWAS_baseline) %in% samevars$Variable_base]

longit_base <- cbind(baseline_unstd, longit_base)

longit_base$wave <- rep(1,5556)

longit_base$FID <- factor(longit_base$FID)
longit_base$rel_family_id <- as.factor(longit_base$rel_family_id)
longit_base$site_id <- as.factor(longit_base$site_id)
longit_base$sex <- as.factor(longit_base$sex)
longit_base[, 5:18] <- scale(longit_base[, 5:18])
longit_base$interview_age <- as.numeric(longit_base$interview_age)

PheWAS_FU3 <- read_excel("FINAL_PheWAS_FU2_n5556_07.29.23.xlsx")
FU_unstd <- PheWAS_FU3 %>%
  dplyr::select(subjectkey, interview_age)
FU_unstd$interview_age <- as.numeric(FU_unstd$interview_age)
FU_unstd2 <- cbind(FU_unstd, longit_base[, 1:20]) 
FU_unstd2 <- FU_unstd2[,-3]
FU_unstd2 <- FU_unstd2 %>%
  pivot_longer(c(interview_age, interview_age.1), names_to = "wave", values_to = "interview_age")

FU_unstd2$wave <- ifelse(FU_unstd2$wave == "interview_age", 2, 1)

longit_FU <- PheWAS_FU[,colnames(PheWAS_FU) %in% samevars$Variable_FU]
colnames(longit_FU) <- samevars$Variable_base[match(names(longit_FU), samevars$Variable_FU)]

longit_FU$wave <- rep(2,5556)
longit_FU$subjectkey <- PheWAS_FU$subjectkey
longit_FU <- longit_FU %>%
  dplyr::select(-kbi_p_c_gay, -sai_ss_music_nyr_p, -sai_ss_read_years_p)
longit_base <- longit_base %>%
  dplyr::select(-kbi_p_c_gay, -sai_ss_music_nyr_p, -sai_ss_read_years_p)

longitdf <- bind_rows(longit_base[, c(1, 21:823)], longit_FU)
longitdf$wave <- as.factor(longitdf$wave)
longitdf$subjectkey <- as.factor(longitdf$subjectkey)
FU_unstd2$wave <- as.factor(FU_unstd2$wave)
longitdf <- merge(FU_unstd2, longitdf, by = c("subjectkey", "wave"), all.y = T)
longitdf <- longitdf %>%
  group_by(subjectkey) %>%
  mutate(age.pm = mean(interview_age, na.rm = T)) %>%
  mutate(age.pmc = interview_age - age.pm)

longitdf <- longitdf %>%
  ungroup()

longitdf <- as.data.frame(longitdf)
attach(longitdf)

# Compulsive, Continuous
First <- 22 
Last <- 583
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Compulsive_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Compulsive_PRScs + C2*Compulsive_PRScs + C3*Compulsive_PRScs + C4*Compulsive_PRScs + C5*Compulsive_PRScs + C6*Compulsive_PRScs + C7*Compulsive_PRScs + C8*Compulsive_PRScs + C9*Compulsive_PRScs + C10*Compulsive_PRScs + sex*Compulsive_PRScs + age.pm*Compulsive_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,5]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[16]
  STEPRSxwave[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[16,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store results in a dataframe
Results_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results
colnames(Results_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")

# Compulsive, Continuous no sex
First <- 584 
Last <- 593
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Compulsive_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + age.pm*wave + C1*Compulsive_PRScs + C2*Compulsive_PRScs + C3*Compulsive_PRScs + C4*Compulsive_PRScs + C5*Compulsive_PRScs + C6*Compulsive_PRScs + C7*Compulsive_PRScs + C8*Compulsive_PRScs + C9*Compulsive_PRScs + C10*Compulsive_PRScs + age.pm*Compulsive_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,5]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[15]
  STEPRSxwave[i] <- summary(a)$`coefficients`[15,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[15,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store results in a dataframe
Results_nosex <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results
colnames(Results_nosex) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")


Results_cont_long <- rbind(Results_long, Results_nosex)


## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 594
Last <- 823
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(longitdf[,i] ~ Compulsive_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Compulsive_PRScs + C2*Compulsive_PRScs + C3*Compulsive_PRScs + C4*Compulsive_PRScs + C5*Compulsive_PRScs + C6*Compulsive_PRScs + C7*Compulsive_PRScs + C8*Compulsive_PRScs + C9*Compulsive_PRScs + C10*Compulsive_PRScs + sex*Compulsive_PRScs + age.pm*Compulsive_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,4]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,4]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[16]
  STEPRSxwave[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[16,4]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_cat_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results
colnames(Results_cat_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")

# merge
Results <- rbind(Results_cont_long, Results_cat_long)

# 2 tiers of FDR correction
Results$FDR_PRSxwave <- p.adjust(Results$PvalPRSxwave, method="fdr")
Results$Bonferroni_PRSxwave <- p.adjust(Results$PvalPRSxwave, method="bonferroni")

#Write out results
fwrite(Results, "Compulsive_results_long_9.15.23.csv")






# Psychotic, Continuous
First <- 22 
Last <- 583
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results2 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Psychotic_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Psychotic_PRScs + C2*Psychotic_PRScs + C3*Psychotic_PRScs + C4*Psychotic_PRScs + C5*Psychotic_PRScs + C6*Psychotic_PRScs + C7*Psychotic_PRScs + C8*Psychotic_PRScs + C9*Psychotic_PRScs + C10*Psychotic_PRScs + sex*Psychotic_PRScs + age.pm*Psychotic_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,5]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[16]
  STEPRSxwave[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[16,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results2 in a dataframe
Results2_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results2
colnames(Results2_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")

# Psychotic, Continuous no sex
First <- 584 
Last <- 593
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results2 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Psychotic_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + age.pm*wave + C1*Psychotic_PRScs + C2*Psychotic_PRScs + C3*Psychotic_PRScs + C4*Psychotic_PRScs + C5*Psychotic_PRScs + C6*Psychotic_PRScs + C7*Psychotic_PRScs + C8*Psychotic_PRScs + C9*Psychotic_PRScs + C10*Psychotic_PRScs + age.pm*Psychotic_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,5]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[15]
  STEPRSxwave[i] <- summary(a)$`coefficients`[15,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[15,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results2 in a dataframe
Results2_nosex <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results2
colnames(Results2_nosex) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")


Results2_cont_long <- rbind(Results2_long, Results2_nosex)


## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 594
Last <- 823
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results2 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(longitdf[,i] ~ Psychotic_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Psychotic_PRScs + C2*Psychotic_PRScs + C3*Psychotic_PRScs + C4*Psychotic_PRScs + C5*Psychotic_PRScs + C6*Psychotic_PRScs + C7*Psychotic_PRScs + C8*Psychotic_PRScs + C9*Psychotic_PRScs + C10*Psychotic_PRScs + sex*Psychotic_PRScs + age.pm*Psychotic_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,4]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,4]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[16]
  STEPRSxwave[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[16,4]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}
#Store Results2 in a dataframe
Results2_cat_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results2
colnames(Results2_cat_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")

# merge
Results2 <- rbind(Results2_cont_long, Results2_cat_long)

# 2 tiers of FDR correction
Results2$FDR_PRSxwave <- p.adjust(Results2$PvalPRSxwave, method="fdr")
Results2$Bonferroni_PRSxwave <- p.adjust(Results2$PvalPRSxwave, method="bonferroni")

#Write out Results2
fwrite(Results2, "Psychotic_Results2_long_9.15.23.csv")



# Neurodev, Continuous
First <- 22 
Last <- 583
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results3 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Neurodev_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Neurodev_PRScs + C2*Neurodev_PRScs + C3*Neurodev_PRScs + C4*Neurodev_PRScs + C5*Neurodev_PRScs + C6*Neurodev_PRScs + C7*Neurodev_PRScs + C8*Neurodev_PRScs + C9*Neurodev_PRScs + C10*Neurodev_PRScs + sex*Neurodev_PRScs + age.pm*Neurodev_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,5]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[16]
  STEPRSxwave[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[16,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results3 in a dataframe
Results3_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results3
colnames(Results3_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")

# Neurodev, Continuous no sex
First <- 584 
Last <- 593
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results3 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Neurodev_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + age.pm*wave + C1*Neurodev_PRScs + C2*Neurodev_PRScs + C3*Neurodev_PRScs + C4*Neurodev_PRScs + C5*Neurodev_PRScs + C6*Neurodev_PRScs + C7*Neurodev_PRScs + C8*Neurodev_PRScs + C9*Neurodev_PRScs + C10*Neurodev_PRScs + age.pm*Neurodev_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,5]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[15]
  STEPRSxwave[i] <- summary(a)$`coefficients`[15,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[15,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results3 in a dataframe
Results3_nosex <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results3
colnames(Results3_nosex) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")


Results3_cont_long <- rbind(Results3_long, Results3_nosex)


## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 594
Last <- 823
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results3 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(longitdf[,i] ~ Neurodev_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Neurodev_PRScs + C2*Neurodev_PRScs + C3*Neurodev_PRScs + C4*Neurodev_PRScs + C5*Neurodev_PRScs + C6*Neurodev_PRScs + C7*Neurodev_PRScs + C8*Neurodev_PRScs + C9*Neurodev_PRScs + C10*Neurodev_PRScs + sex*Neurodev_PRScs + age.pm*Neurodev_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,4]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,4]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[16]
  STEPRSxwave[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[16,4]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}
#Store Results3 in a dataframe
Results3_cat_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results3
colnames(Results3_cat_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")

# merge
Results3 <- rbind(Results3_cont_long, Results3_cat_long)

# 2 tiers of FDR correction
Results3$FDR_PRSxwave <- p.adjust(Results3$PvalPRSxwave, method="fdr")
Results3$Bonferroni_PRSxwave <- p.adjust(Results3$PvalPRSxwave, method="bonferroni")

#Write out Results3
fwrite(Results3, "Neurodev_Results3_long_9.15.23.csv")




# Internalizing, Continuous
First <- 22 
Last <- 583
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results4 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Internalizing_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Internalizing_PRScs + C2*Internalizing_PRScs + C3*Internalizing_PRScs + C4*Internalizing_PRScs + C5*Internalizing_PRScs + C6*Internalizing_PRScs + C7*Internalizing_PRScs + C8*Internalizing_PRScs + C9*Internalizing_PRScs + C10*Internalizing_PRScs + sex*Internalizing_PRScs + age.pm*Internalizing_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,5]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[16]
  STEPRSxwave[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[16,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results4 in a dataframe
Results4_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results4
colnames(Results4_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")

# Internalizing, Continuous no sex
First <- 584 
Last <- 593
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results4 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Internalizing_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + age.pm*wave + C1*Internalizing_PRScs + C2*Internalizing_PRScs + C3*Internalizing_PRScs + C4*Internalizing_PRScs + C5*Internalizing_PRScs + C6*Internalizing_PRScs + C7*Internalizing_PRScs + C8*Internalizing_PRScs + C9*Internalizing_PRScs + C10*Internalizing_PRScs + age.pm*Internalizing_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,5]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[15]
  STEPRSxwave[i] <- summary(a)$`coefficients`[15,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[15,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results4 in a dataframe
Results4_nosex <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results4
colnames(Results4_nosex) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")


Results4_cont_long <- rbind(Results4_long, Results4_nosex)


## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 594
Last <- 823
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betawave <- NULL
STEwave <- NULL
Pvalwave <- NULL
BetaPRSxwave <- NULL
STEPRSxwave <- NULL
PvalPRSxwave <- NULL
i <-  NULL
Warn <- NULL
Results4 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(longitdf[,i] ~ Internalizing_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Internalizing_PRScs + C2*Internalizing_PRScs + C3*Internalizing_PRScs + C4*Internalizing_PRScs + C5*Internalizing_PRScs + C6*Internalizing_PRScs + C7*Internalizing_PRScs + C8*Internalizing_PRScs + C9*Internalizing_PRScs + C10*Internalizing_PRScs + sex*Internalizing_PRScs + age.pm*Internalizing_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,4]
  Betawave[i] <- summary(a)$`coefficients`[3]
  STEwave[i] <- summary(a)$`coefficients`[3,2]
  Pvalwave[i] <-  summary(a)$`coefficients`[3,4]
  BetaPRSxwave[i] <- summary(a)$`coefficients`[16]
  STEPRSxwave[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxwave[i] <-  summary(a)$`coefficients`[16,4]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}
#Store Results4 in a dataframe
Results4_cat_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betawave[First:length(Betawave)], STEwave[First:length(STEwave)], Pvalwave[First:length(Pvalwave)], BetaPRSxwave[First:length(BetaPRSxwave)], STEPRSxwave[First:length(STEPRSxwave)], PvalPRSxwave[First:length(PvalPRSxwave)])
#Relabel Results4
colnames(Results4_cat_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betawave", "STEwave", "Pvalwave","BetaPRSxwave", "STEPRSxwave", "PvalPRSxwave")

# merge
Results4 <- rbind(Results4_cont_long, Results4_cat_long)

# 2 tiers of FDR correction
Results4$FDR_PRSxwave <- p.adjust(Results4$PvalPRSxwave, method="fdr")
Results4$Bonferroni_PRSxwave <- p.adjust(Results4$PvalPRSxwave, method="bonferroni")

#Write out Results4
fwrite(Results4, "Internalizing_Results4_long_9.15.23.csv")
```

#### Longitudinal figures

```{r}
## Neurodev PRS
# rerunning significant models to predict
Neuro_long_bisbas11 <- lmer(bisbas11_y ~ Neurodev_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Neurodev_PRScs + C2*Neurodev_PRScs + C3*Neurodev_PRScs + C4*Neurodev_PRScs + C5*Neurodev_PRScs + C6*Neurodev_PRScs + C7*Neurodev_PRScs + C8*Neurodev_PRScs + C9*Neurodev_PRScs + C10*Neurodev_PRScs + sex*Neurodev_PRScs + age.pm*Neurodev_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = longitdf)

newdata <- ggpredict(Neuro_long_bisbas11, terms = c("wave [all]", "Neurodev_PRScs [-1,0,1]"))

Neuro_long_bisbas11_plot <- ggplot(aes(x=x, y = predicted), data = newdata) +
  #geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha = .2, colour = NA) +
  geom_point(aes(col = group), size = 2, position = position_dodge(.2)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high, col = group),width=.15, size = 1, position = position_dodge(.2)) +
  geom_line(aes(color=group, group=group), linewidth = 1, position = position_dodge(.2)) +
  scale_fill_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_color_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_y_continuous(limits = c(-.2,.1), breaks = seq(-.2,.1,.05), expand = c(0,0)) + 
  #scale_x_discrete(limits = c(-19,19), breaks = seq(-18, 18, 3), expand = c(0,0)) +
  xlab("Wave") +
  ylab("Predicted bisbas11_y \n(It would excite me to win a contest)") +
  ggtitle("Neurodevelopmental PRS moderation of bisbas11_y change") +
  theme_classic2() + 
  theme(plot.title=element_text(size = 10, face = "bold", hjust = .5),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_text(size = 10),
        axis.title.x=element_text(size = 10, face = "bold"),
        axis.title.y=element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10, face = "bold", hjust = .5),
        legend.text = element_text(size = 10),
        legend.position = "right",
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.1, "cm"),
        legend.box.margin = margin(0,0,0,-10))

ggsave(plot = Neuro_long_bisbas11_plot, filename = "Neuro_long_bisbas11_plot2.png", dpi = 500, width = 7, height = 5)

Neuro_long_bisbas_basm <- lmer(bis_y_ss_basm_rr ~ Neurodev_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Neurodev_PRScs + C2*Neurodev_PRScs + C3*Neurodev_PRScs + C4*Neurodev_PRScs + C5*Neurodev_PRScs + C6*Neurodev_PRScs + C7*Neurodev_PRScs + C8*Neurodev_PRScs + C9*Neurodev_PRScs + C10*Neurodev_PRScs + sex*Neurodev_PRScs + age.pm*Neurodev_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = longitdf)

newdata <- ggpredict(Neuro_long_bisbas_basm, terms = c("wave [all]", "Neurodev_PRScs [-1,0,1]"))

Neuro_long_bisbas_basm_plot <- ggplot(aes(x=x, y = predicted), data = newdata) +
  #geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha = .2, colour = NA) +
  geom_point(aes(col = group), size = 2, position = position_dodge(.2)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high, col = group),width=.15, size = 1, position = position_dodge(.2)) +
  geom_line(aes(color=group, group=group), linewidth = 1, position = position_dodge(.2)) +
  scale_fill_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_color_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_y_continuous(limits = c(-.21,.06), breaks = seq(-.2,.05,.05), expand = c(0,0)) + 
  #scale_x_discrete(limits = c(-19,19), breaks = seq(-18, 18, 3), expand = c(0,0)) +
  xlab("Wave") +
  ylab("Predicted bis_y_ss_basm_rr \n(BIS/BAS Reward Responsiveness, modified)") +
  ggtitle("Neurodevelopmental PRS moderation of bis_y_ss_basm_rr change") +
  theme_classic2() + 
  theme(plot.title=element_text(size = 10, face = "bold", hjust = .5),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_text(size = 10),
        axis.title.x=element_text(size = 10, face = "bold"),
        axis.title.y=element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10, face = "bold", hjust = .5),
        legend.text = element_text(size = 10),
        legend.position = "right",
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.1, "cm"),
        legend.box.margin = margin(0,0,0,-10))

ggsave(plot = Neuro_long_bisbas_basm_plot, filename = "Neuro_long_bisbas_basm_plot2.png", dpi = 500, width = 7, height = 5)


Neuro_long_bisbas_bas <- lmer(bis_y_ss_bas_rr ~ Neurodev_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Neurodev_PRScs + C2*Neurodev_PRScs + C3*Neurodev_PRScs + C4*Neurodev_PRScs + C5*Neurodev_PRScs + C6*Neurodev_PRScs + C7*Neurodev_PRScs + C8*Neurodev_PRScs + C9*Neurodev_PRScs + C10*Neurodev_PRScs + sex*Neurodev_PRScs + age.pm*Neurodev_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = longitdf)

newdata <- ggpredict(Neuro_long_bisbas_bas, terms = c("wave [all]", "Neurodev_PRScs [-1,0,1]"))

Neuro_long_bisbas_bas_plot <- ggplot(aes(x=x, y = predicted), data = newdata) +
  #geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha = .2, colour = NA) +
  geom_point(aes(col = group), size = 2, position = position_dodge(.2)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high, col = group),width=.15, size = 1, position = position_dodge(.2)) +
  geom_line(aes(color=group, group=group), linewidth = 1, position = position_dodge(.2)) +
  scale_fill_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_color_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_y_continuous(limits = c(-.2,.07), breaks = seq(-.2,.05,.05), expand = c(0,0)) + 
  #scale_x_discrete(limits = c(-19,19), breaks = seq(-18, 18, 3), expand = c(0,0)) +
  xlab("Wave") +
  ylab("Predicted bis_y_ss_bas_rr \n(BIS/BAS Reward Responsiveness, all items)") +
  ggtitle("Neurodevelopmental PRS moderation of bis_y_ss_bas_rr change") +
  theme_classic2() + 
  theme(plot.title=element_text(size = 10, face = "bold", hjust = .5),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_text(size = 10),
        axis.title.x=element_text(size = 10, face = "bold"),
        axis.title.y=element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10, face = "bold", hjust = .5),
        legend.text = element_text(size = 10),
        legend.position = "right",
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.1, "cm"),
        legend.box.margin = margin(0,0,0,-10))

ggsave(plot = Neuro_long_bisbas_bas_plot, filename = "Neuro_long_bisbas_bas_plot2.png", dpi = 500, width = 7, height = 5)

Neuro_long_st1p_comp <- lmer(screentime1_p_composite ~ Neurodev_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Neurodev_PRScs + C2*Neurodev_PRScs + C3*Neurodev_PRScs + C4*Neurodev_PRScs + C5*Neurodev_PRScs + C6*Neurodev_PRScs + C7*Neurodev_PRScs + C8*Neurodev_PRScs + C9*Neurodev_PRScs + C10*Neurodev_PRScs + sex*Neurodev_PRScs + age.pm*Neurodev_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = longitdf)

newdata <- ggpredict(Neuro_long_st1p_comp, terms = c("wave [all]", "Neurodev_PRScs [-1,0,1]"))

Neuro_long_st1p_comp_plot <- ggplot(aes(x=x, y = predicted), data = newdata) +
  #geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha = .2, colour = NA) +
  geom_point(aes(col = group), size = 2, position = position_dodge(.2)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high, col = group),width=.15, size = 1, position = position_dodge(.2)) +
  geom_line(aes(color=group, group=group), linewidth = 1, position = position_dodge(.2)) +
  scale_fill_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_color_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_y_continuous(limits = c(-.2,.11), breaks = seq(-.2,.1,.05), expand = c(0,0)) + 
  #scale_x_discrete(limits = c(-19,19), breaks = seq(-18, 18, 3), expand = c(0,0)) +
  xlab("Wave") +
  ylab("Predicted screentime1_p_composite \n(Caregiver-reported youth weekday screentime)") +
  ggtitle("Neurodevelopmental PRS moderation of screentime1_p_composite change") +
  theme_classic2() + 
  theme(plot.title=element_text(size = 10, face = "bold", hjust = .5),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_text(size = 10),
        axis.title.x=element_text(size = 10, face = "bold"),
        axis.title.y=element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10, face = "bold", hjust = .5),
        legend.text = element_text(size = 10),
        legend.position = "right",
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.1, "cm"),
        legend.box.margin = margin(0,0,0,-10))

ggsave(plot = Neuro_long_st1p_comp_plot, filename = "Neuro_long_st1p_comp_plot2.png", dpi = 500, width = 7, height = 5)


Neuro_long_caff9 <- lmer(su_caff_intake_9_calc ~ Neurodev_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Neurodev_PRScs + C2*Neurodev_PRScs + C3*Neurodev_PRScs + C4*Neurodev_PRScs + C5*Neurodev_PRScs + C6*Neurodev_PRScs + C7*Neurodev_PRScs + C8*Neurodev_PRScs + C9*Neurodev_PRScs + C10*Neurodev_PRScs + sex*Neurodev_PRScs + age.pm*Neurodev_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = longitdf)

newdata <- ggpredict(Neuro_long_caff9, terms = c("wave [all]", "Neurodev_PRScs [-1,0,1]"))

Neuro_long_caff9_plot <- ggplot(aes(x=x, y = predicted), data = newdata) +
  #geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha = .2, colour = NA) +
  geom_point(aes(col = group), size = 2, position = position_dodge(.2)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high, col = group),width=.15, size = 1, position = position_dodge(.2)) +
  geom_line(aes(color=group, group=group), linewidth = 1, position = position_dodge(.2)) +
  scale_fill_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_color_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_y_continuous(limits = c(-.05,.08), breaks = seq(-.05,.075,.025), expand = c(0,0)) + 
  #scale_x_discrete(limits = c(-19,19), breaks = seq(-18, 18, 3), expand = c(0,0)) +
  xlab("Wave") +
  ylab("Predicted su_caff_intake_9_calc \n(Energy drinks per week)") +
  ggtitle("Neurodevelopmental PRS moderation of su_caff_intake_9_calc change") +
  theme_classic2() + 
  theme(plot.title=element_text(size = 10, face = "bold", hjust = .5),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_text(size = 10),
        axis.title.x=element_text(size = 10, face = "bold"),
        axis.title.y=element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10, face = "bold", hjust = .5),
        legend.text = element_text(size = 10),
        legend.position = "right",
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.1, "cm"),
        legend.box.margin = margin(0,0,0,-10))

ggsave(plot = Neuro_long_caff9_plot, filename = "Neuro_long_caff9_plot2.png", dpi = 500, width = 7, height = 5)


Neuro_long_srpf_iiss <- lmer(srpf_y_ss_iiss ~ Neurodev_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Neurodev_PRScs + C2*Neurodev_PRScs + C3*Neurodev_PRScs + C4*Neurodev_PRScs + C5*Neurodev_PRScs + C6*Neurodev_PRScs + C7*Neurodev_PRScs + C8*Neurodev_PRScs + C9*Neurodev_PRScs + C10*Neurodev_PRScs + sex*Neurodev_PRScs + age.pm*Neurodev_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = longitdf)

newdata <- ggpredict(Neuro_long_srpf_iiss, terms = c("wave [all]", "Neurodev_PRScs [-1,0,1]"))

Neuro_long_srpf_iiss_plot <- ggplot(aes(x=x, y = predicted), data = newdata) +
  #geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha = .2, colour = NA) +
  geom_point(aes(col = group), size = 2, position = position_dodge(.2)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high, col = group),width=.15, size = 1, position = position_dodge(.2)) +
  geom_line(aes(color=group, group=group), linewidth = 1, position = position_dodge(.2)) +
  scale_fill_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_color_manual(name = "Neurodevelopmental PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_y_continuous(limits = c(-.12,.3), breaks = seq(-.1,.3,.05), expand = c(0,0)) + 
  #scale_x_discrete(limits = c(-19,19), breaks = seq(-18, 18, 3), expand = c(0,0)) +
  xlab("Wave") +
  ylab("Predicted srpf_y_ss_iiss \n(SRPF School Involvement)") +
  ggtitle("Neurodevelopmental PRS moderation of srpf_y_ss_iiss change") +
  theme_classic2() + 
  theme(plot.title=element_text(size = 10, face = "bold", hjust = .5),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_text(size = 10),
        axis.title.x=element_text(size = 10, face = "bold"),
        axis.title.y=element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10, face = "bold", hjust = .5),
        legend.text = element_text(size = 10),
        legend.position = "right",
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.1, "cm"),
        legend.box.margin = margin(0,0,0,-10))

ggsave(plot = Neuro_long_srpf_iiss_plot, filename = "Neuro_long_srpf_iiss_plot2.png", dpi = 500, width = 7, height = 5)

Int_long_rules5 <- lmer(parent_rules_q5 ~ Internalizing_PRScs*wave + C1*wave + C2*wave + C3*wave + C4*wave + C5*wave + C6*wave + C7*wave + C8*wave + C9*wave + C10*wave + sex*wave + age.pm*wave + C1*Internalizing_PRScs + C2*Internalizing_PRScs + C3*Internalizing_PRScs + C4*Internalizing_PRScs + C5*Internalizing_PRScs + C6*Internalizing_PRScs + C7*Internalizing_PRScs + C8*Internalizing_PRScs + C9*Internalizing_PRScs + C10*Internalizing_PRScs + sex*Internalizing_PRScs + age.pm*Internalizing_PRScs + (1|site_id) + (1|rel_family_id/subjectkey), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)), data = longitdf)

newdata <- ggpredict(Int_long_rules5, terms = c("wave [all]", "Internalizing_PRScs [-1,0,1]"))

Int_long_pmq5_plot <- ggplot(aes(x=x, y = predicted), data = newdata) +
  #geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha = .2, colour = NA) +
  geom_point(aes(col = group), size = 2, position = position_dodge(.2)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high, col = group),width=.15, size = 1, position = position_dodge(.2)) +
  geom_line(aes(color=group, group=group), linewidth = 1, position = position_dodge(.2)) +
  scale_fill_manual(name = "Internalizing PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_color_manual(name = "Internalizing PRS", breaks = c("-1", "0","1"), labels = c("-1SD", "mean", "+1SD"), values = c("#e8ae8d","#c46027", "#8d441b")) +
  scale_y_continuous(limits = c(-.52,.36), breaks = seq(-.5,.35,.05), expand = c(0,0)) + 
  #scale_x_discrete(limits = c(-19,19), breaks = seq(-18, 18, 3), expand = c(0,0)) +
  xlab("Wave") +
  ylab("Predicted parent_rules_q5 \n(Family Rules on Cigarette Smoking)") +
  ggtitle("Internalizing PRS moderation of parent_rules_q5 change") +
  theme_classic2() + 
  theme(plot.title=element_text(size = 10, face = "bold", hjust = .5),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_text(size = 10),
        axis.title.x=element_text(size = 10, face = "bold"),
        axis.title.y=element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10, face = "bold", hjust = .5),
        legend.text = element_text(size = 10),
        legend.position = "right",
        legend.key.size = unit(.6, 'cm'),
        legend.spacing.y = unit(.1, "cm"),
        legend.box.margin = margin(0,0,0,-10))

ggsave(plot = Int_long_pmq5_plot, filename = "Int_long_pmq5_plot.png", dpi = 500, width = 7, height = 5)
```

#### Longitudinal Take 2 - different random intercepts

```{r}
## Creating longitudinal dataset 
PheWAS_baseline3 <- read_excel("FINAL_PHEWAS_baseline_n5556_5.11.23.xlsx")
baseline_unstd <- PheWAS_baseline3 %>%
  dplyr::select(subjectkey:sex)

longit_base <- PheWAS_baseline[,colnames(PheWAS_baseline) %in% samevars$Variable_base] %>%
  dplyr::select(-contains("read_years"), -contains("music"))

longit_base <- cbind(baseline_unstd, longit_base)

longit_base$wave <- rep(1,5556)

longit_base$FID <- factor(longit_base$FID)
longit_base$rel_family_id <- as.factor(longit_base$rel_family_id)
longit_base$site_id <- as.factor(longit_base$site_id)
longit_base$sex <- as.factor(longit_base$sex)
longit_base[, 5:18] <- scale(longit_base[, 5:18])
longit_base$interview_age <- as.numeric(longit_base$interview_age)

PheWAS_FU3 <- read_excel("FINAL_PheWAS_FU2_n5556_07.29.23.xlsx")
FU_unstd <- PheWAS_FU3 %>%
  dplyr::select(subjectkey, interview_age)
FU_unstd$interview_age <- as.numeric(FU_unstd$interview_age)
FU_unstd2 <- cbind(FU_unstd, longit_base[, 1:20]) 
FU_unstd2 <- FU_unstd2[,-3]
FU_unstd2 <- FU_unstd2 %>%
  pivot_longer(c(interview_age, interview_age.1), names_to = "wave", values_to = "interview_age")

FU_unstd2$wave <- ifelse(FU_unstd2$wave == "interview_age", 2, 1)

longit_FU <- PheWAS_FU[,colnames(PheWAS_FU) %in% samevars$Variable_FU] %>%
  dplyr::select(-contains("read_hours"), -contains("music"))
colnames(longit_FU) <- samevars$Variable_base[match(names(longit_FU), samevars$Variable_FU)]

longit_FU$wave <- rep(2,5556)
longit_FU$subjectkey <- PheWAS_FU$subjectkey
longit_FU <- longit_FU %>%
  dplyr::select(-kbi_p_c_gay)
longit_base <- longit_base %>%
  dplyr::select(-kbi_p_c_gay)

longitdf <- bind_rows(longit_base[, c(1, 21:823)], longit_FU)
longitdf$wave <- as.factor(longitdf$wave)
longitdf$subjectkey <- as.factor(longitdf$subjectkey)
FU_unstd2$wave <- as.factor(FU_unstd2$wave)
longitdf <- merge(FU_unstd2, longitdf, by = c("subjectkey", "wave"), all.y = T)
longitdf <- longitdf %>%
  group_by(subjectkey) %>%
  mutate(age.pm = mean(interview_age, na.rm = T)) %>%
  mutate(age.pmc = interview_age - age.pm)


longitdf <- longitdf %>%
  ungroup()

longitdf <- as.data.frame(longitdf)
attach(longitdf)
# Compulsive, Continuous
First <- 22 
Last <- 583
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Compulsive_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + sex*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,5]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,5]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[16,5]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[17]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[17,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[17,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store results in a dataframe
Results_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results
colnames(Results_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

# Compulsive, Continuous no sex
First <- 584 
Last <- 593
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results_nosex <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Compulsive_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,5]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,5]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[15]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[15,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[15,5]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[16,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store results in a dataframe
Results_nosex <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results
colnames(Results_nosex) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

Results_cont_long <- rbind(Results_long, Results_nosex)


## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 594
Last <- 823
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results_cat_long <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(longitdf[,i] ~ Compulsive_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,4]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,4]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,4]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[16,4]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[17]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[17,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[17,4]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}
#Store results in a dataframe
Results_cat_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results
colnames(Results_cat_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

# merge
Results <- rbind(Results_cont_long, Results_cat_long)

# 2 tiers of FDR correction
Results$FDR_PRSxage.pmc <- p.adjust(Results$PvalPRSxage.pmc, method="fdr")
Results$FDR_PRSxage.pm <- p.adjust(Results$PvalPRSxage.pm, method="fdr")
Results$Bonferroni_PRSxage.pmc <- p.adjust(Results$PvalPRSxage.pmc, method="bonferroni")
Results$Bonferroni_PRSxage.pm <- p.adjust(Results$PvalPRSxage.pm, method="bonferroni")

#Write out results
fwrite(Results, "Compulsive_results_long_9.13.23.csv")






# Psychotic, Continuous
First <- 22 
Last <- 583
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results2 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Psychotic_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + sex*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,5]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,5]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[16,5]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[17]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[17,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[17,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results2 in a dataframe
Results2_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results2
colnames(Results2_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

# Psychotic, Continuous no sex
First <- 584 
Last <- 593
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results2_nosex <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Psychotic_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,5]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,5]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[15]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[15,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[15,5]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[16,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results2 in a dataframe
Results2_nosex <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results2
colnames(Results2_nosex) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

Results2_cont_long <- rbind(Results2_long, Results2_nosex)


## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 594
Last <- 823
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results2_cat_long <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(longitdf[,i] ~ Psychotic_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,4]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,4]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,4]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[16,4]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[17]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[17,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[17,4]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}
#Store Results2 in a dataframe
Results2_cat_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results2
colnames(Results2_cat_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

# merge
Results2 <- rbind(Results2_cont_long, Results2_cat_long)

# 2 tiers of FDR correction
Results2$FDR_PRSxage.pmc <- p.adjust(Results2$PvalPRSxage.pmc, method="fdr")
Results2$FDR_PRSxage.pm <- p.adjust(Results2$PvalPRSxage.pm, method="fdr")
Results2$Bonferroni_PRSxage.pmc <- p.adjust(Results2$PvalPRSxage.pmc, method="bonferroni")
Results2$Bonferroni_PRSxage.pm <- p.adjust(Results2$PvalPRSxage.pm, method="bonferroni")

#Write out Results2
fwrite(Results2, "Psychotic_Results2_long_9.13.23.csv")




# Neurodev, Continuous
First <- 22 
Last <- 583
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results3 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Neurodev_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + sex*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,5]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,5]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[16,5]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[17]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[17,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[17,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results3 in a dataframe
Results3_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results3
colnames(Results3_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

# Neurodev, Continuous no sex
First <- 584 
Last <- 593
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results3_nosex <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Neurodev_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,5]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,5]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[15]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[15,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[15,5]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[16,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results3 in a dataframe
Results3_nosex <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results3
colnames(Results3_nosex) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

Results3_cont_long <- rbind(Results3_long, Results3_nosex)


## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 594
Last <- 823
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results3_cat_long <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(longitdf[,i] ~ Neurodev_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,4]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,4]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,4]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[16,4]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[17]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[17,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[17,4]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}
#Store Results3 in a dataframe
Results3_cat_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results3
colnames(Results3_cat_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

# merge
Results3 <- rbind(Results3_cont_long, Results3_cat_long)

# 2 tiers of FDR correction
Results3$FDR_PRSxage.pmc <- p.adjust(Results3$PvalPRSxage.pmc, method="fdr")
Results3$FDR_PRSxage.pm <- p.adjust(Results3$PvalPRSxage.pm, method="fdr")
Results3$Bonferroni_PRSxage.pmc <- p.adjust(Results3$PvalPRSxage.pmc, method="bonferroni")
Results3$Bonferroni_PRSxage.pm <- p.adjust(Results3$PvalPRSxage.pm, method="bonferroni")

#Write out Results3
fwrite(Results3, "Neurodev_Results3_long_9.13.23.csv")




# Internalizing, Continuous
First <- 22 
Last <- 583
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results4 <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Internalizing_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + sex*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,5]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,5]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[16,5]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[17]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[17,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[17,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results4 in a dataframe
Results4_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results4
colnames(Results4_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

# Internalizing, Continuous no sex
First <- 584 
Last <- 593
#creates objects for the loop
Area <- NULL
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results4_nosex <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
#Runs the for loop
for (i in First:Last) {
  print(i)
  #******CHANGE*******add your covariates, build your LMER ADD SEX VARIABLE and do for each interview age to equation (8/26/22)
  LMEOut <- withWarnings( a <- lmer(longitdf[,i] ~ Internalizing_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,5]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,5]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,5]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[15]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[15,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[15,5]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[16,5]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}

#Store Results4 in a dataframe
Results4_nosex <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results4
colnames(Results4_nosex) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

Results4_cont_long <- rbind(Results4_long, Results4_nosex)


## CATEGORICAL VARABIALES AS OUTCOME (calling for categorical variables)
First <- 594
Last <- 823
BetaPRS <- NULL
STEPRS <- NULL
PvalPRS <- NULL
Betaage.pmc <- NULL
STEage.pmc <- NULL
Pvalage.pmc <- NULL
Betaage.pm <- NULL
STEage.pm <- NULL
Pvalage.pm <- NULL
BetaPRSxage.pmc <- NULL
STEPRSxage.pmc <- NULL
PvalPRSxage.pmc <- NULL
BetaPRSxage.pm <- NULL
STEPRSxage.pm <- NULL
PvalPRSxage.pm <- NULL
i <-  NULL
Warn <- NULL
Results4_cat_long <- NULL
Sigs <- NULL
LMEOut <- NULL
a <- NULL
for (i in First:Last) {
  print(i)
  LMEOut <- withWarnings( a <- glmer(longitdf[,i] ~ Internalizing_PRScs*(age.pmc+age.pm) + C1*(age.pmc+age.pm) + C2*(age.pmc+age.pm) + C3*(age.pmc+age.pm) + C4*(age.pmc+age.pm) + C5*(age.pmc+age.pm) + C6*(age.pmc+age.pm) + C7*(age.pmc+age.pm) + C8*(age.pmc+age.pm) + C9*(age.pmc+age.pm) + C10*(age.pmc+age.pm) + (1|subjectkey) + (1|site_id/rel_family_id), family = "binomial", nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5))))
  BetaPRS[i] <- summary(a)$`coefficients`[2]
  STEPRS[i] <- summary(a)$`coefficients`[2,2]
  PvalPRS[i] <-  summary(a)$`coefficients`[2,4]
  Betaage.pmc[i] <- summary(a)$`coefficients`[3]
  STEage.pmc[i] <- summary(a)$`coefficients`[3,2]
  Pvalage.pmc[i] <-  summary(a)$`coefficients`[3,4]
  Betaage.pm[i] <- summary(a)$`coefficients`[4]
  STEage.pm[i] <- summary(a)$`coefficients`[4,2]
  Pvalage.pm[i] <-  summary(a)$`coefficients`[4,4]
  BetaPRSxage.pmc[i] <- summary(a)$`coefficients`[16]
  STEPRSxage.pmc[i] <- summary(a)$`coefficients`[16,2]
  PvalPRSxage.pmc[i] <-  summary(a)$`coefficients`[16,4]
  BetaPRSxage.pm[i] <- summary(a)$`coefficients`[17]
  STEPRSxage.pm[i] <- summary(a)$`coefficients`[17,2]
  PvalPRSxage.pm[i] <-  summary(a)$`coefficients`[17,4]
  Area[i] <- colnames(longitdf)[i]
  Warn[i] <- LMEOut$warnings
}
#Store Results4 in a dataframe
Results4_cat_long <- cbind.data.frame(Area[First:length(Area)], BetaPRS[First:length(BetaPRS)], STEPRS[First:length(STEPRS)], PvalPRS[First:length(PvalPRS)], Betaage.pmc[First:length(Betaage.pmc)], STEage.pmc[First:length(STEage.pmc)], Pvalage.pmc[First:length(Pvalage.pmc)], Betaage.pm[First:length(Betaage.pm)], STEage.pm[First:length(STEage.pm)], Pvalage.pm[First:length(Pvalage.pm)], BetaPRSxage.pmc[First:length(BetaPRSxage.pmc)], STEPRSxage.pmc[First:length(STEPRSxage.pmc)], PvalPRSxage.pmc[First:length(PvalPRSxage.pmc)], BetaPRSxage.pm[First:length(BetaPRSxage.pm)], STEPRSxage.pm[First:length(STEPRSxage.pm)], PvalPRSxage.pm[First:length(PvalPRSxage.pm)])
#Relabel Results4
colnames(Results4_cat_long) <- c("Variable", "BetaPRS", "STEPRS", "PvalPRS", "Betaage.pmc", "STEage.pmc", "Pvalage.pmc", "Betaage.pm", "STEage.pm", "Pvalage.pm","BetaPRSxage.pmc", "STEPRSxage.pmc", "PvalPRSxage.pmc", "BetaPRSxage.pm", "STEPRSxage.pm", "PvalPRSxage.pm")

# merge
Results4 <- rbind(Results4_cont_long, Results4_cat_long)
# 2 tiers of FDR correction
Results4$FDR_PRSxage.pmc <- p.adjust(Results4$PvalPRSxage.pmc, method="fdr")
Results4$FDR_PRSxage.pm <- p.adjust(Results4$PvalPRSxage.pm, method="fdr")
Results4$Bonferroni_PRSxage.pmc <- p.adjust(Results4$PvalPRSxage.pmc, method="bonferroni")
Results4$Bonferroni_PRSxage.pm <- p.adjust(Results4$PvalPRSxage.pm, method="bonferroni")

#Write out Results4
fwrite(Results4, "Internalizing_Results4_long_9.13.23.csv")
```

#### Longitudinal take 3 - difference scores

```{r}
#### creating wide dataset
longitdf_wide <- longitdf %>%
  dplyr::select(-age.pmc, -age.pm) %>%
  mutate(wave = ifelse(wave == 1, "wave1", "wave2")) %>%
  pivot_wider(names_from = wave, values_from = c(21:823))

longit_wide_wave2 <- longitdf_wide %>%
  dplyr::select(contains("wave2"))

longit_wide_wave1 <- longitdf_wide %>%
  dplyr::select(-contains("wave2"))

longitdf_wide2 <- cbind(longit_wide_wave1, longit_wide_wave2)
longitdf_wide3 <- longitdf_wide2 %>%
  mutate(age.pm = ifelse(is.na(interview_age_wave2), NA, (interview_age_wave1 + interview_age_wave2)/2)) %>%
  mutate(age.diff = interview_age_wave2 - interview_age_wave1) %>%
  mutate(age.pm.gmc = scale(age.pm),
         interview_age_wave1 = scale(interview_age_wave1),
         interview_age_wave2 = scale(interview_age_wave2),
         age.diff = scale(age.diff)) %>%
  relocate(interview_age_wave1, .after = "sex") %>%
  relocate(interview_age_wave2, .after = "tbi_3_wave2") %>%
  relocate(age.pm.gmc, .after = "interview_age_wave2") %>%
  relocate(age.diff, .after = "interview_age_wave1") %>%
  rename(interview_age_1 = interview_age_wave1) %>%
  rename(interview_age_2 = interview_age_wave2)
#fwrite(longitdf_wide3, "PheWAS_longitudinal_wide.csv", na = "NA")

cont_data <- longitdf_wide3[,c(1:583,824:1385)]

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(cont_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(cont_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age_1 + age.diff + (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the LMER model
      lmer_model <- lmer(formula = as.formula(formula_str),
                         control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)),
                         data = cont_data)
      
      # Extract beta, standard error, and p-value
      summary_lmer <- summary(lmer_model)
      Beta[i] <- summary(summary_lmer)$`coefficients`[3]
      STE[i] <- summary(summary_lmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_lmer)$`coefficients`[3,5]
      Area[i] <- var_wave2
      WARN[i] <-  summary_lmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}

#GetResultsTogether
Results_diff_cont_Compulsive <- cbind.data.frame(Area, Beta, STE, Pval)

#Get the variables that errored out
No_Run_Errors <- setdiff(wave2_vars, Area)

nosex_data <- longitdf_wide3[,c(1:21,584:593,1386:1395)]

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(nosex_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(nosex_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age_1 + age.diff +  (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the LMER model
      lmer_model <- lmer(formula = as.formula(formula_str),
                         control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)),
                         data = nosex_data)
      
      # Extract beta, standard error, and p-value
      summary_lmer <- summary(lmer_model)
      Beta[i] <- summary(summary_lmer)$`coefficients`[3]
      STE[i] <- summary(summary_lmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_lmer)$`coefficients`[3,5]
      Area[i] <- var_wave2
      WARN[i] <-  summary_lmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}

#GetResultsTogether
Results_diff_nosex_Compulsive <- cbind.data.frame(Area, Beta, STE, Pval)

#Get the variables that errored out
No_Run_Errors2 <- setdiff(wave2_vars, Area)

cat_data <- longitdf_wide3[,c(1:21,594:823,1396:1625)]

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(cat_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(cat_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Compulsive_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age_1 + age.diff + (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the GLMER model
      glmer_model <- glmer(formula = as.formula(formula_str), family = "binomial", 
                          nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)),
                         data = cat_data)
      
      # Extract beta, standard error, and p-value
      summary_glmer <- summary(glmer_model)
      Beta[i] <- summary(summary_glmer)$`coefficients`[3]
      STE[i] <- summary(summary_glmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_glmer)$`coefficients`[3,4]
      Area[i] <- var_wave2
      WARN[i] <-  summary_glmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}
Results_diff_cat_Compulsive <- cbind.data.frame(Area, Beta, STE, Pval)

No_Run_Errors3 <- setdiff(wave2_vars, Area)

Results_diff_Compulsive <- rbind(Results_diff_cont_Compulsive, Results_diff_nosex_Compulsive, Results_diff_cat_Compulsive)
Results_diff_Compulsive$FDR <- p.adjust(Results_diff_Compulsive$Pval, method = "fdr")
Results_diff_Compulsive$Bonferroni <- p.adjust(Results_diff_Compulsive$Pval, method = "bonferroni")




# Psychotic
# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(cont_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(cont_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age_1 + age.diff + (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the LMER model
      lmer_model <- lmer(formula = as.formula(formula_str),
                         control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)),
                         data = cont_data)
      
      # Extract beta, standard error, and p-value
      summary_lmer <- summary(lmer_model)
      Beta[i] <- summary(summary_lmer)$`coefficients`[3]
      STE[i] <- summary(summary_lmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_lmer)$`coefficients`[3,5]
      Area[i] <- var_wave2
      WARN[i] <-  summary_lmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}

#GetResultsTogether
Results_diff_cont_Psychotic <- cbind.data.frame(Area, Beta, STE, Pval)

#Get the variables that errored out
No_Run_Errors <- setdiff(wave2_vars, Area)

nosex_data <- longitdf_wide3[,c(1:21,584:593,1386:1395)]

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(nosex_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(nosex_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age_1 + age.diff +  (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the LMER model
      lmer_model <- lmer(formula = as.formula(formula_str),
                         control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)),
                         data = nosex_data)
      
      # Extract beta, standard error, and p-value
      summary_lmer <- summary(lmer_model)
      Beta[i] <- summary(summary_lmer)$`coefficients`[3]
      STE[i] <- summary(summary_lmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_lmer)$`coefficients`[3,5]
      Area[i] <- var_wave2
      WARN[i] <-  summary_lmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}

#GetResultsTogether
Results_diff_nosex_Psychotic <- cbind.data.frame(Area, Beta, STE, Pval)

#Get the variables that errored out
No_Run_Errors2 <- setdiff(wave2_vars, Area)

cat_data <- longitdf_wide3[,c(1:21,594:823,1396:1625)]

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(cat_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(cat_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Psychotic_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age_1 + age.diff + (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the GLMER model
      glmer_model <- glmer(formula = as.formula(formula_str), family = "binomial", 
                          nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)),
                         data = cat_data)
      
      # Extract beta, standard error, and p-value
      summary_glmer <- summary(glmer_model)
      Beta[i] <- summary(summary_glmer)$`coefficients`[3]
      STE[i] <- summary(summary_glmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_glmer)$`coefficients`[3,4]
      Area[i] <- var_wave2
      WARN[i] <-  summary_glmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}
Results_diff_cat_Psychotic <- cbind.data.frame(Area, Beta, STE, Pval)

No_Run_Errors3 <- setdiff(wave2_vars, Area)

Results_diff_Psychotic <- rbind(Results_diff_cont_Psychotic, Results_diff_nosex_Psychotic, Results_diff_cat_Psychotic)
Results_diff_Psychotic$FDR <- p.adjust(Results_diff_Psychotic$Pval, method = "fdr")
Results_diff_Psychotic$Bonferroni <- p.adjust(Results_diff_Psychotic$Pval, method = "bonferroni")



# Neurodevelopmental

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(cont_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(cont_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age_1 + age.diff + (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the LMER model
      lmer_model <- lmer(formula = as.formula(formula_str),
                         control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)),
                         data = cont_data)
      
      # Extract beta, standard error, and p-value
      summary_lmer <- summary(lmer_model)
      Beta[i] <- summary(summary_lmer)$`coefficients`[3]
      STE[i] <- summary(summary_lmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_lmer)$`coefficients`[3,5]
      Area[i] <- var_wave2
      WARN[i] <-  summary_lmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}

#GetResultsTogether
Results_diff_cont_Neurodev <- cbind.data.frame(Area, Beta, STE, Pval)

#Get the variables that errored out
No_Run_Errors <- setdiff(wave2_vars, Area)

nosex_data <- longitdf_wide3[,c(1:21,584:593,1386:1395)]

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(nosex_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(nosex_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age_1 + age.diff +  (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the LMER model
      lmer_model <- lmer(formula = as.formula(formula_str),
                         control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)),
                         data = nosex_data)
      
      # Extract beta, standard error, and p-value
      summary_lmer <- summary(lmer_model)
      Beta[i] <- summary(summary_lmer)$`coefficients`[3]
      STE[i] <- summary(summary_lmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_lmer)$`coefficients`[3,5]
      Area[i] <- var_wave2
      WARN[i] <-  summary_lmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}

#GetResultsTogether
Results_diff_nosex_Neurodev <- cbind.data.frame(Area, Beta, STE, Pval)

#Get the variables that errored out
No_Run_Errors2 <- setdiff(wave2_vars, Area)

cat_data <- longitdf_wide3[,c(1:21,594:823,1396:1625)]

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(cat_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(cat_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Neurodev_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age_1 + age.diff + (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the GLMER model
      glmer_model <- glmer(formula = as.formula(formula_str), family = "binomial", 
                          nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)),
                         data = cat_data)
      
      # Extract beta, standard error, and p-value
      summary_glmer <- summary(glmer_model)
      Beta[i] <- summary(summary_glmer)$`coefficients`[3]
      STE[i] <- summary(summary_glmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_glmer)$`coefficients`[3,4]
      Area[i] <- var_wave2
      WARN[i] <-  summary_glmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}
Results_diff_cat_Neurodev <- cbind.data.frame(Area, Beta, STE, Pval)

No_Run_Errors3 <- setdiff(wave2_vars, Area)

Results_diff_Neurodev <- rbind(Results_diff_cont_Neurodev, Results_diff_nosex_Neurodev, Results_diff_cat_Neurodev)
Results_diff_Neurodev$FDR <- p.adjust(Results_diff_Neurodev$Pval, method = "fdr")
Results_diff_Neurodev$Bonferroni <- p.adjust(Results_diff_Neurodev$Pval, method = "bonferroni")


# Internalizing

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(cont_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(cont_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age_1 + age.diff + (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the LMER model
      lmer_model <- lmer(formula = as.formula(formula_str),
                         control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)),
                         data = cont_data)
      
      # Extract beta, standard error, and p-value
      summary_lmer <- summary(lmer_model)
      Beta[i] <- summary(summary_lmer)$`coefficients`[3]
      STE[i] <- summary(summary_lmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_lmer)$`coefficients`[3,5]
      Area[i] <- var_wave2
      WARN[i] <-  summary_lmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}

#GetResultsTogether
Results_diff_cont_Internalizing <- cbind.data.frame(Area, Beta, STE, Pval)

#Get the variables that errored out
No_Run_Errors <- setdiff(wave2_vars, Area)

nosex_data <- longitdf_wide3[,c(1:21,584:593,1386:1395)]

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(nosex_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(nosex_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + interview_age_1 + age.diff +  (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the LMER model
      lmer_model <- lmer(formula = as.formula(formula_str),
                         control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)),
                         data = nosex_data)
      
      # Extract beta, standard error, and p-value
      summary_lmer <- summary(lmer_model)
      Beta[i] <- summary(summary_lmer)$`coefficients`[3]
      STE[i] <- summary(summary_lmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_lmer)$`coefficients`[3,5]
      Area[i] <- var_wave2
      WARN[i] <-  summary_lmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}

#GetResultsTogether
Results_diff_nosex_Internalizing <- cbind.data.frame(Area, Beta, STE, Pval)

#Get the variables that errored out
No_Run_Errors2 <- setdiff(wave2_vars, Area)

cat_data <- longitdf_wide3[,c(1:21,594:823,1396:1625)]

# Creat an empty dataframe to store results
Beta <- NULL
STE <- NULL
Pval <- NULL
Area <- NULL
WARN <- NULL

# Create an empty dataframe to store variables that cause errors
error_df <- data.frame(variable = character(0),
                       error_message = character(0))

# Get variable names that end in "wave1"
wave1_vars <- grep("wave1$", colnames(cat_data), value = TRUE)
wave2_vars <- grep("wave2$", colnames(cat_data), value = TRUE)
i <- NULL
# Loop through each variable with "wave1"
for (i in 1:length(wave1_vars)) {
  # Generate corresponding "wave2" variable name
  var_wave1 <- wave1_vars[i]
  var_wave2 <- gsub("wave1$", "wave2", var_wave1)
  
  # Check if both wave1 and wave2 variables exist

    # Create the LMER formula dynamically
    formula_str <- paste0(var_wave2, " ~ ", var_wave1, " + Internalizing_PRScs + C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age_1 + age.diff + (1|site_id) + (1|rel_family_id)")
    
    # Use tryCatch to handle errors and catch warnings
    tryCatch({
      # Fit the GLMER model
      glmer_model <- glmer(formula = as.formula(formula_str), family = "binomial", 
                          nAGQ = 0, control = glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e5)),
                         data = cat_data)
      
      # Extract beta, standard error, and p-value
      summary_glmer <- summary(glmer_model)
      Beta[i] <- summary(summary_glmer)$`coefficients`[3]
      STE[i] <- summary(summary_glmer)$`coefficients`[3,2]
      Pval[i] <-  summary(summary_glmer)$`coefficients`[3,4]
      Area[i] <- var_wave2
      WARN[i] <-  summary_glmer$optinfo$warnings
    } , error = function(e) {
      # Log the error message and variable
      error_df <- rbind(error_df, data.frame(variable = var_wave1,
                                             error_message = as.character(e$message)))
    })
}
Results_diff_cat_Internalizing <- cbind.data.frame(Area, Beta, STE, Pval)

No_Run_Errors3 <- setdiff(wave2_vars, Area)

Results_diff_Internalizing <- rbind(Results_diff_cont_Internalizing, Results_diff_nosex_Internalizing, Results_diff_cat_Internalizing)
Results_diff_Internalizing$FDR <- p.adjust(Results_diff_Internalizing$Pval, method = "fdr")
Results_diff_Internalizing$Bonferroni <- p.adjust(Results_diff_Internalizing$Pval, method = "bonferroni")


```

### Correlations among significant hits & Pruning
###### Baseline Neurodevelopmental
```{r}
PheWAS_baseline <- read_excel("FINAL_PHEWAS_baseline_n5556_5.11.23.xlsx")

PheWAS_baseline$site_id <- ifelse(PheWAS_baseline$site_id == 22, 21, PheWAS_baseline$site_id)
PheWAS_baseline[PheWAS_baseline == "NA"] <- NA
PheWAS_baseline[PheWAS_baseline == ""] <- NA

which(colnames(PheWAS_baseline) == "tlfb_tob")
#PheWAS_baseline[,c(1:4,20,671:1291)] <- lapply(PheWAS_baseline[,c(1:4,20,671:1291)],as.factor)
PheWAS_baseline[,c(1:4,20)] <- lapply(PheWAS_baseline[,c(1:4,20)],as.factor)
PheWAS_baseline[,c(5:19,21:670)] <- lapply(PheWAS_baseline[,c(5:19,21:670)],as.numeric)

descbase <- as.data.frame(psych::describe(PheWAS_baseline[,21:670]))
skewed <- descbase[descbase$skew > 1.96 | descbase$skew < -1.96,]
skeweddf <- PheWAS_baseline[colnames(PheWAS_baseline) %in% rownames(skewed)] 
skeweddf <- cbind(PheWAS_baseline[,1:20], skeweddf)

skeweddf <- skeweddf %>%
  relocate(pds_m5_y, .after = "medhx_9b") %>%
  relocate(pds_m5_p, .after = "pds_m5_y") %>% 
  relocate(pds_m4_p, .after = "pds_m5_p") %>%
  relocate(medhx_6m_times, .after = "pds_m4_p") %>%
  relocate(medhx_6n_notes, .after = "medhx_6m_times") %>%
  relocate(medhx_6p_notes, .after = "medhx_6n_notes") #%>%
 # mutate(across(path_alc_youth1:path_alc_youth8, ~5-.x)) #%>%
  #mutate(across(where(is.numeric), ~ .x + 1))

# winsorizing
skeweddf[,21:312] <- lapply(skeweddf[,21:312], function(x) Winsorize(x, minval = mean(x, na.rm = T)-3*sd(x, na.rm = T), maxval = mean(x, na.rm = T)+3*sd(x, na.rm = T)))
descskewed <- as.data.frame(psych::describe(skeweddf[,21:312]))
skewed2 <- descskewed[descskewed$skew > 1.96 | descskewed$skew < -1.96,]
skeweddf2 <- skeweddf[colnames(skeweddf) %in% rownames(skewed2)] 
# inverse normal transformation
skeweddf2[,1:226] <- lapply(skeweddf2[,1:226], function(x) qnorm((rank(x, na.last="keep")-0.5)/sum(!is.na(x))))
skeweddf2 <- cbind(skeweddf[,1:20], skeweddf2) 

`%nin%` <- Negate(`%in%`)
PheWAS_baseline <- PheWAS_baseline[colnames(PheWAS_baseline) %nin% rownames(skewed)]

PheWAS_baseline <- PheWAS_baseline %>%
  mutate_if(is.numeric, scale)

skeweddf <- skeweddf[colnames(skeweddf) %nin% colnames(skeweddf2)] %>%
  mutate_if(is.numeric, scale)

PheWAS_baseline <- cbind(PheWAS_baseline[,1:20], skeweddf2[,21:246], skeweddf[colnames(skeweddf) %nin% colnames(skeweddf2)], PheWAS_baseline[,21:999])

## moving continuous items with issues to the end of the continuous section
PheWAS_baseline <- PheWAS_baseline %>%
  relocate(reshist_state_immigrant_factor, .after = "birth_weight_oz_comb") %>%
  relocate(pds_f4_p, .after = "reshist_state_immigrant_factor") %>%
  relocate(pds_f4_2_y, .after = "pds_f4_p") %>%
  relocate(pds_m4_y, .after = "pds_f4_2_y") %>%
  relocate(pds_m5_y, .after = "pds_m4_y") %>%
  relocate(pds_m5_p, .after = "pds_m5_y") %>% 
  relocate(pds_m4_p, .after = "pds_m5_p") %>% 
  relocate(pds_p_ss_female_category_2, .after = "pds_m4_p") %>%
  relocate(pds_p_ss_male_category_2, .after = "pds_p_ss_female_category_2") %>%
  relocate(pds_y_ss_female_category_2, .after = "pds_p_ss_male_category_2") %>%
  relocate(pds_y_ss_male_cat_2, .after = "pds_y_ss_female_category_2") %>%
  relocate(medhx_6m_times, .after = "pds_y_ss_male_cat_2") %>%
  relocate(medhx_6n_notes, .after = "medhx_6m_times") %>%
  relocate(medhx_6p_notes, .after = "medhx_6n_notes")  
which(colnames(PheWAS_baseline) == "birth_weight_oz_comb")

PheWAS_baseline[,671:1291] <- lapply(PheWAS_baseline[,671:1291],as.numeric)


## Neurodevelopmental Baseline
Results3 <- read.csv("Neurodev_results_base_8.11.23.csv")

# Bonferroni
PheWAS_b_neur_sig <- Results3[Results3$Bonferroni < 0.05, ]
PheWAS_b_neur_sig_df <- PheWAS_baseline[colnames(PheWAS_baseline) %in% PheWAS_b_neur_sig$Variable]
PheWAS_b_neur_sig_df <- cbind(PheWAS_baseline[,1:20], PheWAS_b_neur_sig_df)
colnames(PheWAS_b_neur_sig_df)[145] <- "ADHD_past"

## create empty matrix
pheno_names <- colnames(PheWAS_b_neur_sig_df)[21:210]

R2_matrix <- matrix(NA, nrow = length(pheno_names), ncol = length(pheno_names))
dimnames(R2_matrix) <- list(pheno_names, pheno_names)

chunk_size <- 150
write_interval <- 150

## for each phenotype pair, pull out marginal R2 value
for (i in 1:(length(pheno_names) - 1)) {
  for (j in (i + 1):length(pheno_names)) {
    # Extract pheno pair
    pheno_pair <- c(pheno_names[i], pheno_names[j])
    
    # Check if both phenotypes are non-NA
      if (!any(is.na(pheno_pair))) {
    # Attempt to fit linear mixed-effects model with two fixed effects
        model <- tryCatch(
          lmer(paste(pheno_pair[1], "~", pheno_pair[2], "+ (1|site_id) + (1|rel_family_id)"), data = PheWAS_b_neur_sig_df),
          error = function(e) {
            cat("Error fitting model for Phenotype Pair:", pheno_pair, "\n")
            return(NULL)
          }
        )
        
        if (!is.null(model)) {
          # Attempt to extract R-squared values using MuMIn::r.squaredGLMM
          rsquared_values <- tryCatch(
            MuMIn::r.squaredGLMM(model),
            error = function(e) {
              cat("Error extracting R-squared for Phenotype Pair:", pheno_pair, "\n")
              return(NA)
            }
          )
          
          if (!any(is.na(rsquared_values))) {
            # Extract marginal R2
            R2_value <- rsquared_values[1]
            
            # Print values for debugging
            cat("Phenotype Pair:", pheno_pair, "\n")
            cat("Marginal R2 Value:", R2_value, "\n")
            
            # Store R2 value in the symmetric matrix if the entry is NA
            if (is.na(R2_matrix[pheno_pair[1], pheno_pair[2]])) {
              R2_matrix[pheno_pair[1], pheno_pair[2]] <- R2_value
              R2_matrix[pheno_pair[2], pheno_pair[1]] <- R2_value
            }
          } else {
            # Store NA in the symmetric matrix if there was an error extracting R-squared values
            if (is.na(R2_matrix[pheno_pair[1], pheno_pair[2]])) {
              R2_matrix[pheno_pair[1], pheno_pair[2]] <- NA
              R2_matrix[pheno_pair[2], pheno_pair[1]] <- NA
            }
          }
          
          # Update the last successfully processed row and column
          last_row <- i
          last_col <- j
        } else {
          # Store NA in the symmetric matrix if there was an error fitting the model
          if (is.na(R2_matrix[pheno_pair[1], pheno_pair[2]])) {
            R2_matrix[pheno_pair[1], pheno_pair[2]] <- NA
            R2_matrix[pheno_pair[2], pheno_pair[1]] <- NA
          }
        }
      } else {
        # Store NA in the symmetric matrix if either phenotype is NA
        if (is.na(R2_matrix[pheno_pair[1], pheno_pair[2]])) {
          R2_matrix[pheno_pair[1], pheno_pair[2]] <- NA
          R2_matrix[pheno_pair[2], pheno_pair[1]] <- NA
        }
      }
    
    # Periodically write out the matrix to a CSV file
    write.table(R2_matrix, file = paste0("matrix_output_bneur", i, ".csv"), sep = ",", row.names = TRUE, col.names = TRUE)
  }
}


# Print the symmetric matrix of R2 values
print(R2_matrix)

fwrite(R2_matrix, "R2_matrix_base_neur.csv", row.names = T, col.names = T)
R2_matrixb <- R2_matrix
#R2_matrix <- fread("R2_matrix_base_neur.csv", header = T, data.table = F)
#R2_matrix$V1 <- NULL
#rownames(R2_matrix) <- colnames(R2_matrix)

#### R2 > .9
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.9
  high_R2_pairs <- which(R2_matrix > 0.9, arr.ind = TRUE)
  
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]

  phenotype1 <- rownames(R2_matrix)[row_index]
  phenotype2 <- rownames(R2_matrix)[col_index]

  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")

  p1 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype2, "Pval"]

  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")

  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))

  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))


  # Remove the selected phenotype from R2_matrix
  R2_matrix_9 <- R2_matrix[-which(rownames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype


# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_9)
final_phenotypes



#### R2 > .8
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.8
  high_R2_pairs <- which(R2_matrix > 0.8, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix)[row_index]
  phenotype2 <- rownames(R2_matrix)[col_index]
  p1 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_8 <- R2_matrix[-which(rownames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype

# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_8)
final_phenotypes



#### R2 > .7
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.7
  high_R2_pairs <- which(R2_matrix > 0.7, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix)[row_index]
  phenotype2 <- rownames(R2_matrix)[col_index]
  p1 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_7 <- R2_matrix[-which(rownames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype

# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_7)
final_phenotypes


#### R2 > .6
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.6
  high_R2_pairs <- which(R2_matrix > 0.6, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix)[row_index]
  phenotype2 <- rownames(R2_matrix)[col_index]
  p1 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_6 <- R2_matrix[-which(rownames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_6)
final_phenotypes


#### R2 > .5
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.5
  high_R2_pairs <- which(R2_matrix > 0.5, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix)[row_index]
  phenotype2 <- rownames(R2_matrix)[col_index]
  p1 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_5 <- R2_matrix[-which(rownames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_5)
final_phenotypes


#### R2 > .4
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.4
  high_R2_pairs <- which(R2_matrix > 0.4, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix)[row_index]
  phenotype2 <- rownames(R2_matrix)[col_index]
  p1 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_4 <- R2_matrix[-which(rownames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_4)
final_phenotypes


#### R2 > .3
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.3
  high_R2_pairs <- which(R2_matrix > 0.3, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix)[row_index]
  phenotype2 <- rownames(R2_matrix)[col_index]
  p1 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_3 <- R2_matrix[-which(rownames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_3)
final_phenotypes


#### R2 > .2
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.2
  high_R2_pairs <- which(R2_matrix > 0.2, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix)[row_index]
  phenotype2 <- rownames(R2_matrix)[col_index]
  p1 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_2 <- R2_matrix[-which(rownames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_2)
final_phenotypes



#### R2 > .1
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.1
  high_R2_pairs <- which(R2_matrix > 0.1, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix)[row_index]
  phenotype2 <- rownames(R2_matrix)[col_index]
  p1 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_1 <- R2_matrix[-which(rownames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_1)
final_phenotypes

#### R2 > .05
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.05
  high_R2_pairs <- which(R2_matrix > 0.05, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix)[row_index]
  phenotype2 <- rownames(R2_matrix)[col_index]
  p1 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sig[PheWAS_b_neur_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_05 <- R2_matrix[-which(rownames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_05)
final_phenotypes




##### FDR significant
PheWAS_b_neur_sigfdr <- Results3[Results3$FDR < 0.05, ]
PheWAS_b_neur_sigfdr_df <- PheWAS_baseline[colnames(PheWAS_baseline) %in% PheWAS_b_neur_sigfdr$Variable]
PheWAS_b_neur_sigfdr_df <- cbind(PheWAS_baseline[,1:20], PheWAS_b_neur_sigfdr_df)

# create empty matrix
pheno_names <- colnames(PheWAS_b_neur_sigfdr_df)[21:662]
pheno_names[pheno_names == "ADHD present"] <- "ADHD_present"
pheno_names[pheno_names == "ADHD past"] <- "ADHD_past"
colnames(PheWAS_b_neur_sigfdr_df)[451] <- "ADHD_present"
colnames(PheWAS_b_neur_sigfdr_df)[452] <- "ADHD_past"

R2_matrix_bneurfdr <- matrix(NA, nrow = length(pheno_names), ncol = length(pheno_names))
dimnames(R2_matrix_bneurfdr) <- list(pheno_names, pheno_names)

# Initialize the last successfully processed row and column
last_row <- 0
last_col <- 0

# Set the chunk size and the interval to write out the matrix
chunk_size <- 50
write_interval <- 50

# Iterate over all pairs
for (i in 1:(length(pheno_names) - 1)) {
  for (j in (i + 1):length(pheno_names)) {
    # Check if the current pair is beyond the last successfully processed pair
    if (i > last_row || (i == last_row && j > last_col)) {
      # Extract pheno pair
      pheno_pair <- c(pheno_names[i], pheno_names[j])
      
      # Check if both phenotypes are non-NA
      if (!any(is.na(pheno_pair))) {
        # Attempt to fit linear mixed-effects model with two fixed effects
        model <- tryCatch(
          lmer(paste(pheno_pair[1], "~", pheno_pair[2], "+ (1|site_id) + (1|rel_family_id)"), data = PheWAS_b_neur_sigfdr_df),
          error = function(e) {
            cat("Error fitting model for Phenotype Pair:", pheno_pair, "\n")
            return(NULL)
          }
        )
        
        if (!is.null(model)) {
          # Attempt to extract R-squared values using MuMIn::r.squaredGLMM
          rsquared_values <- tryCatch(
            MuMIn::r.squaredGLMM(model),
            error = function(e) {
              cat("Error extracting R-squared for Phenotype Pair:", pheno_pair, "\n")
              return(NA)
            }
          )
          
          if (!any(is.na(rsquared_values))) {
            # Extract marginal R2
            R2_value <- rsquared_values[1]
            
            # Print values for debugging
            cat("Phenotype Pair:", pheno_pair, "\n")
            cat("Marginal R2 Value:", R2_value, "\n")
            
            # Store R2 value in the symmetric matrix if the entry is NA
            if (is.na(R2_matrix_bneurfdr[pheno_pair[1], pheno_pair[2]])) {
              R2_matrix_bneurfdr[pheno_pair[1], pheno_pair[2]] <- R2_value
              R2_matrix_bneurfdr[pheno_pair[2], pheno_pair[1]] <- R2_value
            }
          } else {
            # Store NA in the symmetric matrix if there was an error extracting R-squared values
            if (is.na(R2_matrix_bneurfdr[pheno_pair[1], pheno_pair[2]])) {
              R2_matrix_bneurfdr[pheno_pair[1], pheno_pair[2]] <- NA
              R2_matrix_bneurfdr[pheno_pair[2], pheno_pair[1]] <- NA
            }
          }
          
          # Update the last successfully processed row and column
          last_row <- i
          last_col <- j
        } else {
          # Store NA in the symmetric matrix if there was an error fitting the model
          if (is.na(R2_matrix_bneurfdr[pheno_pair[1], pheno_pair[2]])) {
            R2_matrix_bneurfdr[pheno_pair[1], pheno_pair[2]] <- NA
            R2_matrix_bneurfdr[pheno_pair[2], pheno_pair[1]] <- NA
          }
        }
      } else {
        # Store NA in the symmetric matrix if either phenotype is NA
        if (is.na(R2_matrix_bneurfdr[pheno_pair[1], pheno_pair[2]])) {
          R2_matrix_bneurfdr[pheno_pair[1], pheno_pair[2]] <- NA
          R2_matrix_bneurfdr[pheno_pair[2], pheno_pair[1]] <- NA
        }
      }
    }
    
    # Periodically write out the matrix to a CSV file
    write.table(R2_matrix_bneurfdr, file = paste0("matrix_output_", i, ".csv"), sep = ",", row.names = TRUE, col.names = TRUE)
  }
}

# Print the symmetric matrix of R2 values
print(R2_matrix_bneurfdr)

fwrite(R2_matrix_bneurfdr, "R2_matrix_base_neurfdr.csv", row.names = T, col.names = T)
R2_matrix_bneurfdrb <- R2_matrix_bneurfdr



#### R2 > .9
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.9
  high_R2_pairs <- which(R2_matrix_bneurfdr > 0.9, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bneurfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bneurfdr)[col_index]
  p1 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bneurfdr_9 <- R2_matrix_bneurfdr[-which(rownames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bneurfdr_9)
final_phenotypes




#### R2 > .8
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.8
  high_R2_pairs <- which(R2_matrix_bneurfdr > 0.8, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bneurfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bneurfdr)[col_index]
  p1 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bneurfdr_8 <- R2_matrix_bneurfdr[-which(rownames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bneurfdr_8)
final_phenotypes




#### R2 > .7
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.7
  high_R2_pairs <- which(R2_matrix_bneurfdr > 0.7, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bneurfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bneurfdr)[col_index]
  p1 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bneurfdr_7 <- R2_matrix_bneurfdr[-which(rownames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bneurfdr_7)
final_phenotypes





#### R2 > .6
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.6
  high_R2_pairs <- which(R2_matrix_bneurfdr > 0.6, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bneurfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bneurfdr)[col_index]
  p1 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bneurfdr_6 <- R2_matrix_bneurfdr[-which(rownames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bneurfdr_6)
final_phenotypes





#### R2 > .5
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.5
  high_R2_pairs <- which(R2_matrix_bneurfdr > 0.5, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bneurfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bneurfdr)[col_index]
  p1 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bneurfdr_5 <- R2_matrix_bneurfdr[-which(rownames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bneurfdr_5)
final_phenotypes





#### R2 > .4
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.4
  high_R2_pairs <- which(R2_matrix_bneurfdr > 0.4, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bneurfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bneurfdr)[col_index]
  p1 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bneurfdr_4 <- R2_matrix_bneurfdr[-which(rownames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bneurfdr_4)
final_phenotypes



#### R2 > .3
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.3
  high_R2_pairs <- which(R2_matrix_bneurfdr > 0.3, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bneurfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bneurfdr)[col_index]
  p1 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bneurfdr_3 <- R2_matrix_bneurfdr[-which(rownames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bneurfdr_3)
final_phenotypes




#### R2 > .2
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.2
  high_R2_pairs <- which(R2_matrix_bneurfdr > 0.2, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bneurfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bneurfdr)[col_index]
  p1 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bneurfdr_2 <- R2_matrix_bneurfdr[-which(rownames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bneurfdr_2)
final_phenotypes




#### R2 > .1
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.1
  high_R2_pairs <- which(R2_matrix_bneurfdr > 0.1, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bneurfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bneurfdr)[col_index]
  p1 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bneurfdr_1 <- R2_matrix_bneurfdr[-which(rownames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bneurfdr_1)
final_phenotypes




#### R2 > .05
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.05
  high_R2_pairs <- which(R2_matrix_bneurfdr > 0.05, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bneurfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bneurfdr)[col_index]
  p1 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_neur_sigfdr[PheWAS_b_neur_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bneurfdr_05 <- R2_matrix_bneurfdr[-which(rownames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bneurfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bneurfdr_05)
final_phenotypes
```

###### Baseline Internalizing 
``` {r}
## Internalizing Baseline
Results4 <- read.csv("Internalizing_results_base_8.11.23.csv")

PheWAS_b_int_sig <- Results4[Results4$Bonferroni < 0.05, ]
PheWAS_b_int_sig_df <- PheWAS_baseline[colnames(PheWAS_baseline) %in% PheWAS_b_int_sig$Variable]
PheWAS_b_int_sig_df <- cbind(PheWAS_baseline[,1:20], PheWAS_b_int_sig_df)

## create empty matrix
pheno_names2 <- colnames(PheWAS_b_int_sig_df)[21:144]

R2_matrix2 <- matrix(NA, nrow = length(pheno_names2), ncol = length(pheno_names2))
dimnames(R2_matrix2) <- list(pheno_names2, pheno_names2)

## for each phenotype pair, pull out marginal R2 value
for (i in 1:(length(pheno_names2) - 1)) {
  for (j in (i + 1):length(pheno_names2)) {
    # Extract pheno pair
    pheno_pair2 <- c(pheno_names2[i], pheno_names2[j])
    
    # Attempt to fit linear mixed-effects model with two fixed effects
    model <- tryCatch(
      lmer(paste(pheno_pair2[1], "~", pheno_pair2[2], "+ (1|site_id) + (1|rel_family_id)"), data = PheWAS_b_int_sig_df),
      error = function(e) {
        cat("Error fitting model for Phenotype Pair:", pheno_pair2, "\n")
        return(NULL)
      }
    )
    
    if (!is.null(model)) {
      # Attempt to extract R-squared values using MuMIn::r.squaredGLMM
      rsquared_values <- tryCatch(
        MuMIn::r.squaredGLMM(model),
        error = function(e) {
          cat("Error extracting R-squared for Phenotype Pair:", pheno_pair2, "\n")
          return(NA)
        }
      )
      
      if (!any(is.na(rsquared_values))) {
        # Extract marginal R2
        R2_value2 <- rsquared_values[1]
        
        # Print values for debugging
        cat("Phenotype Pair:", pheno_pair2, "\n")
        cat("Marginal R2 Value:", R2_value2, "\n")
    
    # Store R2 value in the symmetric matrix
    R2_matrix2[pheno_pair2[1], pheno_pair2[2]] <- R2_value2
    R2_matrix2[pheno_pair2[2], pheno_pair2[1]] <- R2_value2
    } else {
        # Store NA in the symmetric matrix2 if there was an error extracting R-squared values
        R2_matrix2[pheno_pair2[1], pheno_pair2[2]] <- NA
        R2_matrix2[pheno_pair2[2], pheno_pair2[1]] <- NA
      }
    } else {
      # Store NA in the symmetric matrix2 if there was an error fitting the model
      R2_matrix2[pheno_pair2[1], pheno_pair2[2]] <- NA
      R2_matrix2[pheno_pair2[2], pheno_pair2[1]] <- NA
    }
  }
}

# Print the symmetric matrix of R2 values
print(R2_matrix2)

fwrite(R2_matrix2, "R2_matrix_base_int.csv", row.names = T, col.names = T)
R2_matrixc <- R2_matrix2
#R2_matrix2 <- fread("R2_matrix_base_int.csv", header = T, data.table = F)
#R2_matrix2$V1 <- NULL
#rownames(R2_matrix2) <- colnames(R2_matrix2)
#R2_matrix2 <- as.matrix(R2_matrix2)

#### R2 > .9
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.9
  high_R2_pairs <- which(R2_matrix2 > 0.9, arr.ind = TRUE)
  
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]

  phenotype1 <- rownames(R2_matrix2)[row_index]
  phenotype2 <- rownames(R2_matrix2)[col_index]

  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")

  p1 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype2, "Pval"]

  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")

  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))

  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

# Keep only the top pairs

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))


  # Remove the selected phenotype from R2_matrix2
  R2_matrix2_9 <- R2_matrix2[-which(rownames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype


# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix2_9)
final_phenotypes



#### R2 > .8
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.8
  high_R2_pairs <- which(R2_matrix2 > 0.8, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix2)[row_index]
  phenotype2 <- rownames(R2_matrix2)[col_index]
  p1 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix2
  R2_matrix2_8 <- R2_matrix2[-which(rownames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype

# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix2_8)
final_phenotypes



#### R2 > .7
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.7
  high_R2_pairs <- which(R2_matrix2 > 0.7, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix2)[row_index]
  phenotype2 <- rownames(R2_matrix2)[col_index]
  p1 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix2
  R2_matrix2_7 <- R2_matrix2[-which(rownames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype

# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix2_7)
final_phenotypes


#### R2 > .6
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.6
  high_R2_pairs <- which(R2_matrix2 > 0.6, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix2)[row_index]
  phenotype2 <- rownames(R2_matrix2)[col_index]
  p1 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix2
  R2_matrix2_6 <- R2_matrix2[-which(rownames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix2_6)
final_phenotypes


#### R2 > .5
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.5
  high_R2_pairs <- which(R2_matrix2 > 0.5, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix2)[row_index]
  phenotype2 <- rownames(R2_matrix2)[col_index]
  p1 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix2
  R2_matrix2_5 <- R2_matrix2[-which(rownames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix2_5)
final_phenotypes


#### R2 > .4
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.4
  high_R2_pairs <- which(R2_matrix2 > 0.4, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix2)[row_index]
  phenotype2 <- rownames(R2_matrix2)[col_index]
  p1 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix2
  R2_matrix2_4 <- R2_matrix2[-which(rownames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix2_4)
final_phenotypes


#### R2 > .3
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.3
  high_R2_pairs <- which(R2_matrix2 > 0.3, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix2)[row_index]
  phenotype2 <- rownames(R2_matrix2)[col_index]
  p1 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix2
  R2_matrix2_3 <- R2_matrix2[-which(rownames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix2_3)
final_phenotypes


#### R2 > .2
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.2
  high_R2_pairs <- which(R2_matrix2 > 0.2, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix2)[row_index]
  phenotype2 <- rownames(R2_matrix2)[col_index]
  p1 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix2
  R2_matrix2_2 <- R2_matrix2[-which(rownames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix2_2)
final_phenotypes



#### R2 > .1
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.1
  high_R2_pairs <- which(R2_matrix2 > 0.1, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix2)[row_index]
  phenotype2 <- rownames(R2_matrix2)[col_index]
  p1 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix2
  R2_matrix2_1 <- R2_matrix2[-which(rownames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix2_1)
final_phenotypes



#### R2 > .05
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.05
  high_R2_pairs <- which(R2_matrix2 > 0.05, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
    # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix2)[row_index]
  phenotype2 <- rownames(R2_matrix2)[col_index]
  p1 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sig[PheWAS_b_int_sig$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix2
  R2_matrix2_05 <- R2_matrix2[-which(rownames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix2) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
length(unique(removed_phenotypes))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix2_05)
final_phenotypes



##### FDR significant

PheWAS_b_int_sigfdr <- Results4[Results4$FDR < 0.05, ]
PheWAS_b_int_sigfdr_df <- PheWAS_baseline[colnames(PheWAS_baseline) %in% PheWAS_b_int_sigfdr$Variable]
PheWAS_b_int_sigfdr_df <- cbind(PheWAS_baseline[,1:20], PheWAS_b_int_sigfdr_df)


# create empty matrix
pheno_names <- colnames(PheWAS_b_int_sigfdr_df)[21:624]
pheno_names[pheno_names == "ADHD past"] <- "ADHD_past"
colnames(PheWAS_b_int_sigfdr_df)[439] <- "ADHD_past"

R2_matrix_bintfdr <- matrix(NA, nrow = length(pheno_names), ncol = length(pheno_names))
dimnames(R2_matrix_bintfdr) <- list(pheno_names, pheno_names)

# Initialize the last successfully processed row and column
last_row <- 0
last_col <- 0

# Set the chunk size and the interval to write out the matrix
chunk_size <- 50
write_interval <- 50

# Iterate over all pairs
for (i in 1:(length(pheno_names) - 1)) {
  for (j in (i + 1):length(pheno_names)) {
    # Check if the current pair is beyond the last successfully processed pair
    if (i > last_row || (i == last_row && j > last_col)) {
      # Extract pheno pair
      pheno_pair <- c(pheno_names[i], pheno_names[j])
      
      # Check if both phenotypes are non-NA
      if (!any(is.na(pheno_pair))) {
        # Attempt to fit linear mixed-effects model with two fixed effects
        model <- tryCatch(
          lmer(paste(pheno_pair[1], "~", pheno_pair[2], "+ (1|site_id) + (1|rel_family_id)"), data = PheWAS_b_int_sigfdr_df),
          error = function(e) {
            cat("Error fitting model for Phenotype Pair:", pheno_pair, "\n")
            return(NULL)
          }
        )
        
        if (!is.null(model)) {
          # Attempt to extract R-squared values using MuMIn::r.squaredGLMM
          rsquared_values <- tryCatch(
            MuMIn::r.squaredGLMM(model),
            error = function(e) {
              cat("Error extracting R-squared for Phenotype Pair:", pheno_pair, "\n")
              return(NA)
            }
          )
          
          if (!any(is.na(rsquared_values))) {
            # Extract marginal R2
            R2_value <- rsquared_values[1]
            
            # Print values for debugging
            cat("Phenotype Pair:", pheno_pair, "\n")
            cat("Marginal R2 Value:", R2_value, "\n")
            
            # Store R2 value in the symmetric matrix if the entry is NA
            if (is.na(R2_matrix_bintfdr[pheno_pair[1], pheno_pair[2]])) {
              R2_matrix_bintfdr[pheno_pair[1], pheno_pair[2]] <- R2_value
              R2_matrix_bintfdr[pheno_pair[2], pheno_pair[1]] <- R2_value
            }
          } else {
            # Store NA in the symmetric matrix if there was an error extracting R-squared values
            if (is.na(R2_matrix_bintfdr[pheno_pair[1], pheno_pair[2]])) {
              R2_matrix_bintfdr[pheno_pair[1], pheno_pair[2]] <- NA
              R2_matrix_bintfdr[pheno_pair[2], pheno_pair[1]] <- NA
            }
          }
          
          # Update the last successfully processed row and column
          last_row <- i
          last_col <- j
        } else {
          # Store NA in the symmetric matrix if there was an error fitting the model
          if (is.na(R2_matrix_bintfdr[pheno_pair[1], pheno_pair[2]])) {
            R2_matrix_bintfdr[pheno_pair[1], pheno_pair[2]] <- NA
            R2_matrix_bintfdr[pheno_pair[2], pheno_pair[1]] <- NA
          }
        }
      } else {
        # Store NA in the symmetric matrix if either phenotype is NA
        if (is.na(R2_matrix_bintfdr[pheno_pair[1], pheno_pair[2]])) {
          R2_matrix_bintfdr[pheno_pair[1], pheno_pair[2]] <- NA
          R2_matrix_bintfdr[pheno_pair[2], pheno_pair[1]] <- NA
        }
      }
    }
    
    # Periodically write out the matrix to a CSV file
    write.table(R2_matrix_bintfdr, file = paste0("matrix_output_bintfdr_", i, ".csv"), sep = ",", row.names = TRUE, col.names = TRUE)
  }
}

# Print the symmetric matrix of R2 values
print(R2_matrix_bintfdr)

fwrite(R2_matrix_bintfdr, "R2_matrix_base_intfdr.csv", row.names = T, col.names = T)
R2_matrix_bintfdrb <- R2_matrix_bintfdr



#### R2 > .9
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.9
  high_R2_pairs <- which(R2_matrix_bintfdr > 0.9, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bintfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bintfdr)[col_index]
  p1 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bintfdr_9 <- R2_matrix_bintfdr[-which(rownames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bintfdr_9)
final_phenotypes




#### R2 > .8
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.8
  high_R2_pairs <- which(R2_matrix_bintfdr > 0.8, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bintfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bintfdr)[col_index]
  p1 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bintfdr_8 <- R2_matrix_bintfdr[-which(rownames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bintfdr_8)
final_phenotypes




#### R2 > .7
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.7
  high_R2_pairs <- which(R2_matrix_bintfdr > 0.7, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bintfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bintfdr)[col_index]
  p1 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bintfdr_7 <- R2_matrix_bintfdr[-which(rownames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bintfdr_7)
final_phenotypes





#### R2 > .6
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.6
  high_R2_pairs <- which(R2_matrix_bintfdr > 0.6, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bintfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bintfdr)[col_index]
  p1 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bintfdr_6 <- R2_matrix_bintfdr[-which(rownames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bintfdr_6)
final_phenotypes





#### R2 > .5
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.5
  high_R2_pairs <- which(R2_matrix_bintfdr > 0.5, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bintfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bintfdr)[col_index]
  p1 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bintfdr_5 <- R2_matrix_bintfdr[-which(rownames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bintfdr_5)
final_phenotypes





#### R2 > .4
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.4
  high_R2_pairs <- which(R2_matrix_bintfdr > 0.4, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bintfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bintfdr)[col_index]
  p1 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bintfdr_4 <- R2_matrix_bintfdr[-which(rownames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bintfdr_4)
final_phenotypes



#### R2 > .3
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.3
  high_R2_pairs <- which(R2_matrix_bintfdr > 0.3, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bintfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bintfdr)[col_index]
  p1 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bintfdr_3 <- R2_matrix_bintfdr[-which(rownames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bintfdr_3)
final_phenotypes




#### R2 > .2
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.2
  high_R2_pairs <- which(R2_matrix_bintfdr > 0.2, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bintfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bintfdr)[col_index]
  p1 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bintfdr_2 <- R2_matrix_bintfdr[-which(rownames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bintfdr_2)
final_phenotypes




#### R2 > .1
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.1
  high_R2_pairs <- which(R2_matrix_bintfdr > 0.1, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bintfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bintfdr)[col_index]
  p1 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bintfdr_1 <- R2_matrix_bintfdr[-which(rownames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bintfdr_1)
final_phenotypes




#### R2 > .05
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.05
  high_R2_pairs <- which(R2_matrix_bintfdr > 0.05, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]

  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_bintfdr)[row_index]
  phenotype2 <- rownames(R2_matrix_bintfdr)[col_index]
  p1 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_b_int_sigfdr[PheWAS_b_int_sigfdr$Variable == phenotype2, "Pval"]
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}

# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")

# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)

# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]

  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))

  # Remove the selected phenotype from R2_matrix
  R2_matrix_bintfdr_05 <- R2_matrix_bintfdr[-which(rownames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_bintfdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_bintfdr_05)
final_phenotypes
```
###### Baseline R2 threshold plot
```{r}
initdat <- data.frame(
  R_squared = rep(c(0, 0.05, seq(.1, 1, .1)), 4),
  hits = c(1, 14, 32, 52, 67, 92, 111, 147, 167, 178, 184, 190,  
           1, 7, 17, 33, 51, 69, 80, 93, 104, 110, 121, 124,
           1, 49, 104, 199, 292, 369, 441, 520, 575, 602, 623, 642,
           1, 50, 114, 195, 301, 379, 450, 504, 543, 566, 586, 604),
  PRS = as.factor(c(rep("Neurodevelopmental", 12), rep("Internalizing", 12), rep("Neurodevelopmental", 12), rep("Internalizing", 12))),
  pval = as.factor(c(rep("Bonferroni", 24), rep("FDR", 24)))
)

# Function to create darker colors
darken_color <- function(color, factor = 1.5) {
  rgb_vals <- col2rgb(color)
  darker_vals <- round(rgb_vals / factor)
  return(rgb(darker_vals[1, ], darker_vals[2, ], darker_vals[3, ], maxColorValue = 255))
}

# Original colors
blue_color <- "skyblue"
coral_color <- "coral"

# Darkened colors for labels
dark_blue_color <- darken_color(blue_color)
dark_coral_color <- darken_color(coral_color)

ggplot(initdat, aes(x = R_squared, y = hits, color = PRS, linetype = pval, shape = pval)) +
  geom_point(size = 3) +
  geom_line(size = 1, alpha = 0.7) +
  geom_text_repel(
    data = subset(initdat, R_squared == 0 & hits == 1)[1, ],
    aes(label = as.character(hits)),
    color = dark_blue_color,  # Darkened color for label
    vjust = -0.5,
    hjust = -0.2,
    size = 3,
    check_overlap = TRUE,
    segment.color = "transparent" # Removes line segments
  ) +
  geom_text_repel(
    data = initdat %>% filter(R_squared != 0, PRS == "Neurodevelopmental", pval == "Bonferroni"),
    aes(label = as.character(hits)),
    color =  dark_blue_color,
    nudge_y = 8,
    size = 3,
    check_overlap = TRUE,
    segment.color = "transparent",  # Removes line segments
    fontface = "bold",  
    show.legend = FALSE
  ) +
  geom_text_repel(
    data = initdat %>% filter(R_squared != 0, PRS == "Neurodevelopmental", pval == "FDR"),
    aes(label = as.character(hits)),
    color =  dark_blue_color,
    nudge_y = 10,
    size = 3,
    check_overlap = TRUE,
    segment.color = "transparent",  # Removes line segments
    fontface = "bold",  
    show.legend = FALSE
  ) +
  geom_text_repel(
    data = initdat %>% filter(R_squared != 0, PRS == "Internalizing", pval == "Bonferroni"),
    aes(label = as.character(hits)),
    color =  dark_coral_color,
    nudge_y = -4,
    size = 3,
    check_overlap = TRUE,
    segment.color = "transparent",  # Removes line segments
    fontface = "bold",  
    show.legend = FALSE
  ) +
  geom_text_repel(
    data = initdat %>% filter(R_squared != 0, PRS == "Internalizing", pval == "FDR"),
    aes(label = as.character(hits)),
    color =  dark_coral_color,
    nudge_y = -14,
    size = 3,
    check_overlap = TRUE,
    segment.color = "transparent",  # Removes line segments
    fontface = "bold",  
    show.legend = FALSE
  ) +
  scale_x_continuous(breaks = c(0, 0.05, seq(0.1, 1, 0.1)), limits = c(0, 1.05), expand = c(0.0, 0.01),
                     labels = c("0.0", "0.05", "0.1", "0.2", "0.3", "0.4", "0.5", "0.6", "0.7", "0.8", "0.9", "1.0")) +
  scale_y_continuous(limits = c(0, 675), breaks = seq(0, 650, 50), expand = c(0.02, 0.02)) +
  labs(
    title = expression(bold("PheWAS Hits at" ~ R^2 ~ "Thresholds")),
    x = expression(bold(R^2 ~ "Thresholds")),
    y = "Hits",
    color = "PRS",
    linetype = "P Value Correction"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    axis.title.x = element_text(size = 10, face = "bold"),
    axis.title.y = element_text(size = 10, face = "bold"),
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 10),
    legend.key.size = unit(.4, 'cm'),
    legend.spacing.y = unit(.0001, "cm"), 
    legend.position = "top",
    legend.box.margin = margin(0, 0, -2, 0),
    plot.margin = unit(c(1, 2, 1, 1), "cm")
  )
```

###### FU2 Neurodevelopmental
```{r}
PheWAS_FU <- read_excel("FINAL_PheWAS_FU2_n5556_07.29.23.xlsx")
PheWAS_FU$site_id <- ifelse(PheWAS_FU$site_id == 22, 21, PheWAS_FU$site_id)
PheWAS_FU[PheWAS_FU == "NA"] <- NA
PheWAS_FU[PheWAS_FU == ""] <- NA

which(colnames(PheWAS_FU) == "tlfb_list_l2___1")
#PheWAS_FU[,c(1:4,20:21,1250:1718)] <- lapply(PheWAS_FU[,c(1:4,20:21,1250:1718)],as.factor)
PheWAS_FU[,c(5:19,22:1249)] <- lapply(PheWAS_FU[,c(5:19,22:1249)],as.numeric)

descFU <- as.data.frame(psych::describe(PheWAS_FU[,22:1249]))
skewedFU <- descFU[descFU$skew > 1.96 | descFU$skew < -1.96,]
#fwrite(skewedFU, "skewedFU.csv", row.names = T)
skewedFUdf <- PheWAS_FU[colnames(PheWAS_FU) %in% rownames(skewedFU)] 

# winsorizing
skewedFUdf[,1:462] <- lapply(skewedFUdf[,1:462], function(x) Winsorize(x, minval = mean(x, na.rm = T)-3*sd(x, na.rm = T), maxval = mean(x, na.rm = T)+3*sd(x, na.rm = T)))
descskewedFU <- as.data.frame(psych::describe(skewedFUdf[,1:462]))
skewedFU2 <- descskewedFU[descskewedFU$skew > 1.96 | descskewedFU$skew < -1.96,]
#fwrite(skewedFU2, "skewedFU2.csv", row.names = T)
skewedFUdf2 <- skewedFUdf[colnames(skewedFUdf) %in% rownames(skewedFU2)] 
# inverse normal transformation
skewedFUdf2[,1:333] <- lapply(skewedFUdf2[,1:333], function(x) qnorm((rank(x, na.last="keep")-0.5)/sum(!is.na(x))))

PheWAS_FU <- PheWAS_FU[colnames(PheWAS_FU) %nin% rownames(skewedFU)]

PheWAS_FU <- PheWAS_FU %>%
  mutate_if(is.numeric, scale)

skewedFUdf <- skewedFUdf[colnames(skewedFUdf) %nin% colnames(skewedFUdf2)] %>%
  mutate_if(is.numeric, scale)

PheWAS_FU <- cbind(PheWAS_FU[,1:21], skewedFUdf2, skewedFUdf, PheWAS_FU[,22:1256])

PheWAS_FU[,1250:1718] <- lapply(PheWAS_FU[,1250:1718],as.numeric)


## Neurodevelopmental Baseline
Results3FU <- fread("Neurodev_results_FU_8.27.23.txt", header = T, data.table = F)

# Bonferroni
PheWAS_f_neur_sig <- Results3FU[Results3FU$Bonferroni < 0.05, ]
PheWAS_f_neur_sig_df <- PheWAS_FU[colnames(PheWAS_FU) %in% PheWAS_f_neur_sig$Variable]
PheWAS_f_neur_sig_df <- cbind(PheWAS_FU[,1:21], PheWAS_f_neur_sig_df)

## create empty matrix
pheno_names <- colnames(PheWAS_f_neur_sig_df)[22:235]

R2_matrix_fneur <- matrix(NA, nrow = length(pheno_names), ncol = length(pheno_names))
dimnames(R2_matrix_fneur) <- list(pheno_names, pheno_names)

## for each phenotype pair, pull out marginal R2 value
for (i in 1:(length(pheno_names) - 1)) {
  for (j in (i + 1):length(pheno_names)) {
    # Extract pheno pair
    pheno_pair <- c(pheno_names[i], pheno_names[j])
    
    # Attempt to fit linear mixed-effects model with two fixed effects
    model <- tryCatch(
      lmer(paste(pheno_pair[1], "~", pheno_pair[2], "+ (1|site_id) + (1|rel_family_id)"), data = PheWAS_f_neur_sig_df),
      error = function(e) {
        cat("Error fitting model for Phenotype Pair:", pheno_pair, "\n")
        return(NULL)
      }
    )
    
    if (!is.null(model)) {
      # Attempt to extract R-squared values using MuMIn::r.squaredGLMM
      rsquared_values <- tryCatch(
        MuMIn::r.squaredGLMM(model),
        error = function(e) {
          cat("Error extracting R-squared for Phenotype Pair:", pheno_pair, "\n")
          return(NA)
        }
      )
      
      if (!any(is.na(rsquared_values))) {
        # Extract marginal R2
        R2_value <- rsquared_values[1]
    
    # Print values for debugging
    cat("Phenotype Pair:", pheno_pair, "\n")
    cat("R2 Value:", R2_value, "\n")
    
    # Store R2 value in the symmetric matrix
    R2_matrix_fneur[pheno_pair[1], pheno_pair[2]] <- R2_value
    R2_matrix_fneur[pheno_pair[2], pheno_pair[1]] <- R2_value
    
      } else {
        # Store NA in the symmetric matrix if there was an error extracting R-squared values
        R2_matrix_fneur[pheno_pair[1], pheno_pair[2]] <- NA
        R2_matrix_fneur[pheno_pair[2], pheno_pair[1]] <- NA
      }
    } else {
      # Store NA in the symmetric matrix if there was an error fitting the model
      R2_matrix_fneur[pheno_pair[1], pheno_pair[2]] <- NA
      R2_matrix_fneur[pheno_pair[2], pheno_pair[1]] <- NA
    }
    
        # Periodically write out the matrix to a CSV file
    write.table(R2_matrix_fneur, file = paste0("matrix_output_fneur_", i, ".csv"), sep = ",", row.names = TRUE, col.names = TRUE)
  }
}


# Print the symmetric matrix of R2 values
print(R2_matrix_fneur)

#fwrite(R2_matrix_fneur, "R2_matrix_FU_neur.csv", row.names = T, col.names = T)
R2_matrix_fneur <- fread("R2_matrix_FU_neur.csv", header = T, data.table = F)
R2_matrix_fneur$V1 <- NULL
rownames(R2_matrix_fneur) <- colnames(R2_matrix_fneur)

#### R2 > .9
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.9
  high_R2_pairs <- which(R2_matrix_fneur > 0.9, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_9 <- R2_matrix_fneur[-which(rownames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_9)
final_phenotypes



#### R2 > .8
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.8
  high_R2_pairs <- which(R2_matrix_fneur > 0.8, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_8 <- R2_matrix_fneur[-which(rownames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_8)
final_phenotypes


#### R2 > .7
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.7
  high_R2_pairs <- which(R2_matrix_fneur > 0.7, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_7 <- R2_matrix_fneur[-which(rownames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_7)
final_phenotypes


#### R2 > .6
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.6
  high_R2_pairs <- which(R2_matrix_fneur > 0.6, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_6 <- R2_matrix_fneur[-which(rownames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_6)
final_phenotypes


#### R2 > .5
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.5
  high_R2_pairs <- which(R2_matrix_fneur > 0.5, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_5 <- R2_matrix_fneur[-which(rownames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_5)
final_phenotypes


#### R2 > .4
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.4
  high_R2_pairs <- which(R2_matrix_fneur > 0.4, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_4 <- R2_matrix_fneur[-which(rownames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_4)
final_phenotypes


#### R2 > .3
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.3
  high_R2_pairs <- which(R2_matrix_fneur > 0.3, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_3 <- R2_matrix_fneur[-which(rownames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_3)
final_phenotypes

#### R2 > .2
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.2
  high_R2_pairs <- which(R2_matrix_fneur > 0.2, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_2 <- R2_matrix_fneur[-which(rownames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_2)
final_phenotypes


#### R2 > .1
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.1
  high_R2_pairs <- which(R2_matrix_fneur > 0.1, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_1 <- R2_matrix_fneur[-which(rownames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_1)
final_phenotypes


#### R2 > .05
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.05
  high_R2_pairs <- which(R2_matrix_fneur > 0.05, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sig[PheWAS_f_neur_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_05 <- R2_matrix_fneur[-which(rownames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_05)
final_phenotypes



#### FDR

# Bonferroni
PheWAS_f_neur_sigfdr <- Results3FU[Results3FU$FDR < 0.05, ]
PheWAS_f_neur_sigfdr_df <- PheWAS_FU[colnames(PheWAS_FU) %in% PheWAS_f_neur_sigfdr$Variable]
PheWAS_f_neur_sigfdr_df <- cbind(PheWAS_FU[,1:21], PheWAS_f_neur_sigfdr_df)


## create empty matrix
pheno_names <- colnames(PheWAS_f_neur_sigfdr_df)[22:722]

R2_matrix_fneurfdr <- matrix(NA, nrow = length(pheno_names), ncol = length(pheno_names))
dimnames(R2_matrix_fneurfdr) <- list(pheno_names, pheno_names)

## for each phenotype pair, pull out marginal R2 value
iteration_count <- 0
for (i in 1:(length(pheno_names) - 1)) {
  for (j in (i + 1):length(pheno_names)) {
    iteration_count <- iteration_count + 1   # Increment the counter
    # Extract pheno pair
    pheno_pair <- c(pheno_names[i], pheno_names[j])
    
    # Attempt to fit linear mixed-effects model with two fixed effects
    model <- tryCatch(
      lmer(paste(pheno_pair[1], "~", pheno_pair[2], "+ (1|site_id) + (1|rel_family_id)"), data = PheWAS_f_neur_sigfdr_df),
      error = function(e) {
        cat("Error fitting model for Phenotype Pair:", pheno_pair, "\n")
        return(NULL)
      }
    )
    
    if (!is.null(model)) {
      # Attempt to extract R-squared values using MuMIn::r.squaredGLMM
      rsquared_values <- tryCatch(
        MuMIn::r.squaredGLMM(model),
        error = function(e) {
          cat("Error extracting R-squared for Phenotype Pair:", pheno_pair, "\n")
          return(NA)
        }
      )
      
      if (!any(is.na(rsquared_values))) {
        # Extract marginal R2
        R2_value <- rsquared_values[1]
    
        # Print values for debugging
        cat("Phenotype Pair:", pheno_pair, "\n")
        cat("R2 Value:", R2_value, "\n")
    
        # Store R2 value in the matrix for this pair only in one half (upper or lower)
        R2_matrix_fneurfdr[pheno_pair[1], pheno_pair[2]] <- R2_value
    
      } else {
        # Store NA in the matrix for this pair only in one half (upper or lower)
        R2_matrix_fneurfdr[pheno_pair[1], pheno_pair[2]] <- NA
      }
    } else {
      # Store NA in the matrix for this pair only in one half (upper or lower)
      R2_matrix_fneurfdr[pheno_pair[1], pheno_pair[2]] <- NA
    }
    
    # Periodically write out the matrix to a CSV file
    if (iteration_count %% 1000 == 0) {  # Save every 1000 iterations
      write.table(R2_matrix_fneurfdr, file = paste0("matrix_output_fneurfdr_", i, "_", j, ".csv"), sep = ",", row.names = TRUE, col.names = TRUE)
    }
  }
}
# Fill the other half of the matrix after the loop
R2_matrix_fneurfdr[lower.tri(R2_matrix_fneurfdr)] <- t(R2_matrix_fneurfdr)[lower.tri(R2_matrix_fneurfdr)]
# Save the final completed matrix
write.table(R2_matrix_fneurfdr, file = "matrix_output_fneurfdr_final.csv", sep = ",", row.names = TRUE, col.names = TRUE)



R2_matrix_fneur_fdr <- fread("matrix_output_fneurfdr_final.csv", header = F,data.table = F)
rownames(R2_matrix_fneur_fdr) <- R2_matrix_fneur_fdr$V1
R2_matrix_fneur_fdr$V1 <- NULL
colnames(R2_matrix_fneur_fdr) <- rownames(R2_matrix_fneur_fdr)

#### R2 > .9
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.9
  high_R2_pairs <- which(R2_matrix_fneur_fdr > 0.9, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_fdr_9 <- R2_matrix_fneur_fdr[-which(rownames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_fdr_9)
final_phenotypes


#### R2 > .8
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.8
  high_R2_pairs <- which(R2_matrix_fneur_fdr > 0.8, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_fdr_8 <- R2_matrix_fneur_fdr[-which(rownames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_fdr_8)
final_phenotypes



#### R2 > .7
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.7
  high_R2_pairs <- which(R2_matrix_fneur_fdr > 0.7, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_fdr_7 <- R2_matrix_fneur_fdr[-which(rownames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_fdr_7)
final_phenotypes



#### R2 > .6
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.6
  high_R2_pairs <- which(R2_matrix_fneur_fdr > 0.6, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_fdr_6 <- R2_matrix_fneur_fdr[-which(rownames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_fdr_6)
final_phenotypes


#### R2 > .5
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.5
  high_R2_pairs <- which(R2_matrix_fneur_fdr > 0.5, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_fdr_5 <- R2_matrix_fneur_fdr[-which(rownames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_fdr_5)
final_phenotypes


#### R2 > .94
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.4
  high_R2_pairs <- which(R2_matrix_fneur_fdr > 0.4, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_fdr_4 <- R2_matrix_fneur_fdr[-which(rownames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_fdr_4)
final_phenotypes



#### R2 > .3
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.3
  high_R2_pairs <- which(R2_matrix_fneur_fdr > 0.3, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_fdr_3 <- R2_matrix_fneur_fdr[-which(rownames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_fdr_3)
final_phenotypes


#### R2 > .2
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.2
  high_R2_pairs <- which(R2_matrix_fneur_fdr > 0.2, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_fdr_2 <- R2_matrix_fneur_fdr[-which(rownames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_fdr_2)
final_phenotypes



#### R2 > .1
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.1
  high_R2_pairs <- which(R2_matrix_fneur_fdr > 0.1, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_fdr_1 <- R2_matrix_fneur_fdr[-which(rownames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_fdr_1)
final_phenotypes



#### R2 > .05
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.05
  high_R2_pairs <- which(R2_matrix_fneur_fdr > 0.05, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fneur_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fneur_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_neur_sigfdr[PheWAS_f_neur_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fneur_fdr_05 <- R2_matrix_fneur_fdr[-which(rownames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fneur_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fneur_fdr_05)
final_phenotypes

```
###### FU2 Internalizing
```{r}
## Internalizing Baseline
Results4FU <- fread("Internalizing_results_FU_8.27.23.txt", header = T, data.table = F)

# Bonferroni
PheWAS_f_int_sig <- Results4FU[Results4FU$Bonferroni < 0.05, ]
PheWAS_f_int_sig_df <- PheWAS_FU[colnames(PheWAS_FU) %in% PheWAS_f_int_sig$Variable]
PheWAS_f_int_sig_df <- cbind(PheWAS_FU[,1:21], PheWAS_f_int_sig_df)

## create empty matrix
pheno_names <- colnames(PheWAS_f_int_sig_df)[22:204]

R2_matrix_fint <- matrix(NA, nrow = length(pheno_names), ncol = length(pheno_names))
dimnames(R2_matrix_fint) <- list(pheno_names, pheno_names)

## for each phenotype pair, pull out marginal R2 value
## for each phenotype pair, pull out marginal R2 value
iteration_count <- 0
for (i in 1:(length(pheno_names) - 1)) {
  for (j in (i + 1):length(pheno_names)) {
    iteration_count <- iteration_count + 1   # Increment the counter
    # Extract pheno pair
    pheno_pair <- c(pheno_names[i], pheno_names[j])
    
    # Attempt to fit linear mixed-effects model with two fixed effects
    model <- tryCatch(
      lmer(paste(pheno_pair[1], "~", pheno_pair[2], "+ (1|site_id) + (1|rel_family_id)"), data = PheWAS_f_int_sig_df),
      error = function(e) {
        cat("Error fitting model for Phenotype Pair:", pheno_pair, "\n")
        return(NULL)
      }
    )
    
    if (!is.null(model)) {
      # Attempt to extract R-squared values using MuMIn::r.squaredGLMM
      rsquared_values <- tryCatch(
        MuMIn::r.squaredGLMM(model),
        error = function(e) {
          cat("Error extracting R-squared for Phenotype Pair:", pheno_pair, "\n")
          return(NA)
        }
      )
      
      if (!any(is.na(rsquared_values))) {
        # Extract marginal R2
        R2_value <- rsquared_values[1]
    
        # Print values for debugging
        cat("Phenotype Pair:", pheno_pair, "\n")
        cat("R2 Value:", R2_value, "\n")
    
        # Store R2 value in the matrix for this pair only in one half (upper or lower)
        R2_matrix_fint[pheno_pair[1], pheno_pair[2]] <- R2_value
    
      } else {
        # Store NA in the matrix for this pair only in one half (upper or lower)
        R2_matrix_fint[pheno_pair[1], pheno_pair[2]] <- NA
      }
    } else {
      # Store NA in the matrix for this pair only in one half (upper or lower)
      R2_matrix_fint[pheno_pair[1], pheno_pair[2]] <- NA
    }
    
    # Periodically write out the matrix to a CSV file
    if (iteration_count %% 1000 == 0) {  # Save every 1000 iterations
      write.table(R2_matrix_fint, file = paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/matrix_output_fint_", i, "_", j, ".csv"), sep = ",", row.names = TRUE, col.names = TRUE)
    }
  }
}
# Fill the other half of the matrix after the loop
R2_matrix_fint[lower.tri(R2_matrix_fint)] <- t(R2_matrix_fint)[lower.tri(R2_matrix_fint)]
# Save the final completed matrix
write.table(R2_matrix_fint, file = "~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/matrix_output_fint_final.csv", sep = ",", row.names = TRUE, col.names = TRUE)

R2_matrix_fint <- fread("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/matrix_output_fint_final.csv", header = F, data.table = F)
rownames(R2_matrix_fint) <- R2_matrix_fint$V1
R2_matrix_fint$V1 <- NULL
colnames(R2_matrix_fint) <- rownames(R2_matrix_fint)

PheWAS_f_int_sig <- Results4FU[Results4FU$Bonferroni < 0.05,]

#### R2 > .9
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.9
  high_R2_pairs <- which(R2_matrix_fint > 0.9, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint)[row_index]
  phenotype2 <- rownames(R2_matrix_fint)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_9 <- R2_matrix_fint[-which(rownames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes9 <- rownames(R2_matrix_fint_9)
final_phenotypes9


#### R2 > .8
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.8
  high_R2_pairs <- which(R2_matrix_fint > 0.8, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint)[row_index]
  phenotype2 <- rownames(R2_matrix_fint)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_8 <- R2_matrix_fint[-which(rownames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes8 <- rownames(R2_matrix_fint_8)
final_phenotypes8


#### R2 > .7
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.7
  high_R2_pairs <- which(R2_matrix_fint > 0.7, arr.ind = TRUE)
  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint)[row_index]
  phenotype2 <- rownames(R2_matrix_fint)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_7 <- R2_matrix_fint[-which(rownames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes7 <- rownames(R2_matrix_fint_7)
final_phenotypes7


#### R2 > .6
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.6
  high_R2_pairs <- which(R2_matrix_fint > 0.6, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint)[row_index]
  phenotype2 <- rownames(R2_matrix_fint)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_6 <- R2_matrix_fint[-which(rownames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes6 <- rownames(R2_matrix_fint_6)
final_phenotypes6


#### R2 > .5
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.5
  high_R2_pairs <- which(R2_matrix_fint > 0.5, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint)[row_index]
  phenotype2 <- rownames(R2_matrix_fint)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_5 <- R2_matrix_fint[-which(rownames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes5 <- rownames(R2_matrix_fint_5)
final_phenotypes5


#### R2 > .4
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.4
  high_R2_pairs <- which(R2_matrix_fint > 0.4, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint)[row_index]
  phenotype2 <- rownames(R2_matrix_fint)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_4 <- R2_matrix_fint[-which(rownames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes4 <- rownames(R2_matrix_fint_4)
final_phenotypes4


#### R2 > .3
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.3
  high_R2_pairs <- which(R2_matrix_fint > 0.3, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint)[row_index]
  phenotype2 <- rownames(R2_matrix_fint)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_3 <- R2_matrix_fint[-which(rownames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes3 <- rownames(R2_matrix_fint_3)
final_phenotypes3

#### R2 > .2
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.2
  high_R2_pairs <- which(R2_matrix_fint > 0.2, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint)[row_index]
  phenotype2 <- rownames(R2_matrix_fint)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_2 <- R2_matrix_fint[-which(rownames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes2 <- rownames(R2_matrix_fint_2)
final_phenotypes2


#### R2 > .1
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.1
  high_R2_pairs <- which(R2_matrix_fint > 0.1, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint)[row_index]
  phenotype2 <- rownames(R2_matrix_fint)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_1 <- R2_matrix_fint[-which(rownames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes1 <- rownames(R2_matrix_fint_1)
final_phenotypes1


#### R2 > .05
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.05
  high_R2_pairs <- which(R2_matrix_fint > 0.05, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint)[row_index]
  phenotype2 <- rownames(R2_matrix_fint)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sig[PheWAS_f_int_sig$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_05 <- R2_matrix_fint[-which(rownames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes05 <- rownames(R2_matrix_fint_05)
final_phenotypes05



#### FDR

# Bonferroni
PheWAS_f_int_sigfdr <- Results4FU[Results4FU$FDR < 0.05, ]
PheWAS_f_int_sigfdr_df <- PheWAS_FU[colnames(PheWAS_FU) %in% PheWAS_f_int_sigfdr$Variable]
PheWAS_f_int_sigfdr_df <- cbind(PheWAS_FU[,1:21], PheWAS_f_int_sigfdr_df)


## create empty matrix
pheno_names <- colnames(PheWAS_f_int_sigfdr_df)[22:717]

R2_matrix_fintfdr <- matrix(NA, nrow = length(pheno_names), ncol = length(pheno_names))
dimnames(R2_matrix_fintfdr) <- list(pheno_names, pheno_names)

## for each phenotype pair, pull out marginal R2 value
iteration_count <- 0
for (i in 1:(length(pheno_names) - 1)) {
  for (j in (i + 1):length(pheno_names)) {
    iteration_count <- iteration_count + 1   # Increment the counter
    # Extract pheno pair
    pheno_pair <- c(pheno_names[i], pheno_names[j])
    
    # Attempt to fit linear mixed-effects model with two fixed effects
    model <- tryCatch(
      lmer(paste(pheno_pair[1], "~", pheno_pair[2], "+ (1|site_id) + (1|rel_family_id)"), data = PheWAS_f_int_sigfdr_df),
      error = function(e) {
        cat("Error fitting model for Phenotype Pair:", pheno_pair, "\n")
        return(NULL)
      }
    )
    
    if (!is.null(model)) {
      # Attempt to extract R-squared values using MuMIn::r.squaredGLMM
      rsquared_values <- tryCatch(
        MuMIn::r.squaredGLMM(model),
        error = function(e) {
          cat("Error extracting R-squared for Phenotype Pair:", pheno_pair, "\n")
          return(NA)
        }
      )
      
      if (!any(is.na(rsquared_values))) {
        # Extract marginal R2
        R2_value <- rsquared_values[1]
    
        # Print values for debugging
        cat("Phenotype Pair:", pheno_pair, "\n")
        cat("R2 Value:", R2_value, "\n")
    
        # Store R2 value in the matrix for this pair only in one half (upper or lower)
        R2_matrix_fintfdr[pheno_pair[1], pheno_pair[2]] <- R2_value
    
      } else {
        # Store NA in the matrix for this pair only in one half (upper or lower)
        R2_matrix_fintfdr[pheno_pair[1], pheno_pair[2]] <- NA
      }
    } else {
      # Store NA in the matrix for this pair only in one half (upper or lower)
      R2_matrix_fintfdr[pheno_pair[1], pheno_pair[2]] <- NA
    }
    
    # Periodically write out the matrix to a CSV file
    if (iteration_count %% 1000 == 0) {  # Save every 1000 iterations
      write.table(R2_matrix_fintfdr, file = paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/matrix_output_fintfdr_", i, "_", j, ".csv"), sep = ",", row.names = TRUE, col.names = TRUE)
    }
  }
}
# Fill the other half of the matrix after the loop
R2_matrix_fintfdr[lower.tri(R2_matrix_fintfdr)] <- t(R2_matrix_fintfdr)[lower.tri(R2_matrix_fintfdr)]
# Save the final completed matrix
write.table(R2_matrix_fintfdr, file = "~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/matrix_output_fintfdr_final.csv", sep = ",", row.names = TRUE, col.names = TRUE)




# Extend the existing matrix to the new size
#new_pheno_names <- colnames(PheWAS_f_int_sigfdr_df)[697:717]  # Adjust indices as needed
#pheno_names <- c(colnames(PheWAS_f_int_sigfdr_df)[22:696], new_pheno_names)  # Combine old and new phenotype names
#new_matrix_size <- length(pheno_names)
#extended_R2_matrix <- matrix(NA, nrow = new_matrix_size, ncol = new_matrix_size)
#dimnames(extended_R2_matrix) <- list(pheno_names, pheno_names)

# Copy existing values into the extended matrix using a loop
#for (i in 1:675) {
#  for (j in 1:675) {
#    extended_R2_matrix[i, j] <- R2_matrix_fint_fdr[i, j]
#  }
#}

# Update the loop for new and old-new phenotype pairs
#iteration_count <- 0
#for (i in 1:(new_matrix_size - 1)) {
#  for (j in (i + 1):new_matrix_size) {
#    if (i <= 675 && j <= 675) {
      # Skip pairs that were already calculated
#      next
 #   }

#    iteration_count <- iteration_count + 1   # Increment the counter
    # Extract pheno pair
#    pheno_pair_names <- c(pheno_names[i], pheno_names[j])
    
    # Convert phenotype names to matrix indices
#    pheno_pair_indices <- match(pheno_pair_names, pheno_names)
    
    # Attempt to fit linear mixed-effects model with two fixed effects
#    model <- tryCatch(
#      lmer(paste(pheno_pair_names[1], "~", pheno_pair_names[2], "+ (1|site_id) + (1|rel_family_id)"), data = PheWAS_f_int_sigfdr_df),
 #     error = function(e) {
 #       cat("Error fitting model for Phenotype Pair:", pheno_pair_names, "\n")
 #       return(NULL)
 #     }
 #   )
    
#    if (!is.null(model)) {
      # Attempt to extract R-squared values using MuMIn::r.squaredGLMM
#      rsquared_values <- tryCatch(
#        MuMIn::r.squaredGLMM(model),
#        error = function(e) {
#          cat("Error extracting R-squared for Phenotype Pair:", pheno_pair_names, "\n")
#          return(NA)
#        }
#      )
      
 #     if (!any(is.na(rsquared_values))) {
        # Extract marginal R2
 #       R2_value <- rsquared_values[1]
    
        # Print values for debugging
  #      cat("Phenotype Pair:", pheno_pair_names, "\n")
  #      cat("R2 Value:", R2_value, "\n")
    
        # Store R2 value in the matrix for this pair only in one half (upper or lower)
  #      extended_R2_matrix[pheno_pair_indices[1], pheno_pair_indices[2]] <- R2_value
    
#      } else {
        # Store NA in the matrix for this pair only in one half (upper or lower)
 #       extended_R2_matrix[pheno_pair_indices[1], pheno_pair_indices[2]] <- NA
 #     }
  #  } else {
      # Store NA in the matrix for this pair only in one half (upper or lower)
#      extended_R2_matrix[pheno_pair_indices[1], pheno_pair_indices[2]] <- NA
#    }
    
    # Periodically write out the matrix to a CSV file
#    if (iteration_count %% 1000 == 0) {
#      write.table(extended_R2_matrix, file = paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/matrix_output_fintfdr_missed_", i, "_", j, ".csv"), sep = ",", row.names = TRUE, col.names = TRUE)
#    }
#  }
#}

# Fill the other half of the extended matrix
#extended_R2_matrix[lower.tri(extended_R2_matrix)] <- t(extended_R2_matrix)[lower.tri(extended_R2_matrix)]

# Save the updated matrix
#write.table(extended_R2_matrix, file = "~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/matrix_output_fintfdr_final_missed.csv", sep = ",", #row.names = TRUE, col.names = TRUE)

R2_matrix_fint_fdr <- fread("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/matrix_output_fintfdr_final_missed.csv", header = F, data.table = F)
rownames(R2_matrix_fint_fdr) <- R2_matrix_fint_fdr$V1
R2_matrix_fint_fdr$V1 <- NULL
colnames(R2_matrix_fint_fdr) <- rownames(R2_matrix_fint_fdr)

#### R2 > .9
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.9
  high_R2_pairs <- which(R2_matrix_fint_fdr > 0.9, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fint_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_fdr_9 <- R2_matrix_fint_fdr[-which(rownames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fint_fdr_9)
final_phenotypes


#### R2 > .8
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.8
  high_R2_pairs <- which(R2_matrix_fint_fdr > 0.8, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fint_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_fdr_8 <- R2_matrix_fint_fdr[-which(rownames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fint_fdr_8)
final_phenotypes


#### R2 > .7
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.7
  high_R2_pairs <- which(R2_matrix_fint_fdr > 0.7, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fint_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_fdr_7 <- R2_matrix_fint_fdr[-which(rownames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fint_fdr_7)
final_phenotypes


#### R2 > .6
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.6
  high_R2_pairs <- which(R2_matrix_fint_fdr > 0.6, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fint_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_fdr_6 <- R2_matrix_fint_fdr[-which(rownames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fint_fdr_6)
final_phenotypes

#### R2 > .5
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.5
  high_R2_pairs <- which(R2_matrix_fint_fdr > 0.5, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fint_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_fdr_5 <- R2_matrix_fint_fdr[-which(rownames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fint_fdr_5)
final_phenotypes

#### R2 > .4
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.4
  high_R2_pairs <- which(R2_matrix_fint_fdr > 0.4, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fint_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_fdr_4 <- R2_matrix_fint_fdr[-which(rownames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fint_fdr_4)
final_phenotypes

#### R2 > .3
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.3
  high_R2_pairs <- which(R2_matrix_fint_fdr > 0.3, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fint_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_fdr_3 <- R2_matrix_fint_fdr[-which(rownames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fint_fdr_3)
final_phenotypes

#### R2 > .2
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.2
  high_R2_pairs <- which(R2_matrix_fint_fdr > 0.2, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fint_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_fdr_2 <- R2_matrix_fint_fdr[-which(rownames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fint_fdr_2)
final_phenotypes

#### R2 > .1
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.1
  high_R2_pairs <- which(R2_matrix_fint_fdr > 0.1, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fint_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_fdr_1 <- R2_matrix_fint_fdr[-which(rownames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fint_fdr_1)
final_phenotypes

#### R2 > .05
# Initialize a vector to keep track of removed phenotypes
removed_phenotypes <- c()
  # Find all pairs with R^2 > 0.05
  high_R2_pairs <- which(R2_matrix_fint_fdr > 0.05, arr.ind = TRUE)

  # Filter out lower triangle and diagonal to avoid duplicates and self-pairs
  high_R2_pairs <- high_R2_pairs[high_R2_pairs[, 1] < high_R2_pairs[, 2], ]
  # If no pairs found, return NULL
  if (nrow(high_R2_pairs) == 0) {
    return(NULL)
  }
  # Determine the phenotype with the highest p-value for each pair
# Function to apply to each pair
get_phenotypes_and_p_values <- function(pair) {
  row_index <- pair[1]
  col_index <- pair[2]
  phenotype1 <- rownames(R2_matrix_fint_fdr)[row_index]
  phenotype2 <- rownames(R2_matrix_fint_fdr)[col_index]
  cat("Debug - Phenotype 1:", phenotype1, "\n")
  cat("Debug - Phenotype 2:", phenotype2, "\n")
  p1 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype1, "Pval"]
  p2 <- PheWAS_f_int_sigfdr[PheWAS_f_int_sigfdr$Variable == phenotype2, "Pval"]
  cat("Debug - p1:", p1, "\n")
  cat("Debug - p2:", p2, "\n")
  if (any(is.na(c(p1, p2)))) return(tibble(Phenotype1 = NA, Pval1 = NA, Phenotype2 = NA, Pval2 = NA))
  return(tibble(Phenotype1 = phenotype1, Pval1 = p1, Phenotype2 = phenotype2, Pval2 = p2))
}
# Apply the function to each pair
phenotypes_and_p_values <- map_df(seq_len(nrow(high_R2_pairs)), function(i) get_phenotypes_and_p_values(high_R2_pairs[i, ]), .id = "Pair_ID")
# Calculate the absolute differences in p-values
phenotypes_and_p_values$Pval_Diff = abs(phenotypes_and_p_values$Pval1 - phenotypes_and_p_values$Pval2)
# Order by the absolute differences in p-values
phenotypes_and_p_values <- phenotypes_and_p_values[order(phenotypes_and_p_values$Pval_Diff, decreasing = TRUE), ]
  # Find the phenotype with the highest p-value across all pairs
phenotypes_and_p_values <- phenotypes_and_p_values %>%
  rowwise() %>%
  mutate(Max_Phenotype = ifelse(Pval1 > Pval2, Phenotype1, Phenotype2),
         Max_Pvalue = pmax(Pval1, Pval2))
  # Remove the selected phenotype from R2_matrix
  R2_matrix_fint_fdr_05 <- R2_matrix_fint_fdr[-which(rownames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype), -which(colnames(R2_matrix_fint_fdr) %in% phenotypes_and_p_values$Max_Phenotype)]
  removed_phenotypes <- phenotypes_and_p_values$Max_Phenotype
  print(length(unique(removed_phenotypes)))
# Output the final list of phenotypes
final_phenotypes <- rownames(R2_matrix_fint_fdr_05)
final_phenotypes
```


#### Partial Least Squares
##### Imputation Baseline
```{r}
PheWAS_baseline <- read_excel("FINAL_PHEWAS_baseline_n5556_5.11.23.xlsx")

PheWAS_baseline$site_id <- ifelse(PheWAS_baseline$site_id == 22, 21, PheWAS_baseline$site_id)
PheWAS_baseline[PheWAS_baseline == "NA"] <- NA
PheWAS_baseline[PheWAS_baseline == ""] <- NA
PheWAS_baseline <- PheWAS_baseline %>%
  mutate(devhx_10 = ifelse(devhx_10 == -1, NA, devhx_10))
which(colnames(PheWAS_baseline) == "tlfb_tob")
PheWAS_baseline[,c(671:1291)] <- lapply(PheWAS_baseline[,c(671:1291)],as.character)
PheWAS_baseline[,c(1:4,20)] <- lapply(PheWAS_baseline[,c(1:4,20)],as.factor)
PheWAS_baseline[,c(5:19,21:670)] <- lapply(PheWAS_baseline[,c(5:19,21:670)],as.numeric)

descbase <- as.data.frame(psych::describe(PheWAS_baseline[,21:670]))
skewed <- descbase[descbase$skew > 1.96 | descbase$skew < -1.96,]
skeweddf <- PheWAS_baseline[colnames(PheWAS_baseline) %in% rownames(skewed)] 
skeweddf <- cbind(PheWAS_baseline[,1:20], skeweddf)

skeweddf <- skeweddf %>%
  relocate(pds_m5_y, .after = "medhx_9b") %>%
  relocate(pds_m5_p, .after = "pds_m5_y") %>% 
  relocate(pds_m4_p, .after = "pds_m5_p") %>%
  relocate(medhx_6m_times, .after = "pds_m4_p") %>%
  relocate(medhx_6n_notes, .after = "medhx_6m_times") %>%
  relocate(medhx_6p_notes, .after = "medhx_6n_notes") 

# winsorizing
skeweddf[,21:312] <- lapply(skeweddf[,21:312], function(x) Winsorize(x, minval = mean(x, na.rm = T)-3*sd(x, na.rm = T), maxval = mean(x, na.rm = T)+3*sd(x, na.rm = T)))
descskewed <- as.data.frame(psych::describe(skeweddf[,21:312]))
skewed2 <- descskewed[descskewed$skew > 1.96 | descskewed$skew < -1.96,]
skeweddf2 <- skeweddf[colnames(skeweddf) %in% rownames(skewed2)] 
# inverse normal transformation
skeweddf2[,1:226] <- lapply(skeweddf2[,1:226], function(x) qnorm((rank(x, na.last="keep")-0.5)/sum(!is.na(x))))
skeweddf2 <- cbind(skeweddf[,1:20], skeweddf2) 

`%nin%` <- Negate(`%in%`)
PheWAS_baseline <- PheWAS_baseline[colnames(PheWAS_baseline) %nin% rownames(skewed)]

PheWAS_baseline <- PheWAS_baseline %>%
  mutate_if(is.numeric, scale)

skeweddf <- skeweddf[colnames(skeweddf) %nin% colnames(skeweddf2)] %>%
  mutate_if(is.numeric, scale)

PheWAS_baseline <- cbind(PheWAS_baseline[,1:20], skeweddf2[,21:246], skeweddf[colnames(skeweddf) %nin% colnames(skeweddf2)], PheWAS_baseline[,21:999])

## moving continuous items with issues to the end of the continuous section
PheWAS_baseline <- PheWAS_baseline %>%
  relocate(reshist_state_immigrant_factor, .after = "birth_weight_oz_comb") %>%
  relocate(pds_f4_p, .after = "reshist_state_immigrant_factor") %>%
  relocate(pds_f4_2_y, .after = "pds_f4_p") %>%
  relocate(pds_m4_y, .after = "pds_f4_2_y") %>%
  relocate(pds_m5_y, .after = "pds_m4_y") %>%
  relocate(pds_m5_p, .after = "pds_m5_y") %>% 
  relocate(pds_m4_p, .after = "pds_m5_p") %>% 
  relocate(pds_p_ss_female_category_2, .after = "pds_m4_p") %>%
  relocate(pds_p_ss_male_category_2, .after = "pds_p_ss_female_category_2") %>%
  relocate(pds_y_ss_female_category_2, .after = "pds_p_ss_male_category_2") %>%
  relocate(pds_y_ss_male_cat_2, .after = "pds_y_ss_female_category_2") %>%
  relocate(medhx_6m_times, .after = "pds_y_ss_male_cat_2") %>%
  relocate(medhx_6n_notes, .after = "medhx_6m_times") %>%
  relocate(medhx_6p_notes, .after = "medhx_6n_notes")  
which(colnames(PheWAS_baseline) == "birth_weight_oz_comb")
colnames(PheWAS_baseline)[919] <- "ADHD_present"
colnames(PheWAS_baseline)[920] <- "ADHD_past"

PheWAS_baseline_forimp <- PheWAS_baseline[, -c(1:18)] %>%
  mutate(sex = ifelse(sex == "F", 1, ifelse(sex == "M", 0, NA)))
#fwrite(PheWAS_baseline_forimp, file = "PheWAS_baseline_forimp.txt", row.names = F, col.names = T, sep = "\t")

Results_neur <- read.csv("Neurodev_results_base_8.11.23.csv")
Results_int <- read.csv("Internalizing_results_base_8.11.23.csv")
PheWAS_b_neur_sig <- Results_neur[Results_neur$Bonferroni < 0.05, ]
PheWAS_b_int_sig <- Results_int[Results_int$Bonferroni < 0.05, ]

PheWAS_baseline_forimp[PheWAS_baseline_forimp == "NA"] <- NA
PheWAS_baseline_forimp[PheWAS_baseline_forimp == ""] <- NA

colnames(PheWAS_baseline_forimp)[901] <- "ADHD_present"
colnames(PheWAS_baseline_forimp)[902] <- "ADHD_past"

PheWAS_b_neur_sig <- PheWAS_b_neur_sig %>%
  mutate(Variable = ifelse(Variable == "ADHD present", "ADHD_present",
                           ifelse(Variable == "ADHD past", "ADHD_past", Variable)))
PheWAS_b_int_sig <- PheWAS_b_int_sig %>%
  mutate(Variable = ifelse(Variable == "ADHD present", "ADHD_present",
                           ifelse(Variable == "ADHD past", "ADHD_past", Variable)))
PheWAS_b_sig <- merge(PheWAS_b_neur_sig, PheWAS_b_int_sig, by = "Variable", all = T)

PheWAS_baseline_forimp[, c(1, 3:652)] <- lapply(PheWAS_baseline_forimp[, c(1, 3:652)], as.numeric)
PheWAS_baseline_forimp[, c(2,653:1273)] <- lapply(PheWAS_baseline_forimp[, c(2,653:1273)], as.factor)


collin <- mice:::find.collinear(PheWAS_baseline_forimp)
`%nin%` <- Negate(`%in%`)
PheWAS_baseline_forimp2 <- PheWAS_baseline_forimp[colnames(PheWAS_baseline_forimp) %nin% collin & colnames(PheWAS_baseline_forimp) %in% PheWAS_b_sig$Variable]
PheWAS_baseline_forimp2 <- PheWAS_baseline_forimp2 %>%
  dplyr::select(names(.)[colSums(is.na(.)) < 2778])
PheWAS_baseline_forimp2 <- cbind(PheWAS_baseline_forimp[,1:2], PheWAS_baseline_forimp2)
methods <- make.method(PheWAS_baseline_forimp2)
for (var in colnames(PheWAS_baseline_forimp2)) {
  if (var %in% PheWAS_b_sig$Variable) {
    if (is.numeric(PheWAS_baseline_forimp2[[var]])) {
      methods[var] <- "pmm"
    } else if (is.factor(PheWAS_baseline_forimp2[[var]])) {
      methods[var] <- "logreg"
    }
  } else {
    methods[var] <- ""
  }
}

print("Methods assigned")


# Set the parameters
n_imputations <- 100
max_iterations <- 10 # 20 for 1, 2, and 24

for (m in 1:n_imputations) {
  # Run mice for a single imputation
  imputed_data <- mice(PheWAS_baseline_forimp2, method = methods, m = 1, maxit = max_iterations, seed = 1234 + m) # 1234 + m + m
  
  # Complete the data
  completed_data <- complete(imputed_data)
  
  # Construct a filename
  filename <- paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/Baseline_imputed_", m, ".csv")
  
  # Save the completed data
  write.csv(completed_data, filename, row.names = FALSE, quote = F)
}

## Checking missingness patterns - glmnet
PheWAS_baseline_forimp2 <- PheWAS_baseline_forimp[colnames(PheWAS_baseline_forimp) %in% PheWAS_b_sig$Variable]
PheWAS_baseline_forimp2 <- cbind(PheWAS_baseline[, c("interview_age", "sex")], PheWAS_baseline_forimp2) %>%
  mutate(sex = as.factor(ifelse(sex == "F", 1, 0)))


rep_cv_folds = function(reps,inner_fold,y_in){
  for (i in 1:reps){
    t_folds <- createFolds(y_in, k = inner_fold) 
    
    names(t_folds) = paste(names(t_folds),".Rep",sep = "",
                           str_pad(string = as.character(i),
                                   width = str_length(as.character(reps)),
                                   side = "left",
                                   pad = "0")
    )
    
    if(i == 1){
      folds=t_folds
    }else{folds = c(folds,t_folds)}
    
  }
  return(folds)
}

complete_cases_percent <- colSums(!is.na(PheWAS_baseline_forimp2)) / nrow(PheWAS_baseline_forimp2)
# Initialize a dataframe to store the accuracy of each model
accuracy_df <- data.frame(Variable = character(), Accuracy = numeric(), stringsAsFactors = F)
skipped_info <- list()
# Loop through the variables from column 3 to 251
for (i in 3:min(250, ncol(PheWAS_baseline_forimp2))) {
  variable_name <- names(PheWAS_baseline_forimp2)[i]
  # Check if the variable has missing data
  if (any(is.na(PheWAS_baseline_forimp2[, i]))) {
    # Prepare the outcome variable and predictors
    y <- is.na(PheWAS_baseline_forimp2[, i]) %>% as.factor()
    # Select predictors with more than 80% complete data
    valid_predictors <- complete_cases_percent > 0.8
    # Exclude the current variable from predictors
    valid_predictors[i] <- FALSE
    # Subset the data
    x <- PheWAS_baseline_forimp2[, valid_predictors, drop = FALSE]
    x <- cbind(y, x)
    
    # Check how many complete cases are present after subsetting predictors
    num_complete_rows <- sum(complete.cases(x))
    print(paste("Variable:", variable_name, "- Complete rows after subsetting:", num_complete_rows))
    
    # If after subsetting predictors there are no complete rows, skip this variable
    if (num_complete_rows == 0) {
      next
    }
    
    x <- na.omit(x)
    
    print(dim(x))
    print(i)
    
    class_table <- table(x[, 1])
    if (any(class_table < 2)) {
      skipped_info[[variable_name]] <- paste("Skipped due to class imbalance:", toString(class_table))
      next
    }
  
    set.seed(1234)
    # Create cross-validation folds
    train_dat_folds <- rep_cv_folds(reps = 10, inner_fold = 2, y_in = x[, 1])
    tr_con <- trainControl(method = "repeatedcv", index = train_dat_folds)
    set.seed(1234)
    # Train the Elastic Net model
    Elnet_model <- train(
      y ~ ., data = x,
      trControl = tr_con,
      family = "binomial",
      method = "glmnet",
      metric = "Accuracy",
      tuneLength = 10
    )
    
    # Retrieve the maximum accuracy and store it
    max_accuracy <- max(Elnet_model$results$Accuracy, na.rm = T)
    accuracy_df <- rbind(accuracy_df, data.frame(Variable = names(PheWAS_baseline_forimp2)[i], Accuracy = max_accuracy))
  } else {
    skipped_info[[variable_name]] <- "Skipped because there are no missing values."
  }
}
# Print the accuracy dataframe
print(accuracy_df)
print(skipped_info)

imputed_1 <- read.csv("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/Baseline_imputed_1.csv")
imputed_1_contin <- imputed_1 %>%
  mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)

PheWAS_baseline_forimp2_contin <- PheWAS_baseline_forimp2 %>%
  dplyr::select(-site_id) %>%
  mutate(interview_age = as.numeric(interview_age)) %>%
   mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)
library(gridExtra)
plots <- list()
for (var in colnames(imputed_1_contin)) {
        p <- ggplot() +
             
          geom_density(data = PheWAS_baseline_forimp2_contin[colnames(PheWAS_baseline_forimp2_contin) %in% colnames(imputed_1_contin)], aes_string(x = var), fill = "blue", alpha = 0.5) +
          geom_density(data = imputed_1_contin, aes_string(x = var), fill = "red", alpha = 0.5) +
             ggtitle(var)
        plots[[var]] <- p
    }

# Display all plots (consider displaying in batches if too many)
do.call(grid.arrange, c(plots[221:232], ncol = 5))
```

##### Imputation FU2
```{r}
PheWAS_FU <- read_excel("FINAL_PheWAS_FU2_n5556_07.29.23.xlsx")

PheWAS_FU$site_id <- ifelse(PheWAS_FU$site_id == 22, 21, PheWAS_FU$site_id)
PheWAS_FU[PheWAS_FU == "NA"] <- NA
PheWAS_FU[PheWAS_FU == ""] <- NA

which(colnames(PheWAS_FU) == "tlfb_list_l2___1")

PheWAS_FU[,c(1:4,20:21)] <- lapply(PheWAS_FU[,c(1:4,20:21)],as.factor)
PheWAS_FU[,c(1250:1718)] <- lapply(PheWAS_FU[,c(1250:1718)],as.character)
PheWAS_FU[,c(5:19,22:1249)] <- lapply(PheWAS_FU[,c(5:19,22:1249)],as.numeric)

descFU <- as.data.frame(psych::describe(PheWAS_FU[,22:1249]))
skewedFU <- descFU[descFU$skew > 1.96 | descFU$skew < -1.96,]
skewedFUdf <- PheWAS_FU[colnames(PheWAS_FU) %in% rownames(skewedFU)] 

# winsorizing
skewedFUdf[,1:462] <- lapply(skewedFUdf[,1:462], function(x) Winsorize(x, minval = mean(x, na.rm = T)-3*sd(x, na.rm = T), maxval = mean(x, na.rm = T)+3*sd(x, na.rm = T)))
descskewedFU <- as.data.frame(psych::describe(skewedFUdf[,1:462]))
skewedFU2 <- descskewedFU[descskewedFU$skew > 1.96 | descskewedFU$skew < -1.96,]
skewedFUdf2 <- skewedFUdf[colnames(skewedFUdf) %in% rownames(skewedFU2)] 
# inverse normal transformation
skewedFUdf2[,1:333] <- lapply(skewedFUdf2[,1:333], function(x) qnorm((rank(x, na.last="keep")-0.5)/sum(!is.na(x))))

`%nin%` <- Negate(`%in%`)
PheWAS_FU <- PheWAS_FU[colnames(PheWAS_FU) %nin% rownames(skewedFU)]

PheWAS_FU <- PheWAS_FU %>%
  mutate_if(is.numeric, scale)

skewedFUdf <- skewedFUdf[colnames(skewedFUdf) %nin% colnames(skewedFUdf2)] %>%
  mutate_if(is.numeric, scale)

PheWAS_FU <- cbind(PheWAS_FU[,1:21], skewedFUdf2, skewedFUdf, PheWAS_FU[,22:1256])

PheWAS_FU_forimp <- PheWAS_FU[, -c(1:18, 21)] %>%
  mutate(sex = ifelse(sex == "F", 1, ifelse(sex == "M", 0, NA))) %>%
  filter(!is.na(sex))
fwrite(PheWAS_FU_forimp, file = "PheWAS_FU_forimp.txt", row.names = F, col.names = T, sep = "\t")

Results_neur_FU <- fread("Neurodev_results_FU_8.27.23.txt", header = T, data.table = F)
Results_int_FU <- fread("Internalizing_results_FU_8.27.23.txt", header = T, data.table = F)
Results_neur_FU_sig <- Results_neur_FU[Results_neur_FU$Bonferroni < 0.05, ]
Results_int_FU_sig <- Results_int_FU[Results_int_FU$Bonferroni < 0.05, ]

PheWAS_FU_forimp[PheWAS_FU_forimp == "NA"] <- NA
PheWAS_FU_forimp[PheWAS_FU_forimp == ""] <- NA

PheWAS_FU_sig <- merge(Results_neur_FU_sig, Results_int_FU_sig, by = "Variable", all = T)

PheWAS_FU_forimp[, c(1, 3:1230)] <- lapply(PheWAS_FU_forimp[, c(1, 3:1230)], as.numeric)
PheWAS_FU_forimp[, c(2,1231:1699)] <- lapply(PheWAS_FU_forimp[, c(2,1231:1699)], as.factor)


collin <- mice:::find.collinear(PheWAS_FU_forimp)
`%nin%` <- Negate(`%in%`)
PheWAS_FU_forimp2 <- PheWAS_FU_forimp[colnames(PheWAS_FU_forimp) %nin% collin & colnames(PheWAS_FU_forimp) %in% PheWAS_FU_sig$Variable]
PheWAS_FU_forimp2 <- PheWAS_FU_forimp2 %>%
  dplyr::select(names(.)[colSums(is.na(.)) < 2524]) %>%
  dplyr::select(names(.)[colSums(is.na(.)) > 1])
PheWAS_FU_forimp2 <- cbind(PheWAS_FU_forimp[,1:2], PheWAS_FU_forimp2)
methods <- make.method(PheWAS_FU_forimp2)
for (var in colnames(PheWAS_FU_forimp2)) {
  if (var %in% PheWAS_FU_sig$Variable) {
    if (is.numeric(PheWAS_FU_forimp2[[var]])) {
      methods[var] <- "pmm"
    } else if (is.factor(PheWAS_FU_forimp2[[var]])) {
      methods[var] <- "logreg"
    }
  } else {
    methods[var] <- ""
  }
}

print("Methods assigned")


# Set the parameters
n_imputations <- 100
max_iterations <- 10 

for (m in 1:n_imputations) {
  # Run mice for a single imputation
  imputed_data_FU <- mice(PheWAS_FU_forimp2, method = methods, m = 1, maxit = max_iterations, seed = 1234 + m) # 1234 + m 
  
  # Complete the data
  completed_data_FU <- complete(imputed_data_FU)
  
  # Construct a filename
  filename_FU <- paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/Imputed_FU_", m, ".csv")
  
  # Save the completed data
  write.csv(completed_data_FU, filename_FU, row.names = FALSE, quote = F)
}


```

##### PLS models
```{r}

# Function to create custom cross-validation folds
grouped_cv_folds <- function(reps, inner_fold, site_id) {
  folds <- list()
  for (i in 1:reps) {
    t_folds <- groupKFold(site_id, k = inner_fold) 
    while(length(t_folds) != inner_fold) {
      t_folds <- groupKFold(site_id, k = inner_fold) 
    }
    names(t_folds) <- paste0(names(t_folds), ".Rep", str_pad(as.character(i), str_length(as.character(reps)), side = "left", pad = "0"))
    if (i == 1) {
      folds <- t_folds
    } else {
      folds <- c(folds, t_folds)
    }
  }
  return(folds)
}

baseline_imputed_comb_resid <-PheWAS_baseline[, c("rel_family_id", "site_id")]
results <- list()
# Loop through files
for (i in 1:100) {
  file_name <- paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/Baseline_imputed_", i, ".csv")
  baseline_imputed <- read.csv(file_name)
  baseline_imputed <- baseline_imputed %>%
    mutate_if(is.factor, as.character) %>%
    mutate_if(is.character, as.numeric)
  baseline_imputed[, 136:232] <- lapply(baseline_imputed[, 136:232], scale) # scaling factor variables
    
  print(i)
  # Combine datasets
  baseline_imputed_comb <- cbind(PheWAS_baseline[, c("rel_family_id", "site_id", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "Neurodev_PRScs", "Internalizing_PRScs")], baseline_imputed) %>%
    relocate(Neurodev_PRScs, .after = "sex")

  # Residualizing variables
  for (j in 16:ncol(baseline_imputed_comb)) {
    formula <- as.formula(paste(names(baseline_imputed_comb)[j], "~ C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id)"))
    model <- lmer(formula, data = baseline_imputed_comb, control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)), na.action = na.exclude)
# Calculate and store residuals
    residuals_model <- residuals(model)
    print(j)

    # Add residuals as a new column to the residuals dataframe
    # Column name is set as the name of the current column from the loop
    baseline_imputed_comb_resid[[names(baseline_imputed_comb)[j]]] <- residuals_model
  }
  set.seed(1234)
  # Select one row per rel_family_id
  baseline_imputed_comb_resid_nofam <- baseline_imputed_comb_resid %>% distinct(rel_family_id, .keep_all = TRUE)

  # Convert all variables except rel_family_id and site_id to numeric
  baseline_imputed_comb_resid_nofam[,-c(1,2)] <- lapply(baseline_imputed_comb_resid_nofam[,-c(1,2)], as.numeric)
  # Define the response variable 'y'
  y <- baseline_imputed_comb_resid_nofam$Neurodev_PRScs

  # Define the predictor variables 'x'
  # Exclude 'rel_family_id', 'site_id', and the response variable itself
  x <- baseline_imputed_comb_resid_nofam[, !(names(baseline_imputed_comb_resid_nofam) %in% c("rel_family_id", "site_id", "Neurodev_PRScs"))]

  # Create custom cross-validation folds
  folds <- grouped_cv_folds(reps = 10, inner_fold = 5, site_id = baseline_imputed_comb_resid_nofam$site_id)

  # Run PLS model
  pls_fit <- train(x, y, method = "pls", trControl = trainControl(method = "repeatedcv", index = folds))
  # Store results
  results[[paste0("Dataset_", i)]] <- pls_fit
  saveRDS(results[[paste0("Dataset_", i)]], file = paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/PLS_base_results_Dataset_", i, ".rds"))
}
saveRDS(results, file = "~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/PLS_base_results.rds")




results_int <- list()
# Loop through files
for (i in 1:100) {
  file_name <- paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/Baseline_imputed_", i, ".csv")
  baseline_imputed <- read.csv(file_name)
  baseline_imputed <- baseline_imputed %>%
    mutate_if(is.factor, as.character) %>%
    mutate_if(is.character, as.numeric)
  baseline_imputed[, 136:232] <- lapply(baseline_imputed[, 136:232], scale) # scaling factor variables
    
  print(i)
  # Combine datasets
  baseline_imputed_comb <- cbind(PheWAS_baseline[, c("rel_family_id", "site_id", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "Neurodev_PRScs", "Internalizing_PRScs")], baseline_imputed) %>%
    relocate(Internalizing_PRScs, .after = "sex")

  # Residualizing variables
  for (j in 16:ncol(baseline_imputed_comb)) {
    formula <- as.formula(paste(names(baseline_imputed_comb)[j], "~ C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id)"))
    model <- lmer(formula, data = baseline_imputed_comb, control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)), na.action = na.exclude)
# Calculate and store residuals
    residuals_model <- residuals(model)
    print(j)

    # Add residuals as a new column to the residuals dataframe
    # Column name is set as the name of the current column from the loop
    baseline_imputed_comb_resid[[names(baseline_imputed_comb)[j]]] <- residuals_model
  }
  set.seed(1234)
  # Select one row per rel_family_id
  baseline_imputed_comb_resid_nofam <- baseline_imputed_comb_resid %>% distinct(rel_family_id, .keep_all = TRUE)

  # Convert all variables except rel_family_id and site_id to numeric
  baseline_imputed_comb_resid_nofam[,-c(1,2)] <- lapply(baseline_imputed_comb_resid_nofam[,-c(1,2)], as.numeric)
  # Define the response variable 'y'
  y <- baseline_imputed_comb_resid_nofam$Internalizing_PRScs

  # Define the predictor variables 'x'
  # Exclude 'rel_family_id', 'site_id', and the response variable itself
  x <- baseline_imputed_comb_resid_nofam[, !(names(baseline_imputed_comb_resid_nofam) %in% c("rel_family_id", "site_id", "Internalizing_PRScs"))]

  # Create custom cross-validation folds
  folds <- grouped_cv_folds(reps = 10, inner_fold = 5, site_id = baseline_imputed_comb_resid_nofam$site_id)

  # Run PLS model
  pls_fit_int <- train(x, y, method = "pls", trControl = trainControl(method = "repeatedcv", index = folds))
  # Store results
  results_int[[paste0("int_Dataset_", i)]] <- pls_fit_int
  saveRDS(results_int[[paste0("int_Dataset_", i)]], file = paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/PLS_base_results_int_Dataset_", i, ".rds"))
}
saveRDS(results_int, file = "~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/PLS_base_results_int.rds")

```

##### Grid Search for Basline PLS
```{r}
baseline_imputed_comb_resid <-PheWAS_baseline[, c("rel_family_id", "site_id")]
results_base_neur_grid <- list()
# Loop through files
for (i in 1:5) {
  file_name <- paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/Baseline_imputed_", i, ".csv")
  baseline_imputed <- read.csv(file_name)
  baseline_imputed <- baseline_imputed %>%
    mutate_if(is.factor, as.character) %>%
    mutate_if(is.character, as.numeric)
  baseline_imputed[, 136:232] <- lapply(baseline_imputed[, 136:232], scale) # scaling factor variables
    
  print(i)
  # Combine datasets
  baseline_imputed_comb <- cbind(PheWAS_baseline[, c("rel_family_id", "site_id", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "Neurodev_PRScs", "Internalizing_PRScs")], baseline_imputed) %>%
    relocate(Neurodev_PRScs, .after = "sex")

  # Residualizing variables
  for (j in 16:ncol(baseline_imputed_comb)) {
    formula <- as.formula(paste(names(baseline_imputed_comb)[j], "~ C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + (1|site_id) + (1|rel_family_id)"))
    model <- lmer(formula, data = baseline_imputed_comb, control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)), na.action = na.exclude)
# Calculate and store residuals
    residuals_model <- residuals(model)
    print(j)

    # Add residuals as a new column to the residuals dataframe
    # Column name is set as the name of the current column from the loop
    baseline_imputed_comb_resid[[names(baseline_imputed_comb)[j]]] <- residuals_model
  }
  set.seed(1234)
  # Select one row per rel_family_id
  baseline_imputed_comb_resid_nofam <- baseline_imputed_comb_resid %>% distinct(rel_family_id, .keep_all = TRUE)

  # Convert all variables except rel_family_id and site_id to numeric
  baseline_imputed_comb_resid_nofam[,-c(1,2)] <- lapply(baseline_imputed_comb_resid_nofam[,-c(1,2)], as.numeric)
  # Define the response variable 'y'
  y <- baseline_imputed_comb_resid_nofam$Neurodev_PRScs

  # Define the predictor variables 'x'
  # Exclude 'rel_family_id', 'site_id', and the response variable itself
  x <- baseline_imputed_comb_resid_nofam[, !(names(baseline_imputed_comb_resid_nofam) %in% c("rel_family_id", "site_id", "Neurodev_PRScs"))]

  # Create custom cross-validation folds
  folds <- grouped_cv_folds(reps = 10, inner_fold = 5, site_id = baseline_imputed_comb_resid_nofam$site_id)
  tune_grid <- expand.grid(.ncomp = 1:20)
  # Run PLS model
  pls_fit <- train(x, y, method = "pls", trControl = trainControl(method = "repeatedcv", index = folds), tuneGrid = tune_grid)
  # Store results
  results_base_neur_grid[[paste0("Dataset_", i)]] <- pls_fit
  saveRDS(results_base_neur_grid[[paste0("Dataset_", i)]], file = paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/PLS_base_results_gridsearch_Dataset_", i, ".rds"))
}
saveRDS(results_base_neur_grid, file = "~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/PLS_base_results_gridsearch.rds")
```

##### FU2 PLS models
```{r}
FU_imputed_comb_resid <-PheWAS_FU[!is.na(PheWAS_FU$interview_age), c("rel_family_id", "site_id", "COVID_visittype")]
results_neur_FU <- list()
# Loop through files
for (i in 1:100) {
  file_name <- paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/Imputed_FU_", i, ".csv")
  FU_imputed <- read.csv(file_name)
  FU_imputed <- FU_imputed %>%
    mutate_if(is.factor, as.character) %>%
    mutate_if(is.character, as.numeric)
  FU_imputed[, 252:273] <- lapply(FU_imputed[, 252:273], scale) # scaling factor variables
    
  print(i)
  # Combine datasets
  FU_imputed_comb <- cbind(PheWAS_FU[!is.na(PheWAS_FU$interview_age), c("rel_family_id", "site_id", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "COVID_visittype", "Neurodev_PRScs", "Internalizing_PRScs")], FU_imputed) %>%
    relocate(Neurodev_PRScs, .after = "sex")

  # Residualizing variables
  for (j in 17:ncol(FU_imputed_comb)) {
    formula <- as.formula(paste(names(FU_imputed_comb)[j], "~ C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|site_id) + (1|rel_family_id)"))
    model <- lmer(formula, data = FU_imputed_comb, control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)), na.action = na.exclude)
# Calculate and store residuals
    residuals_model <- residuals(model)
    print(j)

    # Add residuals as a new column to the residuals dataframe
    # Column name is set as the name of the current column from the loop
  FU_imputed_comb_resid[[names(FU_imputed_comb)[j]]] <- residuals_model
  }
  set.seed(1234)
  # Select one row per rel_family_id
  FU_imputed_comb_resid_nofam <- FU_imputed_comb_resid %>% distinct(rel_family_id, .keep_all = TRUE)

  # Convert all variables except rel_family_id and site_id and COVID_visittype to numeric
  FU_imputed_comb_resid_nofam[,-c(1,2,3)] <- lapply(FU_imputed_comb_resid_nofam[,-c(1,2,3)], as.numeric)
  # Define the response variable 'y'
  y <- FU_imputed_comb_resid_nofam$Neurodev_PRScs

  # Define the predictor variables 'x'
  # Exclude 'rel_family_id', 'site_id', 'COVID_visittype' and the response variable itself
  x <- FU_imputed_comb_resid_nofam[, !(names(FU_imputed_comb_resid_nofam) %in% c("rel_family_id", "site_id", "COVID_visittype", "Neurodev_PRScs"))]

  # Create custom cross-validation folds
  folds <- grouped_cv_folds(reps = 10, inner_fold = 5, site_id = FU_imputed_comb_resid_nofam$site_id)

  # Run PLS model
  pls_fit_FU_neur <- train(x, y, method = "pls", trControl = trainControl(method = "repeatedcv", index = folds))
  # Store results
  results_neur_FU[[paste0("FU_neur_Dataset_", i)]] <- pls_fit_FU_neur
  saveRDS(results_neur_FU[[paste0("FU_neur_Dataset_", i)]], file = paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/PLS_FU_results_neur_Dataset_", i, ".rds"))
}
saveRDS(results_neur_FU, file = "~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/PLS_FU_results_neur.rds")


results_int_FU <- list()
# Loop through files
for (i in 1:100) {
  file_name <- paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/Imputed_FU_", i, ".csv")
  FU_imputed <- read.csv(file_name)
  FU_imputed <- FU_imputed %>%
    mutate_if(is.factor, as.character) %>%
    mutate_if(is.character, as.numeric)
  FU_imputed[, 252:273] <- lapply(FU_imputed[, 252:273], scale) # scaling factor variables
    
  print(i)
  # Combine datasets
  FU_imputed_comb <- cbind(PheWAS_FU[!is.na(PheWAS_FU$interview_age), c("rel_family_id", "site_id", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "COVID_visittype", "Neurodev_PRScs", "Internalizing_PRScs")], FU_imputed) %>%
    relocate(Internalizing_PRScs, .after = "sex")
  print(which(colnames(FU_imputed_comb)== "Neurodev_PRScs"))
  # Residualizing variables
  for (j in 17:ncol(FU_imputed_comb)) {
    formula <- as.formula(paste(names(FU_imputed_comb)[j], "~ C1 + C2 + C3 + C4 + C5 + C6 + C7 + C8 + C9 + C10 + sex + interview_age + COVID_visittype + (1|site_id) + (1|rel_family_id)"))
    model <- lmer(formula, data = FU_imputed_comb, control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)), na.action = na.exclude)
# Calculate and store residuals
    residuals_model <- residuals(model)
    print(j)

    # Add residuals as a new column to the residuals dataframe
    # Column name is set as the name of the current column from the loop
  FU_imputed_comb_resid[[names(FU_imputed_comb)[j]]] <- residuals_model
  }
  set.seed(1234)
  # Select one row per rel_family_id
  FU_imputed_comb_resid_nofam <- FU_imputed_comb_resid %>% distinct(rel_family_id, .keep_all = TRUE)

  # Convert all variables except rel_family_id and site_id and COVID_visittype to numeric
  FU_imputed_comb_resid_nofam[,-c(1,2,3)] <- lapply(FU_imputed_comb_resid_nofam[,-c(1,2,3)], as.numeric)
  # Define the response variable 'y'
  y <- FU_imputed_comb_resid_nofam$Internalizing_PRScs

  # Define the predictor variables 'x'
  # Exclude 'rel_family_id', 'site_id', 'COVID_visittype' and the response variable itself
  x <- FU_imputed_comb_resid_nofam[, !(names(FU_imputed_comb_resid_nofam) %in% c("rel_family_id", "site_id", "COVID_visittype", "Internalizing_PRScs"))]

  # Create custom cross-validation folds
    # Create custom cross-validation folds
  folds <- grouped_cv_folds(reps = 10, inner_fold = 5, site_id = FU_imputed_comb_resid_nofam$site_id)
  tune_grid <- expand.grid(.ncomp = 1:20)
  # Run PLS model
  pls_fit_FU_int <- train(x, y, method = "pls", trControl = trainControl(method = "repeatedcv", index = folds), tuneGrid = tune_grid)
  # Store results
  results_int_FU[[paste0("FU_int_Dataset_", i)]] <- pls_fit_FU_int
  saveRDS(results_int_FU[[paste0("FU_int_Dataset_", i)]], file = paste0("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/PLS_FU_results2_int_Dataset_", i, ".rds"))
}
saveRDS(results_int_FU, file = "~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/PLS_FU_results2_int.rds")
```

```{r}
setwd("~/Docs/Paperpreparation/Nicole_PheWAS_GSEM/")

  base_n_rds_files <- list.files(pattern = "PLS_base_results_Dataset_\\d+\\.rds$")

base_n_pls_results <- list()

for (file in base_n_rds_files) {
    dataset_number <- gsub("PLS_base_results_Dataset_|\\.rds", "", file)
    base_n_pls_results[[dataset_number]] <- readRDS(file)
}

loadings_base_n <- list()

for(i in 1:length(base_n_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    loadings_base_n_matrix <- base_n_pls_results[[i]]$finalModel$loadings

    # Create a data frame with correct variable names and components
    loadings_base_n_df <- data.frame(Variable = rownames(loadings_base_n_matrix), 
                              Comp1 = loadings_base_n_matrix[, 1], 
                              Comp2 = loadings_base_n_matrix[, 2])

    # Store in the list
    loadings_base_n[[i]] <- loadings_base_n_df
}

# Convert loadings to a single data frame
loadings_base_n_df <- bind_rows(loadings_base_n, .id = "Dataset")

fitstats_base_n <- list()

for(i in 1:length(base_n_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    fitstats_base_n_matrix <- base_n_pls_results[[i]]$results

    # Create a data frame with correct variable names and components
    fitstats_base_n_df <- data.frame(fitstats_base_n_matrix)

    # Store in the list
    fitstats_base_n[[i]] <- fitstats_base_n_df
}

# Convert loadings to a single data frame
fitstats_base_n_df <- bind_rows(fitstats_base_n, .id = "Dataset")


foldstats_base_n <- list()

for(i in 1:length(base_n_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    foldstats_base_n_matrix <- base_n_pls_results[[i]]$resample

    # Create a data frame with correct variable names and components
    foldstats_base_n_df <- data.frame(foldstats_base_n_matrix)

    # Store in the list
    foldstats_base_n[[i]] <- foldstats_base_n_df
}

# Convert loadings to a single data frame
foldstats_base_n_df <- bind_rows(foldstats_base_n, .id = "Dataset")


base_in_rds_files <- list.files(pattern = "PLS_base_results_int_Dataset_\\d+\\.rds$")

base_in_pls_results <- list()

for (file in base_in_rds_files) {
    dataset_number <- gsub("PLS_base_int_results_Dataset_|\\.rds", "", file)
    base_in_pls_results[[dataset_number]] <- readRDS(file)
}

loadings_base_in <- list()

for(i in 1:length(base_in_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    loadings_base_in_matrix <- base_in_pls_results[[i]]$finalModel$loadings

    # Create a data frame with correct variable names and components
    loadings_base_in_df <- data.frame(Variable = rownames(loadings_base_in_matrix), 
                              Comp1 = loadings_base_in_matrix[, 1], 
                              Comp2 = loadings_base_in_matrix[, 2])

    # Store in the list
    loadings_base_in[[i]] <- loadings_base_in_df
}

# Convert loadings to a single data frame
loadings_base_in_df <- bind_rows(loadings_base_in, .id = "Dataset")

fitstats_base_in <- list()

for(i in 1:length(base_in_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    fitstats_base_in_matrix <- base_in_pls_results[[i]]$results

    # Create a data frame with correct variable names and components
    fitstats_base_in_df <- data.frame(fitstats_base_in_matrix)

    # Store in the list
    fitstats_base_in[[i]] <- fitstats_base_in_df
}

# Convert loadings to a single data frame
fitstats_base_in_df <- bind_rows(fitstats_base_in, .id = "Dataset")

foldstats_base_in <- list()

for(i in 1:length(base_in_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    foldstats_base_in_matrix <- base_in_pls_results[[i]]$resample

    # Create a data frame with correct variable names and components
    foldstats_base_in_df <- data.frame(foldstats_base_in_matrix)

    # Store in the list
    foldstats_base_in[[i]] <- foldstats_base_in_df
}

# Convert loadings to a single data frame
foldstats_base_in_df <- bind_rows(foldstats_base_in, .id = "Dataset")



FU_n_rds_files <- list.files(pattern = "PLS_FU_results_neur_Dataset_\\d+\\.rds$")

FU_n_pls_results <- list()

for (file in FU_n_rds_files) {
    dataset_number <- gsub("PLS_FU_neur_results_Dataset_|\\.rds", "", file)
    FU_n_pls_results[[dataset_number]] <- readRDS(file)
}

loadings_FU_n <- list()

for(i in 1:length(FU_n_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    loadings_FU_n_matrix <- FU_n_pls_results[[i]]$finalModel$loadings

       # Check if 'loadings_FU_in_matrix' has a second column
    if(ncol(loadings_FU_n_matrix) >= 2) {
        # If 'Comp 2' exists
        comp2 <- loadings_FU_n_matrix[, 2]
    } else {
        # If 'Comp 2' does not exist, create a vector of NAs
        comp2 <- rep(NA, nrow(loadings_FU_n_matrix))
    }

    # Create a data frame with correct variable names and components
    loadings_FU_n_df <- data.frame(Variable = rownames(loadings_FU_n_matrix), 
                              Comp1 = loadings_FU_n_matrix[, 1], 
                              Comp2 = comp2)

    # Store in the list
    loadings_FU_n[[i]] <- loadings_FU_n_df
}

# Convert loadings to a single data frame
loadings_FU_n_df <- bind_rows(loadings_FU_n, .id = "Dataset")


fitstats_FU_n <- list()

for(i in 1:length(FU_n_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    fitstats_FU_n_matrix <- FU_n_pls_results[[i]]$results

    # Create a data frame with correct variable names and components
    fitstats_FU_n_df <- data.frame(fitstats_FU_n_matrix)

    # Store in the list
    fitstats_FU_n[[i]] <- fitstats_FU_n_df
}

# Convert loadings to a single data frame
fitstats_FU_n_df <- bind_rows(fitstats_FU_n, .id = "Dataset")


foldstats_FU_n <- list()

for(i in 1:length(FU_n_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    foldstats_FU_n_matrix <- FU_n_pls_results[[i]]$resample

    # Create a data frame with correct variable names and components
    foldstats_FU_n_df <- data.frame(foldstats_FU_n_matrix)

    # Store in the list
    foldstats_FU_n[[i]] <- foldstats_FU_n_df
}

# Convert loadings to a single data frame
foldstats_FU_n_df <- bind_rows(foldstats_FU_n, .id = "Dataset")


FU_in_rds_files <- list.files(pattern = "PLS_FU_results2_int_Dataset_\\d+\\.rds$")

FU_in_pls_results <- list()

for (file in FU_in_rds_files[]) {
    dataset_number <- gsub("PLS_FU_results2_int_Dataset_|\\.rds", "", file)
    FU_in_pls_results[[dataset_number]] <- readRDS(file)
}

loadings_FU_in <- list()

for(i in 1:length(FU_in_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    loadings_FU_in_matrix <- FU_in_pls_results[[i]]$finalModel$loadings
    
   # Check if 'loadings_FU_in_matrix' has a second column
    if(ncol(loadings_FU_in_matrix) >= 2) {
        # If 'Comp 2' exists
        comp2 <- loadings_FU_in_matrix[, 2]
    } else {
        # If 'Comp 2' does not exist, create a vector of NAs
        comp2 <- rep(NA, nrow(loadings_FU_in_matrix))
    }

    # Create a data frame with correct variable names and components
    loadings_FU_in_df <- data.frame(Variable = rownames(loadings_FU_in_matrix), 
                              Comp1 = loadings_FU_in_matrix[, 1], 
                              Comp2 = comp2)

    # Store in the list
    loadings_FU_in[[i]] <- loadings_FU_in_df
}

# Convert loadings to a single data frame
loadings_FU_in_df <- bind_rows(loadings_FU_in, .id = "Dataset")


fitstats_FU_in <- list()

for(i in 1:length(FU_in_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    fitstats_FU_in_matrix <- FU_in_pls_results[[i]]$results

    # Create a data frame with correct variable names and components
    fitstats_FU_in_df <- data.frame(fitstats_FU_in_matrix)

    # Store in the list
    fitstats_FU_in[[i]] <- fitstats_FU_in_df
}

# Convert loadings to a single data frame
fitstats_FU_in_df <- bind_rows(fitstats_FU_in, .id = "Dataset")


foldstats_FU_in <- list()

for(i in 1:length(FU_in_pls_results)) {
    # Directly use the loadings matrix if it's already in the correct format
    foldstats_FU_in_matrix <- FU_in_pls_results[[i]]$resample

    # Create a data frame with correct variable names and components
    foldstats_FU_in_df <- data.frame(foldstats_FU_in_matrix)

    # Store in the list
    foldstats_FU_in[[i]] <- foldstats_FU_in_df
}

# Convert loadings to a single data frame
foldstats_FU_in_df <- bind_rows(foldstats_FU_in, .id = "Dataset")
```

